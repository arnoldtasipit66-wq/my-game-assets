<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vconsole@latest/dist/vconsole.min.js"></script>
<script>
  var vConsole = new window.VConsole();
</script>
<script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
<title>Pinoy Pool</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

<script src="https://sad.adsgram.ai/js/sad.min.js"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&family=Nunito:wght@400;700&display=swap" rel="stylesheet">

    <style>
    :root {
        --felt-green: #006A4E;
        --wood-brown: #6B4226;
        --light-wood: #A0522D;
        --gold-accent: #FFD700;
        --dark-bg: rgba(20, 20, 35, 0.95); 
        --light-text: #FFFFFF;
    }

    body, html {
    margin: 0;
    padding: 0;
    width: 100vw;
    height: 100vh;
    
    
    background-color: #2c2c2c; 
    
    
background-image: url('https://i.imgur.com/Wg3y3Zn.jpeg');    
    background-repeat: repeat; 
    
    background-size: 500px;  
    background-attachment: fixed; 

    /* Standard settings */
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    font-family: 'Nunito', sans-serif;
    -webkit-user-select: none;
    -ms-user-select: none;
    user-select: none;
}

        /* 1. Ang Background (Black Overlay) */
#full-image-modal {
    background-color: rgba(0, 0, 0, 0.95) !important; /* Halos itim na */
    z-index: 20000 !important; /* Pinaka-ibabaw sa lahat */
    display: flex !important;
    align-items: center;
    justify-content: center;
    
    /* Default: Tago */
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease; /* Fade effect sa background */
}

/* Pag nakabukas na */
#full-image-modal.show {
    opacity: 1;
    visibility: visible;
}

/* 2. Container ng Picture */
.full-image-content {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: none; /* Para lumusot ang click sa background pag isasara */
}

/* 3. Ang Picture Mismo (Zoom Animation) */
#full-image-display {
    max-width: 90vw; /* 90% ng lapad ng screen */
    max-height: 85vh; /* 85% ng taas ng screen */
    
    border: 3px solid #FFD700; /* Gold Border */
    border-radius: 15px;
    box-shadow: 0 0 50px rgba(0,0,0,0.8); /* Malalim na shadow */
    object-fit: contain;
    pointer-events: auto; 

    /* Animation Start: Maliit */
    transform: scale(0.5);
    opacity: 0;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.27); /* Bouncy Zoom Effect */
}

/* Animation End: Malaki na */
#full-image-modal.show #full-image-display {
    transform: scale(1);
    opacity: 1;
}

/* 4. Close Button (X) */
#full-image-close-btn {
    position: absolute !important;
    top: 20px !important;
    right: 20px !important;
    color: white !important;
    font-size: 3em !important;
    cursor: pointer !important;
    z-index: 20001 !important;
    opacity: 0.8;
    transition: transform 0.2s;
}

#full-image-close-btn:hover {
    transform: scale(1.2);
    opacity: 1;
    color: #FFD700 !important;
}
 
    #lobby-buttons-container {
        position: absolute;
        bottom: 25px;
        left: 50%;
        transform: translateX(-50%);
        
        /* Glassmorphism */
        background: rgba(20, 20, 35, 0.65);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 24px;
        
        padding: 12px 20px;
        display: flex;
        gap: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        z-index: 100;
        pointer-events: all;
                
        max-width: 95vw;
        overflow-x: auto;
    }
    
    .menu-button, .lobby-button {
        font-family: 'Nunito', sans-serif;
        font-weight: 800;
        font-size: 0.9em;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: white;
                
        border: none;
             
        border-radius: 14px;
        padding: 12px 20px;
        min-width: 100px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
               
        background-image: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        position: relative;
        margin: 5px; /* Default spacing for menu buttons */
    }

    #lobby-buttons-container .lobby-button {
        margin: 0;
        width: auto;
        min-width: 80px;
        white-space: nowrap;
    }

    .menu-button:hover, .lobby-button:hover {
        transform: translateY(-4px) scale(1.05);
        box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        filter: brightness(1.2);
    }
    
    .menu-button:active, .lobby-button:active {
        transform: translateY(1px) scale(0.98);
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    
    #vs-ai-button { background-image: linear-gradient(to right, #0ba360 0%, #3cba92 100%); box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4); }
    #online-button { background-image: linear-gradient(to right, #0061ff 0%, #60efff 100%); box-shadow: 0 5px 15px rgba(0, 198, 255, 0.4); }
    #leaderboard-button { background-image: linear-gradient(to right, #FF8008 0%, #FFC837 100%); box-shadow: 0 5px 15px rgba(255, 200, 55, 0.4); }
    #shop-button { background-image: linear-gradient(to right, #8E2DE2 0%, #4A00E0 100%); box-shadow: 0 5px 15px rgba(142, 45, 226, 0.4); }
    #daily-reward-button { background-image: linear-gradient(to right, #ff416c 0%, #ff4b2b 100%); box-shadow: 0 5px 15px rgba(255, 65, 108, 0.4); }
    #friends-button { background-image: linear-gradient(to right, #11998e 0%, #38ef7d 100%); box-shadow: 0 5px 15px rgba(17, 153, 142, 0.4); }
    
    #find-match-button { background-image: linear-gradient(to right, #00c6ff 0%, #0072ff 100%); }
    #create-game-button { background-image: linear-gradient(to right, #1D976C 0%, #93F9B9 100%); }
    #join-game-button { background-image: linear-gradient(to right, #EB3349 0%, #F45C43 100%); }
    
    .menu-button:disabled, .lobby-button.claimed, .shop-buy-button.equipped, .shop-buy-button.disabled {
        background-image: none !important;
        background-color: #444 !important;
        opacity: 0.6;
        cursor: not-allowed;
        box-shadow: none !important;
        transform: none !important;
    }
    
    .modal-overlay .content, .instruction-modal .content, #leaderboard-modal .content, #shop-modal .content, #friends-modal .content, #invite-popup-modal .content {
        background: rgba(25, 25, 35, 0.9);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 24px;
        box-shadow: 0 30px 60px rgba(0,0,0,0.6);
        padding: 30px;
        color: #fff;
        max-width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        display: flex; 
        flex-direction: column;
    }

    .modal-overlay h2 {
        font-family: 'Luckiest Guy', cursive;
        font-size: 2.5em;
        margin-bottom: 20px;
        /* Gold Gradient Text */
        background: linear-gradient(180deg, #FFD700 0%, #FFA500 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        filter: drop-shadow(0 4px 0 rgba(0,0,0,0.3));
        letter-spacing: 2px;
    }
    
    input[type="text"] {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        color: white;
        padding: 12px;
        text-align: center;
        font-family: 'Nunito', sans-serif;
        font-size: 1.1em;
        width: 100%;
        max-width: 300px;
        transition: all 0.3s;
    }
    input[type="text"]:focus {
        background: rgba(255, 255, 255, 0.2);
        border-color: #FFD700;
        outline: none;
    }

    .friends-search-container {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
        width: 100%;
        justify-content: center;
    }

    #add-friend-btn {
        flex-shrink: 0;
        padding: 5px 15px !important;
        font-size: 0.9em !important;
        margin: 0 !important;
        min-width: auto;
    }

    .friends-search-results {
        max-height: 120px;
        overflow-y: auto;
        margin-bottom: 15px;
        width: 100%;
    }

    .friends-subheader {
        font-family: 'Luckiest Guy', cursive;
        color: var(--gold-accent);
        margin-top: 20px;
        margin-bottom: 8px;
        text-align: left;
        font-size: 1.4em;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        padding-bottom: 5px;
    }

    .friends-list-container {
        display: flex;
        flex-direction: column;
        gap: 8px;
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        padding: 10px;
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid rgba(0,0,0,0.4);
        width: 100%;
        box-sizing: border-box;
    }

    .friend-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px;
        background-color: rgba(255, 255, 255, 0.05);
        border-radius: 5px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .friend-info {
        display: flex;
        flex-direction: column;
        text-align: left;
    }

    .friend-name {
        font-size: 1.1em;
        font-weight: bold;
        color: var(--light-text);
    }

    .friend-rank {
        font-size: 0.9em;
        opacity: 0.8;
    }

    .friend-actions {
        display: flex;
        gap: 5px;
        flex-shrink: 0;
    }
        
    .friend-actions .menu-button, .friend-actions .lobby-button {
        padding: 5px 10px;
        font-size: 0.8em;
        min-width: 60px;
    }

    .friend-item-empty {
        color: rgba(255, 255, 255, 0.5);
        font-style: italic;
        padding: 10px;
        text-align: center;
    }
   
    .invite-btn { background-color: #007bff !important; }
    .accept-btn { background-color: #28a745 !important; }
    .decline-btn { background-color: #dc3545 !important; }

    #credits-container { display: none; }
    
    #vs-screen-modal.show { animation: vsFadeOut 0.5s ease-out 3.5s forwards; }

    #vs-content-box {
        display: flex;
        flex-direction: row;
        justify-content: center;
        align-items: center;
        gap: 40px;
        width: 90vw;
        max-width: 800px;
    }

    .vs-player-box {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 20px;
        background-color: rgba(0, 0, 0, 0.5);
        border-radius: 10px;
        border: 2px solid rgba(255, 255, 255, 0.3);
    }

    #vs-player-1-box { align-items: flex-end; animation: vsSlideInLeft 0.7s ease-out 0.2s forwards; opacity: 0; }
    #vs-player-2-box { align-items: flex-start; animation: vsSlideInRight 0.7s ease-out 0.2s forwards; opacity: 0; }

    .vs-player-rank {
        font-size: 1.5em;
        font-weight: bold;
        font-family: 'Nunito', sans-serif;
        opacity: 0.8;
    }

    .vs-player-name {
        font-family: 'Luckiest Guy', cursive;
        font-size: 3em;
        color: var(--gold-accent);
        text-shadow: 2px 2px 6px rgba(0,0,0,0.7);
        line-height: 1.1;
        word-break: break-all;
    }

    #vs-divider {
        font-family: 'Luckiest Guy', cursive;
        font-size: 5em;
        color: #ff6b6b;
        text-shadow: 2px 2px 8px rgba(0,0,0,0.8);
        transform: scale(0);
        animation: vsPopIn 0.5s ease-out 0.8s forwards;
    }

    #vs-game-mode {
        position: absolute;
        bottom: 30px;
        font-family: 'Luckiest Guy', cursive;
        font-size: 2em;
        color: var(--light-text);
        text-shadow: 1px 1px 4px rgba(0,0,0,0.6);
        opacity: 0;
        animation: vsFadeIn 1s ease-out 1.2s forwards;
    }
    
    @keyframes vsFadeOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-20px); } }
    @keyframes vsPopIn { from { transform: scale(0); } to { transform: scale(1); } }
    @keyframes vsSlideInLeft { from { opacity: 0; transform: translateX(-100px); } to { opacity: 1; transform: translateX(0); } }
    @keyframes vsSlideInRight { from { opacity: 0; transform: translateX(100px); } to { opacity: 1; transform: translateX(0); } }
    @keyframes vsFadeIn { from { opacity: 0; } to { opacity: 1; } }
    
    #xp-container {
        position: absolute;
        bottom: 0px;
        left: 0px;
        background-color: var(--dark-bg);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        padding: 4px 8px;
        display: flex;
        align-items: center;
        gap: 3px;
        backdrop-filter: blur(5px);
        z-index: 10;
    }
    #xp-level { font-size: 0.9em; font-weight: bold; color: var(--light-text); flex-shrink: 0; }
    #xp-bar-wrapper {
        width: 30px; height: 12px;
        background-color: rgba(0,0,0,0.5);
        border: 1px solid rgba(0,0,0,0.7);
        border-radius: 6px;
        position: relative;
        overflow: hidden;
    }
    #xp-bar-fill-new {
        position: absolute; top: 0; left: 0; height: 100%; width: 0%;
        background: linear-gradient(to right, #33FF57, #28a745);
        border-radius: 6px; transition: width 0.3s ease; z-index: 1;
    }
    #xp-text-display-new {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        display: flex; justify-content: center; align-items: center;
        font-size: 10px; font-weight: bold; color: white;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.8); z-index: 2;
    }
    
    #shop-items-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
        padding: 15px; 
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 10px;
        margin-bottom: 20px; 
        flex-grow: 1;
        overflow-y: auto;
        overflow-x: hidden;
        min-height: 100px;
        width: 100%;
        box-sizing: border-box;
    }
    
    .shop-item-stats {
        width: 100%;
        padding: 5px 0;
        margin-bottom: 10px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    .stat-entry { display: flex; align-items: center; width: 100%; }
    .stat-label { font-size: 0.75em; color: #ddd; width: 40px; text-align: left; margin-right: 5px; flex-shrink: 0; }
    .stat-bar-background {
        flex-grow: 1; height: 10px;
        background-color: rgba(0, 0, 0, 0.4);
        border-radius: 5px; overflow: hidden;
        border: 1px solid rgba(0,0,0,0.6);
    }
    .stat-bar-fill { height: 100%; border-radius: 5px; transition: width 0.3s ease-out; box-shadow: inset 0 0 3px rgba(255,255,255,0.2); }
    .stat-bar-fill.power { background: linear-gradient(to right, #ff6b6b, #ee5253); }
    .stat-bar-fill.aim { background: linear-gradient(to right, #54a0ff, #2e86de); }
    .stat-bar-fill.spin { background: linear-gradient(to right, #1dd1a1, #10ac84); }

    /* SHOP ITEM CARD */
    .shop-item {
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 10px;
        text-align: center;
        border: 1px solid rgba(255, 255, 255, 0.2);
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
    .shop-item-preview {
        width: 100%; height: 100px;
        background-size: contain; background-position: center; background-repeat: no-repeat;
        margin-bottom: 10px;
        filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.7)); 
    }
    .shop-item-name { font-weight: bold; font-size: 0.9em; margin-bottom: 10px; }
   
    .shop-buy-button {
        font-family: 'Nunito', sans-serif;
        text-transform: uppercase;
        letter-spacing: 1px;
        padding: 8px 12px;
        font-size: 0.9em;
        font-weight: bold;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.2s;
        width: 100%;
    }
    .shop-buy-button.buy { background-image: linear-gradient(to right, #28a745, #218838); }
    .shop-buy-button.equip { background-image: linear-gradient(to right, #007bff, #0069d9); }
    .shop-buy-button.equipped { background-color: #6c757d; cursor: not-allowed; opacity: 0.7; background-image: none; }
    .shop-buy-button.disabled { background-color: #dc3545; cursor: not-allowed; opacity: 0.7; background-image: none; }
    
    #cue-stick-element {
        display: none; position: absolute; pointer-events: none; z-index: 30;
        transform-origin: 100% 50%; filter: drop-shadow(2px 2px 5px rgba(0,0,0,0.5));
    }

    #game-wrapper {
    position: absolute; /* Gawing absolute para hindi maapektuhan ng iba */
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    
    display: flex;
    justify-content: center;
    align-items: center;
    
    z-index: 1; 
}
    #table-frame {
    padding: 25px;
        
    background-image: url('https://i.imgur.com/T9ft7vz.jpeg');
    
    background-repeat: repeat;
    
    background-size: 600px; 

    background-color: #5D4037; 
    border-radius: 10px;
    box-sizing: border-box; 
    box-shadow: 0 15px 30px 5px rgba(0,0,0,0.6), inset 0 0 10px rgba(0,0,0,0.7), inset 2px 2px 5px rgba(255, 255, 255, 0.2), inset -2px -2px 5px rgba(0, 0, 0, 0.4);
}

    #game-canvas {
    /* Palitan ang lumang color nito (dating #C59D5F o Green) */
    background-color: #C89646; /* Honey Gold */
    
    cursor: crosshair;
    width: 100%; height: 100%;
    transform: translateZ(0);
    -webkit-transform: translateZ(0);
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
}

    #ghost-hand {
    display: none; 
    position: absolute; 
    width: 60px; 
    height: auto;
    opacity: 0.3; 
    z-index: 50; 
    pointer-events: none;
        
    transform: translate(-50%, -50%); 
    
    filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.4));
}

    #non-interactive-overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        pointer-events: none; z-index: 5;
    }

    #message-box {
        position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
        background-color: var(--dark-bg); color: var(--gold-accent);
        padding: 12px 24px; border-radius: 10px; font-size: 1.3em;
        display: none; text-align: center; font-weight: bold;
        text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.6);
        border: 1px solid rgba(255, 215, 0, 0.3);
    }

    
    .modal-coin-display {
        font-size: 1.1em; font-weight: bold; color: var(--gold-accent);
        background-color: rgba(0, 0, 0, 0.2); padding: 8px 15px;
        border-radius: 8px; margin-bottom: 20px;
        border: 1px solid rgba(255, 255, 255, 0.1); display: inline-block;
    }


#currency-display {
    /* Bagong Posisyon: Kaliwa Baba */
    position: absolute !important;
    bottom: 10px !important; /* Nilipat mula top papuntang bottom */
    left: 10px !important;
    
    /* Pinatagal natin ang z-index para sigurado sa ibabaw */
    z-index: 99999 !important; 

    /* Box Style (Hindi nagbago) */
    background: rgba(0, 0, 0, 0.7) !important;
    backdrop-filter: blur(4px);
    border: 1px solid rgba(255, 215, 0, 0.3) !important;
    border-radius: 12px !important;
    padding: 5px 12px !important;
    display: flex !important;
    align-items: center !important;
    gap: 5px !important;
    color: #FFD700 !important;
    font-family: 'Nunito', sans-serif !important;
    font-weight: 800 !important;
    font-size: 0.85em !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.6) !important;
}

    
    .ui-button {
        position: absolute; padding: 20px 15px; font-size: 1em; color: white;
        border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 5px;
        cursor: pointer; pointer-events: all; z-index: 10;
    }

    #exit-button {
        bottom: 0px; left: 50%; transform: translateX(-50%);
        background-color: rgba(220, 53, 69, 0.7); padding: 4px 16px;
        font-size: 0.8em; z-index: 100; transition: all 0.2s ease-in-out;
        border-radius: 8px;
    }
    #exit-button:hover {
        background-color: rgba(220, 53, 69, 1); transform: translateX(-50%) scale(1.05);
    }

    .icon-button {
        background-color: rgba(0, 0, 0, 0.6); width: 40px; height: 40px;
        display: flex; justify-content: center; align-items: center;
        border-radius: 50%; border: 2px solid rgba(255, 255, 255, 0.5);
        box-shadow: 0 0 10px rgba(0,0,0,0.5); transition: all 0.2s ease-in-out;
    }
    .icon-button:hover { transform: scale(1.1); border-color: var(--gold-accent); }

    #card-hand-container, #poker-foul-cards {
        position: absolute; top: 0px; left: 50%; transform: translateX(-50%);
        display: flex; flex-direction: row; gap: 8px; pointer-events: all; z-index: 10;
    }

    #poker-foul-cards {
        top: auto; position: relative; transform: none; left: auto;
        margin-top: 20px; justify-content: center;
    }

    .card {
        width: 40px; height: 60px;
        background-color: rgba(255, 255, 255, 0.9); 
        border: 1px solid rgba(0, 0, 0, 0.2); border-radius: 4px; 
        display: flex; flex-direction: column; justify-content: space-between;
        align-items: center; padding: 2px; font-weight: bold;
        color: #333; text-shadow: none;
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    #card-hand-container .card { width: 13px; height: 23px; }
    .card-rank { font-size: 1.0em; }
    .card-suit { font-size: 0.9em; align-self: flex-end; }
    #card-hand-container .card-rank { font-size: 0.6em; }
    #card-hand-container .card-suit { font-size: 0.6em; }

    .card.face-down {
        background-image: linear-gradient(135deg, #4a90e2 25%, #50e3c2 100%);
        cursor: pointer;
    }
    .card.face-down:hover { transform: translateY(-10px) scale(1.05); box-shadow: 0 8px 15px rgba(0,0,0,0.3); }

    .control-area {
        position: absolute; display: flex; align-items: center;
        justify-content: center; pointer-events: all; z-index: 20;
    }

    #power-control {
        right: 15px; top: 70%; transform: translateY(-50%);
        width: 40px; height: 230px;
        background-color: rgba(0, 0, 0, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 15px; flex-direction: column;
        justify-content: flex-end; padding: 4px;
    }
    #power-bar {
        width: 100%; background: linear-gradient(to top, #00ff00, #ffff00, #ff0000);
        border-radius: 10px; height: 0%;
    }

        #pektus-control {
        bottom: 70px; 
        left: 5px; 
        top: auto; 
        right: auto; 
        transform: none;
        
        width: 40px; /* Yung pinaikling size */
        height: 12px; 
        
        /* BINAGO: Kulay Gold (#FFD700) na ang background */
        background: #FFD700;
        /* Naglagay ako ng konting gradient para mas maganda tignan */
        background: linear-gradient(to bottom, #FFD700 0%, #E6C200 100%);
        
        border-radius: 4px; 
        cursor: pointer;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3); 
        border: 1px solid #B8860B; /* Darker gold na border */
    }

    #pektus-dot {
        position: absolute; 
        width: 8px; 
        height: 8px; 
        
        /* BINAGO: Ibinalik sa Red ang Dot */
        background-color: red; 
        
        border-radius: 50%;
        top: 50%; 
        left: 50%; 
        transform: translate(-50%, -50%);
        pointer-events: none; 
        
        /* White border para lutang na lutang sa Gold background */
        border: 1px solid white; 
        box-shadow: 0 1px 2px rgba(0,0,0,0.5);
    }
    /* Crosshair sa loob (gawing puti para malinis) */
    #pektus-dot::before, #pektus-dot::after { 
        content: ''; 
        position: absolute; 
        background-color: white; 
    }
    #pektus-dot::before { top: 50%; left: 2px; right: 2px; height: 1px; transform: translateY(-50%); }
    #pektus-dot::after { left: 50%; top: 2px; bottom: 2px; width: 1px; transform: translateX(-50%); }
    .arrow-button {
        position: absolute; bottom: 0px;
        width: 70px; height: 33px;
        background-color: rgba(0, 0, 0, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 10px;
        display: flex; justify-content: center; align-items: center;
        color: white; font-size: 24px; font-weight: bold;
        cursor: pointer; user-select: none; transition: all 0.2s ease;
    }
    .arrow-button:active { transform: scale(0.95); background-color: rgba(0,0,0,0.6); }
    #left-arrow { right: 50%; transform: translateX(-120px); }
    #right-arrow { left: 50%; transform: translateX(120px); }
    
    .modal-overlay {
        display: flex; position: fixed; top: 0; left: 0;
        width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.85);
        justify-content: center; align-items: center;
        text-align: center; color: white; flex-direction: column;
        z-index: 200; opacity: 0; visibility: hidden;
        pointer-events: none; transition: opacity 0.3s ease, visibility 0.3s ease;
        backdrop-filter: blur(8px);
    }
    .modal-overlay.show { opacity: 1; visibility: visible; pointer-events: all; }
    .modal-overlay.faded { opacity: 0.1; }
    #confirm-exit-modal { z-index: 300; }

    .back-button { background-color: rgba(108, 117, 125, 0.5); margin-top: 20px; }
    .back-button:hover { background-color: rgba(108, 117, 125, 0.8); }
    
#winner-modal {
    
    background-color: rgba(0, 0, 0, 0.3) !important; 
    
    /* TANGGALIN ang Blur para malinaw ang laro sa likod */
    backdrop-filter: none !important; 
    
    /* Positioning (Wag galawin) */
    z-index: 9999 !important;
    display: flex !important;
    justify-content: center;
    align-items: center;
}
    #ai-rematch-button { background-color: #4CAF50; }
    #back-to-menu-button { background-color: #6c757d; }

    .winner-modal-content-wrapper {
        display: flex; flex-direction: row-reverse; 
        align-items: flex-start; justify-content: center;
        gap: 50px; background-color: rgba(30, 30, 30, 0.7);
        padding: 30px 40px; border-radius: 15px;
        border: 1px solid rgba(255,255,255,0.2);
        max-width: 90vw; max-height: 80vh; overflow-y: auto;
    }

    .winner-text-and-buttons {
        display: flex; flex-direction: column; align-items: center;
        justify-content: flex-start; text-align: center;
        min-width: 300px; padding-top: 20px; gap: 15px;
    }

    #opponent-hand-reveal { margin-top: 0; display: flex; flex-direction: column; align-items: center; }
    #rematch-button { display: none; width: 250px; margin: 5px 0; font-size: 1.2em; padding: 10px 20px; }

    #online-menu input {
        font-family: 'Nunito', sans-serif; font-size: 1.1em;
        padding: 12px; margin: 10px; width: 280px;
        border-radius: 5px; border: 1px solid #ccc;
    }
    #opponent-hand-reveal .card { transform: scale(0.8); }

    .instruction-modal .play-button-container { margin-bottom: 20px; }
    .instruction-modal p { font-style: italic; line-height: 1.6; font-size: 1.1em; text-align: left; }

    .guide-text {
        position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
        background-color: rgba(255, 255, 0, 0.8); color: black;
        padding: 10px 20px; border-radius: 10px;
        font-size: 1.1em; font-weight: bold; display: none; text-align: center;
    }

    #waiting-room p { font-size: 1.2em; margin-bottom: 15px; }
    #waiting-room #game-id-display {
        background-color: rgba(0,0,0,0.4); padding: 15px 25px;
        border-radius: 8px; font-size: 2.5em; font-weight: bold;
        letter-spacing: 5px; border: 1px solid rgba(255,255,255,0.3);
        margin-bottom: 20px; cursor: pointer;
    }

    #confirm-exit-modal .button-group { display: flex; gap: 20px; margin-top: 20px; }
    #confirm-exit-modal .confirm-button { width: 140px; pointer-events: all; }
    #confirm-exit-yes { background-color: rgba(220, 53, 69, 0.7); }
    #confirm-exit-cancel { background-color: rgba(108, 117, 125, 0.7); }

    #leaderboard-modal .content { width: 80%; max-width: 500px; }
    #leaderboard-modal table { width: 100%; text-align: left; border-collapse: collapse; }
    #leaderboard-modal th, #leaderboard-modal td { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.3); }

    #chat-container {
        position: absolute; bottom: 10px; left: 10px; width: 300px; height: 200px;
        background-color: rgba(0, 0, 0, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px; display: none; flex-direction: column;
        z-index: 150; pointer-events: all; font-size: 0.9em; backdrop-filter: blur(5px);
    }
    #chat-messages { flex-grow: 1; overflow-y: auto; padding: 8px; display: flex; flex-direction: column-reverse; }
    #chat-messages p { margin: 2px 0; padding: 4px 8px; border-radius: 5px; color: white; word-wrap: break-word; }
    #chat-messages .my-message { background-color: #007bff; align-self: flex-end; text-align: right; }
    #chat-messages .opponent-message { background-color: #454d55; align-self: flex-start; text-align: left; }
    #chat-input-area { display: flex; padding: 5px; border-top: 1px solid rgba(255, 255, 255, 0.2); }
    #chat-input { flex-grow: 1; background-color: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; padding: 5px; border-radius: 4px; }
    #chat-send-btn { margin-left: 5px; background-color: #28a745; border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; }

    .loader { width: 48px; height: 48px; border: 5px solid #FFF; border-bottom-color: var(--gold-accent); border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; margin-bottom: 20px; }
    @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    #chat-toggle-button { top: 75% !important; left: 5px !important; }

    #credits-container {
        position: absolute; bottom: 5px; right: 10px; font-size: 0.5em;
        color: rgba(255, 255, 255, 0.6); text-align: right;
        z-index: 100; pointer-events: none;
    }

    /* START: Tutorial Styles */
    #tutorial-overlay {
        z-index: 500; background-color: transparent;
        backdrop-filter: none; pointer-events: none; 
    }
    #tutorial-highlight {
        position: absolute; border: 3px dashed var(--gold-accent);
        border-radius: 10px; box-shadow: none; pointer-events: none;
        transition: all 0.4s ease-in-out; z-index: 501; box-sizing: border-box;
    }
    #tutorial-box {
        position: absolute; background-color: var(--dark-bg);
        color: var(--light-text); padding: 20px; border-radius: 10px;
        border: 2px solid var(--gold-accent); max-width: 350px;
        text-align: center; font-size: 1.1em; pointer-events: all;
        z-index: 502; line-height: 1.5;
        box-shadow: 0 5px 25px rgba(0,0,0,0.5); transition: all 0.4s ease-in-out;
    }
    #tutorial-box p { margin: 0 0 15px 0; }
    #tutorial-next-btn {
        background-color: #4CAF50; color: white; border: none;
        padding: 10px 20px; border-radius: 5px; cursor: pointer;
        font-size: 1em; font-weight: bold; transition: transform 0.2s;
    }
    #tutorial-next-btn:hover { transform: scale(1.05); }
    /* END: Tutorial Styles */

    .modal-close-btn {
    position: absolute; 
    top: 10px; 
    right: 20px; 
    font-size: 2.5em;
    font-weight: bold; 
    color: #fff; 
    line-height: 1; 
    cursor: pointer;
    opacity: 0.8; 
    transition: opacity 0.2s;
    text-shadow: 0 0 5px rgba(0,0,0,0.5); 
    
    
    z-index: 9999 !important; 
    pointer-events: auto !important;
}

.modal-close-btn:hover { 
    opacity: 1; 
    transform: scale(1.1); 
}

    #main-menu-buttons {
        display: flex; flex-direction: column; align-items: center;
        width: 100%; max-width: 320px; 
    }

    @media (orientation: landscape) {
        #main-menu-buttons {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
            width: 100%; max-width: 660px;
        }
        #vs-ai-button { order: 1; }
        #shop-button { order: 2; } 
        #online-button { order: 3; }
        #leaderboard-button { order: 4; }
        #game-mode-select .menu-button {
            width: 100%; box-sizing: border-box; margin: 5px 0;
        }
    }

    #online-menu-columns {
        display: flex; flex-direction: column; align-items: center;
        width: 100%; max-width: 320px;
    }
    #online-menu .online-column {
        display: flex; flex-direction: column; align-items: center; width: 100%;
    }
    #online-menu #find-match-button { margin-top: 15px; }

    @media (orientation: landscape) {
        #online-menu { justify-content: center; }
        #online-menu-columns {
            flex-direction: row; justify-content: center; align-items: flex-start;
            gap: 20px; width: 100%; max-width: 680px; margin-top: 15px;
        }
        #online-menu .online-column { flex: 1; }
        #online-column-left { order: 1; }
        #create-game-button { order: 1; }
        #join-game-button { order: 2; }
        #game-id-input { order: 3; display: block; } 
        #online-column-right { order: 2; }
        #find-match-button { order: 1; }
        #online-back-button { order: 2; }
        #online-menu .online-column .menu-button,
        #online-menu .online-column input {
            width: 100%; box-sizing: border-box;
        }
    }

    #game-mode-select { display: none !important; }

    #utility-controls-container {
        position: absolute; top: 50%; left: 10px;
        transform: translateY(-50%); z-index: 000;
        display: flex; flex-direction: column; gap: 8px; pointer-events: all;
    }

    #utility-controls-container .icon-button {
        width: 35px; height: 35px; padding: 0; margin: 0;
    }

    #fullscreen-button, #mute-button, #voice-toggle-button {
        position: relative !important; top: auto !important; right: auto !important;
        transform: none !important; font-size: 1em !important;
    }

    #fullscreen-button svg, #mute-button svg, #voice-toggle-button svg {
        width: 20px; height: 20px;
    }

    #mute-button svg { display: block; }
    #mute-button { font-size: 1em !important; }

    
    @media (max-height: 550px) {
        .modal-overlay h2 { font-size: 1.8em !important; margin-bottom: 8px !important; }
        .modal-overlay .content { padding-top: 15px !important; padding-bottom: 15px !important; }
        #shop-modal p { margin-top: -8px !important; font-size: 0.9em !important; margin-bottom: 8px !important; }
        .modal-coin-display { margin-bottom: 10px !important; font-size: 1em !important; }
    }

    #friends-modal .content { display: flex; flex-direction: column; }
    .friends-lists-wrapper {
        flex-grow: 1; overflow-y: auto; min-height: 100px; padding-top: 10px;
    }

#lobby-buttons-container .lobby-button {
    flex-shrink: 0 !important; 
    white-space: nowrap !important; 
    margin: 0 4px !important; 
    justify-content: flex-start !important; 
    max-width: 90vw !important;   
    scrollbar-width: none; 
    -ms-overflow-style: none;  
}
#lobby-buttons-container::-webkit-scrollbar { 
    display: none; /* Chrome/Safari */
}



@media (max-height: 500px) {
    .menu-button, .lobby-button {
        font-size: 0.7em !important; 
        padding: 8px 12px !important; 
        min-width: auto !important;
        height: 35px !important; 
    }
    
    #lobby-buttons-container {
        bottom: 15px !important;
        padding: 5px 10px !important;
    }
    
   
    .modal-coin-display {
        font-size: 0.9em !important;
        padding: 5px 10px !important;
    }
}



#xp-container {
    
    position: absolute !important;
    bottom: 0px !important; 
    left: 0px !important;
    top: auto !important; 
    
    background-color: rgba(0, 0, 0, 0.8) !important;
    padding: 5px 10px !important;
    border-radius: 15px !important;
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
    
    display: flex !important;
    align-items: center !important;
    gap: 8px !important; 
    white-space: nowrap !important;
    z-index: 20 !important;
}

#xp-level {
    font-size: 0.9em !important;
    font-weight: bold !important;
    margin-right: 0px !important;
    padding-right: 0px !important;
}

#xp-bar-wrapper {
    width: 100px !important; 
    height: 14px !important; 
    background-color: rgba(255, 255, 255, 0.1) !important;
    border: 1px solid rgba(255, 255, 255, 0.3) !important;
}

#xp-text-display-new {
    font-size: 9px !important; 
    line-height: 14px !important;
}


#xp-container {
    position: absolute !important;
    bottom: 5px !important; 
    left: 50% !important;
    transform: translateX(-50%) !important;
    
    
    top: auto !important;
    right: auto !important;
    
    background-color: rgba(20, 20, 35, 0.9) !important;
    padding: 4px 15px !important;
    border-radius: 15px !important;
    border: 1px solid rgba(255, 255, 255, 0.15) !important;
    box-shadow: 0 4px 15px rgba(0,0,0,0.5) !important;
    
    display: flex !important;
    align-items: center !important;
    gap: 10px !important;
    white-space: nowrap !important;
    z-index: 20 !important;
}


#exit-button {
    position: absolute !important;
    top: 15px !important;          
    right: 15px !important;        
    
    bottom: auto !important;       
    left: auto !important;        
    transform: none !important;    
    
    /* Styling */
    background-color: rgba(220, 53, 69, 0.8) !important;
    padding: 8px 16px !important;
    border-radius: 12px !important;
    font-weight: bold !important;
    font-size: 0.85em !important;
    z-index: 100 !important;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3) !important;
}

#exit-button:hover {
    background-color: rgba(220, 53, 69, 1) !important;
    transform: scale(1.05) !important;
}


@media (max-height: 500px) {
    #xp-container {
        bottom: 15px !important; /* Ibaba konti pag landscape */
        padding: 4px 10px !important;
    }
    #exit-button {
        top: 10px !important;
        right: 10px !important;
        padding: 5px 12px !important;
    }
}


#xp-container {
    position: absolute !important;
    bottom: 0px !important;  
    top: auto !important;    
    left: 50% !important;
    transform: translateX(-50%) !important;
    margin-bottom: 2px !important; 
    z-index: 999 !important; 
}


@media (max-height: 550px) {
    #xp-container {
        bottom: 0px !important; 
        padding: 2px 10px !important; 
    }
}


#lobby-rank-card {
    position: absolute !important;
    
    top: 45% !important; 
    left: 50% !important;
    transform: translate(-50%, -50%) !important;
    
    
    right: auto !important;
    bottom: auto !important;

    background: rgba(20, 20, 35, 0.9) !important;
    backdrop-filter: blur(15px) !important;
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
    border-radius: 24px !important; 

    padding: 20px 30px !important; /* Pinalaki ko ang padding para "Bida" tignan */
    display: none; /* JS ang magpapakita */
    flex-direction: row !important;
    align-items: center !important;
    gap: 20px !important;
    
    /* Z-Index: Mataas sa mesa, pero mas mababa sa Modals (Shop/Settings) */
    z-index: 50 !important; 
    
    box-shadow: 0 20px 50px rgba(0,0,0,0.7) !important; /* Malupit na shadow */
    min-width: 280px; /* Mas malapad */
    transition: all 0.3s ease !important;
}

/* Konting animation pag hinover sa gitna */
#lobby-rank-card:hover {
    transform: translate(-50%, -55%) scale(1.05) !important;
    background: rgba(30, 30, 50, 0.95) !important;
    border-color: #FFD700 !important; /* Mag-go-gold ang border pag tinutok */
}

#lobby-rank-icon {
    font-size: 3.5em !important; /* Pinalaki ang emoji */
    filter: drop-shadow(0 4px 8px rgba(0,0,0,0.6));
}

#lobby-rank-name {
    font-family: 'Luckiest Guy', cursive !important;
    font-size: 1.4em !important; /* Mas malaking font */
    color: #FFD700 !important;
    letter-spacing: 1.5px !important;
    line-height: 1;
    margin-bottom: 8px !important;
    text-shadow: 0 2px 4px rgba(0,0,0,0.5);
}

#lobby-trophy-count {
    font-size: 1em !important;
    color: #eee !important;
    margin-bottom: 8px !important;
    font-weight: bold !important;
}

/* Progress Bar Container */
.rank-progress-bg {
    width: 100% !important;
    height: 10px !important; /* Mas makapal na bar */
    background-color: rgba(0, 0, 0, 0.3) !important;
    border-radius: 5px !important;
    overflow: hidden !important;
    border: 1px solid rgba(255,255,255,0.1) !important;
}

/* Green Fill */
#rank-progress-fill {
    height: 100% !important;
    background: linear-gradient(to right, #00b09b, #96c93d) !important;
    width: 0%; 
    transition: width 0.5s ease-out !important;
    box-shadow: 0 0 10px rgba(150, 201, 61, 0.5); /* Glow sa bar */
}

#lobby-buttons-container .lobby-button {
    /* Dark Glass Background */
    background: rgba(30, 30, 40, 0.8) !important;
    background-image: none !important; /* Remove Rainbow/Blue gradients */
    
    /* Border & Text */
    border: 1px solid rgba(255, 255, 255, 0.15) !important;
    color: rgba(255, 255, 255, 0.9) !important;
    
    /* Soft Shadow */
    box-shadow: 0 4px 10px rgba(0,0,0,0.3) !important;
    
    /* Font tweaks */
    font-weight: 700 !important;
    letter-spacing: 1px !important;
}

/* Hover Effect (Mag-go-gold pag tinutok) */
#lobby-buttons-container .lobby-button:hover {
    background: rgba(50, 50, 70, 0.9) !important;
    border-color: #FFD700 !important; /* Gold Border */
    color: #FFD700 !important; /* Gold Text */
    transform: translateY(-3px) scale(1.05) !important;
    box-shadow: 0 8px 20px rgba(0,0,0,0.5), 0 0 10px rgba(255, 215, 0, 0.2) !important;
}

/* Specific Override para sa "Top" (Leaderboard) button para special siya */
#leaderboard-button {
    border-color: rgba(255, 215, 0, 0.5) !important; /* Gold hint */
    color: #FFD700 !important;
}

#lobby-buttons-container #leaderboard-button {
    border: 2px solid #FFD700 !important; /* Ginawang 2px at Solid Gold */
    color: #FFD700 !important; /* Gold na Text */
    
    /* Lagyan ng konting "Gold Tint" sa background para maiba sa iba */
    background: linear-gradient(to bottom, rgba(255, 215, 0, 0.1), rgba(255, 215, 0, 0.05)) !important;
    
    /* Gold Glow */
    box-shadow: 0 0 15px rgba(255, 215, 0, 0.4) !important;
}

/* Pag tinutok ang mouse (Hover) */
#lobby-buttons-container #leaderboard-button:hover {
    background: rgba(255, 215, 0, 0.2) !important;
    box-shadow: 0 0 25px rgba(255, 215, 0, 0.6) !important;
    transform: translateY(-5px) scale(1.1) !important;
}


/* Reset muna natin ang base style para kumagat ang kulay */
#lobby-buttons-container .lobby-button {
    background-image: none !important;
    font-weight: 800 !important;
    letter-spacing: 1px !important;
    border-width: 2px !important; /* Kapalan ang border */
    border-style: solid !important;
    box-shadow: inset 0 0 10px rgba(0,0,0,0.5) !important; /* Inner shadow para lumalim */
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1) !important;
}

/* Hover Effect: Aangat at liliwanag */
#lobby-buttons-container .lobby-button:hover {
    transform: translateY(-5px) scale(1.1) !important;
    filter: brightness(1.2) !important;
}

/* 1. TOP / LEADERBOARD (GOLD üèÜ) */
#leaderboard-button {
    border-color: #FFD700 !important;
    color: #FFD700 !important;
    background: linear-gradient(to bottom, rgba(255, 215, 0, 0.15), rgba(255, 215, 0, 0.05)) !important;
    box-shadow: 0 0 15px rgba(255, 215, 0, 0.4) !important;
}

/* 2. VS AI (SILVER ü•à) */
#vs-ai-button {
    border-color: #C0C0C0 !important; /* Silver */
    color: #E0E0E0 !important;
    background: linear-gradient(to bottom, rgba(192, 192, 192, 0.15), rgba(192, 192, 192, 0.05)) !important;
    box-shadow: 0 0 15px rgba(192, 192, 192, 0.3) !important;
}

/* 3. FRIENDS (BRONZE / ORANGE ü•â) */
#friends-button {
    border-color: #CD7F32 !important; /* Bronze */
    color: #FFAF60 !important; /* Light Orange text */
    background: linear-gradient(to bottom, rgba(205, 127, 50, 0.15), rgba(205, 127, 50, 0.05)) !important;
    box-shadow: 0 0 15px rgba(205, 127, 50, 0.4) !important;
}

/* 4. ONLINE (ELECTRIC BLUE ‚ö°) */
#online-button {
    border-color: #00E5FF !important; /* Cyan */
    color: #00E5FF !important;
    background: linear-gradient(to bottom, rgba(0, 229, 255, 0.15), rgba(0, 229, 255, 0.05)) !important;
    box-shadow: 0 0 15px rgba(0, 229, 255, 0.4) !important;
}

/* 5. SHOP (PURPLE üíé) */
#shop-button {
    border-color: #D500F9 !important; /* Neon Purple */
    color: #E040FB !important;
    background: linear-gradient(to bottom, rgba(213, 0, 249, 0.15), rgba(213, 0, 249, 0.05)) !important;
    box-shadow: 0 0 15px rgba(213, 0, 249, 0.4) !important;
}

/* 6. REWARD (RED üéÅ) */
#daily-reward-button {
    border-color: #FF3D00 !important; /* Bright Red */
    color: #FF6E40 !important;
    background: linear-gradient(to bottom, rgba(255, 61, 0, 0.15), rgba(255, 61, 0, 0.05)) !important;
    box-shadow: 0 0 15px rgba(255, 61, 0, 0.4) !important;
}

#lobby-buttons-container .lobby-button {
    background-image: none !important;
    font-weight: 800 !important;
    letter-spacing: 1px !important;
    border-width: 2px !important; /* Kapalan ang border */
    border-style: solid !important;
    box-shadow: inset 0 0 10px rgba(0,0,0,0.5) !important; /* Inner shadow para lumalim */
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1) !important;
}

/* Hover Effect: Aangat at liliwanag */
#lobby-buttons-container .lobby-button:hover {
    transform: translateY(-5px) scale(1.1) !important;
    filter: brightness(1.2) !important;
}

/* 1. TOP / LEADERBOARD (GOLD üèÜ) */
#leaderboard-button {
    border-color: #FFD700 !important;
    color: #FFD700 !important;
    background: linear-gradient(to bottom, rgba(255, 215, 0, 0.15), rgba(255, 215, 0, 0.05)) !important;
    box-shadow: 0 0 15px rgba(255, 215, 0, 0.4) !important;
}

/* 2. VS AI (SILVER ü•à) */
#vs-ai-button {
    border-color: #C0C0C0 !important; /* Silver */
    color: #E0E0E0 !important;
    background: linear-gradient(to bottom, rgba(192, 192, 192, 0.15), rgba(192, 192, 192, 0.05)) !important;
    box-shadow: 0 0 15px rgba(192, 192, 192, 0.3) !important;
}

/* 3. FRIENDS (BRONZE / ORANGE ü•â) */
#friends-button {
    border-color: #CD7F32 !important; /* Bronze */
    color: #FFAF60 !important; /* Light Orange text */
    background: linear-gradient(to bottom, rgba(205, 127, 50, 0.15), rgba(205, 127, 50, 0.05)) !important;
    box-shadow: 0 0 15px rgba(205, 127, 50, 0.4) !important;
}

/* 4. ONLINE (ELECTRIC BLUE ‚ö°) */
#online-button {
    border-color: #00E5FF !important; /* Cyan */
    color: #00E5FF !important;
    background: linear-gradient(to bottom, rgba(0, 229, 255, 0.15), rgba(0, 229, 255, 0.05)) !important;
    box-shadow: 0 0 15px rgba(0, 229, 255, 0.4) !important;
}

/* 5. SHOP (PURPLE üíé) */
#shop-button {
    border-color: #D500F9 !important; /* Neon Purple */
    color: #E040FB !important;
    background: linear-gradient(to bottom, rgba(213, 0, 249, 0.15), rgba(213, 0, 249, 0.05)) !important;
    box-shadow: 0 0 15px rgba(213, 0, 249, 0.4) !important;
}

/* 6. REWARD (RED üéÅ) */
#daily-reward-button {
    border-color: #FF3D00 !important; /* Bright Red */
    color: #FF6E40 !important;
    background: linear-gradient(to bottom, rgba(255, 61, 0, 0.15), rgba(255, 61, 0, 0.05)) !important;
    box-shadow: 0 0 15px rgba(255, 61, 0, 0.4) !important;
}


/* 1. VS AI (SILVER ü•à) */
#lobby-buttons-container #vs-ai-button {
    border: 2px solid #C0C0C0 !important;
    color: #E0E0E0 !important;
    background: linear-gradient(to bottom, rgba(192, 192, 192, 0.15), rgba(192, 192, 192, 0.05)) !important;
    box-shadow: 0 0 15px rgba(192, 192, 192, 0.3) !important;
}

/* 2. FRIENDS (BRONZE ü•â) */
#lobby-buttons-container #friends-button {
    border: 2px solid #CD7F32 !important;
    color: #FFAF60 !important;
    background: linear-gradient(to bottom, rgba(205, 127, 50, 0.15), rgba(205, 127, 50, 0.05)) !important;
    box-shadow: 0 0 15px rgba(205, 127, 50, 0.4) !important;
}

/* 3. SHOP (PURPLE üíé) */
#lobby-buttons-container #shop-button {
    border: 2px solid #D500F9 !important;
    color: #E040FB !important;
    background: linear-gradient(to bottom, rgba(213, 0, 249, 0.15), rgba(213, 0, 249, 0.05)) !important;
    box-shadow: 0 0 15px rgba(213, 0, 249, 0.4) !important;
}

/* 4. REWARD (RED üéÅ) */
#lobby-buttons-container #daily-reward-button {
    border: 2px solid #FF3D00 !important;
    color: #FF6E40 !important;
    background: linear-gradient(to bottom, rgba(255, 61, 0, 0.15), rgba(255, 61, 0, 0.05)) !important;
    box-shadow: 0 0 15px rgba(255, 61, 0, 0.4) !important;
}

/* 5. ONLINE (BLUE ‚ö°) */
#lobby-buttons-container #online-button {
    border: 2px solid #00E5FF !important;
    color: #00E5FF !important;
    background: linear-gradient(to bottom, rgba(0, 229, 255, 0.15), rgba(0, 229, 255, 0.05)) !important;
    box-shadow: 0 0 15px rgba(0, 229, 255, 0.4) !important;
    opacity: 1 !important; /* Pilitin ipakita */
}

/* 6. LEADERBOARD (GOLD üèÜ) - Uulitin natin dito para sure */
#lobby-buttons-container #leaderboard-button {
    border: 2px solid #FFD700 !important;
    color: #FFD700 !important;
    background: linear-gradient(to bottom, rgba(255, 215, 0, 0.15), rgba(255, 215, 0, 0.05)) !important;
    box-shadow: 0 0 15px rgba(255, 215, 0, 0.4) !important;
}

/* === ONLINE STATUS DOT === */
.status-dot {
    height: 12px;
    width: 12px;
    background-color: #6c757d; /* Gray (Offline) default */
    border-radius: 50%;
    display: inline-block;
    border: 2px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 0 5px rgba(0,0,0,0.5);
    transition: all 0.3s ease;
}

.status-dot.online {
    background-color: #28a745; /* Green (Online) */
    box-shadow: 0 0 8px #28a745; /* Green Glow */
    border-color: #fff;
}

/* === COMBO POPUP STYLE === */
.combo-text {
    position: absolute;
    top: 30%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0);
    font-family: 'Luckiest Guy', cursive;
    font-size: 4em;
    font-weight: bold;
    color: #FFD700;
    text-shadow: 4px 4px 0px #FF0000, 0 0 20px rgba(255, 215, 0, 0.8);
    z-index: 300;
    pointer-events: none;
    opacity: 0;
    animation: comboPop 1.5s ease-out forwards;
    white-space: nowrap;
}

@keyframes comboPop {
    0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
    20% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; } 
    40% { transform: translate(-50%, -50%) scale(1.0); opacity: 1; } 
    80% { transform: translate(-50%, -50%) scale(1.0); opacity: 1; } 
    100% { transform: translate(-50%, -100%) scale(1.5); opacity: 0; } 
}


#shop-modal .content {
    width: 98vw !important;        /* 98% ng lapad ng screen */
    height: 95vh !important;       /* 95% ng taas ng screen */
    max-width: none !important;    /* TANGGALIN ang limit na 900px */
    max-height: none !important;   /* TANGGALIN ang height limit */
    padding: 10px 20px !important; /* Mas manipis na padding */
    border-radius: 20px !important;
}

/* 2. PALIITIN ANG HEADER (Para mas malaki space ng items) */
#shop-modal h2 {
    font-size: 1.8em !important;   /* Paliitin ang "SHOP" title */
    margin: 5px 0 !important;      /* Bawasan ang margin */
}

/* 3. COMPACT TABS & COINS */
#shop-tabs-container {
    margin-bottom: 5px !important; /* Idikit sa taas */
    padding: 2px !important;
}
.modal-coin-display {
    margin-bottom: 10px !important;
    padding: 5px 15px !important;
    font-size: 1em !important;
}

/* 4. GRID LAYOUT (3 ITEMS PER ROW) */
#shop-items-container {
    display: grid !important;
    /* Pilitin magkasya ang marami. 200px min-width para maging 3 cols */
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)) !important; 
    gap: 12px !important;
    padding: 5px !important;
    height: 100% !important;       /* Gamitin ang natitirang height */
    align-content: start;          /* Simula sa taas */
}

/* 5. COMPACT ITEM CARD */
.shop-item {
    padding: 8px !important;
}

.shop-item-preview {
    height: 50px !important;       /* Mas maliit na image height */
    margin-bottom: 5px !important;
}

.shop-item-name {
    font-size: 0.9em !important;   /* Mas maliit na font */
    margin-bottom: 5px !important;
}

.shop-buy-button {
    padding: 4px 8px !important;   
    font-size: 0.8em !important;
}


#utility-controls-container .ui-button {
    position: relative !important; /* Gawing relative para sumunod sa pila */
    top: auto !important;
    left: auto !important;
    transform: none !important;
    margin-bottom: 15px !important; /* Lagyan ng space sa pagitan nila */
}


#utility-controls-container {
    display: flex !important;
    flex-direction: column !important;
    gap: 10px !important;
    top: 50% !important;
    transform: translateY(-50%) !important;
}

#lobby-screen {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: radial-gradient(circle at center, #2b32b2 0%, #141e30 100%); /* Deep Blue Theme */
    display: flex; flex-direction: column; justify-content: space-between;
    z-index: 50; padding: 20px; box-sizing: border-box;
    font-family: 'Nunito', sans-serif;
}


.lobby-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 10px;
}

.profile-section {
    display: flex; align-items: center; gap: 12px;
    background: rgba(255,255,255,0.1); padding: 8px 15px;
    border-radius: 50px; border: 1px solid rgba(255,255,255,0.2);
    backdrop-filter: blur(10px);
}

.avatar-circle {
    width: 40px; height: 40px; background: #ddd; border-radius: 50%;
    display: flex; align-items: center; justify-content: center; font-size: 1.2em;
    border: 2px solid #fff;
}

.profile-details { display: flex; flex-direction: column; }

.player-name-display {
    font-weight: 800; color: #fff; font-size: 1.1em; line-height: 1.1;
}

.level-badge {
    font-size: 0.8em; color: #FFD700; font-weight: bold; text-transform: uppercase;
}

.coin-pill {
    background: rgba(0,0,0,0.5); padding: 8px 20px; border-radius: 50px;
    color: #FFD700; font-weight: bold; font-size: 1.2em; border: 1px solid #FFD700;
    box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
}

/* --- CENTER STAGE (BIG CARDS) --- */
.lobby-main {
    flex-grow: 1; display: flex; gap: 20px;
    justify-content: center; align-items: center;
    padding: 20px;
}

.game-card {
    position: relative; width: 45%; max-width: 300px; height: 200px;
    border-radius: 20px; cursor: pointer; overflow: hidden;
    transition: transform 0.2s, box-shadow 0.2s;
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    text-align: center; border: 2px solid rgba(255,255,255,0.3);
}

.game-card:active { transform: scale(0.95); }

/* ONLINE CARD (Main) */
.primary-card {
    background: linear-gradient(135deg, #00c6ff 0%, #0072ff 100%);
    box-shadow: 0 10px 30px rgba(0, 114, 255, 0.5);
}
.primary-card:hover { box-shadow: 0 15px 40px rgba(0, 114, 255, 0.8); transform: translateY(-5px); border-color: #fff; }

/* AI CARD (Secondary) */
.secondary-card {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    box-shadow: 0 10px 30px rgba(56, 239, 125, 0.4);
}
.secondary-card:hover { box-shadow: 0 15px 40px rgba(56, 239, 125, 0.7); transform: translateY(-5px); border-color: #fff; }

.card-icon { font-size: 3em; margin-bottom: 10px; filter: drop-shadow(0 2px 5px rgba(0,0,0,0.3)); }
.card-title { font-family: 'Luckiest Guy', cursive; font-size: 1.8em; color: #fff; text-shadow: 0 2px 4px rgba(0,0,0,0.5); letter-spacing: 1px; }
.card-subtitle { font-size: 0.9em; color: rgba(255,255,255,0.9); font-weight: bold; text-transform: uppercase; }

/* --- BOTTOM DOCK --- */
.lobby-dock {
    display: flex; justify-content: center; gap: 15px;
    background: rgba(255,255,255,0.1); padding: 15px 25px;
    border-radius: 30px; backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.1);
    align-self: center; margin-bottom: 10px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.dock-item {
    display: flex; flex-direction: column; align-items: center;
    cursor: pointer; padding: 10px; border-radius: 15px;
    transition: all 0.2s; min-width: 70px;
}

.dock-item:hover { background: rgba(255,255,255,0.15); transform: translateY(-5px); }
.dock-item:active { transform: scale(0.9); }

.dock-icon { font-size: 1.8em; margin-bottom: 5px; }
.dock-label { color: #fff; font-size: 0.8em; font-weight: bold; }

/* Special Colors for Dock Items */
#shop-button .dock-icon { filter: drop-shadow(0 0 5px #D500F9); }
#leaderboard-button .dock-icon { filter: drop-shadow(0 0 5px #FFD700); }
#friends-button .dock-icon { filter: drop-shadow(0 0 5px #00E5FF); }
#daily-reward-button .dock-icon { filter: drop-shadow(0 0 5px #FF3D00); }

/* --- RESPONSIVE FIX (Portrait Mode) --- */
@media (orientation: portrait) {
    .lobby-main { flex-direction: column; }
    .game-card { width: 90%; height: 140px; }
}


@media (max-height: 600px) and (orientation: landscape) {
    
    /* 1. COMPRESS CONTAINER & FIX BUG */
    #lobby-screen {
        /* TINANGGAL KO ANG '!important' DITO para makapag-hide siya pag nag-start ang game */
        display: grid; 
        
        padding: 5px 60px !important; /* Dinagdagan ko padding sa gilid para gumitna */
        grid-template-rows: auto 1fr auto !important; /* Header - Cards - Dock */
        gap: 0px !important;
        align-content: center !important; /* Igitna ang buong content vertically */
    }

    /* 2. PALIITIN ANG HEADER */
    .lobby-header {
        padding: 2px !important;
        margin-bottom: 0 !important;
    }
    .profile-section {
        padding: 4px 12px !important;
        transform: scale(0.9); /* Paliitin konti */
        transform-origin: left;
    }
    .avatar-circle {
        width: 30px !important; height: 30px !important; font-size: 1em !important;
    }
    .coin-pill { 
        padding: 4px 12px !important; font-size: 0.8em !important;
        transform: scale(0.9); transform-origin: right;
    }

    /* 3. RESIZE & CENTER CARDS */
    .lobby-main {
        padding: 0 !important;
        gap: 30px !important; /* Distansya ng dalawang card */
        display: flex !important;
        align-items: center !important; /* Gitna Vertically */
        justify-content: center !important; /* Gitna Horizontally */
        width: 100% !important;
    }

    .game-card {
        height: 140px !important; /* Tamang height sa landscape */
        width: 220px !important;  /* Fixed width para pantay */
        max-width: 35vw !important;
        margin: 0 !important;
    }

    .card-icon { font-size: 1.5em !important; margin-bottom: 2px !important; }
    .card-title { font-size: 1.2em !important; }
    .card-subtitle { font-size: 0.6em !important; }

    /* 4. COMPACT DOCK */
    .lobby-dock {
        padding: 4px 20px !important;
        border-radius: 15px !important;
        margin-bottom: 2px !important;
        gap: 15px !important;
        transform: scale(0.9); /* Paliitin buong dock */
    }

    .dock-item {
        padding: 2px 5px !important;
        min-width: 50px !important;
    }
    .dock-icon { font-size: 1.2em !important; margin-bottom: 0px !important; }
    .dock-label { font-size: 0.6em !important; }
}

#player-info, #opponent-info {
    position: absolute;
    top: 10px !important;
    
    height: 28px !important; 
    
    width: auto !important;
    min-width: auto !important;
    max-width: 200px !important;
    
    display: inline-flex !important;
    align-items: center !important;
    gap: 6px !important; 
    
    background: rgba(20, 20, 35, 0.9) !important;
    backdrop-filter: blur(4px);
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
    border-radius: 50px !important;
    
    color: white !important;
    font-family: 'Nunito', sans-serif !important;
    box-shadow: 0 2px 5px rgba(0,0,0,0.4) !important; /* Pinaliit shadow */
    z-index: 20 !important;
    
    pointer-events: auto !important;
    cursor: pointer !important;
    transition: transform 0.3s ease-out;
}


#player-info {
    left: 120px !important;
    flex-direction: row !important;
    padding: 0 12px 0 3px !important; /* Adjusted padding para sa nipis */
}


#opponent-info {
    right: 120px !important;
    flex-direction: row-reverse !important;
    padding: 0 3px 0 12px !important; /* Adjusted padding para sa nipis */
}


#player-info .hud-details, #opponent-info .hud-details {
    display: flex !important;
    flex-direction: column !important;
    justify-content: center !important;
    
    line-height: 0.9 !important; /* Dikit-dikit na ang lines */
}

#player-info .hud-details { align-items: flex-start !important; }
#opponent-info .hud-details { align-items: flex-end !important; text-align: right !important; }


.hud-avatar {
   
    width: 24px !important;  /* Dati 28px */
    height: 24px !important; /* Dati 28px */
    font-size: 14px !important; /* Dati 16px */
    
    border-radius: 50%;
    background: #333;
    border: 1px solid rgba(255,255,255,0.4);
    display: flex; justify-content: center; align-items: center;
    flex-shrink: 0;
}

.hud-name {
 
    font-size: 10px !important; /* Dati 12px */
    
    font-weight: 800 !important;
    margin: 0 !important;
    white-space: nowrap !important;
}

.hud-sub {

    font-size: 8px !important; /* Dati 9px */
    
    font-weight: 700 !important;
    opacity: 0.9 !important;
    margin-top: 0px !important; /* Wala nang space sa pagitan */
}


@media (max-height: 500px) and (orientation: landscape) {
    #player-info { left: 180px !important; top: 10px !important; }
    #opponent-info { right: 190px !important; top: 10px !important; }
}
.flying-coin-particle {
    position: fixed;
    font-size: 24px; /* Laki ng coin */
    pointer-events: none; /* Para hindi nakaka-block ng click */
    z-index: 1000; /* Nasa ibabaw ng lahat */
    transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.27), opacity 0.8s ease-in;
    text-shadow: 0 2px 5px rgba(0,0,0,0.5);
}

/* 2. Animation ng Coins Display (Yung lalaki-liliit) */
@keyframes coinPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.3); color: #00FF00; filter: drop-shadow(0 0 10px #00FF00); }
    100% { transform: scale(1); }
}

@keyframes coinShake {
    0% { transform: translateX(0); }
    25% { transform: translateX(-5px); color: #FF0000; }
    50% { transform: translateX(5px); color: #FF0000; }
    75% { transform: translateX(-5px); }
    100% { transform: translateX(0); }
}

/* Class na ia-add natin sa JS pag nanalo */
.hud-bump-win {
    animation: coinPulse 0.3s ease-out;
}

/* Class na ia-add natin sa JS pag nabawasan */
.hud-shake-loss {
    animation: coinShake 0.4s ease-in-out;
}

#winner-modal {
    background-color: rgba(0, 0, 0, 0.85) !important; /* Mas madilim para focused */
    backdrop-filter: blur(5px) !important;
    z-index: 9999 !important;
    display: flex !important;
    justify-content: center;
    align-items: center;
}

/* 2. Container ng Laman (Text + Cards + Buttons) */
.winner-modal-content-wrapper {
    background: transparent !important;
    border: none !important;
    box-shadow: none !important;
    
    /* GAGAWING COLUMN PARA HINDI MAGPATONG */
    display: flex !important;
    flex-direction: column !important; 
    justify-content: center !important;
    align-items: center !important;
    
    width: 100% !important;
    height: auto !important;
    max-height: 90vh !important;
    padding: 20px !important;
    gap: 20px !important; /* Espasyo sa pagitan ng elements */
}

/* 3. Ang Text (You Win / You Lose) */
#winner-text {
    font-family: 'Luckiest Guy', cursive !important;
    font-size: 4em !important; /* Fixed size na malaki */
    line-height: 1.1 !important;
    margin: 0 !important;
    text-align: center !important;
    
    /* Reset Positioning */
    position: relative !important;
    transform: none !important;
    top: auto !important;
    left: auto !important;
    
    /* Effects */
    text-shadow: 4px 4px 0 #000, 0 0 30px rgba(0,0,0,0.8) !important;
    z-index: 10001 !important;
    
    /* Animation: Pop In */
    animation: winnerPop 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.27) forwards !important;
}

/* 4. Container ng Cards o Score (Poker/61 Ball) */
#opponent-hand-reveal {
    margin: 10px 0 !important;
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    justify-content: center !important;
    transform: scale(1.1); /* Pinalaki konti para kita */
}

/* 5. Container ng Buttons */
.winner-text-and-buttons {
    /* Reset Positioning */
    position: relative !important;
    bottom: auto !important;
    left: auto !important;
    width: auto !important;
    
    display: flex !important;
    flex-direction: column !important; /* Gawing pababa ang buttons */
    gap: 15px !important;
    margin-top: 20px !important;
    
    z-index: 10002 !important;
}

/* Style ng Buttons */
.winner-text-and-buttons button {
    font-family: 'Nunito', sans-serif !important;
    font-weight: 800 !important;
    font-size: 1.2em !important;
    padding: 12px 40px !important;
    border-radius: 50px !important;
    box-shadow: 0 5px 15px rgba(0,0,0,0.5) !important;
    border: 2px solid rgba(255,255,255,0.2) !important;
    cursor: pointer !important;
    text-transform: uppercase !important;
    letter-spacing: 1px !important;
    min-width: 200px !important;
    transition: transform 0.2s !important;
}

.winner-text-and-buttons button:hover {
    transform: scale(1.05) !important;
}

/* Animation Keyframes */
@keyframes winnerPop {
    0% { transform: scale(0); opacity: 0; }
    80% { transform: scale(1.1); opacity: 1; }
    100% { transform: scale(1); opacity: 1; }
}

/* Landscape Mobile Fix */
@media (max-height: 500px) {
    #winner-text { font-size: 2.5em !important; }
    .winner-modal-content-wrapper { flex-direction: row !important; gap: 40px !important; } /* Magkatabi pag landscape */
    .winner-text-and-buttons { margin-top: 0 !important; }
    #opponent-hand-reveal { transform: scale(0.9); }
}

/* 1. Ang Outer Overlay (Ang tumatakip sa screen) */
#winner-modal {
    /* Gawing halos invisible (0.1 lang ang dilim) */
    background-color: rgba(0, 0, 0, 0.1) !important; 
    
    /* Siguraduhing walang blur */
    backdrop-filter: none !important; 
    -webkit-backdrop-filter: none !important;
}

/* 2. Ang Inner Box/Wrapper (Dito madalas naiiwan ang kulay) */
#winner-modal .winner-modal-content-wrapper {
    /* Tanggalin ang background, border, at shadow */
    background: transparent !important;
    background-color: rgba(0,0,0,0) !important;
    box-shadow: none !important;
    border: none !important;
    
    /* Siguraduhing nasa gitna pa rin */
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    justify-content: center !important;
    width: 100% !important;
    height: 100% !important;
}

/* 3. Siguraduhin na walang ibang 'content' class na sumasapaw */
#winner-modal .content {
    background: transparent !important;
    border: none !important;
    box-shadow: none !important;
}

@media (max-height: 600px) and (orientation: landscape) {
    
    /* 1. gawing magkatabi (Row) imbes na patong-patong (Column) */
    #winner-modal .winner-modal-content-wrapper {
        flex-direction: row !important; /* Side-by-side layout */
        align-items: center !important;
        justify-content: center !important;
        gap: 30px !important; /* Space sa pagitan ng kaliwa at kanan */
        padding: 10px 40px !important;
        width: 90% !important;
    }

    /* 2. Ayusin ang Kaliwang Side (Text & Buttons) */
    .winner-text-and-buttons {
        width: 45% !important; /* Kalahati ng screen */
        display: flex !important;
        flex-direction: column !important;
        align-items: center !important;
        justify-content: center !important;
        margin: 0 !important;
        order: 1; /* Nasa kaliwa */
    }

    /* 3. Ayusin ang Kanang Side (Cards) */
    #opponent-hand-reveal {
        width: 55% !important; /* Kalahati ng screen */
        display: flex !important;
        flex-direction: column !important;
        align-items: center !important;
        justify-content: center !important;
        margin: 0 !important;
        order: 2; /* Nasa kanan */
        
        /* I-shrink ng konti para magkasya lahat */
        transform: scale(0.85) !important; 
    }

    /* 4. Paliitin ang Title at Buttons para hindi masikip */
    #winner-text {
        font-size: 2.5em !important; /* Mas maliit na title */
        margin-bottom: 10px !important;
        line-height: 1 !important;
    }

    .winner-text-and-buttons button {
        font-size: 0.9em !important; /* Mas maliit na buttons */
        padding: 8px 20px !important;
        min-width: 160px !important;
        margin: 4px 0 !important;
        height: auto !important;
    }
}

#ai-menu, 
#online-game-select, 
#online-menu {
    
    background-color: rgba(0, 0, 0, 0.5) !important; 
    
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
    
  
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    justify-content: center !important;
}


#ai-menu h2, 
#online-game-select h2, 
#online-menu h2 {
    text-shadow: 2px 2px 4px #000000 !important;
    filter: drop-shadow(0 0 10px rgba(0,0,0,0.8));
}


#ai-menu h2, 
#online-game-select h2, 
#online-menu h2,
#invite-game-select h2 {
    
    font-family: 'Luckiest Guy', cursive !important;
    
    /* 2. Palakihin at kulayan ng Gold */
    font-size: 3.5em !important;
    color: #FFD700 !important; 
    
    
    text-shadow: 4px 4px 0 #000, 0 0 20px rgba(255, 215, 0, 0.5) !important;
    
    
    margin-bottom: 20px !important;
    text-transform: uppercase !important;
    letter-spacing: 2px !important;
    line-height: 1 !important;
}


@media (max-height: 500px) {
    #ai-menu h2, 
    #online-game-select h2, 
    #online-menu h2,
    #invite-game-select h2 {
        font-size: 2.2em !important; 
        margin-bottom: 10px !important;
    }
}

/* 1. Shop Modal Overlay */
#shop-modal {
    background-color: rgba(0, 0, 0, 0.6) !important; /* Dark dim */
    backdrop-filter: blur(8px) !important; /* Blur sa likod para focus sa tinda */
}

/* 2. Shop Main Container (Ang Kahon) */
#shop-modal .content {
    background: rgba(20, 20, 25, 0.95) !important; /* Halos solid black */
    border: 1px solid rgba(255, 215, 0, 0.3) !important; /* Gold Border */
    box-shadow: 0 0 50px rgba(0,0,0,0.8), inset 0 0 20px rgba(0,0,0,0.5) !important;
    border-radius: 20px !important;
}

/* 3. Shop Title (SHOP) */
#shop-modal h2 {
    font-family: 'Luckiest Guy', cursive !important;
    font-size: 3em !important;
    color: #FFD700 !important;
    text-shadow: 4px 4px 0 #000, 0 0 20px rgba(255, 215, 0, 0.6) !important;
    margin-bottom: 5px !important;
    text-transform: uppercase;
    letter-spacing: 2px;
}

/* 4. Item Cards (Ang mga paninda) */
.shop-item {
    /* Dark Glass Effect */
    background: linear-gradient(145deg, rgba(255,255,255,0.05), rgba(255,255,255,0.01)) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    border-radius: 15px !important;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3) !important;
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1) !important;
    position: relative;
    overflow: hidden;
}

/* Hover Effect: Aangat at maggo-gold ang gilid */
.shop-item:hover {
    transform: translateY(-5px) scale(1.02) !important;
    border-color: rgba(255, 215, 0, 0.6) !important; /* Gold Glow */
    box-shadow: 0 10px 30px rgba(0,0,0,0.5), 0 0 15px rgba(255, 215, 0, 0.2) !important;
    background: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(255,255,255,0.02)) !important;
}

/* 5. Item Name */
.shop-item-name {
    color: #fff !important;
    font-weight: 800 !important;
    font-size: 1em !important;
    text-shadow: 0 2px 4px rgba(0,0,0,0.8);
    margin-top: 5px;
}

/* 6. Tabs (Cues, Tables, etc.) */
#shop-tabs-container button {
    background: transparent !important;
    border: 2px solid rgba(255,255,255,0.2) !important;
    color: #aaa !important;
    box-shadow: none !important;
    transform: none !important;
}

/* Active/Hover Tab style */
#shop-tabs-container button:hover,
#shop-tabs-container button:focus {
    border-color: #FFD700 !important;
    color: #FFD700 !important;
    background: rgba(255, 215, 0, 0.1) !important;
}

/* 7. Stats Bar Enhancements */
.stat-bar-background {
    background-color: rgba(0,0,0,0.6) !important;
    border: 1px solid rgba(255,255,255,0.1) !important;
}


/* 1. I-force ang Grid Layout sa Container para hindi dikit-dikit */
#shop-items-container {
    display: grid !important;
    /* Pilitin na 2 items per row sa mobile, 3-4 sa malaki */
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)) !important; 
    gap: 15px !important;
    padding: 10px !important;
}

/* 2. Ayusin ang Card Layout (Ibalik ang laki) */
.shop-item {
    display: flex !important;
    flex-direction: column !important;
    justify-content: space-between !important;
    align-items: center !important;
    
    /* IMPORTANTE: Bigyan ng minimum height para hindi ma-squash */
    min-height: 220px !important; 
    padding: 15px !important;
}

/* 3. Palitawin ang Preview Image (Tako) */
.shop-item-preview {
    display: block !important;
    width: 100% !important;
    /* Bigyan ng fixed height ang image area */
    height: 100px !important; 
    
    /* Lagyan ng konting liwanag sa likod ng image para makita ang tako */
    background-color: rgba(255, 255, 255, 0.05) !important; 
    border-radius: 10px;
    margin-bottom: 10px !important;
    
    /* Siguraduhing hindi ma-crop */
    background-size: contain !important;
    background-repeat: no-repeat !important;
    background-position: center !important;
    flex-shrink: 0 !important;
}

/* 4. Siguraduhing kita ang Buy/Equip Button */
.shop-buy-button {
    display: block !important;
    width: 100% !important;
    margin-top: auto !important; /* Itulak sa pinakababa */
    position: relative !important;
    z-index: 10 !important;
}

/* 5. Ayusin ang Title ng Item */
.shop-item-name {
    font-size: 0.9em !important;
    margin-bottom: 10px !important;
    text-align: center;
    height: auto !important;
}

.shop-item {
    /* Tinaasan ko from 220px to 270px */
    min-height: 270px !important; 
    
    /* Siguraduhing may space sa ilalim */
    padding-bottom: 20px !important; 
    justify-content: flex-start !important; /* Ayusin ang alignment */
    gap: 10px !important; /* Space sa pagitan ng elements */
}

/* 2. Paliitin konti ang Image (Para di siksikan) */
.shop-item-preview {
    height: 80px !important; /* Dati 100px, ginawang 80px */
    flex-shrink: 0 !important;
    margin-bottom: 5px !important;
}

/* 3. Ayusin ang Stats Container */
.shop-item-stats {
    margin-bottom: 10px !important;
    flex-shrink: 0 !important;
}

/* 4. Button Spacing (Iangat konti) */
.shop-buy-button {
    margin-top: auto !important; /* Itulak sa baba pero pasok sa padding */
    margin-bottom: 5px !important;
    width: 90% !important; /* Mas magandang tignan kung di sagad sa gilid */
    align-self: center !important;
}


.shop-item {
    display: flex !important;
    flex-direction: column !important;
    justify-content: flex-start !important; /* Magsimula sa taas */
    align-items: center !important;
    
    height: auto !important;      /* Hayaang humaba base sa laman */
    min-height: 200px !important; /* Minimum size para pantay */
    padding: 10px !important;
    gap: 8px !important;          /* Space sa pagitan ng elements */
}

/* 2. Image Preview: Fixed Size pero Visible */
.shop-item-preview {
    width: 100% !important;
    height: 80px !important;      /* Saktong height lang */
    min-height: 80px !important;  /* Para di mawala kahit walang image */
    background-color: rgba(255, 255, 255, 0.05) !important;
    border-radius: 8px;
    margin-bottom: 5px !important;
    flex-shrink: 0 !important;    /* BAWAL lumiliit */
}

/* 3. Name: Visible at Bold */
.shop-item-name {
    font-size: 0.9em !important;
    font-weight: bold !important;
    color: white !important;
    text-align: center !important;
    margin: 5px 0 !important;
    min-height: 1.2em !important; /* Siguraduhing may space para sa text */
    flex-shrink: 0 !important;
}

/* 4. Button: Laging Nasa Baba */
.shop-buy-button {
    margin-top: auto !important; /* Itulak sa pinakababa ng card */
    width: 100% !important;
    padding: 8px 0 !important;
    font-size: 0.85em !important;
    flex-shrink: 0 !important;
}

/* 5. Stats (Kung Meron): Gitna */
.shop-item-stats {
    width: 100% !important;
    margin-bottom: 5px !important;
    flex-shrink: 0 !important;
}

.shop-item {
    height: auto !important;       /* Hayaang mag-adjust base sa laman */
    min-height: 240px !important;  /* Tinaasan ko ang minimum height para safe */
    overflow: visible !important;  /* Siguraduhing walang nakatago */
    padding-bottom: 15px !important; /* Space sa ilalim para sa button */
}

/* 2. Stats Container (Ang salarin sa Cues): Bawal lumiit */
.shop-item-stats {
    flex-shrink: 0 !important; /* Bawal ma-squash */
    margin-bottom: 10px !important;
    width: 100% !important;
    display: flex !important;
    flex-direction: column !important;
}

/* 3. Button: Bawal mawala, bawal lumiit */
.shop-buy-button {
    flex-shrink: 0 !important; /* BAWAL I-SHRINK */
    margin-top: auto !important; /* Itulak sa pinaka-ilalim pero visible */
    position: relative !important; 
    z-index: 50 !important; /* Siguraduhing nasa ibabaw */
    display: block !important;
    opacity: 1 !important;
}

/* 4. Image: Slight adjustment para balanced */
.shop-item-preview {
    min-height: 70px !important; /* Liitan konti ang picture para sa space */
    height: 70px !important;
}

@media (max-height: 600px) and (orientation: landscape) {
    
    /* 1. Baguhin ang Main Container: Gawing Grid (2 Columns) */
    #shop-modal .content {
        display: grid !important;
        /* Column 1: 220px (Sidebar), Column 2: The Rest (Items) */
        grid-template-columns: 220px 1fr !important; 
        grid-template-rows: auto auto 1fr !important; /* Rows auto-adjust */
        gap: 10px 20px !important; /* Space sa pagitan */
        
        width: 95vw !important; /* Sagad sa lapad */
        height: 90vh !important; /* Sagad sa taas */
        max-height: none !important;
        padding: 20px !important;
        align-items: start !important; /* Start from top */
    }

  
    #shop-modal h2 {
        grid-column: 1 !important;
        grid-row: 1 !important;
        font-size: 2.5em !important;
        text-align: center !important;
        margin-top: 20px !important;
    }

    /* Subtitle "Buy new cue..." (Pwede itago o paliitin) */
    #shop-modal p {
        grid-column: 1 !important;
        grid-row: 2 !important;
        font-size: 0.8em !important;
        text-align: center !important;
        opacity: 0.7;
    }

    /* "Your Coins" Display */
    .modal-coin-display {
        grid-column: 1 !important;
        grid-row: 3 !important;
        margin-top: 10px !important;
        font-size: 1.2em !important;
        text-align: center !important;
        /* Center container manually if needed */
        justify-self: center !important; 
        width: 90% !important;
    }

    
    #shop-tabs-container {
        grid-column: 2 !important;
        grid-row: 1 !important; /* Nasa taas ng right side */
        justify-self: start !important; /* Start sa kaliwa ng column */
        margin-bottom: 0 !important;
        padding-top: 10px !important;
    }

    /* Items Container (Ang Grid ng Paninda) */
    #shop-items-container {
        grid-column: 2 !important;
        grid-row: 2 / span 3 !important; /* Sakupin ang natitirang rows */
        
        height: 70vh !important; /* Fixed height para ito lang ang mag-scroll */
        overflow-y: auto !important; /* Scrollable area */
        
        /* Grid ng items: 3-4 items per row */
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)) !important;
        padding-right: 10px !important; /* Space para sa scrollbar */
    }

    /* Item Card Tweak para sa Layout na 'to */
    .shop-item {
        min-height: 220px !important; /* Balik sa saktong height */
    }
    
    /* Ayusin ang Close Button para hindi harang */
    #shop-close-btn {
        top: 10px !important;
        right: 15px !important;
        z-index: 100 !important;
    }
}


#poker-foul-card-pick-modal {
    /* Semi-transparent black (0.6 opacity) */
    background-color: rgba(0, 0, 0, 0.6) !important;
    
    /* Tanggalin ang blur para malinaw ang mesa */
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
    
    /* Gitna */
    display: flex !important;
    flex-direction: column !important;
    justify-content: center !important;
    align-items: center !important;
}

/* 2. Pagandahin ang Title ("Foul! Pick a card.") */
#poker-foul-card-pick-modal h2 {
    font-family: 'Luckiest Guy', cursive !important;
    font-size: 3em !important;
    color: #FFD700 !important; /* Gold */
    
    /* Makapal na Outline + Glow */
    text-shadow: 4px 4px 0 #000, 0 0 20px rgba(255, 215, 0, 0.6) !important;
    
    margin-bottom: 40px !important; /* Space sa pagitan ng title at baraha */
    text-transform: uppercase !important;
    letter-spacing: 2px !important;
    text-align: center !important;
}

/* 3. Ayusin ang Container ng Cards */
#poker-foul-cards {
    display: flex !important;
    gap: 20px !important; /* Space sa pagitan ng cards */
    justify-content: center !important;
    align-items: center !important;
    flex-wrap: wrap !important;
}

/* 4. Palakihin ang Cards habang pumipili (Animation) */
#poker-foul-cards .card {
    transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.27) !important;
    box-shadow: 0 10px 20px rgba(0,0,0,0.5) !important;
    cursor: pointer !important;
}

/* Hover Effect: Aangat ang card pag tinutok */
#poker-foul-cards .card:hover {
    transform: translateY(-20px) scale(1.2) !important;
    z-index: 100 !important;
    box-shadow: 0 20px 40px rgba(0,0,0,0.8) !important;
    border: 2px solid #FFD700 !important; /* Gold border pag hover */
}

/* Landscape Mobile Fix */
@media (max-height: 500px) {
    #poker-foul-card-pick-modal h2 {
        font-size: 2em !important;
        margin-bottom: 15px !important;
    }
    #poker-foul-cards .card {
        transform: scale(0.8); /* Paliitin konti sa landscape */
    }
    #poker-foul-cards .card:hover {
        transform: translateY(-10px) scale(1.0) !important;
    }
}

#poker-foul-cards {
    display: flex !important;
    justify-content: center !important;
    align-items: center !important;
    flex-wrap: wrap !important;
    
    /* Dati 20px, ngayon 5px na lang para dikit-dikit */
    gap: 5px !important; 
    
    margin-top: 10px !important;
}

/* 2. Cards: Lakihan ang size */
#poker-foul-cards .card {
    /* Pinalaki ang sukat (Dati maliit lang ito) */
    width: 60px !important; 
    height: 90px !important;
    
    /* Ayusin ang font size sa loob */
    font-size: 1.1em !important;
    
    cursor: pointer !important;
    transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.27) !important;
    box-shadow: 0 5px 15px rgba(0,0,0,0.5) !important;
}

/* 3. Rank at Suit Sizes (Lakihan din) */
#poker-foul-cards .card-rank { font-size: 1.2em !important; }
#poker-foul-cards .card-suit { font-size: 1em !important; }

/* 4. Hover Effect (Aangat pag tinuro) */
#poker-foul-cards .card:hover {
    /* Aangat at liliwanag ang border */
    transform: translateY(-15px) scale(1.1) !important;
    z-index: 100 !important;
    border: 2px solid #FFD700 !important; /* Gold border */
    box-shadow: 0 0 20px rgba(255, 215, 0, 0.5) !important; /* Gold glow */
}

/* 5. Landscape Fix (Para hindi sumakop masyado sa height) */
@media (max-height: 500px) {
    #poker-foul-cards .card {
        width: 50px !important;  /* Paliitin konti pag landscape */
        height: 75px !important;
    }
}

#online-menu, 
#online-game-select, 
#invite-game-select {
    /* 1. Tinted Black (0.7 Opacity) - Mas madilim konti para mabasa ang taya */
    background-color: rgba(0, 0, 0, 0.75) !important; 
    
    /* 2. Tanggalin ang Blur para malinaw ang mesa */
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
    
    /* 3. Border & Shadow para lutang */
    border: 1px solid rgba(255, 215, 0, 0.3) !important; /* Gold border */
    box-shadow: 0 0 40px rgba(0, 0, 0, 0.8) !important; /* Deep shadow */
    border-radius: 20px !important;
}

/* Siguraduhing ang "Current Pot" text ay lutang */
#bet-status-text, 
#invite-bet-status {
    background-color: rgba(0, 0, 0, 0.5); /* Konting background sa text */
    padding: 10px 20px;
    border-radius: 50px;
    border: 1px solid rgba(255, 215, 0, 0.2);
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

/* 1. Targetin ang mga buttons sa AI, Online Select, at Invite Select */
#ai-menu .menu-button,
#online-game-select .menu-button,
#invite-game-select .menu-button {
    /* Palakihin at Patabain */
    width: 85% !important;        /* Mas malapad */
    padding: 18px 20px !important; /* Mas mataba */
    font-size: 1.3em !important;   /* Mas malaking text */
    
    /* Ihiwalay sa isa't isa */
    margin: 12px 0 !important;     
    
    /* Ayusin ang Icon at Text alignment */
    display: flex !important;
    align-items: center !important;
    justify-content: flex-start !important; /* Start sa kaliwa para pantay */
    padding-left: 40px !important; /* Space sa kaliwa */
    gap: 20px !important; /* Layo ng Icon sa Text */
    
    /* Lagyan ng border radius na mas bilog */
    border-radius: 50px !important;
    
    /* Shadow para lutang */
    box-shadow: 0 10px 20px rgba(0,0,0,0.4) !important;
    transition: transform 0.2s !important;
}

/* Hover Effect */
#ai-menu .menu-button:hover,
#online-game-select .menu-button:hover,
#invite-game-select .menu-button:hover {
    transform: scale(1.05) !important;
    filter: brightness(1.2);
}

/* ------------------------------------------- */
/* --- ADD ICONS AUTOMATICALLY (CSS Magic) --- */
/* ------------------------------------------- */

/* 2. POKER BUTTONS (Joker Icon) */
#ai-poker-button::before, 
#online-poker-button::before,
#invite-poker-button::before {
    content: 'üÉè'; 
    font-size: 1.5em;
    filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5));
}

/* 3. STRAIGHT BALL BUTTONS (Billiards 8 Icon) */
#ai-straight-ball-button::before,
#online-straight-ball-button::before,
#invite-straight-ball-button::before {
    content: 'üé±';
    font-size: 1.5em;
    filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5));
}

/* 4. 61 BALL BUTTONS (Numbers Icon) */
#ai-61-button::before,
#online-61-button::before,
#invite-61-button::before {
    content: 'üî¢';
    font-size: 1.5em;
    filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5));
}

@media (max-height: 500px) {
    #ai-menu .menu-button,
    #online-game-select .menu-button,
    #invite-game-select .menu-button {
        padding: 10px 20px !important; /* Paliitin ang taba */
        font-size: 1em !important;     /* Paliitin ang text */
        margin: 5px 0 !important;      /* Pagdikitin konti */
        width: 60% !important;         /* Paliitin ang lapad para di sakop ang screen */
    }
}

#ai-menu .menu-button,
#online-game-select .menu-button,
#invite-game-select .menu-button {
    /* 1. LIITAN ANG LAPAD (Sagot sa 'Mahaba sa landscape') */
    width: 100% !important;
    max-width: 350px !important; /* Limitahan ang haba para hindi "sausage" */
    
    /* 2. PRO STYLE: Dark background na may Gold border */
    /* Tinanggal ang purple, pinalitan ng Dark Gray/Black gradient */
    background: linear-gradient(145deg, #2b2b2b, #1a1a1a) !important;
    border: 2px solid #FFD700 !important; /* Gold Border */
    color: #FFD700 !important; /* Gold Text */
    
    /* 3. Shape & Spacing */
    border-radius: 15px !important; /* Semi-rounded (Mas modern) */
    padding: 15px 25px !important;
    margin: 10px auto !important; /* 'auto' sa gilid para GUMITNA */
    
    /* 4. Font Styling */
    font-family: 'Nunito', sans-serif !important;
    font-weight: 800 !important;
    font-size: 1.2em !important;
    text-transform: uppercase;
    letter-spacing: 1px;
    
    /* 5. Layout ng Icon at Text */
    display: flex !important;
    align-items: center !important;
    justify-content: flex-start !important; /* Kaliwa ang alignment ng laman */
    gap: 20px !important; /* Space sa pagitan ng Icon at Text */
    
    /* Shadow */
    box-shadow: 0 5px 15px rgba(0,0,0,0.5) !important;
    transition: all 0.2s ease !important;
}

/* Hover Effect: Liliwanag at Aangat */
#ai-menu .menu-button:hover,
#online-game-select .menu-button:hover,
#invite-game-select .menu-button:hover {
    transform: translateY(-3px) scale(1.02) !important;
    background: linear-gradient(145deg, #444, #222) !important;
    box-shadow: 0 0 20px rgba(255, 215, 0, 0.4) !important; /* Gold Glow */
    border-color: #FFF !important; /* White border pag tinutok */
    color: #FFF !important;
}

/* Ayusin ang Icons (Para pantay-pantay) */
#ai-menu .menu-button::before,
#online-game-select .menu-button::before,
#invite-game-select .menu-button::before {
    font-size: 1.8em !important; 
    min-width: 40px !important; /* Fixed width para aligned ang text */
    text-align: center;
    filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5));
}

/* SPECIAL LANDSCAPE FIX (Para sa maliliit na screen) */
@media (max-height: 500px) {
    #ai-menu .menu-button,
    #online-game-select .menu-button,
    #invite-game-select .menu-button {
        padding: 8px 20px !important; /* Mas manipis */
        margin: 6px auto !important;  /* Mas dikit */
        font-size: 1em !important;    /* Mas maliit na text */
        max-width: 300px !important;  /* Mas maiksi pa */
    }
}

/* 1. Ang Button Box (Ang lalagyan ng Text) */
#ai-menu .menu-button,
#online-game-select .menu-button,
#invite-game-select .menu-button {
    /* -- HABA at LAKI -- */
    width: fit-content !important;  /* Base sa haba ng text */
    min-width: 200px !important;    /* Minimum na haba para di sobrang liit sa "POKER" */
    padding: 15px 40px !important;  /* "Mataba" na padding */
    
    /* -- POSITIONING -- */
    position: relative !important;  /* Para ma-anchor ang icon */
    overflow: visible !important;   /* IMPORTANTE: Para lumabas ang icon */
    margin: 15px auto !important;   /* Igitna ang button */
    
    /* -- STYLE -- */
    background: linear-gradient(145deg, #2b2b2b, #1a1a1a) !important;
    border: 2px solid #FFD700 !important;
    border-radius: 12px !important; /* Semi-rounded lang */
    
    /* -- TEXT -- */
    display: flex !important;
    justify-content: center !important;
    text-align: center !important;
    
    /* I-usog konti pakanan para balance sa mata dahil may icon sa kaliwa */
    transform: translateX(20px); 
}

/* 2. Ang Icon (Floating sa Labas) */
#ai-menu .menu-button::before,
#online-game-select .menu-button::before,
#invite-game-select .menu-button::before {
    position: absolute !important;
    
    /* ILABAS SA KALIWA */
    left: -70px !important; 
    top: 50% !important;
    transform: translateY(-50%) !important; /* Gitna vertical */
    
    /* LAKI NG ICON */
    font-size: 2.8em !important; 
    filter: drop-shadow(0 5px 5px rgba(0,0,0,0.8)); /* Malupit na shadow */
    
    /* Reset */
    margin: 0 !important;
    width: auto !important;
}

/* 3. Siguraduhing tama ang icons */
#ai-poker-button::before, #online-poker-button::before, #invite-poker-button::before { content: 'üÉè'; }
#ai-straight-ball-button::before, #online-straight-ball-button::before, #invite-straight-ball-button::before { content: 'üé±'; }
#ai-61-button::before, #online-61-button::before, #invite-61-button::before { content: 'üî¢'; }

/* 4. Hover Effect */
#ai-menu .menu-button:hover,
#online-game-select .menu-button:hover,
#invite-game-select .menu-button:hover {
    transform: translateX(20px) scale(1.05) !important; /* Aangat pero stay sa pwesto */
    background: linear-gradient(145deg, #444, #222) !important;
    border-color: #FFF !important;
    box-shadow: 0 0 20px rgba(255, 215, 0, 0.4) !important;
}

/* 5. Landscape Mobile Fix (Paliitin konti pag nakahiga) */
@media (max-height: 500px) {
    #ai-menu .menu-button,
    #online-game-select .menu-button,
    #invite-game-select .menu-button {
        padding: 10px 30px !important; /* Bawasan ang taba */
        min-width: 150px !important;
        margin: 8px auto !important;
    }
    
    /* Paliitin at ilapit ang icon */
    #ai-menu .menu-button::before,
    #online-game-select .menu-button::before,
    #invite-game-select .menu-button::before {
        font-size: 2em !important;
        left: -50px !important;
    }
}

#matchmaking-wait-modal,
#waiting-room,
#invite-wait-modal {
    /* Madilim pero see-through (0.85) */
    background-color: rgba(0, 0, 0, 0.85) !important; 
    backdrop-filter: blur(8px) !important;
    
    /* Manipis na Gold Border */
    border: 1px solid rgba(255, 215, 0, 0.2) !important; 
    
    /* Layout */
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    justify-content: center !important;
}

/* 2. Title ("Searching...", "Waiting...") */
#matchmaking-wait-modal h2,
#waiting-room h2,
#invite-wait-modal h2 {
    font-family: 'Luckiest Guy', cursive !important;
    font-size: 3em !important;
    color: #FFD700 !important; /* Gold */
    
    /* Shadow para lutang */
    text-shadow: 4px 4px 0 #000, 0 0 20px rgba(255, 215, 0, 0.5) !important;
    
    margin-bottom: 30px !important;
    text-transform: uppercase;
    text-align: center;
}

/* 3. Game ID Display (Neon Ticket Style) */
#game-id-display {
    font-family: 'Nunito', sans-serif !important;
    font-size: 3.5em !important;
    font-weight: 900 !important;
    
    /* Cyan Color para contrast sa Gold */
    color: #00E5FF !important; 
    text-shadow: 0 0 15px #00E5FF;
    
    /* Background Box */
    background: rgba(0, 0, 0, 0.6) !important;
    padding: 15px 40px !important;
    border-radius: 15px !important;
    border: 2px dashed rgba(255, 255, 255, 0.3) !important;
    
    letter-spacing: 5px;
    margin-bottom: 20px !important;
    cursor: pointer;
    transition: transform 0.2s;
}

/* Pindutin effect */
#game-id-display:active {
    transform: scale(0.95);
    background: rgba(0, 0, 0, 0.9) !important;
}

/* 4. Spinner/Loader (Gold Ring) */
.loader {
    width: 60px !important;
    height: 60px !important;
    
    /* Border Ring */
    border: 6px solid rgba(255, 255, 255, 0.1) !important;
    border-bottom-color: #FFD700 !important; /* Gold Spinner */
    
    border-radius: 50% !important;
    animation: rotation 1s linear infinite !important;
    
    /* Gold Glow */
    filter: drop-shadow(0 0 10px #FFD700);
    margin-top: 20px !important;
}

/* Landscape Fix */
@media (max-height: 500px) {
    #matchmaking-wait-modal h2, #waiting-room h2 { font-size: 2em !important; margin-bottom: 15px !important; }
    #game-id-display { font-size: 2em !important; padding: 10px 20px !important; }
    .loader { width: 40px !important; height: 40px !important; border-width: 4px !important; }
}

/* 1. Background: Exclusive Club Vibe */
#lobby-screen {
    /* Deep Radial Gradient (Spotlight Effect) */
    background: radial-gradient(circle at center, #1a2a6c 0%, #0f0f1a 100%) !important;
    
    /* Lagyan ng texture overlay kung gusto mo (Optional) */
    background-size: cover !important;
}

/* 2. Top Bar (Profile & Coins): Glass Pills */
.profile-section, 
.coin-pill {
    /* Transparent Glass */
    background: rgba(255, 255, 255, 0.05) !important;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    
    /* Borders */
    border: 1px solid rgba(255, 255, 255, 0.15) !important;
    border-radius: 50px !important;
    
    /* Spacing */
    padding: 8px 20px !important;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3) !important;
    transition: transform 0.2s;
}

/* Animation pag pinindot ang profile */
.profile-section:active, .coin-pill:active {
    transform: scale(0.95);
    background: rgba(255, 255, 255, 0.1) !important;
}

/* 3. CENTER CARDS (Play Modes): Neon Glass */
.game-card {
    /* Dark Glass Base */
    background: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(255,255,255,0.01)) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    border-radius: 25px !important;
    
    /* Shadow */
    box-shadow: 0 15px 35px rgba(0,0,0,0.5) !important;
    
    /* Text Styles */
    font-family: 'Nunito', sans-serif !important;
    color: white !important;
    overflow: visible !important; /* Para lumabas ang glow */
}

/* ONLINE CARD (Main Highlight) */
#online-button.game-card {
    border: 2px solid rgba(0, 229, 255, 0.3) !important; /* Cyan Border */
}

/* Hover/Active Effect sa Online Card */
#online-button.game-card:hover,
#online-button.game-card:active {
    transform: translateY(-5px) scale(1.02) !important;
    box-shadow: 0 0 30px rgba(0, 229, 255, 0.4) !important; /* Cyan Glow */
    border-color: #00E5FF !important;
}

/* VS AI CARD (Secondary) */
#vs-ai-button.game-card {
    border: 2px solid rgba(255, 215, 0, 0.3) !important; /* Gold Border */
}

/* Hover/Active Effect sa AI Card */
#vs-ai-button.game-card:hover,
#vs-ai-button.game-card:active {
    transform: translateY(-5px) scale(1.02) !important;
    box-shadow: 0 0 30px rgba(255, 215, 0, 0.4) !important; /* Gold Glow */
    border-color: #FFD700 !important;
}

/* Icon Sizes sa loob ng card */
.card-icon {
    font-size: 4em !important;
    filter: drop-shadow(0 5px 15px rgba(0,0,0,0.5));
    margin-bottom: 10px !important;
}

/* Title Font */
.card-title {
    font-family: 'Luckiest Guy', cursive !important;
    letter-spacing: 2px !important;
    font-size: 1.8em !important;
    text-shadow: 0 2px 5px rgba(0,0,0,0.8) !important;
}

/* 4. BOTTOM DOCK: Floating Glass Bar */
.lobby-dock {
    /* Glass Bar */
    background: rgba(0, 0, 0, 0.6) !important;
    backdrop-filter: blur(12px) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    border-radius: 40px !important;
    
    /* Floating Effect */
    margin-bottom: 20px !important;
    padding: 15px 30px !important;
    box-shadow: 0 10px 40px rgba(0,0,0,0.6) !important;
    
    gap: 25px !important;
}

/* Dock Icons */
.dock-item {
    opacity: 0.7;
    transition: all 0.3s;
}

.dock-item:hover {
    opacity: 1;
    transform: translateY(-10px) scale(1.1); /* Aangat pag tinutok */
}

.dock-icon {
    font-size: 2em !important;
    filter: drop-shadow(0 2px 5px rgba(0,0,0,0.5));
}


#online-button .card-icon {
    color: transparent !important; /* Gawing invisible ang lumang text */
    position: relative !important;
    text-shadow: none !important; /* Alisin ang lumang shadow */
    overflow: visible !important;
}

/* 2. Ipalit ang "Network Globe" (üåê) gamit ang CSS */
#online-button .card-icon::after {
    content: 'üåê'; /* Ito yung Mundo na may Lines/Grid */
    
    /* I-center ng maayos */
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    
    /* Kulay: Neon Cyan (Tech/Internet Vibe) */
    color: #00E5FF !important; 
    
    /* Siguraduhing kasing-laki ng dati */
    font-size: 1em !important; 
    
    /* Cyber Glow (Para mukhang nag-coconekta) */
    text-shadow: 
        0 0 15px rgba(0, 229, 255, 0.9),
        0 0 30px rgba(0, 229, 255, 0.6);
        
    /* Animation: "Pulse" (Huminga effect) */
    animation: networkPulse 2s infinite alternate ease-in-out;
}

/* Animation Keyframes */
@keyframes networkPulse {
    0% { 
        filter: drop-shadow(0 0 5px #00E5FF); 
        transform: translate(-50%, -50%) scale(1); 
    }
    100% { 
        filter: drop-shadow(0 0 20px #00E5FF); 
        transform: translate(-50%, -50%) scale(1.1); 
    }
}

#online-button .card-icon::after {
    content: 'üåç' !important; /* Simpleng Earth Emoji */
    
    /* Ayusin ang pwesto */
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    
    /* Siguraduhing tama ang laki */
    font-size: 1em !important; 
    
    text-shadow: 0 0 20px rgba(0, 229, 255, 0.8);
    
    /* Pulse Animation (Huminga effect) */
    animation: networkPulse 2s infinite alternate ease-in-out;
}


#vs-ai-button .card-icon {
    display: inline-block !important; /* Importante para gumalaw */
    transform-origin: bottom center;  /* Sa leeg ang pivot point */
    
    /* Pagsamahin ang Animation (3 seconds loop) */
    animation: robotLife 3s infinite ease-in-out;
    
    /* Gold Glow para mukhang powered ON */
    filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.5));
}

/* Ang Magic Keyframes */
@keyframes robotLife {
    0% { transform: rotate(0deg); }
    
    /* 1. GALAW ANTENNA (Kaliwa) */
    25% { transform: rotate(-12deg); } 
    
    /* Gitna */
    45% { transform: rotate(0deg); }
    
    /* 2. KURAP (Blink Effect - Mabilis na squash) */
    48% { transform: scaleY(1); }      /* Mulat */
    50% { transform: scaleY(0.1); opacity: 0.8; } /* Pikit (Squash) */
    52% { transform: scaleY(1); }      /* Mulat Ulit */
    
    /* 3. GALAW ANTENNA (Kanan) */
    75% { transform: rotate(12deg); } 
    
    100% { transform: rotate(0deg); }
}


#straight-ball-instructions,
#poker-instructions,
#61-ball-instructions {
    /* Tinted Black (0.75 Opacity) */
    background-color: rgba(0, 0, 0, 0.75) !important;
    
    /* Tanggalin ang Blur */
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
}

/* 2. Ang Inner Box (Lalagyan ng Text) */
.instruction-modal .content {
    /* Transparent na may konting dilim para mabasa ang text */
    background: rgba(0, 0, 0, 0.6) !important; 
    
    /* Gold Border & Shadow */
    border: 1px solid rgba(255, 215, 0, 0.3) !important;
    box-shadow: 0 0 40px rgba(0, 0, 0, 0.8) !important;
    border-radius: 20px !important;
    
    /* Spacing */
    padding: 30px !important;
    max-width: 600px !important;
}

/* 3. Rules Title (Gawing Gold & Luckiest Guy Font) */
.instruction-modal h2 {
    font-family: 'Luckiest Guy', cursive !important;
    font-size: 2.8em !important;
    color: #FFD700 !important; /* Gold */
    
    /* Black Outline para lutang */
    text-shadow: 3px 3px 0 #000, 0 0 15px rgba(255, 215, 0, 0.4) !important;
    
    margin-bottom: 20px !important;
    text-align: center !important;
    letter-spacing: 1px !important;
}

/* 4. Rules Text (Mas malinaw na puti) */
.instruction-modal p {
    font-family: 'Nunito', sans-serif !important;
    font-size: 1.1em !important;
    line-height: 1.6 !important;
    color: rgba(255, 255, 255, 0.95) !important; /* Bright White */
    text-shadow: 1px 1px 2px rgba(0,0,0,0.8) !important;
}

/* 5. Play Button sa loob ng Rules */
.instruction-modal .menu-button {
    width: 100% !important;
    margin-top: 20px !important;
    background: linear-gradient(145deg, #28a745, #1e7e34) !important; /* Green Play Btn */
    border: 2px solid #fff !important;
    box-shadow: 0 5px 15px rgba(0,0,0,0.5) !important;
}

#straight-ball-instructions,
#poker-instructions,
#61-ball-instructions {
    /* Ginawang 0.6 para mas kita ang mesa sa likod */
    background-color: rgba(0, 0, 0, 0.6) !important;
    backdrop-filter: none !important;
}

/* 2. Ayusin ang "PLAY" Button Style */
.instruction-modal .menu-button {
    /* -- SIZE FIX: Paliitin -- */
    width: auto !important; 
    min-width: 200px !important; /* Saktong haba lang */
    max-width: 300px !important;
    padding: 10px 40px !important;
    
    /* -- THEME FIX: Dark & Gold (Gaya ng iba) -- */
    background: linear-gradient(145deg, #2b2b2b, #1a1a1a) !important; /* Dark Gray */
    border: 2px solid #FFD700 !important; /* Gold Border */
    color: #FFD700 !important; /* Gold Text */
    
    /* -- SHAPE & POSITION -- */
    border-radius: 50px !important; /* Capsule Shape */
    margin: 0 auto 20px auto !important; /* Igitna at lagyan ng space sa baba */
    display: block !important;
    
    /* Shadow */
    box-shadow: 0 5px 15px rgba(0,0,0,0.5) !important;
    font-size: 1.2em !important;
    letter-spacing: 2px;
}

/* 3. Hover Effect sa Play Button */
.instruction-modal .menu-button:hover {
    transform: scale(1.05) !important;
    background: linear-gradient(145deg, #444, #222) !important;
    border-color: #FFF !important; /* Puti pag tinutok */
    color: #FFF !important;
    box-shadow: 0 0 20px rgba(255, 215, 0, 0.4) !important;
}

/* 4. Siguraduhing naka-center ang container ng button */
.instruction-modal .play-button-container {
    display: flex !important;
    justify-content: center !important;
    width: 100% !important;
}

.instruction-modal .menu-button {
    /* Aesthetic Gradient (Lush Green) */
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%) !important;
    
    /* Glowing Border */
    border: 2px solid #b2f2bb !important; /* Pale Green Outline */
    color: white !important;
    
    /* Green Neon Glow */
    box-shadow: 0 0 20px rgba(56, 239, 125, 0.5) !important;
    
    /* Text Style */
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    font-weight: 900 !important;
    letter-spacing: 2px !important;
    
    /* Size adjustments */
    padding: 12px 40px !important;
    border-radius: 50px !important;
    width: auto !important;
    min-width: 200px !important;
    margin: 0 auto 20px auto !important;
}

/* Hover Effect (Mas liliwanag) */
.instruction-modal .menu-button:hover {
    transform: scale(1.05) !important;
    background: linear-gradient(135deg, #38ef7d 0%, #11998e 100%) !important;
    box-shadow: 0 0 30px rgba(56, 239, 125, 0.8) !important;
}

@media (max-height: 500px) and (orientation: landscape) {
    
    /* 1. Main Container: Grid Layout (Hatiin sa Dalawa) */
    .instruction-modal .content {
        display: grid !important;
        /* Column 1 (40%): Title & Button | Column 2 (60%): Text */
        grid-template-columns: 0.8fr 1.2fr !important;
        grid-template-rows: auto auto !important;
        
        width: 95% !important;
        height: 90% !important; /* Sagad sa screen */
        max-height: none !important;
        padding: 15px 30px !important;
        
        align-content: center !important;
        column-gap: 30px !important; /* Space sa gitna */
    }

    /* 2. Rules Title (Kaliwa, Taas) */
    .instruction-modal h2 {
        grid-column: 1 !important;
        grid-row: 1 !important;
        font-size: 2em !important;
        margin-bottom: 10px !important;
        align-self: end !important; /* Idikit sa baba ng cell */
        text-align: center !important;
    }

    /* 3. Play Button (Kaliwa, Baba) */
    .instruction-modal .play-button-container {
        grid-column: 1 !important;
        grid-row: 2 !important;
        width: 100% !important;
        align-self: start !important; /* Idikit sa taas ng cell */
        margin-top: 10px !important;
    }
    
    /* Ayusin ang size ng button sa landscape */
    .instruction-modal .menu-button {
        width: 100% !important;
        max-width: 250px !important;
        padding: 10px 0 !important;
        margin: 0 auto !important;
    }

    /* 4. Rules Text (Kanan, Sakop ang taas at baba) */
    .instruction-modal p {
        grid-column: 2 !important;
        grid-row: 1 / span 2 !important; /* Sakop ang Row 1 at 2 */
        
        font-size: 0.95em !important;
        line-height: 1.4 !important;
        margin: 0 !important;
        text-align: left !important;
        
        /* Divider Line sa gitna */
        border-left: 2px solid rgba(255, 215, 0, 0.3) !important;
        padding-left: 20px !important;
        
        /* Gitna ang text vertically */
        display: flex !important;
        flex-direction: column;
        justify-content: center;
    }
}

.instruction-modal .menu-button {
    /* 1. SIZE: Mas Maiksi / Compact */
    width: auto !important;
    min-width: 140px !important; /* Saktong liit lang */
    max-width: 180px !important; /* Limitahan para di humaba */
    padding: 10px 25px !important;
    
    /* 2. BACKGROUND: Navy Blue Gradient */
    background: linear-gradient(145deg, #001f3f, #003366) !important;
    
    /* 3. BORDER: Gold Line */
    border: 2px solid #FFD700 !important;
    
    /* TEXT: Gold din */
    color: #FFD700 !important;
    font-weight: 800 !important;
    
    /* GLOW: Gold Shadow */
    box-shadow: 0 0 15px rgba(255, 215, 0, 0.4) !important;
    
    /* Alignment */
    margin: 10px auto !important;
    border-radius: 50px !important;
}

/* Hover Effect: Mas liliwanag ang Gold */
.instruction-modal .menu-button:hover {
    transform: scale(1.05) !important;
    background: linear-gradient(145deg, #003366, #001f3f) !important;
    box-shadow: 0 0 25px rgba(255, 215, 0, 0.7) !important;
    filter: brightness(1.2);
}

.instruction-modal .content {
    /* Navy Blue Gradient (Para hindi flat tignan) */
    background: linear-gradient(145deg, #001f3f, #001020) !important;
    
    /* Manipis na Gold border sa box para terno */
    border: 1px solid rgba(255, 215, 0, 0.3) !important;
    
    /* Blue shadow sa likod */
    box-shadow: 0 0 50px rgba(0, 31, 63, 0.8) !important;
}

/* 2. PLAY BUTTON: Green na may Gold Line */
.instruction-modal .menu-button {
    /* Background: Rich Green */
    background: linear-gradient(145deg, #28a745, #1e7e34) !important;
    
    /* Border: Gold Line */
    border: 3px solid #FFD700 !important;
    
    /* Text Color */
    color: #fff !important; /* White text para malinaw sa Green */
    text-shadow: 0 1px 2px rgba(0,0,0,0.5) !important;
    font-weight: 900 !important;
    
    /* Size: Compact / Maiksi (Gaya ng request mo) */
    width: auto !important;
    min-width: 150px !important;
    max-width: 200px !important;
    padding: 10px 30px !important;
    
    /* Alignment */
    margin: 15px auto !important;
    border-radius: 50px !important;
    
    /* Shadow */
    box-shadow: 0 5px 15px rgba(0,0,0,0.5) !important;
}

/* Hover Effect: Liliwanag */
.instruction-modal .menu-button:hover {
    transform: scale(1.05) !important;
    background: linear-gradient(145deg, #34ce57, #28a745) !important;
    box-shadow: 0 0 20px rgba(255, 215, 0, 0.6) !important; /* Gold Glow pag hover */
}

.instruction-modal .menu-button {
    /* 1. Gamitin ang Flexbox para PERFECT CENTER */
    display: flex !important;
    justify-content: center !important; /* Gitna (Kaliwa-Kanan) */
    align-items: center !important;     /* Gitna (Taas-Baba) */
    
    /* 2. Tanggalin ang vertical padding, gamitin ang fixed height */
    padding: 0 20px !important; 
    height: 50px !important;      /* Fixed na taba */
    min-height: 50px !important;  /* Siguradong di liliit */
    
    /* 3. Text Line Height Reset */
    line-height: 1 !important;    /* Para walang extra space sa text */
    text-align: center !important;
    
    /* Siguraduhing nandoon pa rin ang dating style */
    width: auto !important;
    min-width: 150px !important;
    max-width: 200px !important;
    margin: 15px auto !important;
}


@media (max-height: 600px) and (orientation: landscape) {
    
    /* 1. Gawing Grid ang Main Modal Container */
    #friends-modal .content {
        display: grid !important;
        /* Hatiin sa dalawa: 45% Kaliwa, 55% Kanan */
        grid-template-columns: 0.8fr 1.2fr !important;
        /* Rows: Title, Headers, Lists */
        grid-template-rows: auto auto 1fr !important;
        column-gap: 25px !important;
        row-gap: 10px !important;
        
        width: 95% !important;
        height: 95% !important;
        max-width: 900px !important;
        padding: 20px 30px !important;
        align-items: start !important;
    }

    /* 2. Main Title ("FRIENDS LIST") - Sakop ang buong taas */
    #friends-modal h2 {
        grid-column: 1 / span 2 !important; /* Spread across top */
        grid-row: 1 !important;
        margin-bottom: 10px !important;
        font-size: 2em !important;
        text-align: center !important;
    }

    /* --- MAGIC TRICK: Wasakin ang wrapper para ma-move ang laman --- */
    .friends-lists-wrapper {
        display: contents !important;
    }

    /* --- LEFT SIDE (Search & Pending) --- */

    /* A. Search Bar */
    .friends-search-container {
        grid-column: 1 !important;
        grid-row: 2 !important;
        margin-bottom: 5px !important;
    }

    /* B. Search Results (Sa ilalim ng Search Bar) */
    #friend-search-results {
        grid-column: 1 !important;
        grid-row: 3 !important; /* Nakapwesto sa row 3 */
        max-height: 80px !important; /* Limitahan para di matakpan ang pending */
    }

    /* C. Pending Header */
    .friends-lists-wrapper > h3:nth-of-type(1) {
        grid-column: 1 !important;
        grid-row: 4 !important; /* Sa baba ng results */
        margin-top: 10px !important;
        font-size: 1.2em !important;
        border-bottom: 1px solid rgba(255,215,0,0.3) !important;
    }

    /* D. Pending List */
    #friends-list-pending {
        grid-column: 1 !important;
        grid-row: 5 !important;
        height: 100% !important;
        max-height: 150px !important; /* Fixed height para scrollable */
    }

    .friends-lists-wrapper > h3:nth-of-type(2) {
        grid-column: 2 !important;
        grid-row: 2 !important; /* Kapantay ng Search Bar */
        margin-top: 0 !important;
        font-size: 1.5em !important;
        color: #00FF00 !important; /* Green Title */
        border-bottom: 2px solid rgba(255,255,255,0.2) !important;
        padding-bottom: 10px !important;
    }

    
    #friends-list-accepted {
        grid-column: 2 !important;
        grid-row: 3 / span 3 !important; 
        height: 100% !important;
        max-height: 65vh !important; /* Sagad */
        background: rgba(0,0,0,0.3) !important; /* Darker background para focus */
    }
}

.message-btn {
    background-image: linear-gradient(to right, #00c6ff 0%, #0072ff 100%) !important;
    box-shadow: 0 4px 15px rgba(0, 114, 255, 0.4) !important;
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
    min-width: 80px !important; /* Saktong haba */
}

/* Hover Effect */
.message-btn:hover {
    filter: brightness(1.2);
    transform: translateY(-2px) scale(1.05) !important;
}


@media (max-height: 500px) {
    .friend-actions {
        gap: 3px !important; /* Padikitin ang buttons */
    }
    .friend-actions .menu-button {
        padding: 5px 8px !important; /* Paliitin ang taba */
        font-size: 0.7em !important;
        min-width: 60px !important;
    }
}


/* 1. Chat Bubbles */
.chat-bubble {
    max-width: 75%;
    padding: 10px 15px;
    border-radius: 18px;
    font-size: 0.95em;
    line-height: 1.4;
    word-wrap: break-word;
    position: relative;
    animation: popIn 0.2s ease-out;
}

/* 2. My Message (Right Side - Blue) */
.chat-bubble.me {
    align-self: flex-end;
    background: linear-gradient(135deg, #00c6ff, #0072ff);
    color: white;
    border-bottom-right-radius: 4px;
}

/* 3. Friend's Message (Left Side - Gray) */
.chat-bubble.friend {
    align-self: flex-start;
    background: #3a3b3c; /* Facebook Dark Gray */
    color: #e4e6eb;
    border-bottom-left-radius: 4px;
}

/* 4. Timestamp (Maliit sa baba) */
.chat-time {
    font-size: 0.65em;
    opacity: 0.7;
    margin-top: 4px;
    text-align: right;
    display: block;
}

/* Animation */
@keyframes popIn {
    from { transform: scale(0.8); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}



#private-chat-modal {
    /* Tinaasan ko ang Z-Index para lumutang sa ibabaw ng Friends List */
    z-index: 300 !important; 
}

/* Siguraduhin ding nasa ibabaw ang close button ng chat */
#private-chat-modal .modal-close-btn {
    z-index: 301 !important;
}


.message-btn {
    position: relative !important; 
    overflow: visible !important; 
}

.chat-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    width: 14px;
    height: 14px;
    background-color: #FF0000; /* Red */
    border: 2px solid #fff;
    border-radius: 50%;
    display: none; /* Tago muna default */
    box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    z-index: 10;
    animation: bounceBadge 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.27);
}

@keyframes bounceBadge {
    0% { transform: scale(0); }
    50% { transform: scale(1.5); }
    100% { transform: scale(1); }
}


@media (max-height: 550px) and (orientation: landscape) {
    
    /* 1. Gawing GRID ang main container (Hatiin sa dalawa) */
    #invite-game-select {
        display: grid !important;
        /* Columns: 1fr (Kaliwa) 1fr (Kanan) */
        grid-template-columns: 1fr 1fr !important;
        /* Rows: Auto (Title) Auto (Subtext) 1fr (Content) */
        grid-template-rows: auto auto 1fr auto !important;
        
        align-content: center !important;
        justify-items: center !important;
        padding: 10px 40px !important;
        gap: 5px 20px !important; /* Space sa gitna */
    }

    /* 2. TITLE ("Invite Friend") - Sakop ang buong taas */
    #invite-game-select h2 {
        grid-column: 1 / -1 !important; /* Span all columns */
        grid-row: 1 !important;
        margin: 0 !important;
        font-size: 2em !important;
    }

    
    #invite-game-select > p:nth-of-type(1) {
        grid-column: 1 / -1 !important;
        grid-row: 2 !important;
        margin-bottom: 10px !important;
    }

    /* Label "Select Bet:" */
    #invite-game-select > p:nth-of-type(2) {
        grid-column: 1 !important;
        grid-row: 3 !important;
        align-self: end !important; /* Idikit sa baba ng cell */
        margin-bottom: 5px !important;
    }

    /* Bet Buttons Container */
    #invite-bet-container {
        grid-column: 1 !important;
        grid-row: 4 !important;
        align-self: start !important; /* Idikit sa taas */
        
        /* Ayusin ang buttons para magkasya */
        display: grid !important;
        grid-template-columns: repeat(3, 1fr) !important; /* 3 buttons per row */
        gap: 5px !important;
        width: 100% !important;
        max-width: 300px !important;
    }

    /* Status "Bet: 100" */
    #invite-bet-status {
        grid-column: 1 !important;
        grid-row: 5 !important;
        margin-top: 10px !important;
    }

    #invite-poker-button {
        grid-column: 2 !important;
        grid-row: 3 !important; /* Start at row 3 */
        margin: 2px 0 !important;
        width: 90% !important;
    }

    #invite-straight-ball-button {
        grid-column: 2 !important;
        grid-row: 4 !important;
        margin: 2px 0 !important;
        width: 90% !important;
    }

    #invite-61-button {
        grid-column: 2 !important;
        grid-row: 5 !important;
        margin: 2px 0 !important;
        width: 90% !important;
    }

    /* Paliitin ang buttons sa loob ng modal na ito */
    #invite-game-select .menu-button {
        padding: 8px 10px !important;
        font-size: 0.9em !important;
        min-height: auto !important;
    }
}


/* Targetin ang Close Button sa loob ng Invite Game Select */
#invite-game-select .modal-close-btn {
    /* Pilitin na maging Absolute (Lulutang) */
    position: absolute !important;
    
    /* Pwesto sa Kanang Taas */
    top: 10px !important;
    right: 20px !important;
    
    /* Siguraduhing nasa ibabaw ng lahat */
    z-index: 1000 !important; 
    
    /* Style */
    color: #fff !important;
    font-size: 2.5em !important;
    display: block !important; /* Siguraduhing kita */
    
    /* Reset Grid Properties (Para di siya hilahin ng layout) */
    grid-column: auto !important;
    grid-row: auto !important;
    width: auto !important;
    height: auto !important;
    margin: 0 !important;
}

/* Hover Effect (Para alam mong napipindot) */
#invite-game-select .modal-close-btn:hover {
    transform: scale(1.2);
    color: #FFD700 !important; /* Mag-go-gold pag tinutok */
}



@media (max-height: 550px) and (orientation: landscape) {
    
    /* Targetin natin SPECIFICALLY yung ID ng close button na yun */
    #invite-game-select-close-btn {
        /* 1. FORCE FIXED: Didikit sa screen, hindi sa div */
        position: fixed !important; 
        
        /* 2. PWESTO: Kanang Taas */
        top: 15px !important;
        right: 15px !important;
        
        /* 3. SIGURADUHING NASA IBABAW NG LAHAT */
        z-index: 99999 !important; 
        
        /* 4. VISUALS: Lagyan ng background para hindi matabunan ng text */
        display: flex !important;
        align-items: center;
        justify-content: center;
        
        width: 40px !important;
        height: 40px !important;
        
        background-color: rgba(220, 53, 69, 0.8) !important; /* Red background para kitang-kita */
        border-radius: 50% !important; /* Bilog */
        color: white !important;
        
        /* Reset natin ang font size para kasya sa bilog */
        font-size: 1.5em !important; 
        line-height: 1 !important;
        padding: 0 !important;
        
        /* Reset Grid constraints */
        grid-column: auto !important;
        grid-row: auto !important;
        margin: 0 !important;
    }
}


#invite-game-select-close-btn {
    /* 1. POSITIONING: Dikit sa Salamin (Viewport) */
    position: fixed !important; 
    top: 10px !important;
    right: 15px !important;
    
    /* 2. VISIBILITY: Siguraduhing nakalitaw */
    display: flex !important; 
    visibility: visible !important;
    opacity: 1 !important;
    
    /* 3. LAYER: Pinaka-ibabaw sa lahat ng layers ng browser */
    z-index: 2147483647 !important; 
    
    /* 4. SIZE & STYLE: Pulang Bilog */
    width: 45px !important;
    height: 45px !important;
    background-color: rgba(220, 53, 69, 1) !important; /* Solid Red */
    border: 2px solid white !important;
    border-radius: 50% !important;
    color: white !important;
    
    /* 5. TEXT ALIGNMENT: Gitna ang 'X' */
    align-items: center !important;
    justify-content: center !important;
    font-size: 2em !important;
    line-height: 0 !important;
    padding-bottom: 4px !important; /* Adjustment para gumitna ang X */
    
    /* 6. RESET GRID (Para hindi siya kainin ng layout) */
    grid-column: unset !important;
    grid-row: unset !important;
    margin: 0 !important;
    transform: none !important;
}

/* Hover Effect */
#invite-game-select-close-btn:hover {
    transform: scale(1.1) !important;
    background-color: red !important;
    cursor: pointer !important;
}


/* Targetin ang SPECIFIC ID na ito */
#invite-game-select-close-btn {
    /* 1. POSITIONING: Absolute (Relative sa Modal Overlay) */
    /* Mas safe ito kaysa Fixed kapag nasa loob ng modal */
    position: absolute !important; 
    
    /* 2. PWESTO: Kanang Taas ng Screen */
    top: 15px !important;
    right: 15px !important;
    
    /* 3. SIZE: Saktong laki ng daliri */
    width: 45px !important;
    height: 45px !important;
    
    /* 4. DESIGN: Pulang Bilog */
    background-color: #FF0000 !important; /* Bright Red */
    border: 2px solid white !important;
    border-radius: 50% !important;
    color: white !important;
    
    
    display: block !important; 
    text-align: center !important;
    
    /* IMPORTANTE: Gawing pantay sa height para gumitna ang 'X' vertically */
    line-height: 40px !important; 
    font-size: 2em !important;
    padding: 0 !important;
    
    /* 6. LAYER: Pinaka-ibabaw */
    z-index: 2147483647 !important; 
    opacity: 1 !important;
    pointer-events: auto !important;
    
    /* 7. RESET GRID PROPERTIES (Para sigurado) */
    grid-column: auto !important;
    grid-row: auto !important;
    align-self: auto !important;
    justify-self: auto !important;
    margin: 0 !important;
    transform: none !important;
}

/* Hover Effect */
#invite-game-select-close-btn:hover {
    transform: scale(1.1) !important;
    background-color: #cc0000 !important;
}


div#invite-game-select.modal-overlay {
    /* Solid Dark Blue/Black (Wala nang transparency) */
    background: #0f0f1a !important; 
    background-color: #0f0f1a !important;
    
    /* Siguraduhing nasa ibabaw siya ng Friends Modal (z-index 200) */
    z-index: 500 !important; 
    
    /* I-reset ang borders para malinis */
    border: 1px solid #FFD700 !important;
    box-shadow: 0 0 100px rgba(0,0,0,1) !important;
}


div#invite-game-select span#invite-game-select-close-btn {
    /* Pilitin na maging FIXED sa screen (Dedma sa grid layout) */
    position: fixed !important;
    
    /* Pwesto sa Screen (Viewport) */
    top: 15px !important;
    right: 20px !important;
    
    /* Itsura: Pulang Bilog */
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    width: 45px !important;
    height: 45px !important;
    background-color: #FF0000 !important;
    border: 2px solid white !important;
    border-radius: 50% !important;
    
    /* Text Styles */
    color: white !important;
    font-size: 28px !important;
    line-height: 0 !important; /* Reset line height */
    padding-bottom: 5px !important; /* Adjustment para gumitna ang 'x' */
    
    /* Pinaka-mataas na Layer */
    z-index: 9999999 !important;
    visibility: visible !important;
    opacity: 1 !important;
    pointer-events: all !important;
    
    /* Reset Grid Properties (Para hindi siya hilahin ng layout) */
    grid-column: unset !important;
    grid-row: unset !important;
    margin: 0 !important;
    transform: none !important;
}

/* Hover Effect */
div#invite-game-select span#invite-game-select-close-btn:hover {
    transform: scale(1.1) !important;
    background-color: #cc0000 !important;
    cursor: pointer !important;
}


/* 1. Modal Content (Violet Glass) */
#settings-modal .settings-content {
    /* Violet Gradient Background */
    background: linear-gradient(135deg, #240b36 0%, #c31432 100%);
    border: 2px solid #D500F9; /* Neon Purple Border */
    box-shadow: 0 0 50px rgba(142, 45, 226, 0.6);
    width: 90%;
    max-width: 400px;
    padding: 30px;
}

/* 2. Setting Items */
.setting-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(0, 0, 0, 0.3);
    padding: 15px 20px;
    border-radius: 15px;
    margin-bottom: 15px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.setting-label {
    font-size: 1.2em;
    font-weight: bold;
    color: white;
    display: flex;
    align-items: center;
    gap: 10px;
}

/* 3. THE SWITCH (Toggle Button) */
.switch {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 34px;
}

.switch input { 
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 34px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 26px;
    width: 26px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}

/* Pag Naka-ON (Green or Purple) */
input:checked + .slider {
    background-color: #00E676; /* Bright Green pag ON */
    box-shadow: 0 0 10px #00E676;
}

input:checked + .slider:before {
    transform: translateX(26px);
}

/* 4. Settings Gear Button (Main Screen) */
#main-settings-btn {
    position: absolute !important;
    top: 15px !important;
    left: 15px !important;
    z-index: 100 !important;
    font-size: 1.5em !important;
    border: 2px solid #D500F9 !important;
    box-shadow: 0 0 15px rgba(213, 0, 249, 0.5) !important;
}

#main-settings-btn:hover {
    transform: scale(1.1) rotate(90deg); /* Umiikot pag tinutok! */
    background-color: #D500F9 !important;
}

/* Tago na natin ang lumang Mute at Fullscreen buttons */
#mute-button, #fullscreen-button {
    display: none !important;
}


#main-settings-btn {
    /* Siguraduhing naka-FIXED o ABSOLUTE sa screen */
    position: absolute !important;
    
    /* Ibaba ng konti para hindi matakpan ang Coins */
    top: 55px !important; 
    left: 10px !important;
    
    /* Siguraduhing nasa ibabaw */
    z-index: 150 !important; 
    display: flex !important; /* Pilitin ipakita */
    
    /* Style */
    width: 40px !important;
    height: 40px !important;
    font-size: 1.5em !important;
    border: 2px solid #D500F9 !important;
    box-shadow: 0 0 15px rgba(213, 0, 249, 0.5) !important;
}

/* Hover Effect */
#main-settings-btn:hover {
    transform: scale(1.1) rotate(90deg);
    background-color: #D500F9 !important;
    cursor: pointer;
}

#main-settings-btn {
    /* Pilitin na maging FIXED sa screen (Dedma sa ibang div) */
    position: absolute !important;
    
    /* Pwesto: Sa ilalim ng Coins/Rank display */
    top: 65px !important; 
    left: 10px !important;
    
    /* Siguraduhing Nakalitaw */
    display: flex !important;
    visibility: visible !important;
    opacity: 1 !important;
    z-index: 9999 !important; /* Pinaka-ibabaw */
    
    /* Itsura (Violet Neon Style) */
    width: 45px !important;
    height: 45px !important;
    background-color: #6200ea !important; /* Deep Violet */
    border: 2px solid #D500F9 !important; /* Neon Purple Border */
    border-radius: 50% !important; /* Bilog */
    box-shadow: 0 0 15px rgba(213, 0, 249, 0.6) !important;
    
    /* Text Alignment */
    justify-content: center !important;
    align-items: center !important;
    font-size: 24px !important;
    padding: 0 !important;
    color: white !important;
    cursor: pointer !important;
}

/* Hover Effect */
#main-settings-btn:hover {
    transform: scale(1.1) rotate(90deg) !important;
    background-color: #D500F9 !important;
    box-shadow: 0 0 25px rgba(213, 0, 249, 0.9) !important;
}

#settings-modal .settings-content {
    position: relative !important; 
}

/* 2. Palakasin ang Power ng Close Button */
#settings-close-btn {
    /* Pwesto */
    position: absolute !important;
    top: 15px !important;
    right: 15px !important;
    
    /* Size (Lakihan ang pindutan) */
    width: 40px !important;
    height: 40px !important;
    font-size: 2em !important;
    line-height: 35px !important; /* Gitna vertically */
    text-align: center !important;
    
    /* Layering (Pinaka-ibabaw) */
    z-index: 10000 !important; 
    cursor: pointer !important;
    
    /* Visual Debug (Lagyan ng background para sure na kita mo area) */
    background: rgba(0, 0, 0, 0.2) !important; 
    border-radius: 50%;
    color: #fff !important;
}

/* Hover Effect */
#settings-close-btn:hover {
    background: rgba(255, 0, 0, 0.6) !important; /* Mag-re-red pag tinutok */
    transform: scale(1.1);
}


/* Default State (Hindi Turn) - Medyo dim */
#player-info, #opponent-info {
    transition: all 0.3s ease-in-out !important;
    opacity: 0.7 !important; /* Dati 1, ngayon 0.7 para dim pag di mo turn */
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    transform: scale(0.95); /* Paliitin konti pag di turn */
}


@keyframes breathingGlow {
    0% {
        /* Mahina */
        box-shadow: 0 0 10px rgba(255, 215, 0, 0.4), inset 0 0 5px rgba(255, 215, 0, 0.1);
        border-color: rgba(255, 215, 0, 0.5);
        transform: scale(1.0);
    }
    50% {
        /* Malakas (Full Power) */
        box-shadow: 0 0 25px rgba(255, 215, 0, 1), 0 0 50px rgba(255, 215, 0, 0.6), inset 0 0 15px rgba(255, 215, 0, 0.3);
        border-color: #FFD700;
        transform: scale(1.08); /* Lumaki ng konti */
    }
    100% {
        /* Balik sa Mahina */
        box-shadow: 0 0 10px rgba(255, 215, 0, 0.4), inset 0 0 5px rgba(255, 215, 0, 0.1);
        border-color: rgba(255, 215, 0, 0.5);
        transform: scale(1.0);
    }
}

/* 2. I-apply sa Active Player */
#player-info.hud-active, 
#opponent-info.hud-active {
    opacity: 1 !important;
    z-index: 50 !important;
    
    /* Dito natin tinatawag ang animation */
    /* 1.5s = Gaano kabilis huminga (mas maliit, mas mabilis) */
    animation: breathingGlow 1.5s infinite ease-in-out !important;
}

@keyframes superBreathing {
    0% { 
        transform: scale(1); 
        filter: brightness(1) drop-shadow(0 0 5px rgba(255, 215, 0, 0.5));
        border-color: rgba(255, 215, 0, 0.5);
    }
    50% { 
        transform: scale(1.1); 
        filter: brightness(1.3) drop-shadow(0 0 15px rgba(255, 215, 0, 1));
        border-color: #FFD700;
    }
    100% { 
        transform: scale(1); 
        filter: brightness(1) drop-shadow(0 0 5px rgba(255, 215, 0, 0.5));
        border-color: rgba(255, 215, 0, 0.5);
    }
}

/* 2. I-APPLY SA ACTIVE PLAYER (Gamit ang ID+Class para pinaka-malakas) */
/* 2. I-APPLY SA ACTIVE PLAYER (Gamit ang ID+Class para pinaka-malakas) */
div#player-info.hud-active, 
div#opponent-info.hud-active {
    /* Pilitin nating ipakita (Override any hidden opacity) */
    opacity: 1 !important;
    z-index: 999 !important;
    
    /* Pilitin ang GOLD Border (Tatalunin nito ang lumang white border) */
    border: 2px solid #FFD700 !important; 
    
    /* Gawing Solid ang Background para litaw */
    background: rgba(0, 0, 0, 0.8) !important; 
    
    /* Pilitin ang Initial Glow */
    box-shadow: 0 0 20px rgba(255, 215, 0, 0.6) !important;
    
    /* --- DITO ANG PAGBABAGO PARA IWAS LAG --- */
    
    /* Tanggalin ang breathing animation */
    animation: none !important; 

    /* Palitan ng Fixed na Paglaki (Steady lang na malaki) */
    transform: scale(1.15) !important;
}
/* === PRELOADER STYLES === */
#preloader-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: radial-gradient(circle at center, #1a2a6c 0%, #0f0f1a 100%);
    z-index: 99999; /* Pinaka-ibabaw sa lahat */
    display: flex;
    justify-content: center;
    align-items: center;
    transition: opacity 0.5s ease-out;
}

.preloader-content {
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
}

.preloader-title {
    font-family: 'Luckiest Guy', cursive;
    font-size: 4em;
    color: #FFD700;
    text-shadow: 4px 4px 0 #000, 0 0 30px rgba(255, 215, 0, 0.6);
    margin: 0;
    letter-spacing: 3px;
}

/* Spinner Animation */
.loader-spinner {
    width: 60px;
    height: 60px;
    border: 6px solid rgba(255, 255, 255, 0.1);
    border-top-color: #FFD700; /* Gold */
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

#loading-text {
    font-family: 'Nunito', sans-serif;
    color: white;
    font-size: 1.2em;
    font-weight: bold;
    letter-spacing: 1px;
}

/* Hide preloader pag tapos na */
#preloader-overlay.hidden {
    opacity: 0;
    pointer-events: none;
}


@media screen and (min-width: 1024px) {

    /* 1. GENERAL TEXT SCALING */
    body {
        font-size: 20px !important; /* Lakihan ang base font */
    }

    /* 2. LOBBY: PROFILE & COINS (Palakihin ng 30%) */
    .profile-section {
        transform: scale(1.3) !important; 
        transform-origin: top left !important;
        margin-left: 20px !important;
        margin-top: 10px !important;
    }

    .coin-pill {
        transform: scale(1.3) !important;
        transform-origin: top right !important;
        margin-right: 20px !important;
        margin-top: 10px !important;
    }

    /* 3. LOBBY: CARDS (Game Modes) */
    .game-card {
        width: 380px !important; /* Mas malapad */
        height: 260px !important; /* Mas matangkad */
        margin: 20px !important;
    }
    .card-title { font-size: 2.5em !important; } /* Malaking Title */
    .card-icon { font-size: 5em !important; }   /* Malaking Emoji */

    /* 4. LOBBY: BOTTOM DOCK (Icons sa baba) */
    .lobby-dock {
        transform: scale(1.2) !important; /* Palakihin ang buong dock */
        margin-bottom: 30px !important;
        padding: 20px 40px !important;
    }

    /* 5. IN-GAME HUD (Player Names sa taas) */
    #player-info, #opponent-info {
        transform: scale(1.5) !important; /* 50% Bigger */
        top: 20px !important;
    }
    
    #player-info { 
        left: 220px !important; /* Usog pa-kanan para di dikit sa gilid */
        transform-origin: top left !important; 
    }
    
    #opponent-info { 
        right: 220px !important; /* Usog pa-kaliwa */
        transform-origin: top right !important; 
    }

    /* 6. COINS DISPLAY (In-Game) */
    #currency-display {
        transform: scale(1.5) !important;
        top: 20px !important;
        left: 20px !important;
        transform-origin: top left !important;
    }

    /* 7. SETTINGS & UTILITY BUTTONS (Gear, Mute, Chat) */
    .ui-button, .icon-button, #main-settings-btn {
        width: 60px !important;  /* Lakihan ang pindutan */
        height: 60px !important;
        font-size: 1.5em !important; /* Lakihan ang icon sa loob */
    }
    
    /* Ayusin ang pwesto ng Settings button */
    #main-settings-btn {
        top: 100px !important; /* Ibaba konti kasi lumaki ang Coins display */
        left: 25px !important;
    }

    /* 8. MODALS (Popups) - Zoom In effect */
    .modal-overlay .content {
        transform: scale(1.2) !important; /* Lahat ng popup (Shop, Winner, etc) lalaki */
        max-width: 800px !important; /* Mas malapad na limit */
    }

    /* 9. MENU BUTTONS (Yung mga mahahabang button) */
    .menu-button {
        font-size: 1.3em !important;
        padding: 15px 30px !important;
        border-radius: 20px !important;
    }

    /* 10. NOTIFICATIONS / TOASTS */
    #message-box {
        font-size: 2em !important; /* Sobrang laki para kitang kita */
        padding: 20px 40px !important;
    }
}

/* Siguraduhin na naka-relative o absolute ito para di lumabas ang tako */
#power-control {
    overflow: hidden; /* Putulin ang sobra para malinis */
    display: flex;
    justify-content: center; /* Gitna */
    align-items: flex-start; /* Simula sa taas */
}

/* Style para sa Tako sa loob ng Power Bar */
#power-cue-img {
    position: absolute;
    width: 230px;  /* Haba ng tako */
    height: 100px;  /* Taba ng tako */
    
    /* Sentro Horizontal at Vertical + Ikot */
    transform: translate(-50%, -50%) rotate(-90deg);
    
    left: 50%;     /* Gitna horizontally */
    
    /* ITO ANG BAGO: Naka-steady sa GITNA (50%) */
    top: 50%;      
    
    pointer-events: none; 
    transition: top 0.1s ease-out; /* May konting smooth effect pagbalik */
    z-index: 5;
    filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.5));
}

/* Gawing clickable ang itsura ng profile picture */
#profile-avatar-img {
    cursor: pointer;
    transition: transform 0.2s;
}

#profile-avatar-img:hover {
    transform: scale(1.05); /* Lumaki konti pag tinutok mouse */
    filter: brightness(1.1);
}

        /* === ULTIMATE CLARITY OVERRIDE === */

/* Targetin lahat ng avatar images sa Friends, Leaderboard, HUD, at Profile */
.friend-info img, 
.hud-avatar img, 
#leaderboard-body img, 
#profile-avatar-img,
.vs-player-box img,
.avatar-circle img {
    /* Siguraduhing hindi nai-stretch */
    object-fit: cover !important;
    
    /* Pilitin ang browser na gumamit ng High Quality rendering */
    image-rendering: -webkit-optimize-contrast !important; /* Para sa Chrome/Safari mobile */
    image-rendering: high-quality !important; /* Modern Browsers */
    
    /* Tanggalin ang blur effects kung meron man */
    filter: none !important; 
    backdrop-filter: none !important;
    
    /* Siguraduhing bilog na bilog at walang putol */
    border-radius: 50% !important;
    
    /* Hardware acceleration para mas smooth */
    transform: translateZ(0);
}

/* Special fix para sa Friends List at Leaderboard thumbnails */
.friend-info img, #leaderboard-body img {
    background-color: #333; /* Background habang loading */
    box-shadow: 0 2px 5px rgba(0,0,0,0.5) !important;
    border: 1px solid rgba(255,255,255,0.3) !important;
}

/* --- RANK UP ANIMATIONS --- */

/* Umiikot na Sinag (Rays) sa Likod */
.rank-rays {
    position: absolute;
    width: 200vmax; /* Sobrang laki para sakop buong screen kahit anong device */
    height: 200vmax;
    background: repeating-conic-gradient(
        from 0deg,
        rgba(255, 215, 0, 0.15) 0deg 10deg, /* Gold tint */
        transparent 10deg 20deg
    );
    animation: raySpin 20s linear infinite;
    z-index: 1;
    pointer-events: none;
}

@keyframes raySpin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* Icon Pop Animation (Boing effect) */
.rank-pop-anim {
    animation: iconPop 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
}

@keyframes iconPop {
    0% { transform: scale(0); opacity: 0; }
    50% { transform: scale(1.2); opacity: 1; }
    70% { transform: scale(0.9); }
    100% { transform: scale(1); opacity: 1; }
}

/* Text Slide In Effect */
.rank-text-slide {
    animation: slideUpFade 0.6s ease-out 0.3s forwards; /* Delay para sunod sa icon */
    opacity: 0;
    transform: translateY(20px);
}

@keyframes slideUpFade {
    to { opacity: 1; transform: translateY(0); }
}

/* --- RANK EXCLUSIVE BORDERS --- */

/* Override default avatar styles para sumunod sa borders */
.avatar-circle, .hud-avatar, #profile-avatar-img, .friend-info img, .vs-player-box img {
    box-sizing: border-box !important;
    transition: all 0.3s ease;
    position: relative;
    background-clip: padding-box; /* Fix para di matakpan ang border */
}

/* 1. BRONZE */
.rank-border-bronze {
    border: 3px solid #CD7F32 !important;
}

/* 2. SILVER */
.rank-border-silver {
    border: 3px solid #C0C0C0 !important;
    box-shadow: 0 0 5px rgba(192, 192, 192, 0.5);
}

/* 3. GOLD (Pulse Effect) */
.rank-border-gold {
    border: 3px solid #FFD700 !important;
    box-shadow: 0 0 10px rgba(255, 215, 0, 0.6);
    animation: goldPulse 2s infinite;
}

/* 4. PLATINUM (Cyan Glow) */
.rank-border-platinum {
    border: 3px solid #00CED1 !important;
    box-shadow: 0 0 15px #00CED1;
}

/* 5. DIAMOND (Blue Sparkle) */
.rank-border-diamond {
    border: 3px solid #B9F2FF !important;
    box-shadow: 0 0 20px #B9F2FF, inset 0 0 10px #B9F2FF;
}

/* 6. LEGENDARY (Red Aura Breathing) */
.rank-border-legendary {
    border: 4px solid #FF4500 !important;
    animation: legendaryBreath 1.5s infinite alternate;
}

/* 7. MYTHICAL (RGB Fire Effect) */
.rank-border-mythical {
    border: 4px solid transparent !important;
    background-image: linear-gradient(#141423, #141423), linear-gradient(to right, #FF00FF, #00FFFF, #FF00FF) !important;
    background-origin: border-box !important;
    background-clip: content-box, border-box !important;
    box-shadow: 0 0 30px #FF00FF;
    animation: mythicalSpin 3s linear infinite;
}

/* Animations */
@keyframes goldPulse {
    0% { box-shadow: 0 0 5px rgba(255, 215, 0, 0.4); border-color: #DAA520; }
    50% { box-shadow: 0 0 15px rgba(255, 215, 0, 0.9); border-color: #FFD700; }
    100% { box-shadow: 0 0 5px rgba(255, 215, 0, 0.4); border-color: #DAA520; }
}
@keyframes legendaryBreath {
    from { box-shadow: 0 0 10px #FF4500; transform: scale(1); }
    to { box-shadow: 0 0 25px #FF4500; transform: scale(1.02); }
}
@keyframes mythicalSpin {
    0% { filter: hue-rotate(0deg); }
    100% { filter: hue-rotate(360deg); }
}

/* --- LOBBY RANK BACKGROUNDS (FINAL FIX - NO ZOOM) --- */

/* Base Settings */
#lobby-screen {
    transition: background 0.5s ease-in-out, border 0.3s ease;
    position: fixed; 
    top: 0; left: 0; width: 100%; height: 100%;
    z-index: 50;
    
    /* Pilitin na huwag mag-repeat */
    background-repeat: no-repeat !important;
    
    /* Pilitin na nasa gitna */
    background-position: center center !important;
    
    /* Pilitin na 'steady' lang */
    background-attachment: fixed !important;
}

/* 1. BRONZE & SILVER: Default Wood */
#lobby-screen.theme-classic {
    background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.8)), 
                url('https://i.imgur.com/T9ft7vz.jpeg') !important;
    
    /* ITO ANG SOLUSYON: Ulitin ang size dito sa loob */
    background-size: 100% 100% !important; 
    border: none !important; 
}

/* 2. GOLD & PLATINUM: Black Marble */
#lobby-screen.theme-gold {
    background: linear-gradient(rgba(0,0,0,0.2), rgba(0,0,0,0.9)), 
                url('https://i.imgur.com/DvdePuB.jpeg') !important;
    
    /* ITO ANG SOLUSYON: 100% width at 100% height */
    background-size: 100% 100% !important; 
    
    box-shadow: inset 0 0 50px rgba(255, 215, 0, 0.3) !important; 
    border: 4px solid #FFD700 !important;
}

/* 3. DIAMOND: Cyber Chrome */
#lobby-screen.theme-diamond {
    background: linear-gradient(rgba(0, 50, 100, 0.4), rgba(0,0,20,0.9)), 
                url('https://i.imgur.com/xHckgRf.jpeg') !important;

    /* ITO ANG SOLUSYON: Fit to screen */
    background-size: 100% 100% !important; 

    box-shadow: inset 0 0 50px rgba(0, 229, 255, 0.3) !important;
    border: 4px solid #00E5FF !important;
}

/* 4. LEGENDARY & MYTHICAL: Solid Gold */
#lobby-screen.theme-mythical {
    background: linear-gradient(rgba(50, 0, 0, 0.5), rgba(0,0,0,0.9)), 
                url('https://i.imgur.com/tgSGXgj.jpeg') !important;

    /* ITO ANG SOLUSYON: Fit to screen */
    background-size: 100% 100% !important; 

    border: 4px solid #FF4500 !important;
    animation: framePulse 3s infinite alternate;
}

/* Animation */
@keyframes framePulse {
    0% { box-shadow: inset 0 0 30px #8b0000; border-color: #FF4500; }
    100% { box-shadow: inset 0 0 100px #FF0000; border-color: #FFD700; }
}

/* --- FIXED PROFILE MODAL DESIGN --- */

/* Main Modal Content Wrapper */
#profile-modal .content {
    background: rgba(20, 20, 25, 0.95) !important;
    border: 2px solid #FFD700 !important;
    border-radius: 20px !important;
    padding: 20px !important;
    max-width: 400px !important;
    width: 90% !important;
    display: flex !important;
    flex-direction: column !important; /* Default Portrait: Patayo */
    align-items: center !important;
    position: relative !important;
    box-shadow: 0 0 50px rgba(0,0,0,0.8) !important;
}

/* Close Button */
#profile-close-btn {
    position: absolute !important;
    top: 10px !important;
    right: 15px !important;
    font-size: 2em !important;
    color: white !important;
    z-index: 50 !important;
    cursor: pointer;
}

/* Avatar Styling */
.avatar-container {
    position: relative;
    width: 100px;
    height: 100px;
    margin: 0 auto 10px auto;
}

#profile-avatar-img, #profile-avatar-default {
    width: 100%; height: 100%;
    border-radius: 50%;
    border: 3px solid #fff;
    box-shadow: 0 0 15px rgba(255,255,255,0.2);
    object-fit: cover;
}

#profile-avatar-default {
    display: flex; align-items: center; justify-content: center;
    font-size: 4em; background: rgba(255,255,255,0.1);
}

#profile-upload-btn {
    position: absolute; bottom: 0; right: 0;
    width: 30px; height: 30px;
    background: #00E5FF; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    border: 2px solid white; cursor: pointer; z-index: 10;
}

/* Text Styling */
#profile-name-display {
    font-size: 1.8em !important;
    color: white !important;
    margin: 5px 0 !important;
    text-shadow: 2px 2px 0 #000;
    font-family: 'Luckiest Guy', cursive;
}

#profile-rank-text-small {
    color: #FFD700; font-weight: bold; margin-bottom: 10px; font-size: 0.9em;
    display: none; /* Tago muna, sa trophy natin papakita */
}

/* TROPHY SHOWCASE (Gitna) */
.trophy-showcase {
    background: rgba(255, 215, 0, 0.05);
    border: 1px solid rgba(255, 215, 0, 0.2);
    border-radius: 15px;
    padding: 10px;
    width: 100%;
    margin-bottom: 15px;
    text-align: center;
}

#profile-trophy-icon {
    font-size: 4.5em !important;
    filter: drop-shadow(0 0 15px gold);
    animation: floatTrophy 3s ease-in-out infinite;
    line-height: 1;
}

#profile-rank-name {
    font-family: 'Luckiest Guy', cursive;
    font-size: 1.5em;
    color: #FFD700;
    text-transform: uppercase;
    text-shadow: 2px 2px 0 #000;
}

/* STATS GRID */
.stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    width: 100%;
    margin-bottom: 10px;
}

.stat-box {
    background: rgba(255,255,255,0.1);
    padding: 8px;
    border-radius: 10px;
    text-align: center;
}

.stat-label { font-size: 0.7em; color: #aaa; text-transform: uppercase; display: block; }
.stat-val { font-size: 1.3em; font-weight: 800; font-family: 'Nunito', sans-serif; }
.win-color { color: #33FF57; }
.lvl-color { color: #00E5FF; }

/* CUE PREVIEW */
.cue-preview-box {
    background: rgba(0,0,0,0.3);
    padding: 10px;
    border-radius: 10px;
    width: 100%;
    text-align: center;
}

#profile-cue-preview {
    width: 100%; height: 40px;
    background-size: contain; background-position: center; background-repeat: no-repeat;
    margin-top: 5px;
    filter: drop-shadow(0 2px 5px black);
}

.cue-name-text { color: #FFD700; font-weight: bold; font-size: 0.9em; }

@keyframes floatTrophy {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-8px); }
}

/* ========================================= */
/* üî• LANDSCAPE MODE FIX (THE MAGIC PART) üî• */
/* ========================================= */
@media (max-height: 500px) {
    
    #profile-modal .content {
        flex-direction: row !important; /* Gawing Magkatabi */
        width: 90vw !important;
        height: 90vh !important;
        max-width: 600px !important;
        padding: 15px !important;
        gap: 20px;
    }

    /* KALIWA: Avatar & Name */
    .profile-left-col {
        width: 40%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        border-right: 1px solid rgba(255,255,255,0.1);
        padding-right: 10px;
    }

    /* KANAN: Trophy & Stats */
    .profile-right-col {
        width: 60%;
        display: flex;
        flex-direction: column;
        justify-content: space-evenly;
    }

    /* Adjust sizes for Landscape */
    .avatar-container { width: 80px; height: 80px; }
    #profile-name-display { font-size: 1.3em !important; }
    
    .trophy-showcase { 
        padding: 5px; 
        margin-bottom: 5px; 
        background: transparent; /* Remove box bg in landscape to save space */
        border: none;
    }
    #profile-trophy-icon { font-size: 3em !important; }
    #profile-rank-name { font-size: 1.2em; }
    
    .stats-grid { margin-bottom: 5px; }
    .stat-box { padding: 5px; }
    .stat-val { font-size: 1.1em; }
}

        /* --- SPIN WHEEL FIXES --- */

/* 1. Portrait Mode (Default) - Siguraduhing kasya */
#daily-reward-modal .content {
    overflow-y: auto !important; /* Allow scroll kung sumobra sa liit ng screen */
    max-height: 95vh !important;
    display: flex !important;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

/* 2. Fix sa Button Clickability */
#daily-reward-modal canvas {
    pointer-events: none; /* Para lumusot ang click sa likod kung sakali */
}
#spin-btn {
    pointer-events: auto !important; /* Pilitin na mapipindot */
}

/* 3. LANDSCAPE MODE (Nakahiga) */
@media (max-height: 550px) and (orientation: landscape) {
    
    #daily-reward-modal .content {
        display: grid !important;
        /* Hatiin sa Dalawa: Kaliwa (Wheel), Kanan (Text/Button) */
        grid-template-columns: 1fr 1fr !important;
        grid-template-rows: auto 1fr !important;
        
        width: 90vw !important;
        height: 90vh !important;
        padding: 10px 20px !important;
        gap: 0px !important;
        align-items: center !important;
    }

    /* Title: Sakop ang buong taas */
    #daily-reward-modal h2 {
        grid-column: 1 / -1 !important;
        grid-row: 1 !important;
        font-size: 1.8em !important;
        margin: 5px 0 !important;
    }

    /* Wheel Container (Kaliwa) */
    #daily-reward-modal .content > div:first-of-type {
        grid-column: 1 !important;
        grid-row: 2 !important;
        
        /* Paliitin ang Wheel para magkasya */
        transform: scale(0.65) !important; 
        margin: -40px 0 0 -20px !important; /* I-adjust ang pwesto */
    }

    /* Text & Button (Kanan) */
    #spin-status-text {
        grid-column: 2 !important;
        grid-row: 2 !important;
        align-self: start !important;
        margin-top: 40px !important;
        font-size: 1em !important;
    }

    #spin-btn {
        grid-column: 2 !important;
        grid-row: 2 !important;
        align-self: center !important;
        margin-top: 20px !important;
        
        /* Paliitin ang button */
        font-size: 1.2em !important;
        padding: 8px 30px !important;
    }
    
    /* Close Button Adjustment */
    #daily-reward-close-btn {
        top: 5px !important;
        right: 10px !important;
    }
}

        /* ========================================= */
/* üé° SPIN WHEEL FIXES (ILAGAY SA CSS)    üé° */
/* ========================================= */

/* 1. Portrait Mode (Default) - Siguraduhing nasa gitna */
#daily-reward-modal .content {
    overflow-y: auto !important; /* Allow scroll kung sumobra sa liit ng screen */
    max-height: 95vh !important;
    display: flex !important;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

/* 2. CRITICAL FIX: Para mapindot ang button */
/* Ito ang dahilan kung bakit ayaw mapindot minsan, natatakpan siya ng invisible box ng canvas */
#daily-reward-modal canvas {
    pointer-events: none; /* Para lumusot ang click sa likod */
}
#spin-btn {
    pointer-events: auto !important; /* Pilitin na mapipindot */
    cursor: pointer !important;
    position: relative !important;
    z-index: 200 !important;
}

/* 3. LANDSCAPE MODE FIX (Nakahiga) */
@media (max-height: 550px) and (orientation: landscape) {
    
    #daily-reward-modal .content {
        display: grid !important;
        /* Hatiin sa Dalawa: Kaliwa (Wheel), Kanan (Text/Button) */
        grid-template-columns: 1fr 1fr !important;
        grid-template-rows: auto 1fr !important;
        
        width: 90vw !important;
        height: 90vh !important;
        padding: 10px 20px !important;
        gap: 0px !important;
        align-items: center !important;
    }

    /* Title: Sakop ang buong taas */
    #daily-reward-modal h2 {
        grid-column: 1 / -1 !important;
        grid-row: 1 !important;
        font-size: 1.8em !important;
        margin: 5px 0 !important;
    }

    /* Wheel Container (Kaliwa) */
    #daily-reward-modal .content > div:first-of-type {
        grid-column: 1 !important;
        grid-row: 2 !important;
        
        /* Paliitin ang Wheel para magkasya */
        transform: scale(0.65) !important; 
        margin: -40px 0 0 -20px !important; /* I-adjust ang pwesto */
    }

    /* Text & Button (Kanan) */
    #spin-status-text {
        grid-column: 2 !important;
        grid-row: 2 !important;
        align-self: start !important;
        margin-top: 40px !important;
        font-size: 1em !important;
    }

    #spin-btn {
        grid-column: 2 !important;
        grid-row: 2 !important;
        align-self: center !important;
        margin-top: 20px !important;
        
        /* Paliitin ang button */
        font-size: 1.2em !important;
        padding: 8px 30px !important;
    }
    
    /* Close Button Adjustment */
    #daily-reward-close-btn {
        top: 5px !important;
        right: 10px !important;
    }
}

/* --- CLEAN ELITE SIDEBAR (4-BUTTON SETUP) --- */

/* 1. Main Anchor (5% distansya sa gilid ng screen) */
#exit-button, 
#main-settings-btn, 
#utility-controls-container, 
#pektus-control {
    left: 7% !important; 
    right: auto !important;
    position: absolute !important;
    width: 50px !important; /* Standard width para sa lahat */
    margin: 0 !important;
    transform: none !important;
    z-index: 99999 !important;
    transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275) !important;
    box-shadow: 0 5px 15px rgba(0,0,0,0.4) !important;
}

/* 2. Perfect Vertical Spacing (Settings -> Shop -> Pektus -> Exit) */

/* SETTINGS */
#main-settings-btn {
    top: calc(50% - 105px) !important;
    height: 50px !important;
    background: linear-gradient(135deg, #6200ea, #311b92) !important;
    border: 2px solid #D500F9 !important;
    border-radius: 14px !important;
    display: flex !important; align-items: center; justify-content: center;
}

/* SHOP */
#utility-controls-container {
    top: calc(50% - 45px) !important;
    border: none !important; box-shadow: none !important; background: none !important;
}
#ingame-shop-button {
    width: 50px !important; height: 50px !important;
    background: linear-gradient(135deg, #FFD700, #B8860B) !important;
    border: 2px solid #FFF !important;
    border-radius: 14px !important;
    display: flex !important; align-items: center; justify-content: center;
}

/* PEKTUS */
#pektus-control {
    top: calc(50% + 15px) !important;
    height: 24px !important;
    background: #1a1a1a !important;
    border: 2px solid #FFD700 !important;
    border-radius: 6px !important;
}

/* EXIT */
#exit-button {
    top: calc(50% + 50px) !important;
    height: 40px !important;
    background: linear-gradient(135deg, #e53935, #b71c1c) !important;
    border: 2px solid #ff5252 !important;
    border-radius: 14px !important;
    color: white !important; font-weight: 900 !important; font-size: 11px !important;
    display: flex !important; align-items: center; justify-content: center;
}

/* Icons Styling */
.sidebar-icon {
    width: 28px; height: 28px; fill: white;
}

/* Power Bar Alignment (Right Balance) */
#power-control {
    right: 8% !important;
    top: 55% !important;
    transform: translateY(-50%) !important;
    border: 2px solid rgba(255, 215, 0, 0.4) !important;
    border-radius: 25px !important;
    background: rgba(0, 0, 0, 0.5) !important;
}
        
</style>
</head>
<body>

<div id="private-chat-modal" class="modal-overlay">
    <div class="content" style="width: 90%; max-width: 450px; height: 80vh; padding: 0;">
        
        <div style="background: rgba(0,0,0,0.5); padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; border-radius: 20px 20px 0 0;">
            <h2 id="private-chat-title" style="margin: 0; font-size: 1.5em; text-align: left;">Chat</h2>
            <span class="modal-close-btn" id="private-chat-close" style="position: relative; top: auto; right: auto; font-size: 2em;">&times;</span>
        </div>

        <div id="private-chat-history" style="flex-grow: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; background: rgba(0,0,0,0.2);">
            <div style="text-align: center; opacity: 0.5; font-style: italic;">Loading messages...</div>
        </div>

        <div style="padding: 15px; background: rgba(0,0,0,0.5); border-top: 1px solid rgba(255,255,255,0.1); display: flex; gap: 10px; border-radius: 0 0 20px 20px;">
            <input type="text" id="private-chat-input" placeholder="Type a message..." style="text-align: left; padding: 12px 15px;">
            <button id="private-chat-send-btn" class="menu-button" style="min-width: 60px; margin: 0; padding: 0; display: flex; justify-content: center; align-items: center;">
                ‚û§
            </button>
        </div>

    </div>
</div>

    <div id="start-overlay" class="modal-overlay">
    <h2>Pinoy Pool</h2>
    <p id="start-prompt-text" style="font-size: 1.5em; margin-top: -10px; color: rgba(255,255,255,0.8); cursor: pointer; display: none;">
        Click anywhere to start
    </p>

    <div id="start-name-input-area" style="display: flex; flex-direction: column; align-items: center;">
        <p style="font-size: 1.2em; margin-bottom: 10px; color: rgba(255,255,255,0.9);">
            Enter your name to start:
        </p>
        <input type="text" id="start-player-name-input" placeholder="Your Name" maxlength="15" style="font-family: 'Nunito', sans-serif; font-size: 1.3em; padding: 12px; margin: 10px; width: 280px; border-radius: 5px; border: 1px solid #ccc; text-align: center; background-color: rgba(255,255,255,0.1); color: white;">
        <button id="start-name-submit-btn" class="menu-button" style="width: 200px; margin-top: 15px; font-size: 1.1em; padding: 10px 20px;">Continue</button>
    </div>
    </div>

<div id="preloader-overlay">
    <div class="preloader-content">
        <h1 class="preloader-title">PINOY POOL</h1>
        <div class="loader-spinner"></div>
        <div id="loading-text">Loading Assets... 0%</div>
        
        <button id="start-game-btn" class="menu-button" style="display: none; font-size: 1.5em; padding: 15px 40px;">
            TAP TO START
        </button>
    </div>
</div>

    <!-- MOVED: Fullscreen button is now outside the game wrapper to be always visible -->
  

    <div id="game-wrapper">

    <div id="utility-controls-container">
        
        <button id="mute-button" class="ui-button icon-button" title="Toggle Music">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16" style="color: white;"><path d="M11.536 14.01A8.473 8.473 0 0 0 14.026 8a8.473 8.473 0 0 0-2.49-6.01l-1.414 1.414A6.472 6.472 0 0 1 12.026 8a6.472 6.472 0 0 1-1.904 4.596l1.414 1.414zM10.121 12.596A6.48 6.48 0 0 0 12.026 8a6.48 6.48 0 0 0-1.905-4.596l-1.414 1.414A4.486 4.486 0 0 1 10.026 8a4.486 4.486 0 0 1-1.319 3.182l1.414 1.414zM8.707 11.182A2.482 2.482 0 0 0 9.026 8a2.482 2.482 0 0 0-.32-1.182L8 7.525v1.95l.707.707zM6.717 3.55A.5.5 0 0 1 7 4v8a.5.5 0 0 1-.812.39L3.825 10H1.5A.5.5 0 0 1 1 9.5v-3A.5.5 0 0 1 1.5 6h2.325l2.363-2.39a.5.5 0 0 1 .529-.06z"/></svg>
        </button>

    
        <button id="ingame-shop-button" class="ui-button icon-button">
    <svg class="sidebar-icon" viewBox="0 0 24 24" style="fill: #000;">
        <path d="M12,13A5,5 0 0,1 7,8H9A3,3 0 0,0 12,11A3,3 0 0,0 15,8H17A5,5 0 0,1 12,13M12,3A3,3 0 0,1 15,6H9A3,3 0 0,1 12,3M19,6H17V6A5,5 0 0,0 12,1A5,5 0 0,0 7,6V6H5C3.89,6 3,6.89 3,8V20A2,2 0 0,0 5,22H19A2,2 0 0,0 21,20V8C21,6.89 20.11,6 19,6Z" />
    </svg>
</button>
        
        
        <button id="fullscreen-button" class="ui-button icon-button" title="Toggle Fullscreen">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16" style="color: white;"><path d="M1.5 1a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4A1.5 1.5 0 0 1 1.5 0h4a.5.5 0 0 1 0 1h-4zM10 .5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 16 1.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5zM.5 10a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 0 14.5v-4a.5.5 0 0 1 .5-.5zm15 0a.5.5 0 0 1 .5.5v4a1.5 1.5 0 0 1-1.5 1.5h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5z"/></svg>
        </button>
    </div>   

        <img id="cue-stick-element">

        <div id="table-frame">
            <canvas id="game-canvas"></canvas>
        </div>

        <button id="chat-toggle-button" class="icon-button" style="display: none; position: absolute; transform: translateY(-50%); z-index: 151; background: none; border: none; box-shadow: none; width: 30px; height: 30px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16" style="color: white;"><path d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.5a1 1 0 0 0-.8.4l-1.9 2.533a1 1 0 0 1-1.6 0L5.3 12.4a1 1 0 0 0-.8-.4H2a2 2 0 0 1-2-2V2zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h2.5a2 2 0 0 1 1.6.8L8 14.333 9.9 11.8a2 2 0 0 1 1.6-.8H14a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H2z"/></svg>
        </button>

        <img id="ghost-hand" src="https://i.imgur.com/yCvO16j.png">
        
        <div id="non-interactive-overlay">
    
    <div id="currency-display" class="info-box">
    <span style="color: #FFD700; font-weight: bold;">üí∞:</span> <span class="coin-balance-display">0</span>
</div>
<div id="xp-container" style="position: absolute; bottom: 5px; left: 5px; background-color: var(--dark-bg); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 10px; 
    
    padding: 1px 3px; /* <--- GINAWA KONG 3px (taas/baba) at 5px (kaliwa/kanan) */
    
    display: flex; align-items: center; backdrop-filter: blur(5px); z-index: 10; white-space: nowrap;
    
    gap: 0px; 
">
    
    <div id="xp-level" style="font-size: 0.8em; font-weight: bold; color: var(--light-text); flex-shrink: 0;
      
        padding-right: 4px;
    ">
          <span id="player-level-display">1</span>
    </div>
    
    <div id="xp-bar-wrapper" style="width: 80px; height: 8px; background-color: rgba(0,0,0,0.5); border: 1px solid rgba(0,0,0,0.7); border-radius: 4px; position: relative; overflow: hidden;">
        <div id="xp-bar-fill-new" style="position: absolute; top: 0; left: 0; height: 100%; width: 0%; background: linear-gradient(to right, #33FF57, #28a745); border-radius: 4px; transition: width 0.3s ease; z-index: 1;"></div>
    </div>

    <div id="xp-text-display-new" style="font-size: 0.8em; font-weight: bold; color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        
        
        padding-left: 4px;
    ">
        0/100
    </div>

</div>
    
    <div id="player-info" class="info-box">You: ?</div>
    <div id="opponent-info" class="info-box">Opponent: ?</div>
    </div>
            <div id="message-box"></div>
            <div id="cue-ball-guide" class="guide-text"></div>
            <div id="chat-container">
                <div id="chat-messages"></div>
                <div id="chat-input-area">
                    <input type="text" id="chat-input" placeholder="Type a message...">
                    <button id="chat-send-btn">Send</button>
                </div>
            </div>
            <div id="drag-guide-text" class="guide-text">Place the cue ball</div>
        </div>

        <button id="exit-button" class="ui-button">Exit</button>
        <div id="card-hand-container"></div>
        
        <div id="power-control" class="control-area">
    <div id="power-bar"></div>
    <img id="power-cue-img" src="https://i.imgur.com/dKur0qc.png">
</div>
        <div id="pektus-control" class="control-area">
            <div id="pektus-dot"></div>
        </div>
        <div id="left-arrow" class="arrow-button control-area">&lt;</div>
        <div id="right-arrow" class="arrow-button control-area">&gt;</div> 

</div>

<div id="pektus-modal" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; flex-direction: column;">
    
    <h2 style="color: #FFD700; font-family: 'Luckiest Guy'; margin-bottom: 20px; text-shadow: 2px 2px 0 #000; letter-spacing: 2px; pointer-events: none;">ADJUST SPIN</h2>
    
    <div id="big-cue-ball" style="
        width: 300px; 
        height: 80px; 
        background: linear-gradient(to bottom, #FFD700 0%, #E6C200 100%);
        border-radius: 12px; 
        position: relative; 
        box-shadow: 0 10px 25px rgba(0,0,0,0.5); 
        border: 2px solid #B8860B;">
        
        <div style="position: absolute; top: 50%; left: 0; width: 100%; height: 1px; background: rgba(0,0,0,0.1); border-top: 1px dashed rgba(255,255,255,0.3); pointer-events: none;"></div>
        <div style="position: absolute; top: 0; left: 50%; width: 1px; height: 100%; background: rgba(0,0,0,0.1); border-left: 1px dashed rgba(255,255,255,0.3); pointer-events: none;"></div>
        
        <div id="big-red-dot" style="width: 30px; height: 30px; background: red; border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.5); pointer-events: none;"></div>
        
        <div id="big-pektus-touch-area" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: pointer;"></div>
    </div>
    
    <p style="color: white; margin-top: 15px; font-size: 14px; text-shadow: 1px 1px 2px black; pointer-events: none;">(Release to Set)</p>
</div>
<div id="lobby-screen" style="display: none;">
    
    <div class="lobby-header">
        <div class="profile-section">
            <div class="avatar-circle">üë§</div>
            <div class="profile-details">
                <div id="lobby-player-name" class="player-name-display">Loading...</div>
                <div id="lobby-level-badge" class="level-badge">Lv. 1</div>
            </div>
        </div>
        
        <div class="currency-section">
            <div class="coin-pill">
                üí∞ <span class="coin-balance-display">0</span>
            </div>
        </div>
    </div>

    <div class="lobby-main">
        <div id="online-button" class="game-card primary-card">
            <div class="card-bg"></div>
            <div class="card-content">
                <div class="card-icon">üåç</div>
                <div class="card-title">PLAY ONLINE</div>
                <div class="card-subtitle">Ranked Match ‚Ä¢ PVP</div>
            </div>
        </div>

        <div id="vs-ai-button" class="game-card secondary-card">
            <div class="card-content">
                <div class="card-icon">ü§ñ</div>
                <div class="card-title">PRACTICE</div>
                <div class="card-subtitle">vs AI Computer</div>
            </div>
        </div>

        <div id="ton-connect" style="margin-top: 15px; margin-bottom: 10px; display: flex; justify-content: center;"></div>
    </div>

    <div class="lobby-dock">
        <div id="shop-button" class="dock-item">
            <div class="dock-icon">üõí</div>
            <div class="dock-label">Shop</div>
        </div>
        <div id="leaderboard-button" class="dock-item">
            <div class="dock-icon">üèÜ</div>
            <div class="dock-label">Top</div>
        </div>
        <div id="friends-button" class="dock-item">
            <div class="dock-icon">üë•</div>
            <div class="dock-label">Friends</div>
        </div>
        <div id="daily-reward-button" class="dock-item">
            <div class="dock-icon">üéÅ</div>
            <div class="dock-label">Reward</div>
        </div>
    </div>
</div>

  </div> <div id="game-mode-select" class="modal-overlay" style="display: none;">
</div>

<div id="ai-menu" class="modal-overlay">
    <span class="modal-close-btn" id="ai-menu-close-btn">&times;</span> <h2>Player vs AI</h2>
    <button class="menu-button" id="ai-straight-ball-button">STRAIGHT BALL</button>
    <button class="menu-button" id="ai-poker-button">POKER</button>
    <button class="menu-button" id="ai-61-button">61 BALL</button>
    </div>
    <!-- REMOVED: Difficulty select modal is no longer needed -->
    <!-- <div id="difficulty-select" class="modal-overlay"> ... 
 </div> -->
   <div id="straight-ball-instructions" class="modal-overlay instruction-modal"> ... <div class="content"> <div class="play-button-container"> <button class="menu-button" id="play-straight-ball-button">Play</button> </div> <h2>Straight Ball Rules</h2> <p> - Continue your turn by legally pocketing your balls.<br> - The first color legally pocketed on an 'open table' becomes yours.<br> - <strong>Foul:</strong> Pocketing the cue ball returns one of your pocketed balls to the table.<br> - <strong>Foul:</strong> Hitting an opponent's ball first returns any of your balls pocketed on that shot.<br> - First to pocket all their balls wins! </p> </div> </div>
    <div id="poker-instructions" class="modal-overlay instruction-modal"> <div class="content"> <div class="play-button-container"> <button class="menu-button" id="play-poker-button">Play</button> </div> <h2>Poker Pool Rules</h2> <p> - You get 7 cards. Pocket balls matching your cards to win.<br> - A hand of all Kings is an automatic win.<br> - <strong>Cue Ball Foul:</strong> Pocketing the cue ball forces you to draw a penalty card.<br> - <strong>Last Ball Foul:</strong> If you scratch on your last ball, you draw a card. A King wins the game, otherwise, play continues with the new card.<br> - A penalty card matching a pocketed ball is discarded. </p> </div> </div>
    <div id="61-ball-instructions" class="modal-overlay instruction-modal"> <div class="content"> <div class="play-button-container"> <button class="menu-button" id="play-61-ball-button">Play</button> </div> <h2>61 Ball Rules</h2> <p> - The goal is to be the first to score 61 points.<br> - You must always hit the lowest numbered chip on the table first.<br> - Your score is the sum of the numbers on the chips you legally pocket.<br> - <strong>Example:</strong> Hit the 1-chip first, and the 15-chip is pocketed. You get 15 points.<br> - Your turn continues as long as you legally pocket a chip.<br> - <strong>Foul:</strong> Hitting the wrong chip first, or scratching the cue chip, ends your turn. Your opponent gets ball-in-hand. Any chips pocketed on a foul shot will be returned to the table. </p> </div> </div>
    <div id="poker-foul-card-pick-modal" class="modal-overlay"> <h2>Foul! Pick a card.</h2> <div id="poker-foul-cards"></div> </div>
    <div id="online-game-select" class="modal-overlay">
    <span class="modal-close-btn" id="online-select-close-btn">&times;</span>
    <h2>Online: Select Game Type</h2>
    <button class="menu-button" id="online-poker-button">POKER POOL</button>
    <button class="menu-button" id="online-straight-ball-button">STRAIGHT BALL</button>
    <button class="menu-button" id="online-61-button">61 BALL</button>
</div>
    
    
<div id="online-menu" class="modal-overlay">
    <span class="modal-close-btn" id="online-menu-close-btn">&times;</span>
    <h2>Online Pustahan</h2> 

    <div id="bet-selection-container" style="display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; justify-content: center;">
        </div>

    <p id="bet-status-text" style="color: #FFD700; font-weight: bold; margin-bottom: 20px; font-size: 1.1em; text-shadow: 0 2px 4px rgba(0,0,0,0.5);">
        Current Pot: Free Play
    </p>

    <div id="online-menu-columns">
        <div class="online-column" id="online-column-left">
            <button class="menu-button" id="create-game-button">Create Private</button>
            <button class="menu-button" id="join-game-button">Join Private</button>
            <input type="text" id="game-id-input" placeholder="Enter Game ID">
        </div>
        
        <div class="online-column" id="online-column-right">
             <button class="menu-button" id="find-match-button" style="background-image: linear-gradient(to right, #0ba360 0%, #3cba92 100%); box-shadow: 0 0 15px #28a745; font-size: 1.1em;">
                FIND MATCH
             </button>
             <p style="margin: 15px 0; font-size: 0.9em; color: rgba(255,255,255,0.7);">- OR -</p>
             <button class="menu-button back-button" id="online-back-button" style="display: none;">Back</button> 
        </div>
    </div> 
</div>
¬† ¬† <!-- === END PLAYER NAME UPDATE === -->
    <div id="waiting-room" class="modal-overlay"> <span class="modal-close-btn" id="waiting-room-close-btn">&times;</span> <h2>Waiting for Opponent...</h2> <p>Share this Game ID with your friend:</p> <div id="game-id-display" title="Click to copy"></div> </div>
    <div id="matchmaking-wait-modal" class="modal-overlay"> <span class="modal-close-btn" id="matchmaking-close-btn">&times;</span> <h2>Searching for an opponent...</h2> <div class="loader"></div> </div>
    
    <!-- == WINNER MODAL UPDATE == -->
    <div id="winner-modal" class="modal-overlay">
        <div class="winner-modal-content-wrapper">
            <div class="winner-text-and-buttons">
                <h2 id="winner-text"></h2>
                <!-- Button for AI Rematch (formerly Play Again) -->
                <button id="ai-rematch-button" style="display: none;">Rematch</button>
                <!-- Button to go back to Menu (New) -->
                <button id="back-to-menu-button" style="display: none;">Back to Menu</button>
                 <!-- Button for Online Rematch Request (Original, stays hidden for AI) -->
                <button id="rematch-button" class="menu-button">Request Rematch</button>
            </div>
            <div id="opponent-hand-reveal"></div>
        </div>
    </div>
    <!-- == END WINNER MODAL UPDATE == -->

    <div id="confirm-exit-modal" class="modal-overlay"> <h2>Are you sure you want to exit?</h2> <p>This will count as a loss if you are in an online game.</p> <div class="button-group"> <button id="confirm-exit-yes" class="menu-button confirm-button">Yes</button> <button id="confirm-exit-cancel" class="menu-button confirm-button">Cancel</button> </div> </div>
    <div id="leaderboard-modal" class="modal-overlay"> <div class="content"> <span class="modal-close-btn" id="leaderboard-close-btn">&times;</span> <h2>Top Players</h2> <table> <thead> <tr> <th>Rank</th> <th>Name</th> <th>Wins</th> </tr> </thead> <tbody id="leaderboard-body"> <tr><td colspan="3" style="text-align: center; padding: 20px;">Loading...</td></tr> </tbody> </table> </div> </div>

<div id="shop-modal" class="modal-overlay">
    <div class="content" style="width: 80%; max-width: 600px; max-height: 80vh;">

        <span class="modal-close-btn" id="shop-close-btn">&times;</span>

        <h2>üõí Shop</h2>
        <p style="margin-top: -10px; margin-bottom: 10px;">
            Buy new cue sticks with your coins!
        </p>
        <div class="modal-coin-display" style="margin-bottom: 15px; font-size: 1.2em;">
            Your Coins: üí∞ <span class="coin-balance-display">0</span>
        </div>
               <div id="shop-items-container">
            </div>
    </div>
</div>

<div id="settings-modal" class="modal-overlay">
    <div class="content settings-content">
        <span class="modal-close-btn" id="settings-close-btn">&times;</span>
        <h2>‚öôÔ∏è SETTINGS</h2>
        <div class="settings-list">
            <div class="setting-item">
                <div class="setting-label"><span>üéµ Background Music</span></div>
                <label class="switch"><input type="checkbox" id="setting-music-toggle" checked><span class="slider round"></span></label>
            </div>
            <div class="setting-item">
                <div class="setting-label"><span>üîä Sound Effects</span></div>
                <label class="switch"><input type="checkbox" id="setting-sfx-toggle" checked><span class="slider round"></span></label>
            </div>
            <div class="setting-item">
                <div class="setting-label"><span>üì∫ Fullscreen Mode</span></div>
                <label class="switch"><input type="checkbox" id="setting-fullscreen-toggle"><span class="slider round"></span></label>
            </div>
        </div>
        <div style="margin-top: 20px; font-size: 0.8em; opacity: 0.6;">Pinoy Pool v1.0 ‚Ä¢ Made by DugZHak</div>
    </div>
</div>

<div id="profile-modal" class="modal-overlay">
    <div class="content">
        
        <span class="modal-close-btn" id="profile-close-btn">&times;</span>
        
        <div class="profile-left-col">
            <div class="avatar-container">
                <img id="profile-avatar-img" class="viewable-img" src="" style="display: none;">
                <div id="profile-avatar-default">üë§</div>
                <div id="profile-upload-btn">üì∑</div>
            </div>
            
            <input type="file" id="profile-file-input" accept="image/*" style="display: none;">
            
            <h2 id="profile-name-display">Player Name</h2>
            <div id="profile-rank-text-small">[Rank]</div> </div>

        <div class="profile-right-col">
            
            <div class="trophy-showcase">
    <div id="profile-trophy-icon">üèÜ</div>
    <div id="profile-rank-name">RANK NAME</div>

    <div class="rank-progress-wrapper" style="width: 80%; margin: 10px auto;">
        
        <div style="background: rgba(0,0,0,0.5); height: 10px; border-radius: 5px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1);">
            <div id="profile-rank-fill" style="width: 0%; height: 100%; background: linear-gradient(to right, #00b09b, #96c93d); transition: width 0.5s ease;"></div>
        </div>
        
        <div id="profile-rank-next-text" style="font-size: 0.75em; color: #ccc; margin-top: 5px; font-weight: bold;">
            Loading...
        </div>
    </div>
    </div>

            <div class="stats-grid">
                <div class="stat-box">
                    <span class="stat-label">WINS</span>
                    <span id="profile-wins-display" class="stat-val win-color">0</span>
                </div>
                <div class="stat-box">
                    <span class="stat-label">LEVEL</span>
                    <span id="profile-level-display" class="stat-val lvl-color">1</span>
                </div>
            </div>

            <div class="cue-preview-box">
                <span class="stat-label">Equipped:</span>
                <span id="profile-cue-name" class="cue-name-text">Default</span>
                <div id="profile-cue-preview"></div>
            </div>
        </div>

    </div>
</div>

<div id="credits-container">
    <p style="margin: 2px;">Gawa ni: DugZHak</p>
    <p style="margin: 2px; font-size: 0.8em;">Music from GitHub</p>
</div>

<div id="tutorial-overlay" class="modal-overlay">
    <div id="tutorial-highlight"></div>
    <div id="tutorial-box">
        <p id="tutorial-text"></p>
        <button id="tutorial-next-btn">Next</button>
    </div>
</div>

<div id="vs-screen-modal" class="modal-overlay">
    <div id="vs-content-box">
        <div class="vs-player-box" id="vs-player-1-box">
            <div class="vs-player-rank" id="vs-player-1-rank">[Master]</div>
            <div class="vs-player-name" id="vs-player-1-name">Player 1</div>
        </div>
        <div id="vs-divider">VS</div>
        <div class="vs-player-box" id="vs-player-2-box">
            <div class="vs-player-rank" id="vs-player-2-rank">[Hustler]</div>
            <div class="vs-player-name" id="vs-player-2-name">Player 2</div>
        </div>
    </div>
    <h3 id="vs-game-mode">POKER POOL</h3>
</div>

</div>

    <div id="friends-modal" class="modal-overlay">
    <div class="content" style="width: 80%; max-width: 500px; max-height: 80vh;">
        
        <span class="modal-close-btn" id="friends-modal-close-btn">&times;</span>
        <h2>ü§ù Friends List</h2>

        <div class="friends-search-container">
            <input type="text" id="friend-search-input" placeholder="Enter player name...">
            <button class="menu-button lobby-button" id="add-friend-btn">Add</button>
        </div>
        <div id="friend-search-results" class="friends-search-results">
            </div>

        <div class="friends-lists-wrapper">

            <h3 class="friends-subheader">Pending Requests</h3>
            <div id="friends-list-pending" class="friends-list-container">
                <div class="friend-item-empty">No pending requests.</div>
            </div>
    
            <h3 class="friends-subheader">My Friends</h3>
            <div id="friends-list-accepted" class="friends-list-container">
                <div class="friend-item-empty">You have no friends yet.</div>
            </div>

        </div> </div>
</div>

      <div id="invite-popup-modal" class="modal-overlay">
    <div class="content" style="width: 80%; max-width: 450px;">
        
        <h2 id="invite-popup-title" style="font-size: 2.2em; margin-bottom: 10px;">Game Invite!</h2>
        <p id="invite-popup-text" style="font-size: 1.2em; line-height: 1.5; margin-bottom: 25px;">
            Si [Player Name] ay iniimbita ka sa isang laro!
        </p>
        
        <div class="button-group">
             <button id="invite-accept-btn" class="menu-button confirm-button" style="background-color: #28a745; width: 150px;">Accept</button>
             <button id="invite-decline-btn" class="menu-button confirm-button" style="background-color: #dc3545; width: 150px;">Decline</button>
        </div>
        
    </div>
</div>

<div id="invite-wait-modal" class="modal-overlay">
    <span class="modal-close-btn" id="invite-wait-close-btn">&times;</span>
    <h2>Waiting for Friend</h2>
    <p id="invite-wait-text" style="font-size: 1.2em; margin-bottom: 20px;">
        Waiting for [Friend Name] to accept...
    </p>
    <div class="loader"></div>
</div>

<div id="invite-game-select" class="modal-overlay">
    <span class="modal-close-btn" id="invite-game-select-close-btn">&times;</span>
    <h2>Invite Friend</h2>
    
    <p style="font-size: 1.1em; margin-top: -10px; margin-bottom: 10px;">
        Inviting: <strong id="invite-friend-name-display" style="color:var(--gold-accent)">...</strong>
    </p>

    <p style="margin-bottom: 5px; font-size: 0.9em; opacity: 0.8;">Select Bet:</p>
    <div id="invite-bet-container" style="display: flex; gap: 5px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center;">
        </div>

    <p id="invite-bet-status" style="color: #FFD700; font-weight: bold; margin-bottom: 15px; font-size: 1em;">
        Bet: Free Play
    </p>

    <button class="menu-button" id="invite-poker-button">POKER POOL</button>
    <button class="menu-button" id="invite-straight-ball-button">STRAIGHT BALL</button>
    <button class="menu-button" id="invite-61-button">61 BALL</button>
</div>

<div id="daily-reward-modal" class="modal-overlay">
    <div class="content" style="width: 90%; max-width: 450px; text-align: center; position: relative; overflow: visible; background: radial-gradient(circle, #2b32b2 0%, #141e30 100%); border: 2px solid #FFD700; box-shadow: 0 0 30px #FFD700;">
        
        <span class="modal-close-btn" id="daily-reward-close-btn" style="top: 10px; right: 15px; z-index: 100;">&times;</span>
        
        <h2 style="color: #FFD700; text-shadow: 0 0 10px #FFD700; margin-bottom: 10px; font-family: 'Luckiest Guy', cursive; font-size: 2.5em;">LUCKY SPIN üé°</h2>
        
        <div style="position: relative; width: 300px; height: 300px; margin: 0 auto;">
            
            <canvas id="spin-wheel-canvas" width="300" height="300"></canvas>
            
            <div style="
                position: absolute; 
                top: -15px; 
                left: 50%; 
                transform: translateX(-50%); 
                width: 0; 
                height: 0; 
                border-left: 15px solid transparent;
                border-right: 15px solid transparent;
                border-top: 25px solid #FF0000; 
                filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5));
                z-index: 10;">
            </div>

            <div style="
                position: absolute; 
                top: 50%; left: 50%; 
                transform: translate(-50%, -50%); 
                width: 40px; height: 40px; 
                background: #FFF; 
                border-radius: 50%; 
                box-shadow: 0 0 10px rgba(0,0,0,0.5); 
                display: flex; justify-content: center; align-items: center;
                font-size: 20px; z-index: 5;">
                üé±
            </div>
        </div>

        <p id="spin-status-text" style="margin-top: 20px; font-size: 1.2em; font-weight: bold; color: white;">
            Spin to Win Coins!
        </p>

        <button id="spin-btn" class="menu-button" style="position: relative; z-index: 200; pointer-events: auto; background: linear-gradient(to bottom, #FFD700, #FFA500); color: black; font-size: 1.5em; padding: 10px 50px; margin-top: 10px; border: 2px solid white; box-shadow: 0 0 15px #FFD700; cursor: pointer;">
    SPIN!
</button>

    </div>
</div>

    
    <audio id="bg-music-reggae-1" src="https://arnoldtasipit66-wq.github.io/my-game-assets/mrbas-music-labs-roots-reggae-285790.mp3" crossorigin="anonymous" loop></audio>
    <audio id="bg-music-reggae-2" src="https://arnoldtasipit66-wq.github.io/my-game-assets/mrbas-music-labs-roots-reggae-285790.mp3" crossorigin="anonymous" loop></audio>

<audio id="coin-sfx" src="https://arnoldtasipit66-wq.github.io/my-game-assets/coin-dropped-81172.mp3" crossorigin="anonymous"></audio>

    <audio id="win-sfx" src="https://arnoldtasipit66-wq.github.io/my-game-assets/win.mp3" crossorigin="anonymous"></audio>
    <audio id="lose-sfx" src="https://arnoldtasipit66-wq.github.io/my-game-assets/lose.mp3" crossorigin="anonymous"></audio>


<button id="main-settings-btn" class="ui-button icon-button">
    <svg class="sidebar-icon" viewBox="0 0 24 24">
        <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.35 19.43,11.03L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.65 15.47,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.53,5.32 7.96,5.65 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11.03C4.53,11.35 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.04 4.95,18.95L7.44,17.95C7.96,18.35 8.53,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.47,18.68 16.04,18.35 16.56,17.95L19.05,18.95C19.27,19.04 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z" />
    </svg>
</button>

    <div id="full-image-modal" class="modal-overlay" style="background-color: rgba(0,0,0,0.95) !important; z-index: 20000;">
    <span class="modal-close-btn" id="full-image-close-btn" style="top: 20px; right: 20px; font-size: 3em;">&times;</span>
    
    <div style="display: flex; justify-content: center; align-items: center; width: 100%; height: 100%;">
        <img id="full-image-display" src="" style="max-width: 90%; max-height: 80vh; border: 3px solid #FFD700; box-shadow: 0 0 30px rgba(255, 215, 0, 0.5); border-radius: 10px; object-fit: contain;">
    </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, getDoc, deleteDoc, serverTimestamp, increment, collection, query, orderBy, limit, getDocs, addDoc, runTransaction, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getDatabase, ref, onValue, onDisconnect, set } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
const SERVER_URL = "https://pinoypooldugz-pldf60qvz-arnoldtasipit66-wqs-projects.vercel.app";
// --- DITO MAGSISIMULA ANG TELEGRAM SETUP ---
const tg = window.Telegram.WebApp; // Ngayon, kilala na ng code mo si 'tg'
tg.ready(); // Sinasabi nito sa Telegram na handa na ang game
tg.expand(); // Para mag-full screen
tg.enableClosingConfirmation(); // Ito ang sikreto para magtanong bago mag-close
function handleExitRequest() {
    if (typeof tg !== 'undefined') {
        // Ipakita ang native Telegram confirmation dialog
        tg.showConfirm("Are you sure you want to exit Pinoy Pool Monster?", (isConfirmed) => {
            if (isConfirmed) {
                // Kung pinindot ng player ang 'OK' o 'Yes'
                console.log("Exiting game...");
                tg.close(); // Isasara ang buong Telegram Mini App
            } else {
                // Kung 'Cancel', mananatili lang sa laro
                console.log("Exit cancelled.");
            }
        });
    }
}
// --- 2. ANG PINAKAMALUPIT NA TAGABANTAY NG BACK BUTTON ---
tg.BackButton.onClick(() => {
    const activeModal = document.querySelector('.modal-overlay.show');
    
    if (activeModal) {
        activeModal.classList.remove('show');
        window.isClosingModal = true;
        
        // Tawagin ang popstate logic nang manual para mag-sync ang history
        history.back();
        
        // Pagkatapos ng back, i-check ang state
        setTimeout(() => {
            restoreGameState();
            // Itago ang BackButton kung wala na talagang modals
            if (!document.querySelector('.modal-overlay.show')) {
                tg.BackButton.hide();
            }
        }, 50);
    } else {
        handleExitRequest();
    }
});      
               // Gawin nating window properties para ma-access kahit saan
let db, auth, rtdb, firebaseInitialized = false, isAuthReady = false;
window.localPlayerUid = null; // Idagdag ito
window.db = null;             // Idagdag ito

let tempInviteFriendUid = null;
let tempInviteFriendName = null;

// --- ü§ñ STEP 1: BOT NAME GENERATOR ü§ñ ---
const BotGenerator = {
    prefixes: [
        "Boy", "Mang", "Aling", "Totoy", "Nene", "Boss", "Lodi", 
        "Master", "Batang", "King", "Don", "Pareng", "Kuya", "Ate"
    ],
    roots: [
        "Sili", "Bawang", "Pogi", "Ganda", "Tumbok", "Sargo", 
        "Pektus", "Kanto", "Quiapo", "Tondo", "Manila", "Davao", 
        "Cebu", "Barako", "Agimat", "Cardo", "Bato", "Malupit", 
        "Tigas", "Lupet", "Hustler", "Shark"
    ],
    generateName: function() {
        const pre = this.prefixes[Math.floor(Math.random() * this.prefixes.length)];
        const root = this.roots[Math.floor(Math.random() * this.roots.length)];
        const hasNumber = Math.random() < 0.4; // 40% chance may number
        const number = hasNumber ? Math.floor(Math.random() * 99) : "";
        return `${pre}${root}${number}`;
    }
};
// ----------------------------------------


        const musicPlayer1 = document.getElementById('bg-music-reggae-1'), musicPlayer2 = document.getElementById('bg-music-reggae-2'), muteButton = document.getElementById('mute-button');
        const backgroundPlaylist = [musicPlayer1, musicPlayer2];
const VIRTUAL_WIDTH = 950;
const VIRTUAL_HEIGHT = 500;

let lastTime = 0;
        let accumulator = 0;
        const FIXED_DELTA_TIME_MS = 1000 / 60; 
        const FIXED_DELTA_TIME_SEC = 1 / 60.0; 
        const VELOCITY_MULTIPLIER = 60; 
let playerTotalCurrency = 0;
let currentMatchBet = 0; 
const CURRENCY_NAME = "Coins"; 
const REWARD_PER_BALL = 10;
const REWARD_WIN_BONUS = 100;
const REWARD_LOSE_CONSOLATION = 25;


const XP_PER_BALL = 10;         
const XP_WIN_BONUS = 50;
const XP_LOSE_CONSOLATION = 15;
const LEVEL_UP_COIN_REWARD = 250; 

const RANKS = [
    { name: "Bronze",       minTrophies: 0,      color: "#CD7F32", icon: "ü•â", cssClass: "rank-border-bronze" },
    { name: "Silver",       minTrophies: 500,    color: "#C0C0C0", icon: "ü•à", cssClass: "rank-border-silver" }, 
    { name: "Gold",         minTrophies: 1500,   color: "#FFD700", icon: "ü•á", cssClass: "rank-border-gold" }, 
    { name: "Platinum",     minTrophies: 3000,   color: "#00CED1", icon: "üí†", cssClass: "rank-border-platinum" }, 
    { name: "Diamond",      minTrophies: 6000,   color: "#B9F2FF", icon: "üíé", cssClass: "rank-border-diamond" }, 
    { name: "Legendary",    minTrophies: 10000,  color: "#FF4500", icon: "üëë", cssClass: "rank-border-legendary" }, 
    { name: "Mythical",     minTrophies: 20000,  color: "#FF00FF", icon: "üî•", cssClass: "rank-border-mythical" }  
];

let playerLevel = 1;
let currentCombo = 0; 
let isFriendsListLoaded = false;
let playerXP = 0;
let playerTrophies = 0; 
let xpToNextLevel = 100;

// --- DITO MO ILAGAY ---
let adWatchProgress = JSON.parse(localStorage.getItem('pinoyPoolAdProgress')) || {};
// ----------------------

const SHOP_ITEMS = {
    cues: [
        {
            id: 'default',
            name: 'Kawayan (Default)',
            price: 0,
            adRequired: 0,
            imageSrc: 'https://i.imgur.com/dKur0qc.png',
            displayWidth: 450, displayHeight: 150,
            stats: { Power: 2, Aim: 2, Spin: 2 }
        },
        {
            id: 'makabayan',
            name: 'Makabayan',
            price: 2500,
            adRequired: 1, // Madaling makuha!
            imageSrc: 'https://i.imgur.com/LylPqwJ.png',
            displayWidth: 450, displayHeight: 150,
            stats: { Power: 4, Aim: 4, Spin: 3 }
        },
        {
            id: 'watawat_special',
            name: 'Watawat Special',
            price: 12000,
            adRequired: 2,
            imageSrc: 'https://i.imgur.com/hBVzIDy.png',
            displayWidth: 450, displayHeight: 150,
            stats: { Power: 6, Aim: 5, Spin: 5 }
        },
        {
            id: 'mandirigma',
            name: 'Mandirigma',
            price: 35000,
            adRequired: 5,
            imageSrc: 'https://i.imgur.com/syLWSqJ.png',
            displayWidth: 450, displayHeight: 150,
            stats: { Power: 7, Aim: 6, Spin: 8 }
        },
        {
            id: 'datu_tribal',
            name: 'Datu Chieftain',
            price: 85000,
            adRequired: 7,
            imageSrc: 'https://i.imgur.com/MjILiWq.png',
            displayWidth: 450, displayHeight: 150,
            stats: { Power: 8, Aim: 8, Spin: 7 }
        },
        {
            id: 'perlas_legend',
            name: 'Perlas ng Silangan',
            price: 200000,
            adRequired: 12,
            imageSrc: 'https://i.imgur.com/GrDaD6o.png',
            displayWidth: 450, displayHeight: 150,
            stats: { Power: 10, Aim: 9, Spin: 10 }
        },
        {
            id: 'alien_neon',
            name: 'Galactic Neon',
            price: 500000,
            adRequired: 20, // Final boss item
            imageSrc: 'https://i.imgur.com/VghHWbE.png',
            displayWidth: 450, displayHeight: 150,
            stats: { Power: 10, Aim: 10, Spin: 10 }
        }
    ],

    frames: [
        { 
            id: 'default', 
            name: 'Honey Wood (Default)', 
            price: 0, 
            adRequired: 0,
            imageSrc: 'https://i.imgur.com/T9ft7vz.jpeg', 
            type: 'frame'
        },
        { 
            id: 'frame_kamagong', 
            name: 'Kamagong (Ironwood)', 
            price: 15000, 
            adRequired: 3,
            imageSrc: 'https://i.imgur.com/qmFsG79.jpeg', 
            type: 'frame'
        },
        { 
            id: 'frame_black_marble', 
            name: 'Black Marble', 
            price: 40000, 
            adRequired: 6,
            imageSrc: 'https://i.imgur.com/DvdePuB.jpeg', 
            type: 'frame'
        },
        { 
            id: 'frame_chrome', 
            name: 'Cyber Chrome', 
            price: 100000, 
            adRequired: 10,
            imageSrc: 'https://i.imgur.com/xHckgRf.jpeg', 
            type: 'frame'
        },
        { 
            id: 'frame_gold', 
            name: 'Solid Gold Bullion', 
            price: 350000, 
            adRequired: 17,
            imageSrc: 'https://i.imgur.com/tgSGXgj.jpeg', 
            type: 'frame'
        }
    ],

    felts: [
        { 
            id: 'default', 
            name: 'Custom Felt', 
            price: 0, 
            adRequired: 0,
            imageSrc: 'https://raw.githubusercontent.com/arnoldtasipit66-wq/my-game-assets/refs/heads/main/Gemini_Generated_Image_qtberbqtberbqtbe.png', 
            tint: null,
            type: 'felt'
        },
        { 
            id: 'felt_royal_blue', 
            name: 'Lime Wood', 
            price: 5000, 
            adRequired: 1,
            imageSrc: 'https://raw.githubusercontent.com/arnoldtasipit66-wq/my-game-assets/refs/heads/main/1768026422319.jpg', 
            tint: null, 
            type: 'felt'
        },
        { 
            id: 'felt_emerald', 
            name: 'Choco Wood', 
            price: 12000, 
            adRequired: 4,
            imageSrc: 'https://raw.githubusercontent.com/arnoldtasipit66-wq/Arnold-mondina-/refs/heads/main/Gemini_Generated_Image_g5swlng5swlng5sw.png', 
            tint: null, 
            type: 'felt'
        },
        { 
            id: 'felt_casino_red', 
            name: 'Emerald Green', 
            price: 25000, 
            adRequired: 7,
            imageSrc: 'https://raw.githubusercontent.com/arnoldtasipit66-wq/my-game-assets/refs/heads/main/Gemini_Generated_Image_nbbmfhnbbmfhnbbm.png', 
            tint: null, 
            type: 'felt'
        },
        { 
            id: 'felt_midnight_black', 
            name: 'Ocean Wood', 
            price: 60000, 
            adRequired: 12,
            imageSrc: 'https://raw.githubusercontent.com/arnoldtasipit66-wq/my-game-assets/refs/heads/main/Gemini_Generated_Image_653i2m653i2m653i.png', 
            tint: null, 
            type: 'felt'
        }
    ]
};

// --- üí∞ PUSTAHAN SETTINGS (BETTING SYSTEM) üí∞ ---
const BET_TIERS = [
    { id: 'tambay',   name: 'Tambay Lane',   amount: 0,      icon: 'üòä' }, // Free Play
    { id: 'barangay', name: 'Barangay Cup',  amount: 100,    icon: 'ü™ô' },
    { id: 'town',     name: 'Town Plaza',    amount: 1000,   icon: 'üíµ' },
    { id: 'coliseum', name: 'Grand Coliseum',amount: 5000,   icon: 'üíé' },
    { id: 'world',    name: 'World Stage',   amount: 20000,  icon: 'üëë' }
];

let selectedBetAmount = 0; // Default: Free play
const HOUSE_CUT_PERCENTAGE = 0.10; // 10% Tong ng laro



function getCurrentCueStats() {
    // Hanapin ang data ng cue na naka-equip
    const equippedCue = SHOP_ITEMS.cues.find(cue => cue.id === equippedItems.cue);

    
    if (equippedCue && equippedCue.stats) {
        return equippedCue.stats;
    }

    
    return { Power: 1, Aim: 1, Spin: 1 };
}


let opponentEquippedCueId = 'default'; 

let playerInventory = {
    cues: ['default'] // Default na pagmamay-ari
};

// Dito ise-save ang gamit
let equippedItems = {
    cue: 'default'
};
let currentShopTab = 'cues'; 
        let currentTrackIndex = Math.floor(Math.random() * backgroundPlaylist.length), musicHasStarted = false;     
const canvas = document.getElementById('game-canvas'), ctx = canvas.getContext('2d'), gameWrapper = document.getElementById('game-wrapper'), backgroundCanvas = document.createElement('canvas'), backgroundCtx = backgroundCanvas.getContext('2d'), messageBox = document.getElementById('message-box'), winnerModal = document.getElementById('winner-modal'), winnerText = document.getElementById('winner-text'), playerInfo = document.getElementById('player-info'), opponentInfo = document.getElementById('opponent-info'), powerControl = document.getElementById('power-control'), powerBar = document.getElementById('power-bar'), gameModeSelect = document.getElementById('game-mode-select'), /*difficultySelect = document.getElementById('difficulty-select'),*/ onlineMenu = document.getElementById('online-menu'), exitButton = document.getElementById('exit-button'), vsAiButton = document.getElementById('vs-ai-button'), onlineButton = document.getElementById('online-button'), createGameButton = document.getElementById('create-game-button'), joinGameButton = document.getElementById('join-game-button'), gameIdInput = document.getElementById('game-id-input'), /*difficultyBackButton = document.getElementById('difficulty-back-button'),*/  cardHandContainer = document.getElementById('card-hand-container'), opponentHandReveal = document.getElementById('opponent-hand-reveal'),
            // == WINNER MODAL BUTTONS ==
            aiRematchButton = document.getElementById('ai-rematch-button'), // Updated ID
            backToMenuButton = document.getElementById('back-to-menu-button'), // New button
            // == END WINNER MODAL BUTTONS ==
            aiMenu = document.getElementById('ai-menu'), aiStraightBallButton = document.getElementById('ai-straight-ball-button'), aiPokerButton = document.getElementById('ai-poker-button'), ai61Button = document.getElementById('ai-61-button'),  straightBallInstructions = document.getElementById('straight-ball-instructions'), pokerInstructions = document.getElementById('poker-instructions'), sixtyOneInstructions = document.getElementById('61-ball-instructions'), playStraightBallButton = document.getElementById('play-straight-ball-button'), playPokerButton = document.getElementById('play-poker-button'), play61BallButton = document.getElementById('play-61-ball-button'), cueBallGuide = document.getElementById('cue-ball-guide'), waitingRoom = document.getElementById('waiting-room'), gameIdDisplay = document.getElementById('game-id-display'),  onlineGameSelect = document.getElementById('online-game-select'), onlinePokerButton = document.getElementById('online-poker-button'), onlineStraightBallButton = document.getElementById('online-straight-ball-button'), online61Button = document.getElementById('online-61-button'),  confirmExitModal = document.getElementById('confirm-exit-modal'), confirmExitYes = document.getElementById('confirm-exit-yes'), confirmExitCancel = document.getElementById('confirm-exit-cancel'), pektusControl = document.getElementById('pektus-control'), pektusDot = document.getElementById('pektus-dot'), leftArrow = document.getElementById('left-arrow'), rightArrow = document.getElementById('right-arrow'), fullscreenButton = document.getElementById('fullscreen-button'), pokerFoulCardPickModal = document.getElementById('poker-foul-card-pick-modal'), pokerFoulCardsContainer = document.getElementById('poker-foul-cards'), leaderboardModal = document.getElementById('leaderboard-modal'), leaderboardButton = document.getElementById('leaderboard-button'),  leaderboardBody = document.getElementById('leaderboard-body'), 
shopModal = document.getElementById('shop-modal'),
dailyRewardModal = document.getElementById('daily-reward-modal'),
    ghostHand = document.getElementById('ghost-hand'); 

    // ==========================================
    // üÜï NAVIGATION SYSTEM (ISINGIT DITO)
    // ==========================================

    let currentOpenModal = null; 

    function setupNavigationSystem() {
        console.log("Navigation System Activated");
        
        window.addEventListener('popstate', (event) => {
            if (currentOpenModal) {
                closeModalUI(currentOpenModal);
            } else {
                 if (typeof tg !== 'undefined' && tg.BackButton) tg.BackButton.hide();
            }
        });
    }

    function openUniversalModal(modalId) {
        const modal = document.getElementById(modalId);
        if (!modal) return;
        if (typeof playButtonSound === 'function') playButtonSound();
        modal.classList.add('show');
        currentOpenModal = modalId;
        history.pushState({ modal: modalId }, null, `#${modalId}`);
        if (typeof tg !== 'undefined' && tg.BackButton) tg.BackButton.show();
        if (typeof gameState !== 'undefined') gameState = 'modal_open';
    }

    function closeModalUI(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) modal.classList.remove('show');
        currentOpenModal = null;
        if (typeof tg !== 'undefined' && tg.BackButton) tg.BackButton.hide();
        if (typeof gameState !== 'undefined') {
            if (typeof gameMode !== 'undefined' && (gameMode === 'online' || gameMode === 'practice')) {
                gameState = 'playing';
            } else {
                gameState = 'menu';
            }
        }
    }
    // ==========================================
    // ‚¨ÜÔ∏è END OF NAVIGATION SYSTEM ‚¨ÜÔ∏è
    // ==========================================


    // 2. DITO NATIN I-RERESTART ANG 'CONST' CHAIN (Importante ito!)
    const playerNameInput = document.getElementById('player-name-input'), 
          
          // Ituloy ang listahan ng iba pang elements...
          dragGuideText = document.getElementById('drag-guide-text'), 
          findMatchButton = document.getElementById('find-match-button'), 
          matchmakingWaitModal = document.getElementById('matchmaking-wait-modal'),  
          chatContainer = document.getElementById('chat-container'), 
          chatMessages = document.getElementById('chat-messages'), 
          chatInput = document.getElementById('chat-input'), 
          chatSendBtn = document.getElementById('chat-send-btn'), 
          cueStickElement = document.getElementById('cue-stick-element'); // <--- Dulo ng batch na ito
    
    
        // START: Tutorial variables
        const tutorialOverlay = document.getElementById('tutorial-overlay');
        const tutorialHighlight = document.getElementById('tutorial-highlight');
        const tutorialBox = document.getElementById('tutorial-box');
        const tutorialText = document.getElementById('tutorial-text');
        const tutorialNextBtn = document.getElementById('tutorial-next-btn');
        let isTutorialActive = false;
        let tutorialStep = 0;
        let tutorialSteps = [];
        const interactiveElements = [canvas, powerControl, pektusControl, leftArrow, rightArrow];
        // END: Tutorial variables

        const TABLE_ASPECT_RATIO = 1.9, 
¬† ¬† ¬† ¬†BALL_RADIUS = 16,¬† ¬† ¬†// <-- Pinalitan galing 16
¬† ¬† ¬† ¬† ¬† ¬† ¬† CUE_BALL_RADIUS = 18,¬† // <-- Pinalitan galing 18
¬† ¬† ¬† ¬† ¬† ¬† ¬† HOLE_RADIUS = 35,¬† ¬† // <-- Pinalitan galing 35
¬† ¬† ¬† ¬† ¬† ¬† ¬†¬†
¬† ¬† ¬† ¬† ¬† ¬† ¬† 
¬† ¬† ¬† ¬† ¬† ¬† ¬† CUE_CHIP_MASS = 6.5,     // Bigat ng Cue Chip (mas mabigat)
¬† ¬† ¬† ¬† ¬† ¬† ¬† OBJECT_CHIP_MASS = 2.5,  // Bigat ng Object Chip (mas magaan)
              
              COLLISION_FRICTION = 1, // 0 = Walang preno sa banggaan, 1 = Sobrang preno
       
¬† ¬† ¬† ¬† ¬† ¬† ¬† FRICTION_PER_SECOND = 0.2, // <-- ITO ANG PALIT SA 'FRICTION'
¬† ¬† ¬† ¬† ¬† ¬† ¬† MIN_VELOCITY = 5.0, // <-- ITO ANG PALIT SA 'MIN_VELOCITY'
¬† ¬† ¬† ¬† ¬† ¬† ¬† MIN_ROTATION_SPEED = 0.01,¬†
¬† ¬† ¬† ¬† ¬† ¬† ¬† ROTATION_SPEED = 0.001,
¬† ¬† ¬† ¬† ¬† ¬† ¬† TOUCH_AIM_SENSITIVITY = 0.00001;
        
        // START: SPINNING CHIP UPDATE (Nagdagdag ng spin friction)
        const SPIN_FRICTION_PER_SECOND = 0.15;
// Idagdag mo ito para gumana ang Pektus sa Pader
const RAIL_KICK_FACTOR = 1.5; // 0.2 = Sakto lang, 0.5 = Sobrang lakas kumabig
        const WALL_SPIN_FACTOR = 0.005; // Lakas ng spin galing sa pader
        const COLLISION_SPIN_FACTOR = 0.03; // Lakas ng spin galing sa banggaan
        const COLLISION_FRICTION_FACTOR = 0.01; // Mababang friction para madulas (Iwas hatak pabalik)

        let scale = 1, table = { width: 0, height: 0 }, chips = [], holes = [], cueStick = { angle: 0, length: 10000, visible: true, power: 0, pullback: 0 }, gameState = 'menu', gameMode = 'ai-classic', playerTurn = true, colorsAssigned = false, playerChipsType = null, opponentChipsType = null, canMoveCueBall = false, chipsMoving = false, chipsPocketedInTurn = [], firstChipHitInTurn = null, isPoweringUp = false, isAimingOnCanvas = false, isDraggingCueBall = false, difficulty = 'pro', deck = [], playerHand = [], opponentHand = [], originalPlayerHand = [], originalOpponentHand = [], selectedGameConfig = {}, isBreakShot = false, pektusOffset = { x: 0, y: 0 }, shotPektusOffset = { x: 0, y: 0 }, isDraggingPektusDot = false, isRotatingLeft = false, isRotatingRight = false, isInvalidPlacement = false, player61Score = 0, opponent61Score = 0, lowestChipNumber = 1, aiConsecutivePots = 0;
let currentShotStats = { Power: 2, Aim: 3, Spin: 1 }; 
        let gameId = null, localPlayerId = null, localPlayerUid = null, currentTurnUid = null, unsubscribeGameListener, isOnlineGame = false, isMyTurnOnline = false, isProcessingTurnEnd = false, lastProcessedTurnId = -1, isSyncing = false, selectedOnlineGameType = 'poker', lastAimUpdateTime = 0;
        const AIM_UPDATE_INTERVAL = 50;
        let lastTurnControllerUid = null, unsubscribeFromQueue, matchmakingTimeoutId = null, isAiTakeoverActive = false;
let fireworks = [];
        
        let audioInitialized = false, chipCollisionSynth, pocketSynth, uiSynth, cueHitSynth, cushionSynth;
        let aimingSynth, powerSynth; // BAGONG synths
        let lastCollisionSoundTime = -1, lastCushionSoundTime = -1, lastAimSoundTime = -1, buttonSoundPlaying = false;
        let isPowerSoundPlaying = false;
        const AIM_SOUND_INTERVAL = 80; // Gaano kadalas tutunog ang aiming sound (milliseconds)
        // --- End Sound Variables ---
        const cueStickImage = new Image();
        cueStickImage.src = 'https://i.imgur.com/FYXWKhr.png';
const feltTextureImage = new Image();
const tableSurfaceImage = new Image();
tableSurfaceImage.crossOrigin = "Anonymous";
tableSurfaceImage.src = 'https://raw.githubusercontent.com/arnoldtasipit66-wq/my-game-assets/refs/heads/main/Gemini_Generated_Image_qtberbqtberbqtbe.png';
        let unsubscribeFromChat, isInitialChatLoad = true;
        let legalTargetChipIds = new Set(); // <-- BAGONG DAGDAG para sa ring light

        // === START PLAYER NAME UPDATE ===
        let localPlayerName = "You";
        let opponentPlayerName = "Opponent";
        let opponentRankIndex = 0;
        let vsScreenShownThisGame = false;
        // === END PLAYER NAME UPDATE ===

        function init() {
    
    // 1. Sabihin sa Telegram na ready na ang app
    if (window.Telegram && window.Telegram.WebApp) {
        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.expand(); // Para mag-fullscreen sa Telegram
    }
    
    
¬† ¬† ¬† ¬† ¬† ¬† resizeCanvas();

¬† ¬† ¬† ¬† ¬† ¬† // --- MGA BAGONG DAGDAG ---
¬† ¬† ¬† ¬† ¬† ¬† loadCurrency(); // I-load ang pera ng player
¬† ¬† ¬† ¬† ¬† ¬† loadInventory(); // I-load ang mga nabiling tako
            loadPlayerStats();
¬† ¬† ¬† ¬† ¬† ¬† applyEquippedItems(); // I-apply agad yung naka-equip na tako
¬† ¬† ¬† ¬† ¬† ¬† const isReturningPlayer = loadPlayerName(); // I-load ang pangalan
¬† ¬† ¬† ¬† ¬† ¬† // --- END NG DAGDAG ---

¬† ¬† ¬† ¬† ¬† ¬† setupEventListeners(isReturningPlayer); // <-- NAGBAGO ITO!
¬† ¬† ¬† ¬† ¬† ¬† initializeFirebase();
¬† ¬† ¬† ¬† ¬† ¬† history.replaceState({ modal: 'start' }, 'Start', '#start');
¬† ¬† ¬† ¬† ¬† ¬† requestAnimationFrame(update); // Ito na ang magsisimula ng game loop
¬† ¬† ¬† ¬† }

// --- NEW PEKTUS MODAL LOGIC (FIXED) ---

const pektusModal = document.getElementById('pektus-modal');
const bigRedDot = document.getElementById('big-red-dot');
const bigTouchArea = document.getElementById('big-pektus-touch-area');
const bigCueBall = document.getElementById('big-cue-ball');
let isDraggingBigPektus = false; // Eto ang kulang kanina

function openPektusModal() {
    if (!pektusModal) return;
    playButtonSound();
    pektusModal.style.display = 'flex';
    updateBigDotUI();
}

// Logic para igalaw ang malaking dot
function handleBigPektusMove(clientX, clientY) {
    if (!bigCueBall) return;
    const rect = bigCueBall.getBoundingClientRect();
    const centerX = rect.width / 2;
    const centerY = rect.height / 2;
    
    // Position relative sa gitna
    let dx = clientX - rect.left - centerX;
    let dy = clientY - rect.top - centerY;
    
    // LIMITER (RECTANGLE BAKOD)
    const maxDistX = (rect.width / 2) - 15;
    const maxDistY = (rect.height / 2) - 15;
    
    if (dx > maxDistX) dx = maxDistX;
    if (dx < -maxDistX) dx = -maxDistX;
    
    if (dy > maxDistY) dy = maxDistY;
    if (dy < -maxDistY) dy = -maxDistY;
    
    // Update Global Values
    pektusOffset.x = dx / maxDistX;
    pektusOffset.y = dy / maxDistY;
    
    updateBigDotUI();
    
    if (!isTutorialActive) sendLiveAimData();
}

function updateBigDotUI() {
    if (!bigCueBall || !bigRedDot) return;
    const rect = bigCueBall.getBoundingClientRect();
    const maxDistX = (rect.width / 2) - 15;
    const maxDistY = (rect.height / 2) - 15;
    
    const x = (pektusOffset.x * maxDistX) + (rect.width / 2);
    const y = (pektusOffset.y * maxDistY) + (rect.height / 2);
    
    bigRedDot.style.left = x + 'px';
    bigRedDot.style.top = y + 'px';
}

// LISTENERS (Updated para sa Auto-Close)
if (bigTouchArea) {
    // Mouse
    bigTouchArea.addEventListener('mousedown', (e) => {
        isDraggingBigPektus = true;
        handleBigPektusMove(e.clientX, e.clientY);
    });
    
    window.addEventListener('mousemove', (e) => {
        if (isDraggingBigPektus) handleBigPektusMove(e.clientX, e.clientY);
    });

    // Touch
    bigTouchArea.addEventListener('touchstart', (e) => {
        e.preventDefault();
        isDraggingBigPektus = true;
        handleBigPektusMove(e.touches[0].clientX, e.touches[0].clientY);
    }, { passive: false });

    window.addEventListener('touchmove', (e) => {
        if (isDraggingBigPektus) {
            e.preventDefault(); 
            handleBigPektusMove(e.touches[0].clientX, e.touches[0].clientY);
        }
    }, { passive: false });
}

// AUTO CLOSE PAG BINITAWAN (Release to Set)
function finishPektusDrag() {
    if (isDraggingBigPektus) {
        isDraggingBigPektus = false;
        // Isara agad ang modal
        if(pektusModal) pektusModal.style.display = 'none';
        playButtonSound();
        
        // Update yung maliit na icon sa baba
        updatePektusUI();
    }
}

// Ikabit sa window para kahit saan bumitaw, magsasara
window.addEventListener('mouseup', finishPektusDrag);
window.addEventListener('touchend', finishPektusDrag);

// TANGGALIN NA NATIN ANG LISTENER SA BUTTON DAHIL WALA NA YUN
// (Dati meron ditong closePektusBtn listener, burado na)
        
        ¬† ¬† ¬† ¬† function startGame(mode, difficultyLevel = 'pro') {
¬† ¬†¬† ¬† ¬† ¬† // ITO ANG IPALIT MO:

showGameUI();
window.isInGame = true;
¬† ¬† ¬† ¬† ¬† ¬† /* <-- LAGYAN MO NITO SA SIMULA
¬† ¬† ¬† ¬† ¬† ¬† const needsTutorial = !localStorage.getItem('pinoyPoolTutorialCompleted');
¬† ¬† ¬† ¬† ¬† ¬† // Tutorial triggers on any first AI game, regardless of (now removed) difficulty
¬† ¬† ¬† ¬† ¬† ¬† if (needsTutorial && mode.startsWith('ai-')) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† startTutorial(mode, difficultyLevel);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† return;
¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† */  // <-- AT LAGYAN MO NITO SA DULO

¬† ¬† ¬† ¬† ¬† ¬† 

            resizeCanvas(); 
            const allModals = [gameModeSelect, aiMenu, /*difficultySelect,*/ straightBallInstructions, pokerInstructions, sixtyOneInstructions, onlineGameSelect, onlineMenu, waitingRoom, winnerModal, confirmExitModal, pokerFoulCardPickModal, leaderboardModal];
            allModals.forEach(modal => modal.classList.remove('show')); 
            gameMode = mode; 
            isOnlineGame = false; 
            difficulty = difficultyLevel; // Will be 'pro'
            cueBallGuide.style.display = 'none'; 
            dragGuideText.style.display = 'none'; 
            playerTurn = Math.random() < 0.5; 
            canMoveCueBall = false; 
            chipsMoving = false; 
            colorsAssigned = false; 
            playerChipsType = null; 
            opponentChipsType = null; 
            setupChips(); 
            isBreakShot = true; 
            canMoveCueBall = true; 
            gameState = 'moving'; 
            cueStick.visible = true; 
            if (playerTurn) { 
                showMessage("It's your turn to break!", 4000); 
                dragGuideText.style.display = 'block'; 
            } else { 
                showMessage("Opponent will break the balls.", 4000); 
                placeCueChipForAI(); 
            } 
            resetPektus(); 
            if (gameMode.includes('poker')) { 
                createDeck(); 
                dealCards(); 
                updateCardDisplay(); 
            } else if (gameMode.includes('61-ball')) { 
                player61Score = 0; 
                opponent61Score = 0; 
                lowestChipNumber = 1; 
                cardHandContainer.style.display = 'none'; 
            } else {
                cardHandContainer.style.display = 'none'; 
            }
            updateInfoBox(); // Tatawagin nito ang updateLegalTargetChips()
            history.pushState({ modal: 'game' }, 'Game', '#game');
setCueForCurrentTurn();
            if (gameMode.startsWith('ai')) { 
                setTimeout(() => { aiDisplayMessage(getAiChatMessage('start')); }, 1500); 
            } 
        }
        
        // --- ü§ñ AI REMATCH FUNCTION (SUREBALL BAWAS) ü§ñ ---
async function restartAiGame() {
    playButtonSound();
    
    // Check sa console kung magkano ang naaalala niyang taya
    console.log("Attempting Rematch. Saved Bet:", window.lastAiBetAmount);

    // 1. PAYMENT CHECK
    if (window.lastAiBetAmount > 0) {
        
        // MANINGIL ULIT!
        const isPaid = await processBet(window.lastAiBetAmount);
        
        if (!isPaid) {
            return; // Walang pera, hinto.
        }

        // Pagkabayad, I-SET AGAD ang currentMatchBet
        currentMatchBet = window.lastAiBetAmount;
        
        showMessage(`Rematch Started! <br><span style="color:#FFD700">Bet Active: ${formatCurrencyShort(currentMatchBet)}</span>`, 2000);
        
    } else {
        // Free Play logic
        currentMatchBet = 0;
        showMessage("Rematch Started! (Practice)", 2000);
    }

    // 2. RESET GAME (Standard)
    winnerModal.classList.remove('show');
    resizeCanvas();
    
    playerTurn = Math.random() < 0.5;
    canMoveCueBall = false;
    chipsMoving = false;
    colorsAssigned = false;
    playerChipsType = null;
    opponentChipsType = null;
    
    setupChips();
    isBreakShot = true;
    canMoveCueBall = true;
    gameState = 'moving';
    cueStick.visible = true;
    
    if (playerTurn) {
        dragGuideText.style.display = 'block';
    } else {
        placeCueChipForAI();
    }
    
    resetPektus();
    
    if (gameMode.includes('poker')) {
        createDeck();
        dealCards();
        updateCardDisplay();
    } else if (gameMode.includes('61-ball')) {
        player61Score = 0;
        opponent61Score = 0;
        lowestChipNumber = 1;
    }
    
    updateInfoBox(); 
    history.pushState({ modal: 'game' }, 'Game', '#game');
    setCueForCurrentTurn(); 

    // 3. HUD UPDATE (Siguraduhing kita ang Pot)
    setTimeout(() => {
        const sub = document.querySelector('#opponent-info .hud-sub');
        if (sub) {
            if (currentMatchBet > 0) {
                sub.innerHTML = `<span style="color:#FFD700">Pot: ${formatCurrencyShort(currentMatchBet * 2)}</span>`;
            } else {
                sub.innerHTML = '<span style="color:#aaa">Practice Bot</span>';
            }
        }
    }, 500);

    if (gameMode.startsWith('ai')) {
        setTimeout(() => { aiDisplayMessage(getAiChatMessage('start')); }, 1500);
    }
}

        function waitForCardPick() { return new Promise(resolve => { pokerFoulCardPickModal.classList.add('show'); pokerFoulCardsContainer.innerHTML = ''; const cardsToDraw = []; for (let i = 0; i < 5; i++) if (deck.length > 0) cardsToDraw.push(deck.splice(Math.floor(Math.random() * deck.length), 1)[0]); if (cardsToDraw.length === 0) { pokerFoulCardPickModal.classList.remove('show'); resolve(null); return; } cardsToDraw.forEach(card => { const cardDiv = document.createElement('div'); cardDiv.className = 'card face-down'; cardDiv.onclick = () => { playButtonSound(); cardDiv.classList.remove('face-down'); const color = (card.suit === '‚ô•' || card.suit === '‚ô¶') ? '#ff0000' : '#212121'; cardDiv.innerHTML = `<span class="card-rank" style="color: ${color};">${card.rank}</span><span class="card-suit" style="color: ${color};">${card.suit}</span>`; pokerFoulCardsContainer.querySelectorAll('.card').forEach(c => { c.onclick = null; c.style.cursor = 'default'; }); setTimeout(() => { pokerFoulCardPickModal.classList.remove('show'); cardsToDraw.forEach(c => { if (c !== card) deck.push(c); }); resolve(card); }, 1500); }; pokerFoulCardsContainer.appendChild(cardDiv); }); }); }
        
       
async function endGame(winnerTextMessage, finalGameData = null) {
    if (gameState === 'gameover') return;

    // --- üîä SOUND EFFECT LOGIC ---
    const winSound = document.getElementById('win-sfx');
    const loseSound = document.getElementById('lose-sfx');
    
    if (winSound) { winSound.pause(); winSound.currentTime = 0; }
    if (loseSound) { loseSound.pause(); loseSound.currentTime = 0; }

    if (winnerTextMessage.includes("You Win")) {
        if (winSound) { winSound.volume = 0.8; winSound.play().catch(e => console.log("Win Sound Error:", e)); }
    } else if (winnerTextMessage.includes("You Lose") || winnerTextMessage.includes("Forfeited") || winnerTextMessage.includes("Opponent Wins")) {
        if (loseSound) { loseSound.volume = 0.8; loseSound.play().catch(e => console.log("Lose Sound Error:", e)); }
    }

    let bonus = 0;
    let xpBonus = 0;
    let trophiesChange = 0;
    let reason = "";
    
    let bet = 0;
    if (isOnlineGame) {
        const gameData = finalGameData || (gameId ? (await getDoc(doc(db, "games", gameId))).data() : null);
        if (gameData && gameData.betAmount) { bet = gameData.betAmount; } else { bet = currentMatchBet; }
    }

    // --- REWARDS LOGIC (UPDATED) ---
    if (!isOnlineGame) { // AI GAME
        if (winnerTextMessage.includes("You Win")) {
            bonus = REWARD_WIN_BONUS;
            xpBonus = XP_WIN_BONUS;
            
            // ‚úÖ FIX: Gawing 5 para maka-rank up kahit sa AI
            trophiesChange = 5; 
            
            reason = "Practice Win!";
            triggerFireworks(); 
        } else if (winnerTextMessage.includes("You Lose")) {
            bonus = REWARD_LOSE_CONSOLATION;
            xpBonus = XP_LOSE_CONSOLATION;
            trophiesChange = 0; // Wala ring bawas sa AI
            reason = "Good Game!";
        }
        if(bonus > 0) {
            playerTotalCurrency += bonus;
            saveCurrency();
            updateCurrencyDisplay();
        }
    } else { // ONLINE GAME
        if (winnerTextMessage.includes("You Win")) {
            trophiesChange = 25; // RANKED WIN
            xpBonus = XP_WIN_BONUS;
            triggerFireworks(); 

            if (bet > 0) {
                const totalPot = bet * 2;
                const houseCut = Math.floor(totalPot * 0.10); 
                const netWin = totalPot - houseCut;
                playerTotalCurrency += netWin;
                saveCurrency();
                updateCurrencyDisplay(); 
                setTimeout(() => { showRewardPopup(netWin, `POT WON!<br><small>(Tong: ${houseCut})</small>`); }, 1000);
                reason = "Pustahan King!";
            } else {
                bonus = REWARD_WIN_BONUS;
                playerTotalCurrency += bonus;
                saveCurrency();
                updateCurrencyDisplay();
                reason = "Online Win!";
                showRewardPopup(bonus, reason);
            }
        } else {
            trophiesChange = -20; // RANKED LOSS
            if (bet > 0) { setTimeout(() => { showRewardPopup(0, `<span style="color:red">BET LOST: -${bet}</span>`); }, 1000); }
            else { setTimeout(() => { showRewardPopup(0, "Safe Match (No Bet)"); }, 1000); }
        }
    }

    // --- APPLY STATS ---
    if (trophiesChange !== 0) {
        const oldRankIndex = getPlayerRank(playerTrophies).index;
        playerTrophies += trophiesChange;
        if (playerTrophies < 0) playerTrophies = 0;
        const newRankIndex = getPlayerRank(playerTrophies).index;

        if (newRankIndex > oldRankIndex) { setTimeout(() => { showRankUpScreen(newRankIndex); }, 2500); }
        setTimeout(() => { showMessage(`${trophiesChange > 0 ? '+' : ''}${trophiesChange} Trophies`, 2000); }, 1500);
    }

    if (xpBonus > 0) gainXP(xpBonus);
    savePlayerStats();
    currentMatchBet = 0; 
    gameState = 'gameover'; 
    updateCurrencyDisplay();
    updateLegalTargetChips();

    // --- VISUALS ---
    let finalWinnerText = winnerTextMessage;
    winnerText.style.color = "#FFFFFF"; 
    winnerText.style.textShadow = "4px 4px 0 #000";

    if (winnerTextMessage.includes("You Win") || winnerTextMessage.includes("Opponent Forfeited")) {
        winnerText.style.color = "#FFD700"; 
        winnerText.style.textShadow = "4px 4px 0 #000, 0 0 20px gold";
        if (winnerTextMessage.includes("Opponent Forfeited")) { finalWinnerText = "OPPONENT<br>FORFEITED"; }
    } else if (winnerTextMessage.includes("You Lose") || winnerTextMessage.includes("You Forfeited")) {
        winnerText.style.color = "#FF4444"; 
        winnerText.style.textShadow = "4px 4px 0 #000, 0 0 20px red";
        if (winnerTextMessage.includes("You Forfeited")) { finalWinnerText = "YOU<br>FORFEITED"; }
    } else if (winnerTextMessage.includes("Draw")) {
        winnerText.style.color = "#AAAAAA"; 
        finalWinnerText = "DRAW GAME";
    }

    if (gameMode.includes('61-ball')) {
        winnerText.innerHTML = `${finalWinnerText}<br><div style="font-size: 0.4em; margin-top: 10px; color: #eee; font-weight: normal;">${player61Score} - ${opponent61Score}</div>`;
    } else {
        winnerText.innerHTML = finalWinnerText;
    }
    
    // --- ITO ANG PART NA DAPAT MONG I-UPDATE ---
    const onlineRematchButton = document.getElementById('rematch-button');
    const didWin = winnerTextMessage.includes("You Win"); // Check natin kung nanalo

    if (isOnlineGame) {
        // Ito yung existing code mo para sa Online
        updatePlayerData(localPlayerUid, didWin); 
        aiRematchButton.style.display = 'none';
        backToMenuButton.style.display = 'block';
        onlineRematchButton.style.display = 'block';
    } else {
        // --- üëá DITO MO ILALAGAY ANG FIX PARA SA AI üëá ---
        // ‚úÖ Sabihan ang Firestore na i-save ang stats kahit AI ang kalaro
        updatePlayerData(localPlayerUid, didWin); 

        aiRematchButton.style.display = 'block';
        backToMenuButton.style.display = 'block';
        onlineRematchButton.style.display = 'none';
    }
    
    // --- CARD REVEAL ---
    if (gameMode.includes('poker')) {
        opponentHandReveal.innerHTML = `<h4>${opponentPlayerName}'s Hand:</h4>`;
        let opponentsOriginalHand, opponentsFinalHand;
        if (isOnlineGame) {
            const gameData = finalGameData || (await getDoc(doc(db, "games", gameId))).data();
            if (gameData) {
                opponentsOriginalHand = localPlayerId === 'player1' ? gameData.originalPlayer2Hand : gameData.originalPlayer1Hand;
                opponentsFinalHand = localPlayerId === 'player1' ? gameData.player2Hand : gameData.player1Hand;
            } else { opponentsOriginalHand = []; opponentsFinalHand = []; }
        } else {
            opponentsOriginalHand = originalOpponentHand; opponentsFinalHand = opponentHand;
        }

        if(opponentsOriginalHand && opponentsFinalHand) {
            const pocketedCards = opponentsOriginalHand.filter(originalCard => !opponentsFinalHand.some(finalCard => finalCard.rank === originalCard.rank && finalCard.suit === originalCard.suit));
            const createCardElement = (card) => {
                const cardDiv = document.createElement('div'); cardDiv.className = 'card';
                const color = (card.suit === '‚ô•' || card.suit === '‚ô¶') ? '#D32F2F' : '#212121';
                cardDiv.innerHTML = `<span class="card-rank" style="color: ${color};">${card.rank}</span><span class="card-suit" style="color: ${color};">${card.suit}</span>`;
                return cardDiv;
            };
            if (pocketedCards.length > 0) {
                const pocketedContainer = document.createElement('div'); pocketedContainer.innerHTML = '<p style="margin: 10px 0 5px 0;">Pocketed:</p>';
                const pocketedCardsDiv = document.createElement('div'); pocketedCardsDiv.style.cssText = 'display: flex; gap: 5px; justify-content: center; flex-wrap: wrap;';
                pocketedCards.forEach(card => pocketedCardsDiv.appendChild(createCardElement(card)));
                pocketedContainer.appendChild(pocketedCardsDiv); opponentHandReveal.appendChild(pocketedContainer);
            }
            if (opponentsFinalHand.length > 0) {
                const remainingContainer = document.createElement('div'); remainingContainer.innerHTML = '<p style="margin: 10px 0 5px 0;">Remaining:</p>';
                const remainingCardsDiv = document.createElement('div'); remainingCardsDiv.style.cssText = 'display: flex; gap: 5px; justify-content: center; flex-wrap: wrap;';
                opponentsFinalHand.forEach(card => remainingCardsDiv.appendChild(createCardElement(card)));
                remainingContainer.appendChild(remainingCardsDiv); opponentHandReveal.appendChild(remainingContainer);
            }
            opponentHandReveal.style.display = 'flex';
        }
    } else if (gameMode.includes('61-ball')) {
        opponentHandReveal.innerHTML = `<div style="text-align: center;"><h4>Final Score</h4><p style="font-size: 1.4em; margin: 10px 0; color: white;">${localPlayerName}: <span style="font-weight: bold; color: var(--gold-accent);">${player61Score}</span></p><p style="font-size: 1.4em; margin: 10px 0; color: white;">${opponentPlayerName}: <span style="font-weight: bold; color: var(--gold-accent);">${opponent61Score}</span></p></div>`;
        opponentHandReveal.style.display = 'flex';
    } else {
        opponentHandReveal.innerHTML = ''; opponentHandReveal.style.display = 'none';
    }
    setTimeout(() => { winnerModal.classList.add('show'); history.pushState({ modal: 'winner' }, 'Winner', '#winner'); }, 1000);
}
async function resetToMenu() {
    playButtonSound();
window.isInGame = false;
    document.getElementById('chat-toggle-button').style.display = 'none';
    chatContainer.style.display = 'none';
    if (unsubscribeFromChat) unsubscribeFromChat();
    if (isOnlineGame) await leaveOnlineGame(false); // Disconnect but don't force forfeit via UI

    opponentPlayerName = "Opponent"; // Reset opponent name

    // Updated list of modals to hide
    const modalsToHide = [
        winnerModal, aiMenu, onlineMenu, onlineGameSelect, waitingRoom,
        straightBallInstructions, pokerInstructions, sixtyOneInstructions,
        confirmExitModal, leaderboardModal, shopModal, dailyRewardModal,
        matchmakingWaitModal, pokerFoulCardPickModal, tutorialOverlay
    ];
    modalsToHide.forEach(m => {
         if (m) m.classList.remove('show');
    });

    // --- Eto na yung pagpapakita ng Lobby ---
    showLobbyUI(); // <-- Ito na ang nagpapakita ng lobby buttons/view

    if (unsubscribeGameListener) {
        unsubscribeGameListener();
        unsubscribeGameListener = null;
    }

    gameState = 'lobby'; // <-- State ay lobby na

    // Reset game-specific variables
    isOnlineGame = false;
    gameId = null;
    localPlayerId = null;
    isAiTakeoverActive = false;
    playerHand = [];
    opponentHand = [];
    originalPlayerHand = [];
    originalOpponentHand = [];
    playerChipsType = null;
    opponentChipsType = null;
    colorsAssigned = false;
    player61Score = 0;
    opponent61Score = 0;
    lowestChipNumber = 1;
    canMoveCueBall = false;
    isBreakShot = false;
    opponentPlayerName = "Opponent"; 
¬† ¬† opponentRankIndex = 0; // <-- Idagdag mo na rin ito para malinis
¬† ¬† vsScreenShownThisGame = false; // <-- ‚ùó IDAGDAG MO ITO

    updateCardDisplay(); // Clear card display
    updateLegalTargetChips(); // Clear highlights

    // **MAHALAGA:** Hindi na natin binubura yung 'chips' array dito
    draw(); // Redraw ang lobby state

    history.pushState({ modal: 'lobby' }, 'Lobby', '#lobby'); // <-- History state ay lobby na

    updateDailyRewardButtonState(); // Update reward button state
    const cueEl = document.getElementById('cue-stick-element');
    if(cueEl) cueEl.style.display = 'none';
}

// ‚ñº‚ñº‚ñº ULTIMATE POPSTATE FIX (LOBBY/GAME DETECTION) ‚ñº‚ñº‚ñº

window.onpopstate = (event) => {
    const state = event.state || { modal: 'lobby' };

    if (window.isClosingModal) {
        window.isClosingModal = false;
        
        // Itago lang ang modals
        document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('show'));
        
        // ‚ñº‚ñº‚ñº ITO ANG BINAGO ‚ñº‚ñº‚ñº
        // Kung nasa Lobby tayo, ipakita ang Lobby UI.
        if (state.modal === 'lobby' || !window.isInGame) {
            showLobbyUI();
            gameState = 'lobby';
        }
        
        // ‚ñº‚ñº‚ñº DITO ANG BAGONG LOGIC ‚ñº‚ñº‚ñº
        // Kung ang history ay 'lobby' O KAYA ay 'WALA TAYONG LARO' (!window.isInGame)
        if (state.modal === 'lobby' || !window.isInGame) {
            showLobbyUI();
            gameState = 'lobby';
        } else {
            // Kung may laro, balik sa mesa
            
            // (Restore Game State Logic...)
            if (isOnlineGame) {
                 gameState = canMoveCueBall ? 'moving' : 'aiming';
            } else {
                 if (chipsMoving) gameState = 'shooting';
                 else gameState = canMoveCueBall ? 'moving' : 'aiming';
            }

            if (gameState === 'aiming') {
                cueStick.visible = true; 
                if (cueStickElement) cueStickElement.style.display = 'block';
            }

            showGameUI();
            
            // Anti-Freeze AI check
            if (!isOnlineGame && !playerTurn && gameMode.startsWith('ai') && !chipsMoving && gameState === 'aiming') {
                 setTimeout(aiTurn, 1000);
            }
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ‚ñ≤‚ñ≤‚ñ≤
        
        draw();
        return; 
    }

    // ... (Tuloy ang dating code sa baba: HISTORY CHECK, EXIT LOGIC, etc.) ...
    
    // 2. HISTORY CHECK: BALIK LARO BA?
    if (state.modal === 'game') {
        // ... (Kopyahin mo lang yung nasa dating code mo dito pababa) ...
        document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('show'));
        
        if (chipsMoving) {
             gameState = 'shooting';
        } else if (isOnlineGame) {
             gameState = canMoveCueBall ? 'moving' : 'aiming';
        } else {
             gameState = canMoveCueBall ? 'moving' : 'aiming';
        }

        if (gameState === 'aiming') {
            cueStick.visible = true;
            if (cueStickElement) cueStickElement.style.display = 'block';
        }

        showGameUI();
        
        if (!isOnlineGame && !playerTurn && gameMode.startsWith('ai') && !chipsMoving && gameState === 'aiming') {
             setTimeout(aiTurn, 1000);
        }
        draw();
        return;
    }

    // 3. EXIT LOGIC
    const isActiveGameState = gameState !== 'lobby' && gameState !== 'menu' && gameState !== 'gameover' && gameState !== 'modal_open';
    const isModalOverlayVisible = Array.from(document.querySelectorAll('.modal-overlay:not(#start-overlay)')).some(m => m.classList.contains('show'));

    if (isActiveGameState && !isModalOverlayVisible) {
         showExitConfirmation();
         history.pushState({ modal: 'game' }, 'Game', '#game');
         return;
    }

    // 4. UI ROUTER
    const allModals = {
        aiMenu: document.getElementById('ai-menu'),
        straightBallInstructions: document.getElementById('straight-ball-instructions'),
        pokerInstructions: document.getElementById('poker-instructions'),
        sixtyOneInstructions: document.getElementById('61-ball-instructions'),
        onlineGameSelect: document.getElementById('online-game-select'),
        onlineMenu: document.getElementById('online-menu'),
        waitingRoom: document.getElementById('waiting-room'),
        matchmakingWaitModal: document.getElementById('matchmaking-wait-modal'),
        winnerModal: document.getElementById('winner-modal'),
        confirmExitModal: document.getElementById('confirm-exit-modal'),
        pokerFoulCardPickModal: document.getElementById('poker-foul-card-pick-modal'),
        leaderboardModal: document.getElementById('leaderboard-modal'),
        shopModal: document.getElementById('shop-modal'),
        dailyRewardModal: document.getElementById('daily-reward-modal'),
        tutorialOverlay: document.getElementById('tutorial-overlay'),
        friendsModal: document.getElementById('friends-modal'),
        invitePopupModal: document.getElementById('invite-popup-modal'), 
        inviteWaitModal: document.getElementById('invite-wait-modal'),
        inviteGameSelect: document.getElementById('invite-game-select'),
        profileModal: document.getElementById('profile-modal'),
        settingsModal: document.getElementById('settings-modal'),
        privateChatModal: document.getElementById('private-chat-modal'),
        fullImageModal: document.getElementById('full-image-modal')
    };
    
    Object.values(allModals).forEach(modal => { if (modal) modal.classList.remove('show') });
    
    hideLobbyUI();
    const gameControls = ['power-control', 'pektus-control', 'left-arrow', 'right-arrow', 'exit-button', 'player-info', 'opponent-info', 'card-hand-container', 'cue-stick-element', 'chat-toggle-button'];
     gameControls.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
    });
    cueBallGuide.style.display = 'none';
    dragGuideText.style.display = 'none';

    if (state.modal === 'lobby') {
        showLobbyUI();
        gameState = 'lobby';
        draw();
    } else if (allModals[state.modal]) {
        allModals[state.modal].classList.add('show');
         
         if (['shopModal', 'leaderboardModal', 'dailyRewardModal', 'aiMenu', 'onlineGameSelect', 'onlineMenu', 'friendsModal'].includes(state.modal)) {
             const lobbyContainer = document.getElementById('lobby-buttons-container');
             if (lobbyContainer) lobbyContainer.style.display = 'flex';
             const xpCont = document.getElementById('xp-container');
             if(xpCont) xpCont.style.display = 'flex';
         } else {
             const xpCont = document.getElementById('xp-container');
             if(xpCont) xpCont.style.display = 'none';
         }
         
         gameState = 'modal_open';
         draw();
    } else {
        showLobbyUI();
        gameState = 'lobby';
        draw();
    }

    updateDailyRewardButtonState(); 
};

        function showExitConfirmation() { playButtonSound(); if (gameState !== 'menu' && gameState !== 'gameover' && !confirmExitModal.classList.contains('show')) { confirmExitModal.classList.add('show'); } }
        
        async function forfeitOnlineGame() {
            // 1. Safety check: Kung wala sa game, exit agad
            if (!isOnlineGame || !gameId) {
                // DITO ANG PAGBABAGO: Simpleng "You Forfeited" na lang ang message
                endGame("You Forfeited"); 
                return;
            }

            const gameDocRef = doc(db, "games", gameId);
            try {
                // 2. Kunin ang data para malaman kung sino ang panalo (yung kalaban)
                const gameData = (await getDoc(gameDocRef)).data();
                if (gameData && gameData.gameState !== 'finished') {
                    const opponentId = localPlayerId === 'player1' ? 'player2' : 'player1';
                    const winnerUid = gameData.players[opponentId]?.uid;

                    if (winnerUid) {
                        // 3. I-update sa database na "forfeited" ka
                        await updateDoc(gameDocRef, {
                            gameState: 'finished',
                            winner: winnerUid,
                            [`players.${localPlayerId}.status`]: 'forfeited' 
                        });
                    }
                }
            } catch (error) {
                console.error("Error forfeiting game:", error);
            } finally {
                // 4. Update UI: Ito ang magpapakita ng modal
                // DITO ANG PAGBABAGO: "You Forfeited" para maging PULA ang kulay
                endGame("You Forfeited"); 
            }
        }

        // === START PLAYER NAME UPDATE ===
        // Bagong function para i-manage ang pangalan
        function updateAndSavePlayerName() {
            const newName = playerNameInput.value.trim();
            if (newName && newName !== "") {
                localPlayerName = newName;
                localStorage.setItem('pinoyPoolPlayerName', newName);
            } else {
                // Kung walang laman, bigyan ng default
                localPlayerName = "Guest" + Math.floor(Math.random() * 1000);
                playerNameInput.value = localPlayerName; // I-update din ang input box
                localStorage.setItem('pinoyPoolPlayerName', localPlayerName);
            }
            return localPlayerName;
        }
        // === END PLAYER NAME UPDATE ===

function setupEventListeners(isReturningPlayer) { // <-- NAGBAGO ITO!
¬† ¬† const startOverlay = document.getElementById('start-overlay');
    const startPromptText = document.getElementById('start-prompt-text');
    const startNameInputArea = document.getElementById('start-name-input-area');
    const startNameInput = document.getElementById('start-player-name-input');
    const startNameSubmitBtn = document.getElementById('start-name-submit-btn');

    // Function para ituloy papuntang lobby
    async function proceedToLobby(playerName) {
        console.log("proceedToLobby function CALLED with name:", playerName); // Debug log
        if (!playerName) {
             console.error("Proceeding to lobby without player name!");
             localPlayerName = "Player"; // Fallback name
        } else {
            localPlayerName = playerName; // Set the name variable for the current session's use
        }

        // Start Audio Context
        try {
            if (!audioInitialized) {
                console.log("Initializing audio in proceedToLobby..."); // Debug log
                await initAudio();
            }
            if (audioInitialized) {
                 console.log("Playing background music..."); // Debug log
                 playBackgroundMusic();
            } else {
                 console.log("Audio still not initialized after initAudio call."); // Debug log
            }
        } catch (audioError) {
            console.error("Error initializing or playing audio:", audioError);
        }

        console.log("Hiding start overlay..."); // Debug log
        startOverlay.classList.remove('show');
        console.log("Showing lobby UI..."); // Debug log
        showLobbyUI();
        console.log("Replacing history state..."); // Debug log
        history.replaceState({ modal: 'lobby' }, 'Lobby', '#lobby');

        // Show welcome message only once after setting name
        if (!localStorage.getItem('pinoyPoolPlayerNameWasSet')) {
             console.log("Showing welcome message..."); // Debug log
             showMessage(`Welcome to Pinoy Pool, ${localPlayerName}!`, 4000);
             localStorage.setItem('pinoyPoolPlayerNameWasSet', 'true');
        }

        console.log("Loading last claim time..."); // Debug log
        loadLastClaimTime();
        console.log("Updating info box..."); // Debug log
        updateInfoBox();
        console.log("proceedToLobby finished."); // Debug log
createPlayerDocument();
    }

    // --- BAGO AT MAS MALINIS NA LOGIC ---
¬† ¬† // --- UPDATED LOGIC (Preloader Compatible) ---
    if (isReturningPlayer) { 
        // KUNG MAY PANGALAN NA: Deretso na agad sa Lobby!
        // Hindi na kailangan mag-click ulit dahil nag-click ka na sa Preloader.
        proceedToLobby(localPlayerName);

    } else {
        // KUNG NEW PLAYER: Ipakita ang Input Box para humingi ng pangalan
        startOverlay.classList.add('show'); // Ipakita ang overlay
        startPromptText.style.display = 'none'; // Tago ang "Click anywhere" text
        startNameInputArea.style.display = 'block'; // Pakita ang input box

        // Function to handle name submission
        const handleNameSubmit = () => {
            playButtonSound(); // Sound effect
            const name = startNameInput.value.trim();
            if (name) { 
                localStorage.setItem('pinoyPoolPlayerName', name); 
                localStorage.removeItem('pinoyPoolPlayerNameWasSet'); 
                proceedToLobby(name); 
            } else { 
                showMessage("Please enter your name!", 2000);
                startNameInput.focus(); 
            }
        };

        // Siguraduhing tanggalin muna ang lumang listener para iwas doble
        startNameSubmitBtn.onclick = handleNameSubmit; 

        // Listener sa Enter Key
        startNameInput.onkeyup = (event) => {
            if (event.key === 'Enter') handleNameSubmit();
        };
    }
¬† ¬† // --- END NG BAGO AT MAS MALINIS NA LOGIC ---
    // --- End of Start Overlay Logic ---
    // --- Basic UI Listeners ---
    muteButton.addEventListener('click', toggleMusic);
    fullscreenButton.addEventListener('click', toggleFullScreen);
    chatSendBtn.addEventListener('click', function() { sendMessage(); });
    chatInput.addEventListener('keyup', (event) => { if (event.key === 'Enter') { sendMessage(); } });
    const chatToggleButton = document.getElementById('chat-toggle-button');
    chatToggleButton.addEventListener('click', () => { if (chatContainer.style.display === 'flex') { chatContainer.style.display = 'none'; } else { chatContainer.style.display = 'flex'; } });
    window.addEventListener('resize', resizeCanvas);
    window.addEventListener('orientationchange', resizeCanvas);
    window.addEventListener('beforeunload', () => { if (isOnlineGame) leaveOnlineGame(true); });

    // General Sound Listener for all buttons
    document.querySelectorAll('.menu-button, .ui-button, .icon-button, .back-button, .confirm-button, .shop-buy-button, .modal-close-btn').forEach(button => {
        if (!button.hasAttribute('data-sound-listener-added')) {
            button.addEventListener('click', playButtonSound);
            button.setAttribute('data-sound-listener-added', 'true');
        }
    });

    // --- Lobby Button Listeners ---
    vsAiButton.addEventListener('click', () => {
        hideLobbyUI();
        aiMenu.classList.add('show');
        history.pushState({ modal: 'aiMenu' }, 'AI Menu', '#ai');
    });

    onlineButton.addEventListener('click', () => {
        if (!isAuthReady) { showMessage("Connecting... Please wait.", 2000); return; }
        if (!firebaseInitialized) { showMessage("An internet connection is required for online mode.", 3000); return; }
        hideLobbyUI();
        onlineGameSelect.classList.add('show');
        history.pushState({ modal: 'onlineGameSelect' }, 'Online', '#online');
    });

    // ... (ibang event listeners) ...

leaderboardButton.addEventListener('click', showLeaderboard);
document.getElementById('shop-button').addEventListener('click', openShop);
document.getElementById('daily-reward-button').addEventListener('click', claimDailyReward);
document.getElementById('friends-button').addEventListener('click', openFriendsModal);
document.getElementById('add-friend-btn').addEventListener('click', searchAndAddFriend);
// --- Listeners para sa Invite Game Select Modal ---
document.getElementById('invite-poker-button').addEventListener('click', () => sendInvite('poker'));
document.getElementById('invite-straight-ball-button').addEventListener('click', () => sendInvite('straight-ball'));
document.getElementById('invite-61-button').addEventListener('click', () => sendInvite('61-ball'));

// Close button para sa invite select
document.getElementById('invite-game-select-close-btn').addEventListener('click', () => {
    document.getElementById('invite-game-select').classList.remove('show');
    // Gagamitin natin ang history.back() para gumana sa popstate
    history.back();
});

    aiStraightBallButton.addEventListener('click', () => {
        selectedGameConfig.mode = 'ai-straight-ball';
        aiMenu.classList.remove('show');
        straightBallInstructions.classList.add('show');
        history.pushState({ modal: 'straightBallInstructions' }, 'Rules', '#rules');
    });
    aiPokerButton.addEventListener('click', () => {
        selectedGameConfig.mode = 'ai-poker';
        aiMenu.classList.remove('show');
        pokerInstructions.classList.add('show');
        history.pushState({ modal: 'pokerInstructions' }, 'Rules', '#rules');
    });
    ai61Button.addEventListener('click', () => {
        selectedGameConfig.mode = 'ai-61-ball';
        aiMenu.classList.remove('show');
        sixtyOneInstructions.classList.add('show');
        history.pushState({ modal: 'sixtyOneInstructions' }, 'Rules', '#rules');
    });

    // --- Instruction/Play Button Listeners ---
    playStraightBallButton.addEventListener('click', () => startGame(selectedGameConfig.mode, 'pro'));
    playPokerButton.addEventListener('click', () => startGame(selectedGameConfig.mode, 'pro'));
    play61BallButton.addEventListener('click', () => startGame(selectedGameConfig.mode, 'pro'));


    // 1. POKER BUTTON
    const btnPoker = document.getElementById('online-poker-button');
    if (btnPoker) {
        btnPoker.addEventListener('click', () => { 
            selectedOnlineGameType = 'poker';
            selectedBetAmount = 0; 
            if (typeof renderBetButtons === 'function') renderBetButtons();
            
            const gsModal = document.getElementById('online-game-select');
            const omModal = document.getElementById('online-menu');
            if (gsModal) gsModal.classList.remove('show'); 
            if (omModal) omModal.classList.add('show'); 
            history.pushState({ modal: 'onlineMenu' }, 'Online Menu', '#online-menu'); 
        });
    } else {
        console.warn("‚ö†Ô∏è WARNING: Nawawala ang 'online-poker-button' sa HTML!");
    }

    // 2. STRAIGHT BALL BUTTON
    const btnStraight = document.getElementById('online-straight-ball-button');
    if (btnStraight) {
        btnStraight.addEventListener('click', () => { 
            selectedOnlineGameType = 'straight-ball';
            selectedBetAmount = 0; 
            if (typeof renderBetButtons === 'function') renderBetButtons();
            
            const gsModal = document.getElementById('online-game-select');
            const omModal = document.getElementById('online-menu');
            if (gsModal) gsModal.classList.remove('show'); 
            if (omModal) omModal.classList.add('show'); 
            history.pushState({ modal: 'onlineMenu' }, 'Online Menu', '#online-menu'); 
        });
    } else {
        console.warn("‚ö†Ô∏è WARNING: Nawawala ang 'online-straight-ball-button' sa HTML!");
    }

    // 3. 61 BALL BUTTON
    const btn61 = document.getElementById('online-61-button');
    if (btn61) {
        btn61.addEventListener('click', () => { 
            selectedOnlineGameType = '61-ball';
            selectedBetAmount = 0; 
            if (typeof renderBetButtons === 'function') renderBetButtons();
            
            const gsModal = document.getElementById('online-game-select');
            const omModal = document.getElementById('online-menu');
            if (gsModal) gsModal.classList.remove('show'); 
            if (omModal) omModal.classList.add('show'); 
            history.pushState({ modal: 'onlineMenu' }, 'Online Menu', '#online-menu'); 
        });
    } else {
        console.warn("‚ö†Ô∏è WARNING: Nawawala ang 'online-61-button' sa HTML!");
    }
    createGameButton.addEventListener('click', createOnlineGame);
    joinGameButton.addEventListener('click', joinOnlineGame);
    findMatchButton.addEventListener('click', findMatch);
    // Ang listener para sa 'cancelMatchmakingButton' ay tinanggal na at pinalitan ng 'matchmaking-close-btn'

        // --- "X" (Close) Button Listeners ---
    const backButtonIds = [
        'ai-menu-close-btn',
        'online-select-close-btn',
        'online-menu-close-btn',
        'waiting-room-close-btn',
        'leaderboard-close-btn',
        'shop-close-btn',
        'friends-modal-close-btn' 
        // WALA NA DITO YUNG PROFILE!
    ];

    backButtonIds.forEach(id => {
        const btn = document.getElementById(id);
        if (btn && !btn.hasAttribute('data-click-listener-added')) {
            btn.addEventListener('click', () => {
                // playButtonSound(); // Handled na ng general listener sa taas
                history.back();
            });
            btn.setAttribute('data-click-listener-added', 'true');
        }
    });

    // --- Special "X" (Close) Buttons ---
    const matchmakingCloseBtn = document.getElementById('matchmaking-close-btn');
    if (matchmakingCloseBtn && !matchmakingCloseBtn.hasAttribute('data-click-listener-added')) {
        matchmakingCloseBtn.addEventListener('click', cancelMatchmaking);
        matchmakingCloseBtn.setAttribute('data-click-listener-added', 'true');
    }

    const dailyRewardCloseBtn = document.getElementById('daily-reward-close-btn');
    if (dailyRewardCloseBtn && !dailyRewardCloseBtn.hasAttribute('data-click-listener-added')) {
        dailyRewardCloseBtn.addEventListener('click', closeDailyRewardModal);
        dailyRewardCloseBtn.setAttribute('data-click-listener-added', 'true');
    }

    const dailyRewardOkBtn = document.getElementById('daily-reward-ok-btn');
    if (dailyRewardOkBtn && !dailyRewardOkBtn.hasAttribute('data-click-listener-added')) {
        dailyRewardOkBtn.addEventListener('click', closeDailyRewardModal);
        dailyRewardOkBtn.setAttribute('data-click-listener-added', 'true');
    }

    // --- In-Game / Modal Specific Listeners ---
    exitButton.addEventListener('click', showExitConfirmation);
    gameIdDisplay.addEventListener('click', () => { navigator.clipboard?.writeText(gameIdDisplay.textContent).then(() => showMessage("Game ID copied!", 1500)); });
    confirmExitYes.addEventListener('click', async () => {
        confirmExitModal.classList.remove('show');
        if (gameState === 'gameover' || gameState === 'menu' || gameState === 'lobby') {
            resetToMenu();
            return;
        }
        if (isOnlineGame) {
            await forfeitOnlineGame();
        } else {
            await endGame("You Forfeited. Opponent Wins!");
        }
    });
    confirmExitCancel.addEventListener('click', () => { confirmExitModal.classList.remove('show'); });

    // Winner Modal buttons
    aiRematchButton.addEventListener('click', restartAiGame);
    backToMenuButton.addEventListener('click', resetToMenu);
    document.getElementById('rematch-button').addEventListener('click', handleRematchRequest);

    // Pointer Event Listeners
    interactiveElements.forEach(el => {
        if (el && !el.hasAttribute('data-pointer-listeners-added')) {
            el.addEventListener('mousedown', handlePointerDown);
            el.addEventListener('touchstart', handlePointerDown, { passive: false });
            el.setAttribute('data-pointer-listeners-added', 'true');
        }
    });
    window.addEventListener('mouseup', handlePointerUp);
    window.addEventListener('touchend', handlePointerUp);
    window.addEventListener('mousemove', handlePointerMove);
    window.addEventListener('touchmove', handlePointerMove, { passive: false });

    // ‚ñº‚ñº‚ñº AI VOICE REMOVED (SILENT MODE) ‚ñº‚ñº‚ñº

// Ginawang empty para hindi mag-error ang laro
const aiChatter = {}; 
let isAiVoiceEnabled = false;

function getAiChatMessage(event, lang = 'tl') { return ""; }
function aiDisplayMessage(message) { return; /* Do nothing */ }
function toggleAiVoice() { return; /* Do nothing */ }
function updateVoiceButtonIcon() { return; /* Do nothing */ }

// ‚ñ≤‚ñ≤‚ñ≤ END OF SILENT MODE ‚ñ≤‚ñ≤‚ñ≤
    // Tutorial Button
    tutorialNextBtn.addEventListener('click', nextTutorialStep);

    // --- Winner Modal Fade Logic ---
    const revealWinnerModal = () => { if(winnerModal) winnerModal.classList.remove('faded'); };
    const fadeWinnerModal = (e) => {
        const target = e.target;
        const buttonContainer = winnerModal.querySelector('.winner-text-and-buttons');
        if (buttonContainer && buttonContainer.contains(target) && target.tagName === 'BUTTON') {
            return;
        }
        if (winnerModal && winnerModal.classList.contains('show')) {
            winnerModal.classList.add('faded');
        }
    };
    if (winnerModal && !winnerModal.hasAttribute('data-fade-listeners-added')) {
        winnerModal.addEventListener('mousedown', fadeWinnerModal);
        winnerModal.addEventListener('touchstart', fadeWinnerModal, { passive: true });
        winnerModal.addEventListener('mouseup', revealWinnerModal);
        winnerModal.addEventListener('touchend', revealWinnerModal);
        winnerModal.addEventListener('mouseleave', revealWinnerModal);
        winnerModal.setAttribute('data-fade-listeners-added', 'true');
    }

    // ... (iba pang code sa taas) ...

    // Ito yung nilagay natin kanina para sa Shop button
    const ingameShopBtn = document.getElementById('ingame-shop-button');
    if (ingameShopBtn) {
        ingameShopBtn.addEventListener('click', () => {
            playButtonSound(); 
            openShop(); 
        });
    }
    // ‚ñº‚ñº‚ñº DITO SA DULO NG setupEventListeners ‚ñº‚ñº‚ñº

    const profileCloseBtn = document.getElementById('profile-close-btn');
    if (profileCloseBtn) {
        const newBtn = profileCloseBtn.cloneNode(true);
        profileCloseBtn.parentNode.replaceChild(newBtn, profileCloseBtn);
        
        newBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            playButtonSound();
            
            // ‚úÖ FIX: Itaas lang ang flag, PERO WAG BAGUHIN ANG GAMESTATE
            window.isClosingModal = true; 
            
            // ‚ùå gameState = 'modal_open';  <-- TINANGGAL NATIN ITO
            // Hinayaan lang natin kung 'shooting' pa siya para matapos ang tira

            const modal = document.getElementById('profile-modal');
            if (modal) modal.classList.remove('show');

            history.back(); 
        });
    }
    

    
} // <--- ITO ANG DULO NG setupEventListeners (Wag mong buburahin to)


        function setupChatListener(gameIdForChat) { if (unsubscribeFromChat) { unsubscribeFromChat(); } chatMessages.innerHTML = ''; isInitialChatLoad = true; const chatToggleButton = document.getElementById('chat-toggle-button'); if(chatToggleButton) chatToggleButton.style.display = 'flex'; const messagesRef = collection(db, "games", gameIdForChat, "messages"); const q = query(messagesRef, orderBy("timestamp"), limit(200)); unsubscribeFromChat = onSnapshot(q, (snapshot) => { snapshot.docChanges().forEach(change => { if (change.type === 'added' && !isInitialChatLoad) { const messageData = change.doc.data(); if (messageData.senderId !== localPlayerUid && messageData.text) { showMessage(`${opponentPlayerName}: ${messageData.text}`, 5000); } } }); const allMessages = []; snapshot.docs.forEach(doc => allMessages.push(doc.data())); chatMessages.innerHTML = ''; allMessages.reverse().forEach(messageData => { const messageP = document.createElement('p'); messageP.textContent = messageData.text; if (messageData.senderId === localPlayerUid) { messageP.className = 'my-message'; } else { messageP.className = 'opponent-message'; } chatMessages.appendChild(messageP); }); isInitialChatLoad = false; }); }
        async function sendMessage() { const messageText = chatInput.value.trim(); if (messageText === '') { showMessage("ERROR: Hindi pwedeng walang laman ang message!", 3000); return; } if (isOnlineGame) { if (!gameId) { console.error("Cannot send message, no game ID."); return; } const messagesRef = collection(db, "games", gameId, "messages"); try { await addDoc(messagesRef, { text: messageText, senderId: localPlayerUid, timestamp: serverTimestamp() }); } catch (error) { showMessage("FIREBASE ERROR: Tingnan ang console.", 4000); console.error("Ang Firebase error ay:", error); } } else { const messageP = document.createElement('p'); messageP.textContent = messageText; messageP.className = 'my-message'; chatMessages.insertBefore(messageP, chatMessages.firstChild); } chatInput.value = ''; chatContainer.style.display = 'none'; }

        // Updated initAudio function
        function initAudio() {
            if (audioInitialized || typeof Tone === 'undefined') {
                return Promise.resolve();
            }
            return Tone.start().then(() => {
                // Existing Synths
                chipCollisionSynth = new Tone.MembraneSynth({ pitchDecay: 0.008, octaves: 5, oscillator: { type: "triangle" }, envelope: { attack: 0.001, decay: 0.15, sustain: 0, release: 0.1, attackCurve: "exponential", }, }).toDestination();
                chipCollisionSynth.volume.value = -4;

                cueHitSynth = new Tone.PluckSynth({ attackNoise: 1, dampening: 2000, resonance: 0.5, }).toDestination();
                cueHitSynth.volume.value = -1;

                cushionSynth = new Tone.MembraneSynth({ pitchDecay: 0.01, octaves: 4, envelope: { attack: 0.001, decay: 0.2, sustain: 0 } }).toDestination();
                cushionSynth.volume.value = -10;

                pocketSynth = new Tone.NoiseSynth({ noise: { type: 'brown' }, envelope: { attack: 0.005, decay: 0.15, sustain: 0.1 } }).toDestination();
                pocketSynth.volume.value = -5;

                uiSynth = new Tone.PluckSynth({ attackNoise: 0.5, dampening: 4000, resonance: 0.8 }).toDestination();
                uiSynth.volume.value = -4;

                // --- BAGONG Synths ---
                aimingSynth = new Tone.MetalSynth({
                    frequency: 300,
                    envelope: { attack: 0.001, decay: 0.05, release: 0.05 },
                    harmonicity: 3.1,
                    modulationIndex: 16,
                    resonance: 2000,
                    octaves: 0.5
                }).toDestination();
                aimingSynth.volume.value = -25; // Mahina lang dapat

                powerSynth = new Tone.AMSynth({
                    harmonicity: 1.5,
                    envelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 0.1 },
                    modulationEnvelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 0.1 }
                }).toDestination();
                powerSynth.volume.value = -15; // Medyo mahina para hindi masakit sa tenga
                // --- End BAGONG Synths ---


                audioInitialized = true;
                console.log("Tone.js audio context started successfully.");
            }).catch(e => {
                console.error("Could not start Tone.js audio context:", e);
                audioInitialized = false;
            });
        }

// Ito ang taga-play ng sound
function playCoinSound() {
    // 1. Hanapin yung player na nilagay natin sa HTML
    const sfx = document.getElementById('coin-sfx');
    
    if (sfx) {
        // 2. Gumawa ng "Clone" (Kopya)
        // Bakit? Para kung sunod-sunod ang coins, hindi maputol ang tunog!
        const clone = sfx.cloneNode();
        
        // 3. I-set ang volume (0.1 to 1.0)
        clone.volume = 0.5; 
        
        // 4. Play!
        clone.play().catch(e => console.log("Audio error:", e));
        
        // 5. Itapon ang clone pagtapos tumunog para malinis
        clone.onended = function() {
            clone.remove();
        };
    }
}
        async function playButtonSound() {
             if (buttonSoundPlaying) return;
             // Ensure audio is initialized, especially if this is the first interaction
             if (!audioInitialized) await initAudio();
             if (!audioInitialized || !uiSynth) {
                console.log("Cannot play button sound: Audio not ready or synth missing.");
                return;
             }
             buttonSoundPlaying = true;
             try {
                uiSynth.triggerAttackRelease("C5", "8n", Tone.now());
             } catch (e) {
                 console.error("Error playing button sound:", e);
             }
             setTimeout(() => { buttonSoundPlaying = false; }, 50); // Prevent rapid re-triggering
        }

        async function playAimingSound() {
             return;
             if (!audioInitialized || !aimingSynth) return;
             const now = Tone.now();
             if (now < lastAimSoundTime + (AIM_SOUND_INTERVAL / 1000)) return; // Throttle the sound
             lastAimSoundTime = now;
             try {
                 // Adjust frequency slightly for variation
                 const freq = 200 + Math.random() * 50;
                 aimingSynth.frequency.setValueAtTime(freq, now);
                 aimingSynth.triggerAttackRelease("32n", now);
             } catch (e) {
                 console.error("Error playing aiming sound:", e);
             }
        }

        async function playPowerSound(powerLevel) { // powerLevel is 0 to 1
             if (!audioInitialized || !powerSynth) return;
             const now = Tone.now();
             const minFreq = 100;
             const maxFreq = 600;
             const freq = minFreq + (maxFreq - minFreq) * powerLevel * powerLevel; // Exponential increase sounds better
             const volume = -20 + (powerLevel * 15); // Louder as power increases

             if (!isPowerSoundPlaying) {
                 isPowerSoundPlaying = true;
                 powerSynth.volume.linearRampToValueAtTime(volume, now + 0.01);
                 powerSynth.frequency.linearRampToValueAtTime(freq, now + 0.01);
                 powerSynth.triggerAttack(now);
             } else {
                 // Adjust volume and frequency smoothly if already playing
                 powerSynth.volume.linearRampToValueAtTime(volume, now + 0.05);
                 powerSynth.frequency.linearRampToValueAtTime(freq, now + 0.05);
             }
        }

        async function stopPowerSound() {
            if (!audioInitialized || !powerSynth || !isPowerSoundPlaying) return;
            isPowerSoundPlaying = false;
            try {
                 const now = Tone.now();
                 // Ramp down volume quickly before release
                 powerSynth.volume.linearRampToValueAtTime(-60, now + 0.05);
                 powerSynth.triggerRelease(now + 0.06);
            } catch (e) {
                console.error("Error stopping power sound:", e);
            }
        }


        // START: SPINNING CHIP UPDATE (Pinalitan ang note para maging "clack!")
        async function playCollisionSound(speed) { if (!audioInitialized) await initAudio(); if (!audioInitialized) return; const now = Tone.now(); if (now <= lastCollisionSoundTime) return; lastCollisionSoundTime = now + 0.04; const volume = -12 + Math.min(1, speed / 25) * 14; const note = speed > 15 ? 'C3' : (speed > 5 ? 'A2' : 'G2'); chipCollisionSynth.volume.value = volume; chipCollisionSynth.triggerAttackRelease(note, "32n", now); }
        async function playCushionSound(speed) { if (!audioInitialized) await initAudio(); if (!audioInitialized) return; const now = Tone.now(); if (now <= lastCushionSoundTime) return; lastCushionSoundTime = now + 0.03; const volume = -12 + Math.min(1, speed / 15) * 8; const note = speed > 10 ? 'C2' : 'D1'; cushionSynth.volume.value = volume; cushionSynth.triggerAttackRelease(note, '16n', now); }
        async function playCueHitSound(power) { if (!audioInitialized) await initAudio(); if (!audioInitialized) return; const now = Tone.now(); const volume = -6 + (power * 6); const note = 'C4'; cueHitSynth.volume.value = volume; cueHitSynth.triggerAttack(note, now); }
        async function playPocketSound() { if (!audioInitialized) await initAudio(); if (!audioInitialized) return; pocketSynth.triggerAttackRelease("0.2"); }
        function update(timestamp) { // <-- Ito na 'yung bago, na may (timestamp)
            
            // Kung 'di pa nagsisimula, set mo ang lastTime
            if (lastTime === 0) {
                lastTime = timestamp;
            }
            
            // 1. Kalkulahin kung gaano katagal ang lumipas
            const deltaTime = timestamp - lastTime;
            lastTime = timestamp;

            // 2. Idagdag ang lumipas na oras sa "accumulator"
            accumulator += deltaTime;

            // 3. I-proseso ang input (ito 'yung dati mong code sa update)
            if (isRotatingLeft || isRotatingRight) {
                if (isRotatingLeft) cueStick.angle -= ROTATION_SPEED;
                if (isRotatingRight) cueStick.angle += ROTATION_SPEED;
                if (!isTutorialActive) sendLiveAimData();
                playAimingSound();
            }

            // 4. Ito ang magic: Ang Physics Loop
¬† ¬† ¬† ¬† ¬† ¬† // (Idagdag ito para maiwasan ang "spiral of death" kung mag-lag ng 1 segundo)
¬† ¬† ¬† ¬† ¬† ¬† let maxLoops = 5; // Limitahan sa 5 physics update bawat frame

¬† ¬† ¬† ¬† ¬† ¬† // Habang may sapat na oras na naipon, patakbuhin ang physics
¬† ¬† ¬† ¬† ¬† ¬† while (accumulator >= FIXED_DELTA_TIME_MS && maxLoops > 0) { // <--- BINAGO
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (chipsMoving) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† updateChipPositions(FIXED_DELTA_TIME_SEC);¬†
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† accumulator -= FIXED_DELTA_TIME_MS;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† maxLoops--; // <--- DINAGDAG
¬† ¬† ¬† ¬† ¬† ¬† }

            // 5. I-drawing ang resulta (kahit gaano kabilis ang screen)
            draw();
            
            // 6. Ulitin
            requestAnimationFrame(update); // <-- Tatawagin ulit ang sarili niya
        }
        // ‚ñº‚ñº‚ñº PALITAN MO ANG BUONG draw FUNCTION NITO ‚ñº‚ñº‚ñº

function draw() { 
    // 1. I-drawing ang background (Mabilis ito)
    ctx.drawImage(backgroundCanvas, 0, 0);

    // ‚ùå WALA NA DAPAT DITO YUNG VIGNETTE CODE ‚ùå

    // 2. I-drawing ang mga chips
    drawChips(); 
    
    // 3. Guidelines
    const isMyTurn = isOnlineGame ? isMyTurnOnline : playerTurn; 
    if (isMyTurn && gameState === 'aiming' && !isTutorialActive) { 
        drawGuidelines(); 
    } 

    // 4. Tako / Cue Stick
    if ((gameState === 'aiming' || gameState === 'shooting_animation' || (isOnlineGame && !isMyTurnOnline)) && cueStick.visible) { 
        drawCueStick(); 
    } 

    // 5. Fireworks
    updateAndDrawFireworks();
}

function toggleMusic() { const isMuted = backgroundPlaylist[0].muted; backgroundPlaylist.forEach(player => { player.muted = !isMuted; }); muteButton.textContent = isMuted ? "üéµ" : "üîá"; }
        // ‚ñº‚ñº‚ñº PALITAN MO ITONG BUONG FUNCTION ‚ñº‚ñº‚ñº
        function resizeCanvas() {
¬† ¬† const oldCanvasWidth = canvas.width;
¬† ¬† const oldCanvasHeight = canvas.height;
¬† ¬† let chipRatios;

¬† ¬† if (!isBreakShot && chips.length > 0 && oldCanvasWidth > 0 && oldCanvasHeight > 0) {
¬† ¬† ¬† ¬† 
¬† ¬† ¬† ¬† chipRatios = chips.map(c => ({ x: c.x / VIRTUAL_WIDTH, y: c.y / VIRTUAL_HEIGHT }));
¬† ¬† }

¬† ¬† const containerWidth = window.innerWidth;
¬† ¬† const containerHeight = window.innerHeight;
¬† ¬† const screenAspectRatio = containerWidth / containerHeight;
¬† ¬† const tableFrame = document.getElementById('table-frame');
¬† ¬† let frameWidth, frameHeight;

¬† ¬† const paddingPercentage = 0.85; 

¬† ¬† if (screenAspectRatio > TABLE_ASPECT_RATIO) {
¬† ¬† ¬† ¬† frameHeight = containerHeight * paddingPercentage; // <-- NILAGYAN NG PADDING
¬† ¬† ¬† ¬† frameWidth = frameHeight * TABLE_ASPECT_RATIO;
¬† ¬† } else {
¬† ¬† ¬† ¬† frameWidth = containerWidth * paddingPercentage; // <-- NILAGYAN NG PADDING
¬† ¬† ¬† ¬† frameHeight = frameWidth / TABLE_ASPECT_RATIO;
¬† ¬† }
¬† ¬† 
¬† ¬† tableFrame.style.width = `${frameWidth}px`;
¬† ¬† tableFrame.style.height = `${frameHeight}px`;

¬† ¬† canvas.width = VIRTUAL_WIDTH;
¬† ¬† canvas.height = VIRTUAL_HEIGHT;

¬† ¬† 
¬† ¬† backgroundCanvas.width = VIRTUAL_WIDTH;
¬† ¬† backgroundCanvas.height = VIRTUAL_HEIGHT;

¬† ¬† table.width = VIRTUAL_WIDTH;
¬† ¬† table.height = VIRTUAL_HEIGHT;
¬† ¬†
¬† ¬† setupHoles(); ¬† ¬† if (isBreakShot || !chipRatios) {
¬† ¬† ¬† ¬† setupChips(); // Gagamit na rin ng scale=1
¬† ¬† } else if (chipRatios) {
¬† ¬† ¬† ¬† chips.forEach((chip, i) => {
¬† ¬† ¬† ¬† ¬† ¬† const radiusConstant = chip.id === 0 ? CUE_BALL_RADIUS : BALL_RADIUS;
¬† ¬† ¬† ¬† ¬† ¬† if (chipRatios[i]) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // I-multiply sa VIRTUAL_WIDTH/HEIGHT
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† chip.x = chipRatios[i].x * VIRTUAL_WIDTH;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† chip.y = chipRatios[i].y * VIRTUAL_HEIGHT;
¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† 
¬† ¬† ¬† ¬† ¬† ¬† chip.radius = radiusConstant; 
¬† ¬† ¬† ¬† });
¬† ¬† }

¬† ¬† 
¬† ¬† drawBackgroundLayer();
}
        function setupHoles() { const hr = HOLE_RADIUS * scale; holes = [ { x: 0, y: 0, radius: hr }, { x: canvas.width, y: 0, radius: hr }, { x: 0, y: canvas.height, radius: hr }, { x: canvas.width, y: canvas.height, radius: hr } ]; }
        function setupChips() { chips = []; const newCueChip = { id: 0, value: 0, x: canvas.width * 0.25, y: canvas.height / 2, vx: 0, vy: 0, radius: CUE_BALL_RADIUS * scale, inPlay: true, color: '#1a1a1a', type: 'cue', isPocketing: false, pocketingProgress: 0, pocketingHole: null, rotation: 0, rotationSpeed: 0, currentSideSpin: 0 }; chips.push(newCueChip); const objectChipRadius = BALL_RADIUS * scale; if (gameMode.includes('straight-ball') || gameMode.includes('poker')) { const redChipsSource = []; const blueChipsSource = []; for (let i = 1; i <= 12; i++) { if (i <= 6) { redChipsSource.push({ id: i, color: '#C8102E', type: 'red', value: i }); } else { blueChipsSource.push({ id: i, color: '#0033A0', type: 'blue', value: i }); } } const startX = canvas.width * 0.7; const startY = canvas.height / 2; const colSpacing = objectChipRadius * 2.1; const rowSpacing = objectChipRadius * 1.8; const positions = []; const rows = 4; const cols = 3; const totalHeight = (rows - 1) * rowSpacing; const initialY = startY - totalHeight / 2; for (let row = 0; row < rows; row++) { for (let col = 0; col < cols; col++) { positions.push({ x: startX + col * colSpacing, y: initialY + row * rowSpacing }); } } const chipDataOrder = [ ...redChipsSource, ...blueChipsSource ]; for (let i = 0; i < positions.length; i++) { let chipData = chipDataOrder[i]; if (chipData) { const newObjectChip = { id: chipData.id, value: chipData.value, x: positions[i].x, y: positions[i].y, vx: 0, vy: 0, radius: objectChipRadius, inPlay: true, color: chipData.color, type: chipData.type, isPocketing: false, pocketingProgress: 0, pocketingHole: null, rotation: 0, rotationSpeed: 0 }; chips.push(newObjectChip); } } } else if (gameMode.includes('61-ball')) { const chipColors = [ null, '#FFD700', '#0000FF', '#FF0000', '#800080', '#FFA500', '#008000', '#964B00', '#212121', '#FFC107', '#03A9F4', '#F44336', '#9C27B0', '#FF9800', '#4CAF50', '#795548' ]; let chipIds = Array.from({length: 15}, (_, i) => i + 1); const startX = canvas.width * 0.7; const startY = canvas.height / 2; const rowSpacing = objectChipRadius * 1.8; const rackPositions = []; for (let row = 0; row < 5; row++) { for (let col = 0; col <= row; col++) { rackPositions.push({ x: startX + row * rowSpacing, y: startY + (col * objectChipRadius * 2.1) - (row * objectChipRadius * 1.05) }); } } for (let i = 0; i < 15; i++) { const chipId = chipIds[i]; const newObjectChip = { id: chipId, value: chipId, x: rackPositions[i].x, y: rackPositions[i].y, vx: 0, vy: 0, radius: objectChipRadius, inPlay: true, color: chipColors[chipId], type: 'numbered', isPocketing: false, pocketingProgress: 0, pocketingHole: null, rotation: 0, rotationSpeed: 0 }; chips.push(newObjectChip); } } }
        

function drawBackgroundLayer() {
    // 1. I-DRAWING ANG PICTURE (Wood, Blue Felt, etc.)
    if (tableSurfaceImage.complete && tableSurfaceImage.naturalWidth !== 0) {
        backgroundCtx.drawImage(tableSurfaceImage, 0, 0, backgroundCanvas.width, backgroundCanvas.height);
    } else {
        // Fallback color habang naglo-load
        backgroundCtx.fillStyle = '#C89646'; 
        backgroundCtx.fillRect(0, 0, backgroundCanvas.width, backgroundCanvas.height);
    }

    
    
    let tintToUse = window.currentFeltTint;
    
    // Safety check: Kung bagong load at undefined, mag-default sa Gold (para sa Wood texture)
    if (typeof tintToUse === 'undefined') {
        tintToUse = 'rgba(200, 150, 70, 0.85)';
    }

    // KUNG MAY LAMAN ANG TINT, IPATONG. KUNG NULL, WAG GALAWIN.
    if (tintToUse !== null) {
        backgroundCtx.fillStyle = tintToUse;
        backgroundCtx.fillRect(0, 0, backgroundCanvas.width, backgroundCanvas.height);
    }
    
    const shadowColor = 'rgba(0, 0, 0, 0.5)'; 
    const shadowWidth = 10; 
    const transparent = 'rgba(0, 0, 0, 0)';
    
    // Top
    const topGradient = backgroundCtx.createLinearGradient(0, 0, 0, shadowWidth);
    topGradient.addColorStop(0, shadowColor); topGradient.addColorStop(1, transparent);
    backgroundCtx.fillStyle = topGradient; backgroundCtx.fillRect(0, 0, backgroundCanvas.width, shadowWidth);

    // Bottom
    const bottomGradient = backgroundCtx.createLinearGradient(0, backgroundCanvas.height - shadowWidth, 0, backgroundCanvas.height);
    bottomGradient.addColorStop(0, transparent); bottomGradient.addColorStop(1, shadowColor);
    backgroundCtx.fillStyle = bottomGradient; backgroundCtx.fillRect(0, backgroundCanvas.height - shadowWidth, backgroundCanvas.width, shadowWidth);

    // Left
    const leftGradient = backgroundCtx.createLinearGradient(0, 0, shadowWidth, 0);
    leftGradient.addColorStop(0, shadowColor); leftGradient.addColorStop(1, transparent);
    backgroundCtx.fillStyle = leftGradient; backgroundCtx.fillRect(0, 0, shadowWidth, backgroundCanvas.height);

    // Right
    const rightGradient = backgroundCtx.createLinearGradient(backgroundCanvas.width - shadowWidth, 0, backgroundCanvas.width, 0);
    rightGradient.addColorStop(0, transparent); rightGradient.addColorStop(1, shadowColor);
    backgroundCtx.fillStyle = rightGradient; backgroundCtx.fillRect(backgroundCanvas.width - shadowWidth, 0, shadowWidth, backgroundCanvas.height);
    
    backgroundCtx.fillStyle = '#1a1a1a';
    holes.forEach(hole => {
        backgroundCtx.beginPath();
        backgroundCtx.arc(hole.x, hole.y, hole.radius, 0, Math.PI * 2);
        backgroundCtx.fill();
        backgroundCtx.strokeStyle = 'rgba(255,255,255,0.15)';
        backgroundCtx.lineWidth = 2;
        backgroundCtx.stroke();
    });

    if (backgroundCanvas.width > 0) {
        const fontSize = 60 * scale; 
        backgroundCtx.font = `italic bold ${fontSize}px Georgia`;
        
        backgroundCtx.fillStyle = 'rgba(0, 0, 0, 0.4)';  
        backgroundCtx.strokeStyle = 'rgba(0, 0, 0, 0.2)';
        backgroundCtx.textBaseline = 'middle';
        
        // Ang Spot (Headstring spot)
        const spotX = backgroundCanvas.width * 0.7; 
        const spotY = backgroundCanvas.height / 2;
        const spotRadius = BALL_RADIUS * scale;
        
        // Drawing ng Spot (Bilog) - Ito ang magsisilbing "O"
        backgroundCtx.lineWidth = 3.5 * scale;
        backgroundCtx.beginPath();
        backgroundCtx.arc(spotX, spotY, spotRadius, 0, Math.PI * 2);
        backgroundCtx.stroke(); 
     
        const textPart1 = "M";      // Kaliwa ng spot
        const textPart2 = "nster";  // Kanan ng spot
        const spacing = 8 * scale;
        
        // Drawing Part 1 (M)
        backgroundCtx.textAlign = 'right';
        backgroundCtx.fillText(textPart1, spotX - spotRadius - spacing, spotY);
        
        // Drawing Part 2 (nster)
        backgroundCtx.textAlign = 'left';
        backgroundCtx.fillText(textPart2, spotX + spotRadius + spacing, spotY);
        
        // Drawing Main Title (Pinoy Pool)
        backgroundCtx.font = `italic bold ${fontSize}px Georgia`;
        backgroundCtx.textAlign = 'center';
        backgroundCtx.fillText("Pinoy Pool", (backgroundCanvas.width / 2) - (60 * scale), spotY);
    }
}

function drawChips() {
    chips.forEach(chip => {
        if (chip.inPlay) {
            let displayRadius = chip.radius;
            
            // Animation kapag nahuhulog sa butas
            if (chip.isPocketing) {
                displayRadius *= (1 - chip.pocketingProgress);
            }

            // SAVE STATE 1: Para sa Translation/Rotation
            ctx.save(); 
            ctx.translate(chip.x, chip.y); 

            // --- STEP A: FAKE SHADOW ---
            if (!chip.isPocketing) { 
                ctx.beginPath();
                ctx.arc(3 * scale, 4 * scale, displayRadius, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(0, 0, 0, 0.3)'; 
                ctx.fill();
            }

            // --- STEP B: ROTATION ---
            ctx.rotate(chip.rotation);

            // --- STEP C: DRAWING ---
            if (chip.id === 0) {
                // === CUE CHIP (TIRADOR) ===
                ctx.beginPath();
                ctx.arc(0, 0, displayRadius, 0, Math.PI * 2);
                ctx.fillStyle = '#FFD700'; 
                ctx.fill();

                // Mga guhit ng Tirador
                ctx.strokeStyle = '#424242';
                ctx.lineWidth = 1.5 * scale;
                ctx.beginPath(); ctx.arc(0, 0, displayRadius * 0.8, 0, Math.PI * 2); ctx.stroke();
                ctx.beginPath(); ctx.arc(0, 0, displayRadius * 0.5, 0, Math.PI * 2); ctx.stroke();
                ctx.beginPath(); ctx.arc(0, 0, displayRadius * 0.2, 0, Math.PI * 2); ctx.fillStyle = '#303030'; ctx.fill();

            } else {
                // === OBJECT CHIP (PICHA) ===
                const acrylicThickness = displayRadius * 0.15;
                const coloredRadius = displayRadius - acrylicThickness;

                // 1. Outer Acrylic Edge (Gawing GOLD #FFD700)
                ctx.beginPath(); 
                ctx.arc(0, 0, displayRadius - (acrylicThickness / 3), 0, Math.PI * 2);
                
                // DITO BINAGO: Ginawang Gold ang border
                ctx.strokeStyle = '#FFD700'; 
                
                ctx.lineWidth = acrylicThickness * 0.8; 
                ctx.stroke(); 

                // 2. Inner Colored Area (Red 1-6, Blue 7-12)
                let finalColor = chip.color; 
                if (chip.id >= 1 && chip.id <= 6) finalColor = '#C62828'; 
                else if (chip.id >= 7 && chip.id <= 12) finalColor = '#1565C0'; 

                ctx.beginPath();
                ctx.arc(0, 0, coloredRadius, 0, Math.PI * 2);
                ctx.fillStyle = finalColor;
                ctx.fill();

                // Glossy Inner Stroke
                ctx.strokeStyle = 'rgba(255,255,255,0.2)';
                ctx.lineWidth = 1;
                ctx.stroke();

                // 3. Numero (BIGGER FONTS)
                if (chip.id) {
                    ctx.save(); 

                    // DITO BINAGO: Pinalaki ang multiplier mula 1.1 -> 1.4
                    ctx.font = `900 ${coloredRadius * 1.4}px "Arial Black", "Impact", sans-serif`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';

                    const textOffsetY = coloredRadius * 0.1; 

                    // Outline
                    ctx.strokeStyle = 'black';
                    ctx.lineWidth = coloredRadius * 0.15; 
                    ctx.lineJoin = 'round'; 
                    ctx.strokeText(chip.id, 0, textOffsetY);

                    // Fill
                    ctx.fillStyle = 'white';
                    ctx.fillText(chip.id, 0, textOffsetY);

                    // Special Case: Labels for 6 & 9
                    if (chip.id === 6 || chip.id === 9) {
                        const labelText = chip.id === 6 ? "SIX" : "NINE";
                        ctx.font = `bold ${coloredRadius * 0.25}px Arial, sans-serif`;
                        ctx.lineWidth = coloredRadius * 0.05;
                        // Adjusted position para di tumama sa malaking number
                        ctx.strokeText(labelText, 0, coloredRadius * 0.75); 
                        ctx.fillText(labelText, 0, coloredRadius * 0.75);
                    }
                    
                    ctx.restore(); 
                }
            } 

            ctx.restore(); // RESTORE STATE
        } 

        // === RING LIGHT / HIGHLIGHT ===
        const isMyTurn = isOnlineGame ? isMyTurnOnline : playerTurn;
        if (isMyTurn && (gameState === 'aiming' || (gameState === 'moving' && canMoveCueBall)) && chip.inPlay && legalTargetChipIds.has(chip.id)) {
            const pulse = Math.abs(Math.sin(performance.now() * 0.004));
            const alpha = pulse * 0.7 + 0.3;
            const ringWidth = 2.5 * scale;
            const glowRadius = 0 * scale;
            const ringColor = `rgba(255, 255, 0, ${alpha})`;
            const glowColor = `rgba(255, 255, 0, ${alpha * 0.7})`;

            ctx.save();
            ctx.shadowColor = glowColor;
            ctx.shadowBlur = glowRadius;
            ctx.beginPath();
            ctx.arc(chip.x, chip.y, chip.radius + ringWidth + (2 * scale), 0, Math.PI * 2);
            ctx.strokeStyle = ringColor;
            ctx.lineWidth = ringWidth;
            ctx.stroke();
            ctx.restore();
        }
    });
}
        
function drawCueStick() {
    // 1. Check kung dapat ipakita ang tako
    if (!cueStick.visible || !chips[0] || !chips[0].inPlay || !cueStickElement) return;
    
    const cueChip = chips[0];
    const canvasRect = canvas.getBoundingClientRect(); 
    const wrapperRect = gameWrapper.getBoundingClientRect();
    
    // Kunin ang sukat
    const stickWidth = cueStickElement.offsetWidth;
    const stickHeight = cueStickElement.offsetHeight;

    // 2. Conversion logic (Virtual to Screen)
    const xRatio = canvasRect.width / VIRTUAL_WIDTH;
    const yRatio = canvasRect.height / VIRTUAL_HEIGHT;
    const cueBallScreenX = cueChip.x * xRatio;
    const cueBallScreenY = cueChip.y * yRatio;
    const canvasScreenLeft = canvasRect.left - wrapperRect.left;
    const canvasScreenTop = canvasRect.top - wrapperRect.top;
    const cueBallCenterX = canvasScreenLeft + cueBallScreenX;
    const cueBallCenterY = canvasScreenTop + cueBallScreenY;

    // 3. Position and Rotation
    cueStickElement.style.left = `${cueBallCenterX - stickWidth}px`;
    cueStickElement.style.top = `${cueBallCenterY - (stickHeight / 2)}px`;
    
    const pullbackPixels = -cueStick.pullback;
    cueStickElement.style.transform = `rotate(${cueStick.angle}rad) translateX(${pullbackPixels - 15}px)`;

    // ‚ñº‚ñº‚ñº 4. GLOW LOGIC (UPDATED) ‚ñº‚ñº‚ñº
    
    let currentCueId = 'default'; 

    if (isOnlineGame) {
        // ONLINE MODE
        if (isMyTurnOnline) {
            currentCueId = equippedItems.cue;
        } else {
            currentCueId = opponentEquippedCueId || 'default';
        }
    } else {
        // AI / PRACTICE MODE
        if (playerTurn) {
            currentCueId = equippedItems.cue; // Sayo
        } else {
            currentCueId = 'default'; // AI (Laging Kawayan)
        }
    }

    // I-set ang filter base sa ID
    if (currentCueId === 'alien_neon') {
        // CYAN NEON GLOW
        cueStickElement.style.filter = 'drop-shadow(0 0 8px #00FFFF) drop-shadow(0 0 15px #00E5FF)';
        
    } else if (currentCueId === 'perlas_legend') {
        // GOLD GLOW
        cueStickElement.style.filter = 'drop-shadow(0 0 8px #FFD700)';
        
    } else {
        // DEFAULT SHADOW (Walang ilaw)
        cueStickElement.style.filter = 'drop-shadow(2px 5px 5px rgba(0,0,0,0.5))';
    }
}


// ‚ñº‚ñº‚ñº PURE WHITE TRACTOR BEAM (NO CENTER LINE) ‚ñº‚ñº‚ñº

function drawGuidelines() {
    // 1. Kunin ang stats
    const stats = getCurrentCueStats();

    // 2. Safety Checks
    if (gameState !== 'aiming' || chipsMoving) return;
    const cueChip = chips[0];
    if (!cueChip || !cueChip.inPlay) return;
    
    // 3. Kalkulahin ang Hit Logic
    const angle = cueStick.angle;
    const shotVector = { x: Math.cos(angle), y: Math.sin(angle) };
    let firstHit = null;
    let minCollisionDist = Infinity;
    
    for (const targetChip of chips) {
        if (targetChip.id === 0 || !targetChip.inPlay) continue;
        const cueToTarget = { x: targetChip.x - cueChip.x, y: targetChip.y - cueChip.y };
        const projDist = cueToTarget.x * shotVector.x + cueToTarget.y * shotVector.y;
        if (projDist <= 0) continue;
        const closestPointOnPath = { x: cueChip.x + projDist * shotVector.x, y: cueChip.y + projDist * shotVector.y };
        const perpDistSq = (closestPointOnPath.x - targetChip.x)**2 + (closestPointOnPath.y - targetChip.y)**2;
        const combinedRadiusSq = (cueChip.radius + targetChip.radius)**2;
        if (perpDistSq >= combinedRadiusSq) continue;
        const travelDist = projDist - Math.sqrt(combinedRadiusSq - perpDistSq);
        if (travelDist < minCollisionDist) {
            minCollisionDist = travelDist;
            firstHit = { chip: targetChip, travelDist: travelDist };
        }
    }
    
    // --- ANIMATION PULSE ---
    const time = Date.now() * 0.005;
    const pulse = (Math.sin(time) + 1) / 2; 
    // Mas "Ghostly" na puti (0.2 hanggang 0.4 opacity)
    const beamAlpha = 0.2 + (pulse * 0.2); 

    // Setup Points
    let startX = cueChip.x;
    let startY = cueChip.y;
    let endX, endY;

    if (firstHit) {
        endX = cueChip.x + firstHit.travelDist * shotVector.x;
        endY = cueChip.y + firstHit.travelDist * shotVector.y;
    } else {
        endX = cueChip.x + shotVector.x * 2000;
        endY = cueChip.y + shotVector.y * 2000;
    }

    
    ctx.save();
    
    // Gradient: Pure White -> Transparent
    const beamGradient = ctx.createLinearGradient(startX, startY, endX, endY);
    beamGradient.addColorStop(0, `rgba(255, 255, 255, ${beamAlpha})`);   
    beamGradient.addColorStop(1, `rgba(255, 255, 255, 0)`);             

    // Draw Beam (Walang inner line)
    ctx.beginPath();
    ctx.moveTo(startX, startY);
    ctx.lineTo(endX, endY);
    
    ctx.lineWidth = cueChip.radius * 1.8; // Malapad pa rin
    ctx.strokeStyle = beamGradient;
    ctx.lineCap = 'round';
    
    // White Glow Effect
    ctx.shadowBlur = 15; 
    ctx.shadowColor = 'rgba(255, 255, 255, 0.5)';
    
    ctx.stroke();
    
    ctx.restore();

    
    if (firstHit) {
        const impactPoint = { x: endX, y: endY };
        
        ctx.save();
        ctx.translate(impactPoint.x, impactPoint.y);
        
        ctx.beginPath();
        ctx.arc(0, 0, cueChip.radius, 0, Math.PI * 2);
        
        // Semi-transparent White
        ctx.fillStyle = `rgba(255, 255, 255, 0.2)`; 
        ctx.fill();
        
        // White Outline
        ctx.strokeStyle = '#FFFFFF';
        ctx.lineWidth = 2;
        ctx.shadowBlur = 10;
        ctx.shadowColor = '#FFFFFF';
        ctx.stroke();
        
        ctx.restore();

        // --- PREDICTION LINES ---
        const objectChip = firstHit.chip;
        const collisionNormal = { x: objectChip.x - impactPoint.x, y: objectChip.y - impactPoint.y };
        const normMag = Math.sqrt(collisionNormal.x**2 + collisionNormal.y**2);
        const unitNormal = { x: collisionNormal.x / normMag, y: collisionNormal.y / normMag };
        const tangentVector = { x: -unitNormal.y, y: unitNormal.x };
        
        if (tangentVector.x * shotVector.x + tangentVector.y * shotVector.y < 0) {
            tangentVector.x *= -1;
            tangentVector.y *= -1;
        }

        const sideSpinAngle = pektusOffset.x * 1.5;
        const followFactor = 1 - (pektusOffset.y * 0.8);
        const deflectedCueVector = { 
            x: tangentVector.x * Math.cos(sideSpinAngle) - tangentVector.y * Math.sin(sideSpinAngle), 
            y: tangentVector.x * Math.sin(sideSpinAngle) + tangentVector.y * Math.cos(sideSpinAngle) 
        };
        const finalCueVector = { 
            x: (deflectedCueVector.x * 0.7 + shotVector.x * 0.3) * followFactor, 
            y: (deflectedCueVector.y * 0.7 + shotVector.y * 0.3) * followFactor 
        };

        // --- LINE 2: YELLOW PATH (Object Ball) ---
        if (stats.Aim >= 4 || equippedItems.cue === 'default') {
            ctx.save();
            ctx.strokeStyle = 'rgba(255, 215, 0, 0.8)'; // Gold pa rin para kita mo trajectory
            ctx.lineWidth = 4;
            ctx.shadowBlur = 10;
            ctx.shadowColor = 'yellow';
            
            ctx.beginPath();
            ctx.moveTo(objectChip.x, objectChip.y);
            ctx.lineTo(objectChip.x + unitNormal.x * 45, objectChip.y + unitNormal.y * 45);
            ctx.stroke();
            ctx.restore();
        }

        // --- LINE 3: WHITE PATH (Cue Ball Bounce) ---
        if (stats.Aim >= 8) {
            ctx.save();
            ctx.strokeStyle = `rgba(255, 255, 255, ${beamAlpha})`;
            ctx.lineWidth = 2;
            ctx.setLineDash([10, 10]); 
            
            ctx.beginPath();
            ctx.moveTo(impactPoint.x, impactPoint.y);
            ctx.lineTo(impactPoint.x + finalCueVector.x * 200, impactPoint.y + finalCueVector.y * 200);
            ctx.stroke();
            ctx.restore();
        }
        
        // --- Foul Indicator ---
        let isWrongTarget = false;
        const isMyTurn = isOnlineGame ? isMyTurnOnline : playerTurn;
        if (isMyTurn) {
            if (gameMode.includes('straight-ball') && colorsAssigned && playerChipsType) {
                if (firstHit.chip.type !== playerChipsType) isWrongTarget = true;
            } else if (gameMode.includes('61-ball') && lowestChipNumber > 0) {
                if (firstHit.chip.id !== lowestChipNumber) isWrongTarget = true;
            }
        }
        
        if (isWrongTarget) {
            ctx.save();
            ctx.font = `bold ${firstHit.chip.radius * 2}px Arial`;
            ctx.fillStyle = 'rgba(255, 0, 0, 0.8)'; 
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.shadowBlur = 10;
            ctx.shadowColor = 'red';
            ctx.fillText('üö´', firstHit.chip.x, firstHit.chip.y);
            ctx.restore();
        }
    }
}

 // START: SPINNING CHIP UPDATE (With Fixed AI Cheat)
function updateChipPositions(dt_sec) { 
    // Gaano kaliit ang bawat substep
    const subSteps = 8; 
    const dt_sub = dt_sec / subSteps; // Oras bawat substep

    for (let i = 0; i < subSteps; i++) { 
        chips.forEach(chip => { 
            if (chip.inPlay && !chip.isPocketing) { 
                // Ito ang bagong pag-galaw (Velocity * Time)
                chip.x += chip.vx * dt_sub; 
                chip.y += chip.vy * dt_sub; 
                
                // Ito ang bagong pag-ikot (Rotation Speed * Time)
                chip.rotation += chip.rotationSpeed * dt_sub;
            }
        }); 
        
        // --- WALL COLLISIONS ---
        const spinFactor = WALL_SPIN_FACTOR; 

        for (let j = 0; j < chips.length; j++) { 
            const chip1 = chips[j]; 
            if (!chip1.inPlay || chip1.isPocketing) continue; 
            
            const sideSpin = chip1.currentSideSpin || 0;

            // 1. KANANG PADER (Right Wall)
            if (chip1.x + chip1.radius > canvas.width) { 
                playCushionSound(Math.abs(chip1.vx)); 
                chip1.vx = -Math.abs(chip1.vx); 
                chip1.x = canvas.width - chip1.radius; 
                chip1.vy -= sideSpin * RAIL_KICK_FACTOR; 
                chip1.rotationSpeed -= chip1.vy * spinFactor; 
                chip1.currentSideSpin *= 0.8; 
            } 
            // 2. KALIWANG PADER (Left Wall)
            else if (chip1.x - chip1.radius < 0) { 
                playCushionSound(Math.abs(chip1.vx)); 
                chip1.vx = Math.abs(chip1.vx); 
                chip1.x = chip1.radius; 
                chip1.vy -= sideSpin * RAIL_KICK_FACTOR; 
                chip1.rotationSpeed -= chip1.vy * spinFactor; 
                chip1.currentSideSpin *= 0.8; 
            } 
            // 3. BABANG PADER (Bottom Wall)
            if (chip1.y + chip1.radius > canvas.height) { 
                playCushionSound(Math.abs(chip1.vy)); 
                chip1.vy = -Math.abs(chip1.vy); 
                chip1.y = canvas.height - chip1.radius; 
                chip1.vx += sideSpin * RAIL_KICK_FACTOR; 
                chip1.rotationSpeed += chip1.vx * spinFactor; 
                chip1.currentSideSpin *= 0.8; 
            } 
            // 4. TAAS NA PADER (Top Wall)
            else if (chip1.y - chip1.radius < 0) { 
                playCushionSound(Math.abs(chip1.vy)); 
                chip1.vy = Math.abs(chip1.vy); 
                chip1.y = chip1.radius; 
                chip1.vx += sideSpin * RAIL_KICK_FACTOR; 
                chip1.rotationSpeed += chip1.vx * spinFactor; 
                chip1.currentSideSpin *= 0.8; 
            }

            // CHIP COLLISION
            for (let k = j + 1; k < chips.length; k++) { 
                const chip2 = chips[k]; 
                if (chip2.inPlay && !chip2.isPocketing) handleChipCollision(chip1, chip2); 
            } 
        } 
    } 
    
    let stillMoving = false; 
    
    // FRICTION LOGIC
    const frictionThisStep = Math.pow(FRICTION_PER_SECOND, dt_sec);
    const spinFrictionThisStep = Math.pow(SPIN_FRICTION_PER_SECOND, dt_sec);

    chips.forEach(chip => { 
        if (chip.inPlay) { 
            if (chip.isPocketing) { 
                // Animation pag nahulog sa butas
                chip.pocketingProgress += 0.05; 
                chip.rotation += chip.rotationSpeed * dt_sec; 
                chip.x += (chip.pocketingHole.x - chip.x) * 0.1; 
                chip.y += (chip.pocketingHole.y - chip.y) * 0.1; 
                if (chip.pocketingProgress >= 1) { 
                    chip.inPlay = false; 
                    chip.isPocketing = false; 
                } 
            } else { 
                // Apply Friction
                chip.vx *= frictionThisStep; 
                chip.vy *= frictionThisStep;
                chip.rotationSpeed *= spinFrictionThisStep;

                if (chip.currentSideSpin) {
                    chip.currentSideSpin *= 0.995; 
                    if (Math.abs(chip.currentSideSpin) < 0.1) {
                        chip.currentSideSpin = 0;
                    }
                }
                
                if (Math.abs(chip.vx) < MIN_VELOCITY) chip.vx = 0; 
                if (Math.abs(chip.vy) < MIN_VELOCITY) chip.vy = 0; 
                if (Math.abs(chip.rotationSpeed) < MIN_ROTATION_SPEED) chip.rotationSpeed = 0;
                
                // --- POCKET DETECTION (DITO YUNG FIX) ---
                holes.forEach(hole => { 
                    const distToHole = Math.sqrt((hole.x - chip.x)**2 + (hole.y - chip.y)**2);
                    
                    let effectiveHoleRadius = hole.radius;

                    // ‚ñº‚ñº‚ñº AI CHEAT FIX ‚ñº‚ñº‚ñº
                    // 1. Kalkulahin ang bilis ng bola
                    const speed = Math.sqrt(chip.vx * chip.vx + chip.vy * chip.vy);
                    
                    // 2. Check kung gumagalaw ba talaga (speed > 1.0)
                    const isMoving = speed > 1.0; 

                    // 3. Lalaki lang ang butas KUNG:
                    //    - Turn ng AI (!playerTurn)
                    //    - Mode ay AI (gameMode.startsWith('ai'))
                    //    - AT GUMAGALAW ang bola (isMoving)
                    if (!playerTurn && gameMode.startsWith('ai') && isMoving) {
                        effectiveHoleRadius = hole.radius * 1.3; 
                    }
                    // ‚ñ≤‚ñ≤‚ñ≤ END FIX ‚ñ≤‚ñ≤‚ñ≤

                    if (distToHole < effectiveHoleRadius) { 
                        playPocketSound(); 
                        chip.isPocketing = true; 
                        chip.pocketingHole = hole; 
                        
                        chip.vx = chip.vx * 0.1; 
                        chip.vy = chip.vy * 0.1;
                        chip.rotationSpeed = (Math.random() - 0.5) * 0.2; 
                        
                        if (!chipsPocketedInTurn.find(p => p.id === chip.id)) chipsPocketedInTurn.push(chip); 
                    } 
                });
            } 
            
            if (chip.vx !== 0 || chip.vy !== 0 || chip.isPocketing) stillMoving = true;
        } 
    }); 
    
    chipsMoving = stillMoving; 
    if (!chipsMoving) { 
        if (gameState === 'shooting') { 
            gameState = 'evaluating'; 
            if (isTutorialActive) { 
                setTimeout(nextTutorialStep, 500); 
            } else if (!isOnlineGame || localPlayerUid === lastTurnControllerUid) { 
                handleTurnEnd(); 
            } 
        } 
    } 
}       
  

function handleChipCollision(chip1, chip2) { 
    const dx = chip2.x - chip1.x, dy = chip2.y - chip1.y; 
    const dist = Math.sqrt(dx*dx + dy*dy); 
    const combinedRadius = chip1.radius + chip2.radius; 
    
    if (dist < combinedRadius) { 
        const impactSpeed = Math.sqrt((chip1.vx - chip2.vx)**2 + (chip1.vy - chip2.vy)**2); 
        if (impactSpeed > 0.1) playCollisionSound(impactSpeed); 
        
        if (firstChipHitInTurn === null) { 
            if (chip1.id === 0) firstChipHitInTurn = chip2; 
            else if (chip2.id === 0) firstChipHitInTurn = chip1; 
        } 
        
        // ‚ñº‚ñº‚ñº "HOCKEY" PHYSICS ‚ñº‚ñº‚ñº

        // 1. I-rotate ang velocities para ang x-axis ay nasa linya ng banggaan
        const angle = Math.atan2(dy, dx), sin = Math.sin(angle), cos = Math.cos(angle); 
        let vel1 = { x: chip1.vx * cos + chip1.vy * sin, y: chip1.vy * cos - chip1.vx * sin }; 
        let vel2 = { x: chip2.vx * cos + chip2.vy * sin, y: chip2.vy * cos - chip2.vx * sin }; 

        // 2. Kunin ang bigat (mass) ng bawat chip
        const m1 = (chip1.id === 0) ? CUE_CHIP_MASS : OBJECT_CHIP_MASS;
        const m2 = (chip2.id === 0) ? CUE_CHIP_MASS : OBJECT_CHIP_MASS;

        // 3. Itabi ang original velocities bago mag-calculate
        const v1i = vel1.x; // Bilis ng chip1 bago tumama
        const v2i = vel2.x; // Bilis ng chip2 bago tumama

        // 4. Ilapat ang 1D Elastic Collision formula (gamit ang MASS)
        vel1.x = ((m1 - m2) * v1i + 2 * m2 * v2i) / (m1 + m2);
        vel2.x = ((m2 - m1) * v2i + 2 * m1 * v1i) / (m1 + m2);

        // 5. Hanapin kung alin ang cue chip para sa Pektus
        let cueVel, otherVel, shotPektus;
        if (chip1.id === 0) {
            cueVel = vel1;
            otherVel = vel2;
            shotPektus = shotPektusOffset;
        } else if (chip2.id === 0) {
            cueVel = vel2;
            otherVel = vel1;
            // Baliktarin ang pektus dahil baliktad ang impact
            shotPektus = { x: -shotPektusOffset.x, y: -shotPektusOffset.y }; 
        }

        // 6. I-apply ang Pektus (Spin)
    
        // Kunin ang stats at kalkulahin ang lakas ng spin
        const stats = currentShotStats;
        const spinMultiplier = 0.5 + (stats.Spin / 10) * 1.5; // Mula 0.65x hanggang 2.0x

        if (cueVel) {
            const relativeVelX = Math.abs(v1i - v2i); // Gaano kalakas ang tama

            // A. Sidespin (Left/Right) - ginamitan na ng spinMultiplier
            const sideSpin = (shotPektus.x * 0.2) * spinMultiplier;
            cueVel.y += sideSpin * relativeVelX;

            // B. Topspin (Follow) - ginamitan na ng spinMultiplier
            // (Dahil sa handlePektusInput, ang shotPektus.y ay laging negative o zero)
            if (shotPektus.y < 0) { // Pataas ang dot (topspin)
                const followEnergy = Math.abs(shotPektus.y * 0.25) * spinMultiplier * relativeVelX;
                cueVel.x += followEnergy;  // Dagdag na "follow"
            }
        }
        // 7. Ayusin ang "overlap"
        const overlap = combinedRadius - dist; 
        chip1.x -= (overlap / 2) * cos; 
        chip1.y -= (overlap / 2) * sin; 
        chip2.x += (overlap / 2) * cos; 
        chip2.y += (overlap / 2) * sin; 

        // 8. I-transform pabalik ang velocities
        chip1.vx = vel1.x * cos - vel1.y * sin; 
        chip1.vy = vel1.y * cos + vel1.x * sin; 
        chip2.vx = vel2.x * cos - vel2.y * sin; 
        chip2.vy = vel2.y * cos + vel2.x * sin; 

        // 9. I-apply ang spin AT friction galing sa banggaan
        const spinFactor = COLLISION_SPIN_FACTOR;
        const tangentialVelDiff = vel1.y - vel2.y; // Gaano kabilis ang "pagkiskis"
        
        // Kalkulahin ang "preno" galing sa pagkiskis
        const frictionImpulse = tangentialVelDiff * (1.0 - COLLISION_FRICTION_FACTOR);

        // I-apply ang spin (galing sa nawalang "dulas")
        chip1.rotationSpeed += (tangentialVelDiff * spinFactor);
        chip2.rotationSpeed -= (tangentialVelDiff * spinFactor);

        // I-apply ang "preno" sa tangential velocity (pag-dulas)
        vel1.y -= frictionImpulse / m1;
        vel2.y += frictionImpulse / m2;
    } 
}

// ‚ñº‚ñº‚ñº COMBO FUNCTION ‚ñº‚ñº‚ñº
function showComboPopup(count) {
    if (count < 2) return; // 2 pataas lang ang may popup

    const comboContainer = document.getElementById('non-interactive-overlay');
    const comboEl = document.createElement('div');
    comboEl.className = 'combo-text';

    let text = `${count}x COMBO!`;
    let color = '#FFD700'; // Gold

    if (count === 2) {
        text = "DOUBLE HIT!";
        color = '#00E5FF'; // Cyan
    } else if (count === 3) {
        text = "TRIPLE HIT! üî•";
        color = '#FFA500'; // Orange
    } else if (count >= 4) {
        text = "UNSTOPPABLE! üëø";
        color = '#FF0000'; // Red
    }

    comboEl.textContent = text;
    comboEl.style.color = color;
    comboEl.style.textShadow = `4px 4px 0px black, 0 0 20px ${color}`;

    comboContainer.appendChild(comboEl);

    // Sound Effect (Pitch Up)
    if (audioInitialized && uiSynth) {
        const notes = ["C4", "E4", "G4", "C5", "E5", "G5"]; 
        const note = notes[Math.min(count, notes.length) - 1];
        uiSynth.triggerAttackRelease(note, "8n");
    }

    setTimeout(() => { comboEl.remove(); }, 1500);
}

async function handle61BallTurnEnd() {
    let foul = false;
    let switchTurn = true;
    const isMyTurn = isOnlineGame ? isMyTurnOnline : playerTurn;
    
    const pocketedObjectChips = chipsPocketedInTurn.filter(c => c.id !== 0);
    const lowestChipOnTable = lowestChipNumber;
    const wasCueBallPocketed = chipsPocketedInTurn.some(c => c.id === 0);
    
    // 1. FOUL DETECTION (Original Logic)
    // Dapat tamaan muna ang lowest number.
    const didHitWrongBallFirst = !isBreakShot && firstChipHitInTurn && firstChipHitInTurn.id !== lowestChipOnTable;
    const didNotHitAnyBall = firstChipHitInTurn === null && chips.some(c => c.inPlay && c.id !== 0);
    
    if (wasCueBallPocketed || didHitWrongBallFirst || didNotHitAnyBall) {
        foul = true;
    }

    if (foul) {
        // --- FOUL HANDLING ---
        if(typeof currentCombo !== 'undefined') currentCombo = 0; // Reset Combo
        if (isMyTurn && !isOnlineGame) setTimeout(() => aiDisplayMessage(getAiChatMessage('playerFoul')), 800);
        
        switchTurn = true; // Lipat turn pag foul
        canMoveCueBall = true; // Ball in hand
        
        // Ibalik ang Cue Ball kung Scratch
        if (wasCueBallPocketed) {
            const cueChip = chips.find(c => c.id === 0);
            if (cueChip) {
                resetChipStateForReturn(cueChip);
                cueChip.x = canvas.width * 0.25;
                cueChip.y = canvas.height / 2;
            }
        }
        
        // Ibalik ang lahat ng bola na nahulog (No points sa foul)
        if (pocketedObjectChips.length > 0) {
            pocketedObjectChips.forEach(chip => {
                const chipToReturn = chips.find(c => c.id === chip.id);
                if (chipToReturn) {
                    resetChipStateForReturn(chipToReturn);
                    placeChipOnSpot(chipToReturn);
                }
            });
        }
        if (isMyTurn) showMessage("Foul! Chips returned.", 2500);

    } else {
        // --- VALID SHOT SCENARIO ---
        if (pocketedObjectChips.length > 0) {
            // Compute Score (Sum of values)
            const pointsThisTurn = pocketedObjectChips.reduce((sum, chip) => sum + chip.value, 0);
            
            if (isMyTurn) player61Score += pointsThisTurn;
            else opponent61Score += pointsThisTurn;

            switchTurn = false; // Tuloy ang tira
            if (isMyTurn && !isOnlineGame) setTimeout(() => aiDisplayMessage(getAiChatMessage('playerGoodShot')), 800);
            
            // Combo & Rewards
            if (isMyTurn) {
                if(typeof currentCombo !== 'undefined') { currentCombo++; showComboPopup(currentCombo); }
                
                const reward = pocketedObjectChips.length * REWARD_PER_BALL;
// --- BAGONG SERVER CODE (61 Ball) ---
// Visual muna (Optimistic UI)
playerTotalCurrency += reward;
showRewardPopup(reward);
updateCurrencyDisplay();

// Request sa Server
if (localPlayerUid) {
    fetch(`${SERVER_URL}/api/record-win`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            uid: localPlayerUid,
            ballsPocketed: pocketedObjectChips.length, // Bilang ng bola
            gameMode: '61-ball'
        })
    }).catch(e => console.error(e));
}
// ------------------------------------
gainXP(pocketedObjectChips.length * XP_PER_BALL); // XP logic (pwede iwan dito o ilipat sa server next time)
            }

        } else {
            // Walang pumasok -> Lipat turn
            switchTurn = true;
            if(typeof currentCombo !== 'undefined') currentCombo = 0;
        }
    }

    // Update Lowest Chip (Para sa susunod na tira)
    const newRemainingChips = chips.filter(c => c.inPlay && c.id !== 0);
    lowestChipNumber = newRemainingChips.length > 0 ? Math.min(...newRemainingChips.map(c => c.id)) : 0;
    
    // 2. CHECK WINNER & ONLINE SYNC (Dito ang Fix)
    const winner = checkWinCondition(); // (Score >= 61 check)
    
    if (winner) {
        
        // ‚ñº‚ñº‚ñº ITO ANG FIX PARA HINDI MA-STUCK ANG KALABAN ‚ñº‚ñº‚ñº
        if (isOnlineGame && gameId) {
            try {
                const gameRef = doc(db, "games", gameId);
                const gSnap = await getDoc(gameRef);
                
                if (gSnap.exists()) {
                    const gData = gSnap.data();
                    let winnerUid;
                    
                    if (winner === 'player') winnerUid = localPlayerUid;
                    else if (winner === 'opponent') winnerUid = (gData.players.player1.uid === localPlayerUid) ? gData.players.player2.uid : gData.players.player1.uid;
                    else winnerUid = 'draw';

                    // Update Firebase na FINISHED na at i-save ang final score
                    await updateDoc(gameRef, { 
                        gameState: 'finished', 
                        winner: winnerUid,
                        // Siguraduhing updated ang score sa server
                        player1_61Score: localPlayerId === 'player1' ? player61Score : opponent61Score,
                        player2_61Score: localPlayerId === 'player1' ? opponent61Score : player61Score
                    });
                }
            } catch (err) { console.error(err); }
        }
        // ‚ñ≤‚ñ≤‚ñ≤ END NG FIX ‚ñ≤‚ñ≤‚ñ≤

        const winnerText = (winner === 'player') ? 'You Win!' : (winner === 'opponent' ? 'You Lose!' : "It's a Draw! 60-60");
        await endGame(winnerText);
        return;
    }

    isBreakShot = false;
    if (isOnlineGame) await updateOnlineGameState(switchTurn);
    else updateLocalGameState(switchTurn);
}

        // ‚ñº‚ñº‚ñº UPDATED MESSAGE BOX (WITH FILTER) ‚ñº‚ñº‚ñº

function showMessage(msg, duration = 2000) { 
    // 1. BLACKLIST: Mga salitang BAWAL ipakita (Turn messages)
    if (msg.includes("Your turn") || 
        msg.includes("'s turn") || 
        msg.includes("You break") || 
        msg.includes("'s break") ||
        msg.includes("Opponent will break")) {
        return; // STOP! Wag ituloy.
    }

    // 2. Kung hindi bawal, ipakita ang message
    messageBox.innerHTML = msg; // Ginawang innerHTML para gumana ang <br> styles
    messageBox.style.display = 'block'; 
    
    // Animation reset trick
    messageBox.style.animation = 'none';
    messageBox.offsetHeight; /* trigger reflow */
    messageBox.style.animation = 'fadeIn 0.3s';

    setTimeout(() => { 
        if (messageBox.innerHTML === msg) {
            messageBox.style.display = 'none'; 
        }
    }, duration); 
}
        function resetChipStateForReturn(chip) { if (!chip) return; chip.inPlay = true; chip.isPocketing = false; chip.pocketingProgress = 0; chip.pocketingHole = null; chip.vx = 0; chip.vy = 0; chip.rotation = 0; chip.rotationSpeed = 0; } // Dinagdag ang reset sa rotation
        async function handleTurnEnd() { if (isOnlineGame && lastTurnControllerUid !== localPlayerUid) { return; } if (isProcessingTurnEnd) return; isProcessingTurnEnd = true; if (gameMode.includes('poker')) await handlePokerTurnEnd(); else if (gameMode.includes('straight-ball')) await handleStraightBallTurnEnd(); else if (gameMode.includes('61-ball')) await handle61BallTurnEnd(); isProcessingTurnEnd = false; }
        async function handlePokerTurnEnd() {
    const isMyTurn = isOnlineGame ? isMyTurnOnline : playerTurn;
    
    // 1. IDENTIFY HANDS (Original Logic)
    // Gamitin ang global variables nang direkta para ma-update sila agad
    const currentHand = isMyTurn ? playerHand : opponentHand;
    
    const pocketedObjectChips = chipsPocketedInTurn.filter(c => c.id !== 0);
    const wasCueBallPocketed = chipsPocketedInTurn.some(c => c.id === 0);
    const didHitNothing = firstChipHitInTurn === null && chips.some(c => c.inPlay && c.id !== 0);
    
    // Check kung valid ang pumasok (nasa kamay ba?)
    const legallyPocketedOwnChips = pocketedObjectChips.filter(chip => currentHand.some(card => card.value === chip.id));

    let switchTurn = true; 
    let foul = wasCueBallPocketed || didHitNothing;

    // 2. TURN SWITCH & COMBO LOGIC (Pinaghalong Original + Combo)
    if (legallyPocketedOwnChips.length > 0 && !foul && pocketedObjectChips.length === legallyPocketedOwnChips.length) {
        switchTurn = false; // Tuloy ang tira
        
        if (isMyTurn && !isOnlineGame) setTimeout(() => aiDisplayMessage(getAiChatMessage('playerGoodShot')), 800);
        
        // Combo & Rewards
        if (isMyTurn) {
            if(typeof currentCombo !== 'undefined') { currentCombo++; showComboPopup(currentCombo); }
            const reward = legallyPocketedOwnChips.length * REWARD_PER_BALL;
            // --- BAGONG SERVER CODE (Poker) ---
playerTotalCurrency += reward;
showRewardPopup(reward);
updateCurrencyDisplay();

if (localPlayerUid) {
    fetch(`${SERVER_URL}/api/record-win`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            uid: localPlayerUid,
            ballsPocketed: legallyPocketedOwnChips.length,
            gameMode: 'poker'
        })
    }).catch(e => console.error(e));
}
// ----------------------------------
gainXP(legallyPocketedOwnChips.length * XP_PER_BALL);
        }
    } else {
        if(typeof currentCombo !== 'undefined') currentCombo = 0;
    }

    // 3. REMOVE POCKETED CARDS (Original Logic - CRITICAL)
    // Ina-update nito ang GLOBAL variables na playerHand/opponentHand bago mag-check ng panalo
    if (pocketedObjectChips.length > 0) {
        const pocketedIds = pocketedObjectChips.map(c => c.id);
        // I-filter ang global variables
        playerHand = playerHand.filter(card => !pocketedIds.includes(card.value));
        opponentHand = opponentHand.filter(card => !pocketedIds.includes(card.value));
    }

    // 4. HANDLE FOULS & PENALTY CARDS (Original Logic)
    if (foul) {
        if(typeof currentCombo !== 'undefined') currentCombo = 0;
        if (isMyTurn && !isOnlineGame) setTimeout(() => aiDisplayMessage(getAiChatMessage('playerFoul')), 800);
        canMoveCueBall = true; 
        
        if (wasCueBallPocketed) {
            // Ibalik ang Cue Ball
            const cueChip = chips.find(c => c.id === 0);
            if (cueChip) {
                resetChipStateForReturn(cueChip);
                cueChip.x = canvas.width * 0.25;
                cueChip.y = canvas.height / 2;
            }
            if (isMyTurn) showMessage("Foul! You scratched.", 3000);

            // Draw Penalty Card
            let newCard = isMyTurn ? await waitForCardPick() : (deck.length > 0 ? deck.splice(Math.floor(Math.random() * deck.length), 1)[0] : null);
            
            if (newCard) {
                const cardName = `${newCard.rank}${newCard.suit}`;
                // Check kung ang nabunot ay pumasok na (Discard rule)
                const correspondingChip = chips.find(c => c.id === newCard.value);
                
                if (correspondingChip && !correspondingChip.inPlay) {
                    if (isMyTurn) showMessage(`You picked ${cardName}, but ball is gone. Card discarded.`, 3000);
                } else {
                    // Idagdag sa GLOBAL hand
                    (isMyTurn ? playerHand : opponentHand).push(newCard);
                    if (isMyTurn) showMessage(`Foul! You picked ${cardName}.`, 3000);
                }
            }
        } else if (didHitNothing) {
            if (isMyTurn) showMessage("Foul! No ball hit.", 3000);
        }
    }

    // 5. CHECK WIN CONDITION (Original Logic)
    // Tinitignan nito ang updated na hands para malaman kung sino ang nanalo
    let winner = null;
    let shouldEndGame = false;
    
    const currentPlayerHandAfterShot = isMyTurn ? playerHand : opponentHand;
    const waitingPlayerHandAfterShot = isMyTurn ? opponentHand : playerHand;
    const currentTurnWinner = isMyTurn ? 'player' : 'opponent';
    const waitingPlayerWinner = isMyTurn ? 'opponent' : 'player';

    // Case A: Ubos na ang baraha ng tumira O puro Kings
    if (currentPlayerHandAfterShot.length === 0 || (currentPlayerHandAfterShot.length > 0 && currentPlayerHandAfterShot.every(card => card.rank === 'K'))) {
        winner = currentTurnWinner;
        shouldEndGame = true;
    } 
    // Case B: Ubos na ang baraha ng naghihintay (at lumipat ang turn)
    else if (waitingPlayerHandAfterShot.length === 0 || (waitingPlayerHandAfterShot.length > 0 && waitingPlayerHandAfterShot.every(card => card.rank === 'K'))) {
        if (switchTurn) {
            winner = waitingPlayerWinner;
            shouldEndGame = true;
        }
    }

    // 6. END GAME & SYNC FIX (Dito lang tayo nagdagdag)
    if (shouldEndGame) {
        
        // ‚ñº‚ñº‚ñº ITO LANG ANG BINAGO (SYNC FIX) ‚ñº‚ñº‚ñº
        if (isOnlineGame && gameId) {
            try {
                const gameRef = doc(db, "games", gameId);
                // Tukuyin ang UID ng nanalo para alam ng server
                let winnerUid;
                // Kuhanin muna ang current game data para sa UIDs
                const gSnap = await getDoc(gameRef);
                if (gSnap.exists()) {
                    const gData = gSnap.data();
                    if (winner === 'player') {
                        winnerUid = localPlayerUid;
                    } else {
                        // Kung opponent ang nanalo, kunin ang UID ng kalaban
                        winnerUid = (gData.players.player1.uid === localPlayerUid) ? gData.players.player2.uid : gData.players.player1.uid;
                    }
                    
                    // I-update sa Firebase na TAPOS NA
                    await updateDoc(gameRef, {
                        gameState: 'finished',
                        winner: winnerUid,
                        // I-update din ang cards para sakto sa reveal
                        player1Hand: localPlayerId === 'player1' ? playerHand : opponentHand,
                        player2Hand: localPlayerId === 'player1' ? opponentHand : playerHand
                    });
                }
            } catch (err) { console.error("Error finishing game:", err); }
        }
        // ‚ñ≤‚ñ≤‚ñ≤ END NG SYNC FIX ‚ñ≤‚ñ≤‚ñ≤

        const winnerText = (winner === 'player') ? 'You Win!' : 'You Lose!';
        await endGame(winnerText);
        return;
    }

    // 7. CONTINUE GAME (Original Logic)
    isBreakShot = false;
    if (isOnlineGame) await updateOnlineGameState(switchTurn);
    else updateLocalGameState(switchTurn);
}


async function handleStraightBallTurnEnd() {
    let isFoul = false;
    let switchTurn = true;
    let foulReason = "";
    
    const isMyTurn = isOnlineGame ? isMyTurnOnline : playerTurn;
    const pocketedObjectChips = chipsPocketedInTurn.filter(c => c.id !== 0);
    const wasCueBallPocketed = chipsPocketedInTurn.some(c => c.id === 0);
    
    const didNotHitAnyBall = firstChipHitInTurn === null && chips.some(c => c.inPlay && c.id !== 0);
    let didHitWrongBallFirst = false;
    if (colorsAssigned) {
        const currentPlayerColor = isMyTurn ? playerChipsType : opponentChipsType;
        didHitWrongBallFirst = !isBreakShot && firstChipHitInTurn && firstChipHitInTurn.type !== currentPlayerColor;
    }

    if (wasCueBallPocketed || didHitWrongBallFirst || didNotHitAnyBall) isFoul = true;

    // Assign colors logic...
    if (pocketedObjectChips.length > 0 && !colorsAssigned) {
        const redCount = pocketedObjectChips.filter(c => c.type === 'red').length;
        const blueCount = pocketedObjectChips.filter(c => c.type === 'blue').length;
        let chosenType = pocketedObjectChips[0].type; 
        if (redCount > blueCount) chosenType = 'red';
        else if (blueCount > redCount) chosenType = 'blue';

        if (isMyTurn) {
            playerChipsType = chosenType;
            opponentChipsType = (chosenType === 'red' ? 'blue' : 'red');
        } else {
            opponentChipsType = chosenType;
            playerChipsType = (chosenType === 'red' ? 'blue' : 'red');
        }
        colorsAssigned = true;
        const colorName = (isMyTurn ? playerChipsType : opponentChipsType).toUpperCase();
        showColorAssignmentPopup(isMyTurn ? `You got ${colorName}!` : `Opponent got ${colorName}!`, (isMyTurn ? playerChipsType : opponentChipsType));
    }

    const shooterColor = isMyTurn ? playerChipsType : opponentChipsType;
    const opponentColor = isMyTurn ? opponentChipsType : playerChipsType;

    if (isFoul) {
        if(typeof currentCombo !== 'undefined') currentCombo = 0;
        if (isMyTurn && !isOnlineGame) setTimeout(() => aiDisplayMessage(getAiChatMessage('playerFoul')), 800);
        switchTurn = true;
        canMoveCueBall = true; 

        if (wasCueBallPocketed) {
            foulReason += "Scratch! ";
            const cueChip = chips.find(c => c.id === 0);
            if (cueChip) {
                resetChipStateForReturn(cueChip);
                cueChip.x = canvas.width * 0.25;
                cueChip.y = canvas.height / 2;
            }
            // Penalty: Return 1 ball
            const shooterPocketedBalls = pocketedObjectChips.filter(c => c.type === shooterColor);
            let chipToReturn = null;
            if (shooterPocketedBalls.length > 0) chipToReturn = chips.find(c => c.id === shooterPocketedBalls[0].id);
            else chipToReturn = chips.find(c => c.type === shooterColor && !c.inPlay);

            if (chipToReturn) {
                resetChipStateForReturn(chipToReturn);
                placeChipOnSpot(chipToReturn);
                if (isMyTurn) showMessage("Scratch! 1 ball returned.", 3000);
            }
        }

        if (didHitWrongBallFirst) {
            foulReason += "Hit opponent's ball first. ";
            const myIllegalPocketed = pocketedObjectChips.filter(c => c.type === shooterColor);
            if (myIllegalPocketed.length > 0) {
                foulReason += "Your balls returned. ";
                myIllegalPocketed.forEach(pc => {
                    const foundChip = chips.find(c => c.id === pc.id);
                    if (foundChip) {
                        resetChipStateForReturn(foundChip);
                        placeChipOnSpot(foundChip);
                    }
                });
            }
        }

        if (didNotHitAnyBall) foulReason += "No ball hit. ";
        if (isMyTurn && foulReason) showMessage("Foul! " + foulReason.trim(), 4000);

    } else {
        const myPocketedCount = pocketedObjectChips.filter(c => c.type === shooterColor).length;
        const opponentPocketedCount = pocketedObjectChips.filter(c => c.type === opponentColor).length;

        if (myPocketedCount > 0 && opponentPocketedCount === 0) {
            switchTurn = false;
            try {
                if (isMyTurn) { 
                    if (typeof currentCombo !== 'undefined') { currentCombo++; showComboPopup(currentCombo); }
                    // --- REPLIT SERVER UPDATE START ---
                    const reward = pocketedObjectChips.length * REWARD_PER_BALL; 
                    
                    // 1. Visual Update (Para makita agad ng player)
                    playerTotalCurrency += reward; 
                    showRewardPopup(reward); 
                    updateCurrencyDisplay(); 

                    // 2. I-save sa Database gamit ang Replit
                    if (localPlayerUid) {
                        fetch(`${SERVER_URL}/api/record-win`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                uid: localPlayerUid,
                                ballsPocketed: pocketedObjectChips.length,
                                gameMode: 'straight-ball' 
                            })
                        }).catch(e => console.error("Server Save Error:", e));
                    }

                    gainXP(pocketedObjectChips.length * XP_PER_BALL);
                    // --- REPLIT SERVER UPDATE END ---
                }
            } catch (err) {}
        } else {
            switchTurn = true;
            if(isMyTurn && myPocketedCount > 0 && opponentPocketedCount > 0) showMessage("Mixed balls. Turn passed.", 3000);
            if(typeof currentCombo !== 'undefined') currentCombo = 0;
        }
    }

    // CHECK WINNER
    const winner = checkWinCondition();
    if (winner) {
        // ‚ñº‚ñº‚ñº ITO ANG FIX PARA SA ONLINE GAME! ‚ñº‚ñº‚ñº
        if (isOnlineGame && gameId) {
            try {
                const gameRef = doc(db, "games", gameId);
                const gSnap = await getDoc(gameRef);
                if (gSnap.exists()) {
                    const gData = gSnap.data();
                    let winnerUid;
                    if (winner === 'player') winnerUid = localPlayerUid;
                    else winnerUid = (gData.players.player1.uid === localPlayerUid) ? gData.players.player2.uid : gData.players.player1.uid;

                    await updateDoc(gameRef, { gameState: 'finished', winner: winnerUid });
                }
            } catch (err) { console.error(err); }
        }
        // ‚ñ≤‚ñ≤‚ñ≤ END NG FIX ‚ñ≤‚ñ≤‚ñ≤

        await endGame((winner === 'player') ? 'You Win!' : 'You Lose!');
        return;
    }
    
    isBreakShot = false;
    if (isOnlineGame) await updateOnlineGameState(switchTurn);
    else updateLocalGameState(switchTurn);
}

        async function updateOnlineGameState(switchTurn) { try { const gameDocRef = doc(db, "games", gameId); const docSnap = await getDoc(gameDocRef); if (!docSnap.exists() || docSnap.data().gameState === 'finished') return; let nextTurnUid = docSnap.data().currentTurnUid; if (switchTurn) { nextTurnUid = (nextTurnUid === docSnap.data().players.player1.uid) ? docSnap.data().players.player2.uid : docSnap.data().players.player1.uid; } const chipsToSend = chips.map(c => ({...c, x: c.x / canvas.width, y: c.y / canvas.height })); const newTurnId = (docSnap.data().turnId || 0) + 1; const updatedData = { chips: chipsToSend, currentTurnUid: nextTurnUid, canMoveCueBall, isBreakShot: false, turnInProgress: false, turnId: newTurnId, liveAimData: null }; if (gameMode.includes('poker')) { const hands = (localPlayerId === 'player1') ? { player1Hand: playerHand, player2Hand: opponentHand } : { player1Hand: opponentHand, player2Hand: playerHand }; Object.assign(updatedData, { deck }, hands); } else if (gameMode.includes('straight-ball')) { const types = (localPlayerId === 'player1') ? { player1ChipsType: playerChipsType, player2ChipsType: opponentChipsType } : { player1ChipsType: opponentChipsType, player2ChipsType: playerChipsType }; Object.assign(updatedData, { colorsAssigned }, types); } else if (gameMode.includes('61-ball')) { const scores = (localPlayerId === 'player1') ? { player1_61Score: player61Score, player2_61Score: opponent61Score } : { player1_61Score: opponent61Score, player2_61Score: player61Score }; Object.assign(updatedData, { lowestChipNumber }, scores); } await updateDoc(gameDocRef, updatedData); } catch (error) { console.error("Error updating game state:", error); showMessage("Connection error.", 3000); } }
        function updateLocalGameState(switchTurn) {
    if (switchTurn) {
        if (!playerTurn && chipsPocketedInTurn.length > 0) { 
            // Panatilihin lang ang "Nice Shot" ng AI, wag tanggalin
            setTimeout(() => { aiDisplayMessage(getAiChatMessage('playerGoodShot')); }, 700); 
        }
        playerTurn = !playerTurn;
        setCueForCurrentTurn();
        if (playerTurn) { aiConsecutivePots = 0; }
        
        // --- TINANGGAL NA NATIN ANG MESSAGE DITO ---
        // showMessage(`${playerTurn ? 'Your' : 'Opponent'}'s turn`, 1500); 
    } else {
        if (playerTurn) { 
            // showMessage("You shoot again!", 1500);  <-- TINANGGAL DIN
        } else {
            aiConsecutivePots++;
            // showMessage("AI shoots again!", 1500); <-- TINANGGAL DIN
            setTimeout(() => { aiDisplayMessage(getAiChatMessage('goodShot')); }, 700);
        }
    }
    
    chipsPocketedInTurn = [];
    firstChipHitInTurn = null;
    resetPektus();
    updateCardDisplay();
    updateInfoBox(); // <-- ITO ANG MAGPAPALIT NG ILAW (HUD GLOW)
    
    if (gameState !== 'gameover') {
        if (canMoveCueBall) {
            gameState = 'moving';
            if (gameMode.includes('ai') && !playerTurn) {
                placeCueChipForAI();
            } else if (playerTurn) {
                dragGuideText.style.display = 'block';
            }
        } else {
            gameState = 'aiming';
            dragGuideText.style.display = 'none';
            cueStick.visible = true;
            if (cueStickElement) cueStickElement.style.display = 'block';
            if (gameMode.includes('ai') && !playerTurn) {
                setTimeout(aiTurn, 1000);
            }
        }
    }
}
        // ‚ñº‚ñº‚ñº PALITAN MO ITONG BUONG FUNCTION ‚ñº‚ñº‚ñº

function checkWinCondition() { 
    if (gameState === 'gameover') return null; 
    let winner = null; 

    if (gameMode.includes('poker')) { 
        
        // --- BAGONG LOGIC DITO ---
        // Titingnan natin kung sino ang kasalukuyang tumitira
        const isCurrentTurnPlayer = isOnlineGame ? isMyTurnOnline : playerTurn;
        
        // Ito 'yung mga baraha ng tumitira at naghihintay
        const currentTurnHand = isCurrentTurnPlayer ? playerHand : opponentHand;
        const waitingPlayerHand = isCurrentTurnPlayer ? opponentHand : playerHand;
        
        // Ito 'yung "identity" nila
        const currentTurnWinner = isCurrentTurnPlayer ? 'player' : 'opponent';
        const waitingPlayerWinner = isCurrentTurnPlayer ? 'opponent' : 'player';

        // 1. Unang i-check: Nanalo ba ang KASALUKUYANG TUMITIRA?
        if (currentTurnHand.length === 0 || (currentTurnHand.length > 0 && currentTurnHand.every(card => card.rank === 'K'))) {
            winner = currentTurnWinner;
        } 
        // 2. Kung hindi, i-check: Nanalo ba ang NAGHIHINTAY na player?
        else if (waitingPlayerHand.length === 0 || (waitingPlayerHand.length > 0 && waitingPlayerHand.every(card => card.rank === 'K'))) {
            winner = waitingPlayerWinner;
        }
        // --- END NG BAGONG LOGIC ---

    } else if (gameMode.includes('straight-ball') && colorsAssigned) { 
        if (!chips.some(c => c.inPlay && c.type === playerChipsType) && playerChipsType) winner = 'player'; 
        else if (!chips.some(c => c.inPlay && c.type === opponentChipsType) && opponentChipsType) winner = 'opponent'; 
    } else if (gameMode.includes('61-ball')) { 
        if (player61Score >= 61) winner = 'player'; 
        else if (opponent61Score >= 61) winner = 'opponent'; 
        else if (!chips.some(c => c.inPlay && c.id !== 0) && player61Score === 60 && opponent61Score === 60) winner = 'draw'; 
    } 
    return winner; 
}

/**
 * Tumatanggap ng "raw power" (2-42) at ipinapasa ito sa animation at applyShot.
 */
async function shoot(shotPowerValue) { // Renamed parameter to avoid conflict
    if (gameState !== 'aiming' || chipsMoving) return;
    const powerNormalized = (shotPowerValue - 2) / 40; // Normalize power (0 to ~1)
    playCueHitSound(powerNormalized); // Pass normalized power
    chipsPocketedInTurn = [];
    firstChipHitInTurn = null;
    shotPektusOffset = { ...pektusOffset };

    // === SIMULA NG PAGBABAGO ===
    // Kunin ang stats ng tako mo BAGO tumira
    const stats = getCurrentCueStats();
    
    // Isama ang 'cueStats' sa ipapadalang data
    const shotData = {
        uid: localPlayerUid,
        angle: cueStick.angle,
        power: shotPowerValue,
        pektus: shotPektusOffset,
        timestamp: Date.now(),
        cueStats: stats // <-- ITO ANG BAGONG DAGDAG!
    };
    // === TAPOS NG PAGBABAGO ===

    cueStick.power = 0;
    powerBar.style.height = '0%';
    gameState = 'shooting_animation';
    let startTime = null;
    const animationDuration = 100;
    const startPullback = cueStick.pullback;
    const endPullback = -30 * scale;

    function animateLocalShot(timestamp) {
        if (!startTime) startTime = timestamp;
        const progress = Math.min((timestamp - startTime) / animationDuration, 1);
        cueStick.pullback = startPullback + (endPullback - startPullback) * progress;
        if (progress < 1) {
            requestAnimationFrame(animateLocalShot);
        } else {
            cueStick.pullback = 0;
            cueStick.visible = false;
            if(cueStickElement) cueStickElement.style.display = 'none';
            if (isOnlineGame) {
                try {
                    lastTurnControllerUid = localPlayerUid;
                    // Ipadala ang shotData na may kasama nang stats
                    updateDoc(doc(db, "games", gameId), { lastShot: shotData, turnInProgress: true, lastTurnController: localPlayerUid });
                } catch (error) {
                    console.error("Error sending shot data:", error);
                    gameState = 'aiming'; // Revert state if sending fails
                    cueStick.visible = true;
                }
            } else {
                applyShot(shotData);
            }
        }
    }
    requestAnimationFrame(animateLocalShot);
}


function applyShot(shotData) {
    if (chipsMoving) return;
    const cueChip = chips[0];
    if (!cueChip || !cueChip.inPlay) return;

    const stats = shotData.cueStats || getCurrentCueStats();
    currentShotStats = stats;

    const powerBonus = (stats.Power - 2) * 0.05;
    const finalPowerMultiplier = VELOCITY_MULTIPLIER * (1 + powerBonus);

    shotPektusOffset = shotData.pektus || { x: 0, y: 0 };
    
    // ‚ñº‚ñº‚ñº DITO TAYO MAGPAPALIT PARA LUMAKAS ANG SPIN ‚ñº‚ñº‚ñº
    const spinMultiplier = 1 + (stats.Spin / 5); 
    
    // Gawing * 35 (Dati ay * 20). Ito ang "Starting Spin Power".
    cueChip.currentSideSpin = (shotPektusOffset.x * 35) * spinMultiplier; 
    // ‚ñ≤‚ñ≤‚ñ≤ ‚ñ≤‚ñ≤‚ñ≤

    cueChip.vx = Math.cos(shotData.angle) * shotData.power * finalPowerMultiplier;
    cueChip.vy = Math.sin(shotData.angle) * shotData.power * finalPowerMultiplier;
    
    chipsMoving = true;
    gameState = 'shooting';
    if (isOnlineGame) {
        lastTurnControllerUid = shotData.uid;
    }
}
// --- ü§ù ONLINE REMATCH REQUEST (SECURED) ü§ù ---
async function handleRematchRequest() { 
    if (!isOnlineGame || !gameId) return; 
    
    const rematchButton = document.getElementById('rematch-button'); 
    
    // Disable button muna para hindi spam
    rematchButton.disabled = true; 
    rematchButton.textContent = 'Checking funds...'; 

    try {
        // 1. KUNIN ANG TOTOONG BET AMOUNT SA DATABASE
        // (Kasi na-reset na sa 0 ang local variable natin after game)
        const gameDocRef = doc(db, "games", gameId); 
        const docSnap = await getDoc(gameDocRef);
        
        if (!docSnap.exists()) {
            showMessage("Game error. Cannot rematch.", 2000);
            return;
        }

        const gameData = docSnap.data();
        const betForRematch = gameData.betAmount || 0;

        // 2. CHECK BALANCE (Meron ka bang pambayad?)
        if (betForRematch > 0 && playerTotalCurrency < betForRematch) {
            showMessage(`Cannot Rematch! Not enough coins. Need: ${formatCurrencyShort(betForRematch)}`, 3000);
            rematchButton.textContent = 'Request Rematch';
            rematchButton.disabled = false;
            return; // STOP! Bawal ituloy.
        }

        // 3. KUNG MAY PERA, SEND REQUEST
        rematchButton.textContent = 'Waiting for Opponent...'; 
        
        // I-flag sa database na gusto mo ng rematch
        await updateDoc(gameDocRef, { [`rematchRequest.${localPlayerUid}`]: true }); 
        
        console.log(`Rematch requested. Bet needed: ${betForRematch}`);

    } catch (error) { 
        console.error("Error sending rematch request:", error); 
        rematchButton.textContent = 'Error! Try Again'; 
        rematchButton.disabled = false; 
    } 
}

async function updatePlayerData(uid, didWin = false) {
    if (!uid || !db) return;
   
    const playerDocRef = doc(db, "players", uid);
   
    try {
        const playerDoc = await getDoc(playerDocRef);
        const displayName = localStorage.getItem('pinoyPoolPlayerName') || "Anonymous";
        
        // Kunin ang data mula sa Telegram
        const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user;
        
        // Kunin ang Wallet Address mula sa TON Connect UI
        const currentWalletAddress = tonConnectUI.account?.address || null;
       
        const dataToSave = {
            displayName: displayName,
            searchableName: displayName.toLowerCase(),
            trophies: playerTrophies,
            level: playerLevel,
            xp: playerXP,
            balance: playerTotalCurrency, // <--- Ngayon nase-save na rin ang Coins dito
            tgId: tgUser ? tgUser.id.toString() : (playerDoc.exists() ? (playerDoc.data().tgId || null) : null),
            walletAddress: currentWalletAddress || (playerDoc.exists() ? (playerDoc.data().walletAddress || null) : null),
            lastPlayed: serverTimestamp()
        };

        if (didWin) {
            dataToSave.wins = increment(1);
        }
       
        // Gamitin ang setDoc na may { merge: true } para hindi mabura ang ibang fields
        await setDoc(playerDocRef, dataToSave, { merge: true });
       
        console.log("‚úÖ All stats synced to Firestore (Coins, Trophies, Wallet, etc.)");
        updateCurrencyDisplay(); // I-refresh ang UI
       
    } catch (error) {
        console.error("‚ùå Error updating player data:", error);
    }
}
// ‚ñ≤‚ñ≤‚ñ≤ DULO NG STEP 5 ‚ñ≤‚ñ≤‚ñ≤
        async function cleanupMatchmakingEntry() { if (unsubscribeFromQueue) { unsubscribeFromQueue(); unsubscribeFromQueue = null; } const queueCollection = collection(db, "matchmakingQueue"); const q = query(queueCollection, where("uid", "==", localPlayerUid)); const snapshot = await getDocs(q); if (!snapshot.empty) { const myDocRef = snapshot.docs[0].ref; await deleteDoc(myDocRef); } }
        

        
        // --- ü§ñ STEP 2: START BOT MATCH (HIGH STAKES AI - NO REFUND) ü§ñ ---
// --- ü§ñ STEP 2: START BOT MATCH (MEMORY FIX) ü§ñ ---
async function startBotMatch() {
    await cleanupMatchmakingEntry();
    matchmakingWaitModal.classList.remove('show');

    const botName = BotGenerator.generateName();
    opponentPlayerName = botName;

    // ‚ñº‚ñº‚ñº DITO ANG FIX: SAVE & LOCK ‚ñº‚ñº‚ñº
    if (currentMatchBet > 0) {
        // 1. I-save sa Global Variable para hindi makalimutan ng Rematch
        window.lastAiBetAmount = currentMatchBet; 

        // 2. Ipakita na ACTIVE ang taya (Wag i-refund, wag i-reset sa 0)
        showMessage(`No human found. Playing vs AI.<br><span style="color:#FFD700">Bet Active: ${formatCurrencyShort(currentMatchBet)}</span>`, 3000);
        
        console.log("AI Match Started. Bet Locked:", currentMatchBet); // Debugging

    } else {
        // Kung Free Play, siguraduhing 0 din ang memory
        window.lastAiBetAmount = 0;
        showMessage(`Match Found! Opponent: ${botName}`, 3000);
    }
    // ‚ñ≤‚ñ≤‚ñ≤ ‚ñ≤‚ñ≤‚ñ≤

    playButtonSound(); 
    startGame(`ai-${selectedOnlineGameType}`, 'pro'); 
    
    setTimeout(() => {
        opponentPlayerName = botName; 
        updateInfoBox(); 
        
        // Update HUD
        const sub = document.querySelector('#opponent-info .hud-sub');
        if(sub) {
            // Check kung may laman ang currentMatchBet
            if (currentMatchBet > 0) {
                sub.innerHTML = `<span style="color:#FFD700">Pot: ${formatCurrencyShort(currentMatchBet * 2)}</span>`;
            } else {
                sub.innerHTML = '<span style="color:#aaa">Practice Bot</span>';
            }
        }
    }, 500); 
}async function processBet(amount) {
    // 1. Kung libre, lusot agad
    if (amount <= 0) return true; 

    // 2. Check kung may sapat na coins (Visual check)
    if (playerTotalCurrency < amount) {
        showMessage(`Kulang ang coins! Need: ${formatCurrencyShort(amount)}`, 3000);
        return false;
    }

    // 3. Ipakita ang loading message
    showMessage(`Processing payment: -${formatCurrencyShort(amount)}...`, 1000);

    // --- DITO ANG PAGBABAGO: MANUAL DEDUCTION (WALANG SERVER FETCH) ---
    try {
        // Bawasan ang local variable
        playerTotalCurrency -= amount;
        
        // I-save agad sa Firebase para hindi daya
        await updatePlayerData(localPlayerUid, false); 
        
        // Update display
        updateCurrencyDisplay();
        
        console.log("Payment successful (Local Mode)!");
        return true; // Success!

    } catch (error) {
        console.error("Payment Error:", error);
        // Ibalik ang pera kung nag-error ang save
        playerTotalCurrency += amount; 
        updateCurrencyDisplay();
        showMessage("Error saving transaction. Try again.", 3000);
        return false;
    }
}
// ----------------------------------------
async function findMatch() {
    const displayName = localPlayerName || "Guest";
    
    // 1. BASIC CHECKS
    if (!isAuthReady || !localPlayerUid) { 
        showMessage("Connecting to server..."); 
        return; 
    }

    // 2. SERVER PAYMENT FIRST (Bayad Muna!)
    // Kung may taya, tawagin ang Replit para maningil.
    if (selectedBetAmount > 0) {
        showMessage(`Processing Entry Fee: ${formatCurrencyShort(selectedBetAmount)}...`, 1000);
        
        // Tawagin ang Server API
        const isPaid = await processBet(selectedBetAmount);
        
        if (!isPaid) {
            // Kung walang pera o nag-error, STOP AGAD.
            return; 
        }
        
        // Visual Update lang (para sa UI logic)
        currentMatchBet = selectedBetAmount;
    }

    // 3. UI SETUP
    onlineMenu.classList.remove('show');
    matchmakingWaitModal.classList.add('show');
    history.pushState({ modal: 'matchmaking' }, 'Matchmaking', '#matchmaking');

    // Kunin ang Photo para handa na
    const myPhoto = localStorage.getItem('pinoyPoolPlayerPhoto');

    // 4. TIMEOUT LOGIC (BOT MATCH + REFUND)
    if (matchmakingTimeoutId) clearTimeout(matchmakingTimeoutId);
    
    matchmakingTimeoutId = setTimeout(async () => {
        if (gameId) return; // May nahanap na palang tao, wag ituloy ang bot
        
        console.log("Time's up. Switching to Bot Match.");

        // ‚ñº‚ñº‚ñº REFUND LOGIC (CORRECTED: SAFE & CLIENT-SIDE) ‚ñº‚ñº‚ñº
    
    // 1. STRICT CHECK: Gamitin ang 'currentMatchBet'. 
    // Ito ay nagiging > 0 LAMANG kung success ang bawas sa taas.
    if (currentMatchBet > 0) {
        
        // 2. Ibalik ang pera sa Local Variable
        playerTotalCurrency += currentMatchBet; 
        
        // 3. I-save agad sa Firebase at Update UI
        saveCurrency(); 
        updateCurrencyDisplay();

        // 4. Ipakita ang message
        showMessage(`No opponent found.<br><span style="color:#00FF00">Bet Refunded: +${formatCurrencyShort(currentMatchBet)}</span>`, 3000);
        
        // 5. RESET: Importanteng ibalik sa 0 para di na maulit
        currentMatchBet = 0; 
        selectedBetAmount = 0; 

    } else {
        // Kung walang nabawas (o Free Play), walang refund message.
        // Hahayaan lang natin tumuloy sa Bot Match.
        console.log("No active bet to refund.");
    }
    // ‚ñ≤‚ñ≤‚ñ≤ END REFUND ‚ñ≤‚ñ≤‚ñ≤

        // Start Bot Match (Practice Mode na lang ito)
        startBotMatch(); 
    }, 12000); // 12 Seconds waiting time

    // 5. FIND OPPONENT IN QUEUE
    const queueCollection = collection(db, "matchmakingQueue");
    
    const q = query(
        queueCollection, 
        where("status", "==", "waiting"), 
        where("gameType", "==", selectedOnlineGameType),
        where("betAmount", "==", selectedBetAmount), 
        limit(10)
    );
    
    try {
        const snapshot = await getDocs(q);
        let opponentDoc = null;

        // Filter: Hanap ng active player (wala pang 60s ang tanda)
        for (const docSnap of snapshot.docs) {
            const data = docSnap.data();
            if (data.uid !== localPlayerUid) {
                let time = data.timestamp?.toMillis ? data.timestamp.toMillis() : Date.now();
                if (Date.now() - time < 60000) { 
                    opponentDoc = docSnap;
                    break;
                }
            }
        }

        if (opponentDoc) {
            // --- OPPONENT FOUND (CREATE GAME) ---
            clearTimeout(matchmakingTimeoutId); // Stop Bot Timer
            
            const oppData = opponentDoc.data();
            const oppRef = opponentDoc.ref;

            // Double Check kung waiting pa rin
            const freshSnap = await getDoc(oppRef);
            if (!freshSnap.exists() || freshSnap.data().status !== 'waiting') {
                // Unlucky: Nakuha na ng iba. Retry tayo.
                // Note: Bayad ka na, kaya findMatch ulit (wag magbayad ulit logic dapat, 
                // pero sa simple version, hayaan muna natin ang retry sa UI or auto-retry logic requires more code)
                showMessage("Match failed. Retrying...", 1000);
                findMatch(); // Recursive retry (Ingat lang sa loop, pero 12s timeout will catch it)
                return;
            }

            // SETUP GAME DATA
            gameId = Math.random().toString(36).substring(2, 7).toUpperCase();
            localPlayerId = 'player1'; 
            gameMode = `online-${selectedOnlineGameType}`;
            resizeCanvas();
            setupChips();
            
            const initialChips = chips.map(c => ({...c, x: c.x/canvas.width, y: c.y/canvas.height }));
            const startUid = Math.random() < 0.5 ? localPlayerUid : oppData.uid;
            
            const myCue = equippedItems.cue || 'default';
            const myRank = getPlayerRank(playerLevel).index;
            
            const oppRank = oppData.rankIndex !== undefined ? oppData.rankIndex : 0;
            const oppCue = oppData.equippedCueId || 'default';
            const oppPhoto = oppData.photo || null;

            const gameData = {
                gameId, gameType: selectedOnlineGameType, gameState: 'playing', turnId: 1,
                betAmount: selectedBetAmount,
                pot: selectedBetAmount * 2, // Pot Money (X2 dahil dalawa kayo)
                players: {
                    player1: { 
                        uid: localPlayerUid, 
                        status: 'online', 
                        displayName: displayName, 
                        equippedCueId: myCue, 
                        rankIndex: myRank,
                        photo: myPhoto 
                    },
                    player2: { 
                        uid: oppData.uid, 
                        status: 'online', 
                        displayName: oppData.displayName, 
                        equippedCueId: oppCue, 
                        rankIndex: oppRank,
                        photo: oppPhoto 
                    }
                },
                chips: initialChips, currentTurnUid: startUid, canMoveCueBall: true, isBreakShot: true, winner: null
            };
            
            // Mode Specifics
            if (selectedOnlineGameType === 'poker') {
                createDeck(); dealCards();
                Object.assign(gameData, { deck, player1Hand: playerHand, player2Hand: opponentHand, originalPlayer1Hand: originalPlayerHand, originalPlayer2Hand: originalOpponentHand });
            } else if (selectedOnlineGameType === 'straight-ball') {
                Object.assign(gameData, { colorsAssigned: false, player1ChipsType: null, player2ChipsType: null });
            } else if (selectedOnlineGameType === '61-ball') {
                Object.assign(gameData, { player1_61Score: 0, player2_61Score: 0, lowestChipNumber: 1 });
            }

            // Save & Start
            await setDoc(doc(db, "games", gameId), gameData);
            await updateDoc(oppRef, { status: 'matched', gameId: gameId });
            
            if (unsubscribeFromQueue) unsubscribeFromQueue();
            matchmakingWaitModal.classList.remove('show');
            showMessage(`Matched! Pot Money: ${formatCurrencyShort(gameData.pot)}`, 2000);
            listenToGameUpdates(gameId);

        } else {
            // --- NO OPPONENT YET (JOIN QUEUE) ---
            if (!unsubscribeFromQueue) {
                const myRank = getPlayerRank(playerLevel).index;
                const myCue = equippedItems.cue || 'default';
                
                // Add self to Queue
                const ref = await addDoc(queueCollection, { 
                    uid: localPlayerUid, 
                    gameType: selectedOnlineGameType, 
                    betAmount: selectedBetAmount,
                    status: 'waiting', 
                    timestamp: serverTimestamp(), 
                    displayName: displayName,
                    rankIndex: myRank, 
                    equippedCueId: myCue,
                    photo: myPhoto
                });
                
                // Listen kung may kukuha sa atin
                unsubscribeFromQueue = onSnapshot(ref, (doc) => {
                    if(doc.exists() && doc.data().status === 'matched' && doc.data().gameId) {
                        clearTimeout(matchmakingTimeoutId); // Stop Bot Timer
                        if (unsubscribeFromQueue) unsubscribeFromQueue();
                        matchmakingWaitModal.classList.remove('show');
                        showMessage("Match found! Joining...", 2000);
                        gameId = doc.data().gameId;
                        localPlayerId = 'player2';
                        listenToGameUpdates(gameId);
                    }
                });
            }
        }
    } catch (e) {
        console.error("Match Error:", e);
        
        // ERROR HANDLING (Important: Refund kung nag-error after magbayad)
        if (selectedBetAmount > 0) {
             showMessage("Error occurred. Refunding...", 2000);
             // Call Refund API
             fetch(`${SERVER_URL}/api/refund`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ uid: localPlayerUid, amount: selectedBetAmount })
             }).then(() => {
                 playerTotalCurrency += selectedBetAmount;
                 updateCurrencyDisplay();
             });
        }
        
        if (e.code === 'failed-precondition') {
             showMessage("Database Index Required. Check Console.", 5000);
        } else {
             // setTimeout(findMatch, 1000); // Optional auto-retry
        }
    }
}

async function cancelMatchmaking() { 
    if (matchmakingTimeoutId) { clearTimeout(matchmakingTimeoutId); matchmakingTimeoutId = null; } 
    await cleanupMatchmakingEntry(); 
    
    // NOTE: Tinanggal ang Refund Logic dahil Server-side na ang bayad.
    // Kapag nag-cancel ka habang nasa queue, "Forfeited" ang coins mo sa version na ito.
    // (Kung gusto mo ng refund, kailangan ng server update next time).
    
    showMessage("Matchmaking cancelled."); 

    matchmakingWaitModal.classList.remove('show'); 
    onlineMenu.classList.add('show'); 
    history.back(); 
}


        function animateAndApplyShot(shotData) { cueStick.angle = shotData.angle; cueStick.visible = true; if (cueStickElement) cueStickElement.style.display = 'block'; gameState = 'shooting_animation'; let startTime = null; const animationDuration = 100; const shotPowerNormalized = (shotData.power - 5) / 40; const startPullback = shotPowerNormalized * (150 * scale); const endPullback = -30 * scale; function animate(timestamp) { if (!startTime) startTime = timestamp; const progress = Math.min((timestamp - startTime) / animationDuration, 1); cueStick.pullback = startPullback + (endPullback - startPullback) * progress; if (progress < 1) { requestAnimationFrame(animate); } else { cueStick.visible = false; cueStick.pullback = 0; if (cueStickElement) cueStickElement.style.display = 'none'; applyShot(shotData); } } requestAnimationFrame(animate); }
        
        function syncGameState(data) {
    // 1. Safety Checks
    if (isSyncing || !data) return;
    isSyncing = true;

    // 2. Identify Opponent Info & Status
    let opponentId = null;
    let opponentStatus = null;
    
    if (localPlayerId && data.players) {
        opponentId = localPlayerId === 'player1' ? 'player2' : 'player1';
        if (data.players[opponentId]) {
            const oppData = data.players[opponentId];
            
            // --- KUNIN ANG DATA NG KALABAN ---
            opponentStatus = oppData.status;
            opponentPlayerName = oppData.displayName || "Opponent";
            opponentEquippedCueId = oppData.equippedCueId || 'default';
            opponentRankIndex = oppData.rankIndex || 0;
            
            // SAVE PHOTO PARA SA HUD
            window.opponentPhotoUrl = oppData.photo || null; 
        }
    } else {
        // Fallback defaults
        opponentPlayerName = "Opponent";
        opponentEquippedCueId = 'default';
        opponentRankIndex = 0;
        window.opponentPhotoUrl = null;
    }

    // 3. INITIAL GAME LOAD (Start of Game)
    if (data.gameState === 'playing' && gameState !== 'playing') {
        gameState = 'playing';
        isOnlineGame = true;
        showGameUI();
        
        gameMode = `online-${data.gameType}`;
        lastProcessedTurnId = -1;

        // ‚ñº‚ñº‚ñº FIX SA FREEZE & LONG LIST ‚ñº‚ñº‚ñº
        
        // 1. I-define muna natin ito para hindi maging "undefined"
        const inviteModalElement = document.getElementById('invite-popup-modal');

        // 2. Ito ang ORIGINAL LONG LIST mo + yung Invite Modal variable
        const modalsToHide = [
            winnerModal, aiMenu, onlineMenu, onlineGameSelect, waitingRoom,
            straightBallInstructions, pokerInstructions, sixtyOneInstructions,
            confirmExitModal, leaderboardModal, shopModal, dailyRewardModal,
            matchmakingWaitModal, pokerFoulCardPickModal, tutorialOverlay,
            inviteModalElement // <--- Gamitin ang variable, wag ang ID string o undefined var
        ];

        // 3. Loop para itago (Safe check)
        modalsToHide.forEach(m => {
             if (m && m.classList) m.classList.remove('show');
        });

        // ‚ñ≤‚ñ≤‚ñ≤ ‚ñ≤‚ñ≤‚ñ≤

        history.pushState({ modal: 'game' }, 'Game', '#game');
        if (canvas.width === 0) resizeCanvas();

        // Load Initial Chips
        if (data.chips) {
            chips = data.chips.map(remoteChip => ({ ...remoteChip,
                x: remoteChip.x * canvas.width,
                y: remoteChip.y * canvas.height,
                radius: (remoteChip.id === 0 ? CUE_BALL_RADIUS : BALL_RADIUS) * scale
            }));
        }

        // Sync Specific Game Modes
        if (data.gameType === 'poker') {
            deck = data.deck || [];
            playerHand = (localPlayerId === 'player1') ? data.player1Hand : data.player2Hand;
            opponentHand = (localPlayerId === 'player1') ? data.player2Hand : data.player1Hand;
            originalPlayerHand = (localPlayerId === 'player1') ? data.originalPlayer1Hand : data.originalPlayer2Hand;
            originalOpponentHand = (localPlayerId === 'player1') ? data.originalPlayer2Hand : data.originalPlayer1Hand;
        } else if (data.gameType === '61-ball') {
            player61Score = (localPlayerId === 'player1') ? data.player1_61Score : data.player2_61Score;
            opponent61Score = (localPlayerId === 'player1') ? data.player2_61Score : data.player1_61Score;
            lowestChipNumber = data.lowestChipNumber;
        } else if (data.gameType === 'straight-ball') {
            colorsAssigned = data.colorsAssigned;
            playerChipsType = (localPlayerId === 'player1') ? data.player1ChipsType : data.player2ChipsType;
            opponentChipsType = (localPlayerId === 'player1') ? data.player2ChipsType : data.player1ChipsType;
        }

        updateInfoBox(); // Update HUD

        // --- VS SCREEN DISPLAY ---
        if (!vsScreenShownThisGame) {
            vsScreenShownThisGame = true;

            const myRankInfo = getPlayerRank(playerLevel);
            const opponentRankInfo = RANKS[opponentRankIndex] || RANKS[0];
            const myPhoto = localStorage.getItem('pinoyPoolPlayerPhoto');

            let player1Data, player2Data;

            if (localPlayerId === 'player1') {
                player1Data = { name: localPlayerName, rankInfo: myRankInfo, photo: myPhoto };
                player2Data = { name: opponentPlayerName, rankInfo: opponentRankInfo, photo: window.opponentPhotoUrl };
            } else {
                player1Data = { name: opponentPlayerName, rankInfo: opponentRankInfo, photo: window.opponentPhotoUrl };
                player2Data = { name: localPlayerName, rankInfo: myRankInfo, photo: myPhoto };
            }

            // Ipakita ang VS Screen
            showVsScreen(player1Data, player2Data, data.gameType);
        }
    }

    // 4. GAME OVER HANDLING
    if (data.gameState === 'finished' && gameState !== 'gameover') {
        endGame(data.winner === localPlayerUid ? 'You Win!' : 'You Lose!', data);
        isSyncing = false;
        return;
    }

    // 5. ACTIVE GAMEPLAY UPDATES
    if (gameState === 'playing') {
        
        // --- AI TAKEOVER ---
        if (opponentStatus === 'disconnected' && !isAiTakeoverActive) {
            isAiTakeoverActive = true;
            showMessage("Opponent disconnected. AI taking over.", 4000);
            opponentPlayerName = "AI (Bot)";
            updateInfoBox();
        } else if (opponentStatus === 'online' && isAiTakeoverActive) {
            isAiTakeoverActive = false;
            opponentPlayerName = data.players[opponentId]?.displayName || "Opponent";
            updateInfoBox();
            showMessage("Opponent reconnected!", 3000);
        }

        // --- TURN SYNC ---
        isMyTurnOnline = (data.currentTurnUid === localPlayerUid);
        setCueForCurrentTurn();

        // Process Updates if Turn ID increased
        if (data.turnId > lastProcessedTurnId) {
            lastProcessedTurnId = data.turnId;
            chipsMoving = false;

            // Teleport Correction
            if (data.chips && canvas.width > 0) {
                chips = data.chips.map(remoteChip => ({ ...remoteChip,
                    x: remoteChip.x * canvas.width,
                    y: remoteChip.y * canvas.height,
                    radius: (remoteChip.id === 0 ? CUE_BALL_RADIUS : BALL_RADIUS) * scale
                }));
            }

            // Sync Game Specific Data
            if (data.gameType === 'poker') {
                playerHand = (localPlayerId === 'player1') ? data.player1Hand : data.player2Hand;
                opponentHand = (localPlayerId === 'player1') ? data.player2Hand : data.player1Hand;
            } else if (data.gameType === '61-ball') {
                player61Score = (localPlayerId === 'player1') ? data.player1_61Score : data.player2_61Score;
                opponent61Score = (localPlayerId === 'player1') ? data.player2_61Score : data.player1_61Score;
                lowestChipNumber = data.lowestChipNumber;
            } else if (data.gameType === 'straight-ball') {
                colorsAssigned = data.colorsAssigned;
                playerChipsType = (localPlayerId === 'player1') ? data.player1ChipsType : data.player2ChipsType;
                opponentChipsType = (localPlayerId === 'player1') ? data.player2ChipsType : data.player1ChipsType;
            }

            canMoveCueBall = data.canMoveCueBall;
            isBreakShot = data.isBreakShot;

            updateCardDisplay();
            updateInfoBox(); 

            // Turn Messages
            const message = data.isBreakShot ?
                (isMyTurnOnline ? "You break!" : `${opponentPlayerName}'s break!`) :
                (isMyTurnOnline ? "Your turn" : `${opponentPlayerName}'s turn`);

            if (isMyTurnOnline && canMoveCueBall) {
                showMessage(message, 3000);
                dragGuideText.style.display = 'block';
            } else if (!canMoveCueBall) {
                showMessage(message, 2000);
            }

            if (isMyTurnOnline && !canMoveCueBall && gameState !== 'aiming') {
                resetPektus();
            }
        }

        // State Management
        if (isMyTurnOnline) {
            gameState = canMoveCueBall ? 'moving' : 'aiming';
            if (gameState === 'aiming') {
                dragGuideText.style.display = 'none';
                cueStick.visible = true;
                if (cueStickElement) cueStickElement.style.display = 'block';
            }
        } else {
            gameState = 'aiming';
            dragGuideText.style.display = 'none';
        }

        // Trigger AI Logic if Takeover is active
        if (isAiTakeoverActive && !isMyTurnOnline && !chipsMoving && !data.turnInProgress) {
            setTimeout(() => {
                if (isAiTakeoverActive && !isMyTurnOnline && !chipsMoving) aiTurn();
            }, 1500);
        }
    }
    
    isSyncing = false;
}
        function playBackgroundMusic() { if (musicHasStarted) return; const playNextTrack = () => { currentTrackIndex = (currentTrackIndex + 1) % backgroundPlaylist.length; const nextPlayer = backgroundPlaylist[currentTrackIndex]; nextPlayer.currentTime = 0; nextPlayer.play(); }; backgroundPlaylist.forEach(player => { player.volume = 0.25; player.onended = playNextTrack; }); const initialPlayer = backgroundPlaylist[currentTrackIndex]; initialPlayer.play().catch(error => { console.log("Music play was prevented by the browser."); }); musicHasStarted = true; }
        /**
 * Binubuksan ang shop at ipinapakita ang mga items.
 * (ITO YUNG NAWAWALA MONG FUNCTION)
 */
function openShop() {
    playButtonSound();
    gameModeSelect.classList.remove('show');
    document.getElementById('shop-modal').classList.add('show');
if (typeof tg !== 'undefined') {
        tg.BackButton.show();
    }
    history.pushState({ modal: 'shopModal' }, 'Shop', '#shop');
    
    // Reset to Cues pag binuksan
    currentShopTab = 'cues';
    renderShopTabs(); // Render tabs
    renderShopItems(); // Render items
}

async function showLeaderboard() {
    playButtonSound();

    const modal = document.getElementById('leaderboard-modal');
    const tbody = document.getElementById('leaderboard-body');
    
    document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('show'));
    modal.classList.add('show');
    if (typeof tg !== 'undefined') {
        tg.BackButton.show();
    }
    history.pushState({ modal: 'leaderboardModal' }, 'Leaderboard', '#leaderboard');

    tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px; font-style: italic; color: #aaa;">Fetching Top Players...</td></tr>';

    if (!db) return;

    try {
        const playersRef = collection(db, "players");
        const q = query(playersRef, orderBy("wins", "desc"), limit(50));
        const querySnapshot = await getDocs(q);

        if (querySnapshot.empty) {
            tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px;">No records yet.</td></tr>';
            return;
        }

        let uniqueMap = {};

        querySnapshot.forEach((doc) => {
            const data = doc.data();
            const name = data.displayName || "Unknown";
            const wins = parseInt(data.wins) || 0;
            const level = parseInt(data.level) || 1;
            const photo = data.photo || null; // <--- KUNIN ANG PHOTO

            if (!uniqueMap[name] || wins > uniqueMap[name].wins) {
                uniqueMap[name] = {
                    name: name,
                    wins: wins,
                    level: level,
                    photo: photo, // <--- I-SAVE DITO
                    isMe: (doc.id === localPlayerUid) 
                };
            }
        });

        let sortedPlayers = Object.values(uniqueMap);
        sortedPlayers.sort((a, b) => b.wins - a.wins);

        tbody.innerHTML = '';
        let rank = 1;

        sortedPlayers.forEach(player => {
            const row = document.createElement('tr');
            
            let rankDisplay = `#${rank}`;
            let rowBackground = "transparent";
            let nameColor = "#fff"; 

            if (rank === 1) { rankDisplay = "ü•á"; rowBackground = "rgba(255, 215, 0, 0.1)"; nameColor = "#FFD700"; }
            else if (rank === 2) { rankDisplay = "ü•à"; rowBackground = "rgba(192, 192, 192, 0.1)"; nameColor = "#C0C0C0"; }
            else if (rank === 3) { rankDisplay = "ü•â"; rowBackground = "rgba(205, 127, 50, 0.1)"; nameColor = "#CD7F32"; }

            if (player.isMe) { rowBackground = "rgba(0, 255, 0, 0.15)"; nameColor = "#00FF00"; }

            // --- AVATAR LOGIC (FIXED) ---
            // Sa loob ng showLeaderboard function, palitan ang avatarHtml logic nito:

let avatarHtml = "";
if (player.photo) {
    // MAY PHOTO: High Quality settings
    avatarHtml = `<img src="${player.photo}" onclick="window.viewFullPhoto('${player.photo}')" style="width: 38px; height: 38px; border-radius: 50%; margin-right: 12px; border: 2px solid rgba(255,255,255,0.2); object-fit: cover; cursor: pointer; background-color: #222;">`;
} else {
    // WALA: Default na mataas resolution (size=128)
    const safeName = player.name.replace(/ /g, "+");
    avatarHtml = `<img src="https://ui-avatars.com/api/?name=${safeName}&background=random&color=fff&size=128" style="width: 38px; height: 38px; border-radius: 50%; margin-right: 12px; border: 2px solid rgba(255,255,255,0.2); object-fit: cover;">`;
}

            row.innerHTML = `
                <td style="padding: 10px; font-weight: bold; font-size: 1.2em; text-align: center;">${rankDisplay}</td>
                <td style="padding: 10px;">
                    <div style="display: flex; align-items: center;">
                        ${avatarHtml}
                        <div>
                            <div style="font-weight: bold; font-size: 1em; color: ${nameColor};">${player.name}</div>
                            <div style="font-size: 0.7em; opacity: 0.6; color: #ddd;">Lv. ${player.level}</div>
                        </div>
                    </div>
                </td>
                <td style="padding: 10px; font-weight: bold; color: #33FF57; text-align: right;">${player.wins} Wins</td>
            `;
            
            row.style.backgroundColor = rowBackground;
            row.style.borderBottom = "1px solid rgba(255,255,255,0.1)";
            tbody.appendChild(row);
            rank++;
        });

    } catch (error) {
        console.error("Leaderboard Error:", error);
    }
} 

function showVsScreen(player1, player2, gameType) {
    const modal = document.getElementById('vs-screen-modal');
    if (!modal) return;

    // Helper: Gumawa ng Image Tag kung may photo, o Avatar kung wala
    const getAvatarHTML = (p) => {
        if (p.photo) {
            // Picture na may kulay ng Rank sa border
            return `<img src="${p.photo}" class="viewable-img" style="width: 100px; height: 100px; border-radius: 50%; border: 4px solid ${p.rankInfo.color || '#fff'}; object-fit: cover; box-shadow: 0 0 20px ${p.rankInfo.color}; cursor: pointer;">`;
        } else {
            // Default na emoji/icon (Galing sa Original Code logic)
            return `<div style="font-size: 4em;">${p.rankInfo.icon || 'üë§'}</div>`;
        }
    };

    // 1. Player 1 (Left) - Original Logic + Photo Logic
    document.getElementById('vs-player-1-box').innerHTML = `
        ${getAvatarHTML(player1)}
        <div class="vs-player-rank" style="color: ${player1.rankInfo.color}; margin-top: 10px;">[${player1.rankInfo.name}]</div>
        <div class="vs-player-name">${player1.name}</div>
    `;

    // 2. Player 2 (Right) - Original Logic + Photo Logic
    document.getElementById('vs-player-2-box').innerHTML = `
        ${getAvatarHTML(player2)}
        <div class="vs-player-rank" style="color: ${player2.rankInfo.color}; margin-top: 10px;">[${player2.rankInfo.name}]</div>
        <div class="vs-player-name">${player2.name}</div>
    `;

    // 3. Game Mode Text (Original Logic)
    let gameModeText = "UNKNOWN GAME";
    if (gameType === 'poker') gameModeText = "POKER POOL";
    else if (gameType === 'straight-ball') gameModeText = "STRAIGHT BALL";
    else if (gameType === '61-ball') gameModeText = "61 BALL";
    document.getElementById('vs-game-mode').textContent = gameModeText;

    // Show Modal
    modal.classList.add('show');
    setTimeout(() => { modal.classList.remove('show'); }, 4000);
}
        
function loadPlayerStats() {
    const savedLevel = localStorage.getItem('pinoyPoolPlayerLevel');
    const savedXP = localStorage.getItem('pinoyPoolPlayerXP');
    const savedTrophies = localStorage.getItem('pinoyPoolPlayerTrophies');

    playerLevel = savedLevel ? parseInt(savedLevel, 10) : 1;
    playerXP = savedXP ? parseInt(savedXP, 10) : 0;
    playerTrophies = savedTrophies ? parseInt(savedTrophies, 10) : 0;

    // Kalkulahin ang next level requirement
    xpToNextLevel = calculateXPForLevel(playerLevel); 
    
    // I-update agad ang UI
    updateXPDisplay(); 
}

/**
 * 2. Save Stats: Sine-save ang progress.
 */
function savePlayerStats() {
    localStorage.setItem('pinoyPoolPlayerLevel', playerLevel.toString());
    localStorage.setItem('pinoyPoolPlayerXP', playerXP.toString());
    localStorage.setItem('pinoyPoolPlayerTrophies', playerTrophies.toString());
}

/**
 * 3. Math Helper: Mas mahirap mag-level up habang tumataas.
 * Pinalitan ang multiplier: 100 -> 200, at power 1.2 -> 1.5
 */
function calculateXPForLevel(level) {
    // Dati: 100 * Math.pow(level, 1.2)
    // Ngayon: Mas matarik na ang curve. Matagal bago mag Level 10+.
    return Math.floor(200 * Math.pow(level, 1.5));
}


/**
 * 4. Popup Helper: Ipinapakita ang "LEVEL UP!" message.
 * (KASAMA NA ITO NGAYON PARA HINDI MAG-ERROR)
 */
function showLevelUpPopup(newLevel, coinReward) {
    const popup = document.createElement('div');
    popup.innerHTML = `LEVEL UP!<br>You are now Level ${newLevel}<br>+${coinReward} Coins!`;
    
    popup.style.cssText = `
        position: absolute; left: 50%; top: 70px; transform: translateX(-50%) translateY(0);
        color: var(--gold-accent); font-size: 1.5em; font-weight: bold;
        font-family: 'Luckiest Guy', cursive; text-shadow: 2px 2px 5px rgba(0,0,0,0.9);
        z-index: 210; opacity: 1; transition: opacity 2.0s ease-out, transform 2.0s ease-out;
        pointer-events: none; text-align: center; padding: 10px 15px;
        background: rgba(0,0,0,0.7); border-radius: 10px; border: 2px solid var(--gold-accent);
    `;
    // Safety check kung may overlay
    const overlay = document.getElementById('non-interactive-overlay') || document.body;
    overlay.appendChild(popup);
    
    // Animation
    setTimeout(() => { popup.style.opacity = '0'; popup.style.transform = 'translateX(-50%) translateY(-30px)'; }, 2500);
    setTimeout(() => { popup.remove(); }, 4500);
}

function gainXP(amount) {
    // Kung tapos na ang laro, wag na gumalaw
    if (gameState === 'gameover') return; 

    try {
        if (amount > 0) {
            playerXP += amount;
            
            // Level Up Logic
            while (playerXP >= xpToNextLevel) {
                playerLevel++;
                playerXP -= xpToNextLevel; 
                xpToNextLevel = calculateXPForLevel(playerLevel); 

                // Rewards
                playerTotalCurrency += 250; 
                saveCurrency();
                updateCurrencyDisplay(); 
                
                // Safe call sa popup
                if (typeof showLevelUpPopup === 'function') {
                    showLevelUpPopup(playerLevel, 250);
                }
            }

            // Save Stats
            savePlayerStats();
            
            // Update UI
            updateXPDisplay();
        }
    } catch (e) {
        console.error("XP Error (Ignored to keep game running):", e);
        // IMPORTANTE: Kahit mag-error ang XP, hindi natin ihihinto ang laro.
    }
}
function getPlayerRank(trophies) {
    // Default / Fallback Rank (Para hindi mag-crash)
    let currentRank = { name: "Bronze", minTrophies: 0, color: "#CD7F32", icon: "ü•â", index: 0 };
    
    // Safety Check: Kung wala pang RANKS o trophies, balik agad sa default
    if (typeof RANKS === 'undefined' || !Array.isArray(RANKS)) return currentRank;
    if (typeof trophies !== 'number') trophies = 0;

    for (let i = 0; i < RANKS.length; i++) {
        if (trophies >= RANKS[i].minTrophies) {
            currentRank = RANKS[i];
            currentRank.index = i; // Siguraduhing may index
        } else {
            break; 
        }
    }
    return currentRank;
}

// ‚ñº‚ñº‚ñº CLEAN XP BAR: EMOJI + LVL LANG (Wala nang Rank Name) ‚ñº‚ñº‚ñº

function updateXPDisplay() {
    try {
        const levelDisplay = document.getElementById('player-level-display');
        const xpBarFill = document.getElementById('xp-bar-fill-new'); 
        const xpText = document.getElementById('xp-text-display-new'); 

        // Kunin ang Rank para sa Emoji at Kulay
        const safeTrophies = (typeof playerTrophies !== 'undefined') ? playerTrophies : 0;
        const rankInfo = getPlayerRank(safeTrophies); 

        if (levelDisplay) {
            // FORMAT: [Emoji] Lv. [Number]
            // Halimbawa: üèÜ Lv. 5
            levelDisplay.innerHTML = `${rankInfo.icon} <span style="color: ${rankInfo.color}; font-weight:bold;">Lv. ${playerLevel}</span>`;
        }
        
        if (xpBarFill) {
            let safeMax = xpToNextLevel > 0 ? xpToNextLevel : 100;
            const percentage = (playerXP / safeMax) * 100;
            xpBarFill.style.width = `${Math.max(0, Math.min(100, percentage))}%`;
        }
        
        if (xpText) {
            // Ang XP numbers (e.g. 50/100) ay mananatili SA LOOB ng bar
            xpText.textContent = `${Math.floor(playerXP)}/${xpToNextLevel}`;
        }
    } catch (e) {
        console.error("Display Error (Ignored):", e);
    }
}

function updateInfoBox() { 
    // 1. Kunin ang Rank Data
    const safeTrophies = (typeof playerTrophies !== 'undefined') ? playerTrophies : 0;
    const myRank = getPlayerRank(safeTrophies);
    const opponentRank = RANKS[opponentRankIndex] || RANKS[0]; 

    const player1Name = localPlayerName || 'You'; 
    let player2Name = opponentPlayerName || 'Opponent'; 
    
    // --- BAGO: Kunin ang CSS Class para sa Border (Bronze, Gold, Mythical, etc.) ---
    // Kung walang cssClass, mag-default sa Bronze
    const myBorderClass = myRank.cssClass || 'rank-border-bronze';
    
    // Check kung Online o AI para sa border ng kalaban
    const oppBorderClass = (isOnlineGame ? opponentRank.cssClass : 'rank-border-bronze') || 'rank-border-bronze';

    // A. My Avatar HTML
    const myLocalPhoto = localStorage.getItem('pinoyPoolPlayerPhoto');
    let myAvatarHTML = myRank.icon; 
    
    if (myLocalPhoto && myLocalPhoto !== 'null' && myLocalPhoto !== 'undefined') {
        myAvatarHTML = `<img src="${myLocalPhoto}" onclick="event.stopPropagation(); window.viewFullPhoto('${myLocalPhoto}')" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover; cursor: pointer;">`;
    }

    // B. Opponent Avatar HTML
    let opponentAvatarHTML = opponentRank.icon;
    if (isOnlineGame) {
        if (window.opponentPhotoUrl && window.opponentPhotoUrl !== 'null') {
            opponentAvatarHTML = `<img src="${window.opponentPhotoUrl}" onclick="event.stopPropagation(); window.viewFullPhoto('${window.opponentPhotoUrl}')" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover; cursor: pointer;">`;
        }
    } else {
        opponentAvatarHTML = "ü§ñ";
        if (opponentPlayerName && opponentPlayerName !== "Opponent") {
            player2Name = opponentPlayerName; 
        } else {
            player2Name = "AI Bot"; 
        }
    }

    // --- GAME SUBTEXT (Score/Cards) ---
    let p1Sub = "", p2Sub = "";
    if (gameMode.includes('poker')) { 
        p1Sub = `<span style="color:#33FF57">${playerHand?.length || 0} Cards</span>`;
        p2Sub = `<span style="color:#FF6B6B">${opponentHand?.length || 0} Cards</span>`;
    } else if (gameMode.includes('straight-ball')) { 
        const myColor = playerChipsType ? playerChipsType.toUpperCase() : 'OPEN';
        const oppColor = opponentChipsType ? opponentChipsType.toUpperCase() : 'OPEN';
        const c1 = myColor === 'RED' ? '#ff6b6b' : (myColor === 'BLUE' ? '#54a0ff' : '#ddd');
        const c2 = oppColor === 'RED' ? '#ff6b6b' : (oppColor === 'BLUE' ? '#54a0ff' : '#ddd');
        p1Sub = `<span style="color:${c1}">${myColor}</span>`;
        p2Sub = `<span style="color:${c2}">${oppColor}</span>`;
    } else if (gameMode.includes('61-ball')) { 
        p1Sub = `<span style="color:#FFD700">${player61Score} Pts</span>`;
        p2Sub = `<span style="color:#FFD700">${opponent61Score} Pts</span>`;
        if(lowestChipNumber > 0 && gameState === 'aiming') { 
            cueBallGuide.innerHTML = `Target: Chip #${lowestChipNumber}`; 
            cueBallGuide.style.display = 'block'; 
        } else { 
            cueBallGuide.style.display = 'none'; 
        } 
    }

    // --- RENDER HTML (ETO ANG IMPORTANTE: GINAMIT ANG CLASSES) ---
    
    playerInfo.innerHTML = `
        <div class="hud-avatar ${myBorderClass}" style="overflow: hidden; padding: 0;">${myAvatarHTML}</div>
        <div class="hud-details">
            <div class="hud-name">${player1Name}</div>
            <div class="hud-sub">${p1Sub}</div>
        </div>
    `;
    playerInfo.style.cursor = 'pointer';
    playerInfo.onclick = () => showProfile('player');

    opponentInfo.innerHTML = `
        <div class="hud-details">
            <div class="hud-name">${player2Name}</div>
            <div class="hud-sub">${p2Sub}</div>
        </div>
        <div class="hud-avatar ${oppBorderClass}" style="overflow: hidden; padding: 0;">${opponentAvatarHTML}</div>
    `;
    opponentInfo.style.cursor = 'pointer';
    opponentInfo.onclick = () => showProfile('opponent');

    // Active Turn Glow
    const isMyTurn = isOnlineGame ? isMyTurnOnline : playerTurn;
    if (isMyTurn) {
        playerInfo.classList.add('hud-active'); 
        opponentInfo.classList.remove('hud-active'); 
    } else {
        playerInfo.classList.remove('hud-active'); 
        opponentInfo.classList.add('hud-active'); 
    }
    
    updateLegalTargetChips(); 
}
        function initializeFirebase() { 
    try { 
        // onlineButton.textContent = "Connecting..."; // <--- BINURA KO NA ITO (Commented out)
        onlineButton.disabled = true; // Disable muna habang loading
        
        const firebaseConfig = { 
            apiKey: "AIzaSyD0gZfJxpA_4fO-SEOjX9JNs0v7IzQ0iSc", 
            authDomain: "pinoy-pool-master.firebaseapp.com", 
            databaseURL: "https://pinoy-pool-master-default-rtdb.asia-southeast1.firebasedatabase.app/", 
            projectId: "pinoy-pool-master", 
            storageBucket: "pinoy-pool-master.appspot.com", 
            messagingSenderId: "1003592334290", 
            appId: "1:1003592334290:web:2982cdc8691e8ef7c6260b" 
        }; 

        const app = initializeApp(firebaseConfig); 
        db = getFirestore(app); 
        auth = getAuth(app); 
        rtdb = getDatabase(app); 
        
        signInPlayer(); 
        firebaseInitialized = true; 
    } catch (error) { 
        console.warn("Firebase failed.", error); 
        firebaseInitialized = false; 
      
        // onlineButton.textContent = "Offline"; // <--- BINURA KO RIN ITO
        
        // Update natin ang subtitle na lang kung offline (Optional)
        const sub = document.querySelector('#online-button .card-subtitle');
        if(sub) sub.textContent = "Offline (Check Internet)";
        
        onlineButton.disabled = true; 
    } 
}
// Idagdag itong 3 bagong functions
// ‚úÖ BAGONG LOAD FUNCTION (Galing Firebase)
async function loadCurrency() {
    // 1. UNAHING KUNIN ANG SAVE SA CELLPHONE (Local Storage)
    // Para kahit offline o loading pa ang internet, may makikita agad na coins.
    const localCoins = localStorage.getItem('pinoyPoolCoins');
    
    if (localCoins !== null) {
        playerTotalCurrency = parseInt(localCoins, 10);
        console.log("Local Coins Loaded:", playerTotalCurrency);
        updateCurrencyDisplay(); // Ipakita agad sa UI
    }

    // 2. SAKA KUNIN ANG SA DATABASE (Sync)
    if (!db || !localPlayerUid) return; 

    try {
        const docRef = doc(db, "players", localPlayerUid);
        const snap = await getDoc(docRef);
        
        if (snap.exists()) {
            const serverCoins = snap.data().balance || 0;
            
            // Kung mas bago o iba ang nasa server, i-update natin ang local
            if (serverCoins !== playerTotalCurrency) {
                console.log("Syncing with Server Coins:", serverCoins);
                playerTotalCurrency = serverCoins;
                
                // I-save agad sa local para sa susunod
                localStorage.setItem('pinoyPoolCoins', serverCoins.toString());
                updateCurrencyDisplay();
            }
        } else {
            // New Player Logic
            if (playerTotalCurrency === 0) { // Kung wala ring laman ang local
                playerTotalCurrency = 100;
                updatePlayerData(localPlayerUid); 
                localStorage.setItem('pinoyPoolCoins', '100'); // Save local
                updateCurrencyDisplay();
            }
        }
    } catch (e) {
        console.error("Error loading online PPM (Using local backup):", e);
    }
}
function loadPlayerName() {
    // 1. I-check kung nasa loob tayo ng Telegram Mini App
    const tg = window.Telegram?.WebApp;
    
    if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
        const user = tg.initDataUnsafe.user;
        
        // 2. Kunin ang pangalan mula sa Telegram (First Name + Last Name)
        localPlayerName = user.first_name + (user.last_name ? " " + user.last_name : "");
        
        // I-save sa localStorage para consistent sa system mo
        localStorage.setItem('pinoyPoolPlayerName', localPlayerName);
        
        // 3. I-save din ang Telegram Profile Photo kung mayroon para lumitaw sa HUD
        if (user.photo_url) {
            localStorage.setItem('pinoyPoolPlayerPhoto', user.photo_url);
        }
        
        return true; // I-skip na ang "Enter Name" screen dahil may data na tayo
    }

    // --- Fallback: Kung wala sa Telegram (e.g. testing sa browser), gamitin ang dati mong logic ---
    const savedPlayerName = localStorage.getItem('pinoyPoolPlayerName');
    if (savedPlayerName) {
        localPlayerName = savedPlayerName;
        return true;
    } else {
        localPlayerName = "Guest";
        return false;
    }
}
function loadInventory() {
    const savedInventory = localStorage.getItem('pinoyPoolInventory');
    const savedEquipped = localStorage.getItem('pinoyPoolEquipped');

    if (savedInventory) {
        try {
            playerInventory = JSON.parse(savedInventory);
        } catch (e) {
            console.error("Corrupted inventory, resetting.");
            playerInventory = null;
        }
    }

    // SAFETY CHECK: Siguraduhing kumpleto ang arrays kahit luma ang save
    if (!playerInventory) {
        playerInventory = { cues: ['default'], frames: ['default'], felts: ['default'] };
    }
    if (!playerInventory.cues) playerInventory.cues = ['default'];
    if (!playerInventory.frames) playerInventory.frames = ['default'];
    if (!playerInventory.felts) playerInventory.felts = ['default'];

    if (savedEquipped) {
        try {
            equippedItems = JSON.parse(savedEquipped);
        } catch (e) {
            equippedItems = null;
        }
    }

    // SAFETY CHECK: Siguraduhing may default values
    if (!equippedItems) {
        equippedItems = { cue: 'default', frame: 'default', felt: 'default' };
    }
    if (!equippedItems.frame) equippedItems.frame = 'default';
    if (!equippedItems.felt) equippedItems.felt = 'default';

    // I-save ulit para ma-fix ang format kung may kulang
    saveInventory();
}


/**
 * Sine-save ang inventory at equipped items sa localStorage.
 */
function saveInventory() {
    localStorage.setItem('pinoyPoolInventory', JSON.stringify(playerInventory));
    localStorage.setItem('pinoyPoolEquipped', JSON.stringify(equippedItems));
}

function openFriendsModal() {
    playButtonSound();
    
    const modal = document.getElementById('friends-modal');
    
    // Ipakita ang modal
    modal.classList.add('show');
    if (typeof tg !== 'undefined') {
        tg.BackButton.show();
    }
    history.pushState({ modal: 'friendsModal' }, 'Friends', '#friends');

    // ‚ñº‚ñº‚ñº ANG BAGONG FIX (SMART LOAD) ‚ñº‚ñº‚ñº
    // Kung HINDI pa na-load dati, tsaka lang tayo mag-lo-load sa database.
    // Kung na-load na, hayaan na lang (nandoon na ang Green Dots).
    if (!isFriendsListLoaded) {
        document.getElementById('friends-list-pending').innerHTML = '<div class="friend-item-empty">Loading...</div>';
        document.getElementById('friends-list-accepted').innerHTML = '<div class="friend-item-empty">Loading...</div>';
        
        loadFriendsList(); 
        isFriendsListLoaded = true; // Markahan na tapos na mag-load
    }
    
    // Reset search bar lang
    document.getElementById('friend-search-results').innerHTML = '';
    document.getElementById('friend-search-input').value = '';
}
/**
 * Async function na kumukuha ng TOTOONG data mula sa Firestore at tinatawag ang render functions.
 */
async function loadFriendsList() {
    if (!localPlayerUid || !db) {
        return;
    }

    const pendingListUI = document.getElementById('friends-list-pending');
    const acceptedListUI = document.getElementById('friends-list-accepted');

    // I-clear para sa fresh data
    pendingListUI.innerHTML = '';
    acceptedListUI.innerHTML = '';

    let hasPending = false;
    let hasAccepted = false;
    
    // 1. Pending Requests
    try {
        const qPending = query(collection(db, "friendships"), 
            where("requestedTo", "==", localPlayerUid), 
            where("status", "==", "pending")
        );
        const pendingSnapshot = await getDocs(qPending);
        
        pendingSnapshot.forEach((doc) => {
            hasPending = true;
            renderFriendItem(pendingListUI, doc.id, doc.data(), "pending");
        });
    } catch (e) { console.error(e); }

    // 2. Accepted Friends
    try {
        const qAccepted = query(collection(db, "friendships"), 
            where("uids", "array-contains", localPlayerUid), 
            where("status", "==", "accepted")
        );
        const acceptedSnapshot = await getDocs(qAccepted);

        acceptedSnapshot.forEach((doc) => {
            hasAccepted = true;
            renderFriendItem(acceptedListUI, doc.id, doc.data(), "accepted");
        });
    } catch (e) { console.error(e); }

    if (!hasPending) pendingListUI.innerHTML = '<div class="friend-item-empty">No pending requests.</div>';
    if (!hasAccepted) acceptedListUI.innerHTML = '<div class="friend-item-empty">You have no friends yet.</div>';
    
    // Markahan na loaded na (para sa refresh logic)
    isFriendsListLoaded = true; 
}

function renderFriendItem(listElement, docId, data, type) {
    const friendUid = data.uids.find(uid => uid !== localPlayerUid);
    if (!friendUid) return; 

    const friendName = data.names[friendUid] || "Unknown";
    const friendLevel = data.levels[friendUid] || 1;
    const rankInfo = getPlayerRank(friendLevel);

    const itemDiv = document.createElement('div');
    itemDiv.className = 'friend-item';
    itemDiv.id = `friend-item-${docId}`;
    itemDiv.setAttribute('data-friend-uid', friendUid);

    // Hanapin ang part na ito sa loob ng renderFriendItem function
// at palitan ng code sa baba:

// --- OPTIMIZED IMAGE LOADING ---
const imgId = `friend-img-${friendUid}`;
// Default Placeholder (Mataas ang resolution: size=128)
const defaultImg = `https://ui-avatars.com/api/?name=${friendName}&background=random&color=fff&size=128`;

// Fetch REAL Photo sa background
if (db) {
    getDoc(doc(db, "players", friendUid)).then(snap => {
        if (snap.exists() && snap.data().photo) {
            const imgEl = document.getElementById(imgId);
            if (imgEl) {
                // I-load ang HD photo
                imgEl.src = snap.data().photo;
            }
        }
    });
}

// Dito ang pagbabago: Tinaasan ko ang width/height sa 40px at naglagay ng onclick para ma-view ng malaki
const imageHTML = `<img id="${imgId}" src="${defaultImg}" onclick="window.viewFullPhoto(this.src)" style="width: 40px; height: 40px; min-width: 40px; border-radius: 50%; margin-right: 12px; object-fit: cover; cursor: pointer; background-color: #222;">`;
    let buttonsHtml = '';
    if (type === "pending") {
        buttonsHtml = `<button class="menu-button lobby-button accept-btn" data-doc-id="${docId}">Accept</button><button class="menu-button lobby-button decline-btn" data-doc-id="${docId}">Decline</button>`;
    } else {
        buttonsHtml = `
            <button class="menu-button lobby-button invite-btn" data-friend-uid="${friendUid}" data-friend-name="${friendName}">Invite</button>
            <button class="menu-button lobby-button message-btn" data-friend-uid="${friendUid}" data-friend-name="${friendName}">Chat</button>
            <button class="menu-button lobby-button decline-btn" data-doc-id="${docId}">X</button>
        `;
    }

    itemDiv.innerHTML = `
        <div class="friend-info" style="flex-direction: row; align-items: center;">
            ${imageHTML}
            <div style="display: flex; flex-direction: column;">
                <span class="friend-name">${friendName}</span>
                <span class="friend-rank" style="color: ${rankInfo.color}; font-size: 0.8em;">[${rankInfo.name}]</span>
            </div>
        </div>
        <div class="friend-actions">${buttonsHtml}</div>
    `;

    listElement.appendChild(itemDiv);

    // Re-attach listeners (Invite, Chat, Accept, Decline)...
    // (Gamitin mo yung existing code mo dito para sa listeners)
    const inviteBtn = itemDiv.querySelector('.invite-btn');
    if(inviteBtn) inviteBtn.onclick = () => inviteFriend(friendUid, friendName);
    
    const msgBtn = itemDiv.querySelector('.message-btn');
    if(msgBtn) {
        monitorFriendChat(friendUid, friendName, msgBtn);
        msgBtn.onclick = () => openPrivateChat(friendUid, friendName);
    }

    const acceptBtn = itemDiv.querySelector('.accept-btn');
    if(acceptBtn) acceptBtn.onclick = () => acceptFriendRequest(docId);

    const declineBtn = itemDiv.querySelector('.decline-btn');
    if(declineBtn) declineBtn.onclick = () => declineOrUnfriend(docId);
}
// ‚ñº‚ñº‚ñº GLOBAL ONLINE STATUS SETUP ‚ñº‚ñº‚ñº
function setupOnlineStatus() {
    if (!localPlayerUid || !rtdb) return;

    // Reference sa status mo sa Realtime Database
    const myStatusRef = ref(rtdb, '/status/' + localPlayerUid);
    const isOfflineForDatabase = { state: 'offline', last_changed: Date.now() };
    const isOnlineForDatabase = { state: 'online', last_changed: Date.now() };

    // Reference sa connection ng Firebase
    const connectedRef = ref(rtdb, '.info/connected');

    onValue(connectedRef, (snapshot) => {
        if (snapshot.val() == false) {
            return;
        };

        // Kapag nadisconnect, automatic magiging 'offline'
        onDisconnect(myStatusRef).set(isOfflineForDatabase).then(() => {
            // Kapag connected, set as 'online'
            set(myStatusRef, isOnlineForDatabase);
        });
    });
}


/**
 * Nagse-search ng players sa Firebase at ipinapakita ang results. (VERSION 2 - Fixed)
 */
async function searchAndAddFriend() {
    playButtonSound();
    const searchInput = document.getElementById('friend-search-input');
    const searchResultsUI = document.getElementById('friend-search-results');
    const searchTerm = searchInput.value.trim();
    
    // 1. GAGAWIN NATING LOWERCASE ANG SEARCH TERM
    const searchTermLower = searchTerm.toLowerCase(); 

    if (searchTerm.length < 3) {
        showMessage("Please enter at least 3 letters to search.", 2000);
        return;
    }
    
    if (searchTermLower === localPlayerName.toLowerCase()) {
         searchResultsUI.innerHTML = '<div class="friend-item-empty">You cannot add yourself.</div>';
        return;
    }

    searchResultsUI.innerHTML = `<div class="friend-item-empty">Searching for "${searchTermLower}"...</div>`;

    try {
        const playersRef = collection(db, "players");
        
        // 2. HAHANAPIN NA NATIN YUNG BAGONG FIELD NA "searchableName"
        const q = query(playersRef, 
            where("searchableName", ">=", searchTermLower),
            where("searchableName", "<=", searchTermLower + '\uf8ff') 
        );

        const querySnapshot = await getDocs(q);
        
        searchResultsUI.innerHTML = ''; // Linisin ang "Searching..."

        if (querySnapshot.empty) {
            searchResultsUI.innerHTML = `<div class="friend-item-empty">No players found.</div>`;
            return;
        }

        const allMyRelations = await getDocs(query(collection(db, "friendships"), where("uids", "array-contains", localPlayerUid)));
        const existingRelations = new Map();
        allMyRelations.forEach(doc => {
            const data = doc.data();
            const friendUid = data.uids.find(uid => uid !== localPlayerUid);
            existingRelations.set(friendUid, {status: data.status, docId: doc.id}); // I-save din ang Doc ID
        });

        let resultsFound = 0;
        querySnapshot.forEach((doc) => {
            const playerData = doc.data();
            const playerUid = doc.id;

            if (playerUid === localPlayerUid) return;
            resultsFound++;
            
            const rankInfo = getPlayerRank(playerData.level || 1);
            const itemDiv = document.createElement('div');
            itemDiv.className = 'friend-item';

            let buttonHtml = '';
            const relation = existingRelations.get(playerUid);

            if (relation && relation.status === "accepted") {
                buttonHtml = `<button class="shop-buy-button equipped" disabled>Already Friends</button>`;
            } else if (relation && relation.status === "pending") {
                // I-check kung sino ang nag-request
                const requestDoc = allMyRelations.docs.find(d => d.id === relation.docId);
                const requestData = requestDoc?.data();

                if (requestData && requestData.requestedBy === localPlayerUid) {
                    buttonHtml = `<button class="shop-buy-button equipped" disabled>Request Sent</button>`;
                } else {
                    // Siya ang nag-request sa'yo, kaya pwede mong i-accept
                    buttonHtml = `<button class="menu-button lobby-button accept-btn" data-doc-id="${relation.docId}">Accept Request</button>`;
                }
            } else {
                // Wala pang relasyon
                buttonHtml = `<button class="menu-button lobby-button accept-btn" data-player-uid="${playerUid}" data-player-name="${playerData.displayName}" data-player-level="${playerData.level || 1}">Send Request</button>`;
            }

            itemDiv.innerHTML = `
                <div class="friend-info">
                    <span class="friend-name">${playerData.displayName}</span>
                    <span class="friend-rank" style="color: ${rankInfo.color};">[${rankInfo.name}]</span>
                </div>
                <div class="friend-actions">
                    ${buttonHtml}
                </div>
            `;
            searchResultsUI.appendChild(itemDiv);

            // Listener para sa "Send Request"
            const sendBtn = itemDiv.querySelector('.accept-btn[data-player-uid]');
            if (sendBtn) {
                sendBtn.addEventListener('click', (e) => {
                    const target = e.currentTarget;
                    sendFriendRequest(target.dataset.playerUid, target.dataset.playerName, target.dataset.playerLevel);
                    target.textContent = "Sent!";
                    target.disabled = true;
                });
            }
            
            // Listener para sa "Accept Request"
             const acceptBtn = itemDiv.querySelector('.accept-btn[data-doc-id]');
            if (acceptBtn) {
                acceptBtn.addEventListener('click', (e) => {
                    acceptFriendRequest(e.currentTarget.dataset.docId);
                    e.currentTarget.textContent = "Accepted!";
                    e.currentTarget.disabled = true;
                });
            }
        });

        if (resultsFound === 0) {
             searchResultsUI.innerHTML = `<div class="friend-item-empty">No players found.</div>`;
        }

    } catch (error) {
        console.error("Error searching friends:", error);
        searchResultsUI.innerHTML = `<div class="friend-item-empty">Error loading results. Check console (F12).</div>`;
        
        // IPAPAKITA KO ANG INDEXING ERROR DITO
        if (error.code === 'failed-precondition') {
             showMessage("Error: Database needs an index. Check the console (F12) for a link!", 5000);
        }
    }
}
/**
 * Gagawa ng bagong 'friendships' document na may status na "pending".
 * (Ito 'yung galing sa Step 5.B)
 */
async function sendFriendRequest(targetUid, targetName, targetLevel) {
    playButtonSound();
    
    // Tiyakin na may data bago i-send
    if (!localPlayerUid || !targetUid || !targetName) {
        showMessage("Error: Cannot send request.", 2000);
        return;
    }
    
    // I-convert ang targetLevel sa numero
    const friendLevel = parseInt(targetLevel, 10) || 1;

    try {
        // Gawa ng bagong document
        await addDoc(collection(db, "friendships"), {
            uids: [localPlayerUid, targetUid],
            requestedBy: localPlayerUid,
            requestedTo: targetUid,
            status: "pending",
            // Isama ang info ng parehong player
            names: {
                [localPlayerUid]: localPlayerName,
                [targetUid]: targetName
            },
            levels: {
                [localPlayerUid]: playerLevel,
                [targetUid]: friendLevel
            },
            createdAt: serverTimestamp()
        });

        showMessage(`Friend request sent to ${targetName}!`, 2000);
        
        // I-update ang search results UI para ipakita ang "Sent!"
        // (Handled na ito ng event listener sa searchAndAddFriend)

    } catch (error) {
        console.error("Error sending friend request:", error);
        showMessage("Error: Could not send request.", 2000);
    }
}

/**
 * Ina-update ang status ng request sa "accepted".
 * (Ito 'yung galing sa Step 6.D)
 */
async function acceptFriendRequest(docId) {
    if (!docId) return;
    playButtonSound();
    
    try {
        // Ito ang Firebase code para i-update ang status
        const friendshipDocRef = doc(db, "friendships", docId);
        await updateDoc(friendshipDocRef, { 
            status: "accepted" 
        });
        
        // Tanggalin sa "Pending" UI at i-refresh ang lists
        document.getElementById(`friend-item-${docId}`)?.remove();
        loadFriendsList(); // I-reload lahat para lumipat sa "My Friends"
        showMessage("Friend request accepted!", 2000);

    } catch (error) {
        console.error("Error accepting request:", error);
        showMessage("Error: Could not accept request.", 2000);
    }
}

/**
 * Binubura ang 'friendships' document (para sa decline o unfriend).
 * (Ito 'yung galing sa Step 6.E)
 */
async function declineOrUnfriend(docId) {
    if (!docId) return;
    playButtonSound();

    // Kumpirmahin muna
    const confirmed = confirm("Are you sure you want to remove this player?");
    if (!confirmed) {
        return; // Huwag ituloy kung na-cancel
    }

    try {
        // Ito ang Firebase code para burahin ang document
        const friendshipDocRef = doc(db, "friendships", docId);
        await deleteDoc(friendshipDocRef);
        
        // Tanggalin agad sa UI
        document.getElementById(`friend-item-${docId}`)?.remove();
        showMessage("Friend removed.", 2000);
        
        // I-check ulit kung naging empty ang lists
        loadFriendsList(); 

    } catch (error) {
        console.error("Error removing friend:", error);
        showMessage("Error: Could not remove friend.", 2000);
    }
}

/**
 * Dito magsisimula ang pag-imbita.
 * Ipinapakita nito ang "Select Game Type" modal.
 * @param {string} friendUid - Ang UID ng iimbitahin.
 * @param {string} friendName - Ang pangalan ng iimbitahin.
 */
async function inviteFriend(friendUid, friendName) {
    playButtonSound();

    // 1. I-save muna natin ang info ng friend sa global variables
    tempInviteFriendUid = friendUid;
    tempInviteFriendName = friendName;

    // 2. Ipakita ang "Select Game" modal
    document.getElementById('invite-friend-name-display').textContent = friendName;

// ‚ñº‚ñº‚ñº DAGDAG MO ITO ‚ñº‚ñº‚ñº
    selectedBetAmount = 0; // Reset to free default
    renderInviteBetButtons(); // Render buttons
    // ‚ñ≤‚ñ≤‚ñ≤ ‚ñ≤‚ñ≤‚ñ≤
    document.getElementById('invite-game-select').classList.add('show');

if (typeof tg !== 'undefined') {
        tg.BackButton.show();
    }

    history.pushState({ modal: 'inviteGameSelect' }, 'Select Game', '#invite-game');
}

async function sendInvite(selectedGameType) {
    const friendUid = tempInviteFriendUid;
    const friendName = tempInviteFriendName;

    if (!friendUid || !friendName) {
        showMessage("Error: Friend info lost.", 2000);
        return;
    }

    // ‚ñº‚ñº‚ñº CHECK BALANCE NI HOST ‚ñº‚ñº‚ñº
    if (playerTotalCurrency < selectedBetAmount) {
        showMessage(`Not enough coins! You need ${formatCurrencyShort(selectedBetAmount)}.`, 3000);
        return;
    }
    // ‚ñ≤‚ñ≤‚ñ≤ ‚ñ≤‚ñ≤‚ñ≤

    document.getElementById('invite-game-select').classList.remove('show');
    if (history.state && history.state.modal === 'inviteGameSelect') {
        history.back();
    }
    
    const modal = document.getElementById('invite-wait-modal');
    document.getElementById('invite-wait-text').textContent = `Waiting for ${friendName}...`;
    modal.classList.add('show');

    let inviteId = null;
    let unsubscribe = null;

    try {
        const newInviteRef = await addDoc(collection(db, "game_invites"), {
            fromUid: localPlayerUid,
            fromName: localPlayerName,
            toUid: friendUid,
            gameType: selectedGameType,
            status: "pending",
            
            // ‚ñº‚ñº‚ñº SAVE THE BET AMOUNT ‚ñº‚ñº‚ñº
            betAmount: selectedBetAmount,
            // ‚ñ≤‚ñ≤‚ñ≤ ‚ñ≤‚ñ≤‚ñ≤
            
            gameId: null,
            createdAt: serverTimestamp()
        });

        inviteId = newInviteRef.id;

        unsubscribe = onSnapshot(doc(db, "game_invites", inviteId), (docSnap) => {
            if (!docSnap.exists()) {
                if(unsubscribe) unsubscribe();
                modal.classList.remove('show');
                return;
            }
            const inviteData = docSnap.data();
            if (inviteData.status === "accepted") {
                if(unsubscribe) unsubscribe();
                createPrivateGame(inviteData, inviteId);
            } else if (inviteData.status === "declined") {
                if(unsubscribe) unsubscribe();
                modal.classList.remove('show');
                showMessage(`${friendName} declined.`, 2000);
            }
        });

        const closeBtn = document.getElementById('invite-wait-close-btn');
        const newCloseBtn = closeBtn.cloneNode(true);
        closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);
        
        newCloseBtn.addEventListener('click', () => {
            if(unsubscribe) unsubscribe();
            deleteDoc(doc(db, "game_invites", inviteId));
            modal.classList.remove('show');
        }, { once: true });

    } catch (error) {
        console.error("Error sending invite:", error);
        modal.classList.remove('show');
        showMessage("Error sending invite.", 3000);
    }
}


/**
 * Tatawagin kapag tinanggap ng player (Player B) ang imbitasyon.
 * @param {string} inviteId - Ang ID ng invite document.
 */
async function handleInviteAccept(inviteId, inviteData) {
    if (!inviteId) return;

    const modal = document.getElementById('invite-wait-modal');
    document.getElementById('invite-wait-text').textContent = "Joining game...";
    document.getElementById('invite-wait-close-btn').style.display = 'none'; 
    modal.classList.add('show');

    // ‚ñº‚ñº‚ñº SERVER PAYMENT (GUEST) ‚ñº‚ñº‚ñº
    const betCost = inviteData.betAmount || 0;
    
    if (betCost > 0) {
        // Tawagin ang Server para magbayad
        showMessage("Processing payment...", 1000);
        const paymentSuccess = await processBet(betCost);
        
        if (!paymentSuccess) {
            // KAPAG WALANG PERA SI GUEST o FAILED:
            modal.classList.remove('show');
            // Huwag ituloy ang pag-accept
            return; 
        }

        // Visual Feedback lang
        setTimeout(() => {
            showRewardPopup(0, `<span style="color:red; font-size: 0.8em;">PAID BET: -${formatCurrencyShort(betCost)}</span>`);
        }, 500);
    }
    // ‚ñ≤‚ñ≤‚ñ≤ ‚ñ≤‚ñ≤‚ñ≤

    let unsubscribe = null; 

    try {
        const inviteDocRef = doc(db, "game_invites", inviteId);
        
        // DITO TAYO MAG-UUPDATE NG STATUS TO 'ACCEPTED'
        // (Dahil nakabayad na siya sa taas)
        await updateDoc(inviteDocRef, { status: "accepted" });

        unsubscribe = onSnapshot(inviteDocRef, (docSnap) => {
            if (!docSnap.exists() || docSnap.data().status === "declined") {
                if(unsubscribe) unsubscribe();
                modal.classList.remove('show');
                
                // NOTE: Wala nang refund logic dito dahil Server-side na.
                // Kung na-cancel man, technically talo na yung taya sa ngayon.
                showMessage("Invite cancelled.");
                return;
            }

            const data = docSnap.data();
            
            if (data.gameId) {
                if(unsubscribe) unsubscribe(); 
                modal.classList.remove('show');
                
                localPlayerId = 'player2'; 
                gameId = data.gameId; 
                listenToGameUpdates(gameId); 
            }
        });

    } catch (error) {
        console.error("Error accepting invite:", error);
        if(unsubscribe) unsubscribe();
        modal.classList.remove('show');
        showMessage("Error: Could not accept invite.", 3000);
    }
}

async function createPrivateGame(inviteData, inviteId) {
    const friendUid = inviteData.toUid;
    const friendName = inviteData.fromName === localPlayerName ? inviteData.toName : inviteData.fromName;
    const betCost = inviteData.betAmount || 0;

    // 1. SERVER PAYMENT FIRST (Ang Bago at Tamang Paraan)
    if (betCost > 0) {
        showMessage("Processing payment...", 1000);
        
        // Tawagin ang Server Cashier
        const paymentSuccess = await processBet(betCost); 
        
        // Kapag walang pera o nag-error, HINTO AGAD.
        if (!paymentSuccess) {
            document.getElementById('invite-wait-modal').classList.remove('show');
            return; 
        }
        
        // VISUAL FEEDBACK: Pinapakita lang na nabayaran na
        setTimeout(() => {
            showRewardPopup(0, `<span style="color:red; font-size: 0.8em;">PAID BET: -${formatCurrencyShort(betCost)}</span>`);
        }, 500);
    }

    // 2. PREPARE GAME ID & MODE
    const newGameId = Math.random().toString(36).substring(2, 7).toUpperCase();
    localPlayerId = 'player1';
    gameId = newGameId;
    gameMode = `online-${inviteData.gameType}`;
    
    resizeCanvas();
    setupChips();
    
    const initialChipsToSend = chips.map(c => ({...c, x: c.x/canvas.width, y: c.y/canvas.height }));
    const startingPlayerUid = Math.random() < 0.5 ? localPlayerUid : friendUid;

    // 3. PREPARE PLAYER INFO (MY DATA)
    const myPhoto = localStorage.getItem('pinoyPoolPlayerPhoto');
    const myRankInfo = getPlayerRank(playerLevel);
    
    const myPlayerInfo = {
        uid: localPlayerUid,
        status: 'online',
        displayName: localPlayerName,
        equippedCueId: equippedItems.cue,
        rankIndex: myRankInfo.index,
        photo: myPhoto
    };

    // 4. FETCH FRIEND DATA (Opponent Data)
    let friendPlayerInfo = null;
    try {
        const friendDoc = await getDoc(doc(db, "players", friendUid));
        if (friendDoc.exists()) {
            const friendData = friendDoc.data();
            friendPlayerInfo = {
                uid: friendUid,
                status: 'online',
                displayName: friendData.displayName,
                equippedCueId: friendData.equippedCueId || 'default',
                rankIndex: getPlayerRank(friendData.trophies || 0).index,
                photo: friendData.photo || null
            };
        }
    } catch (e) { console.log("Friend data fetch error", e); }

    if (!friendPlayerInfo) {
        friendPlayerInfo = {
            uid: friendUid, 
            status: 'online', 
            displayName: (friendName || "Friend"),
            equippedCueId: 'default', 
            rankIndex: 0,
            photo: null
        };
    }

    // 5. CONSTRUCT GAME DATA
    let gameData = {
        gameId: newGameId,
        gameType: inviteData.gameType,
        gameState: 'playing',
        turnId: 1,
        
        // Pustahan Info
        betAmount: betCost,
        pot: betCost * 2, 
        
        players: {
            player1: myPlayerInfo,
            player2: friendPlayerInfo
        },
        chips: initialChipsToSend,
        currentTurnUid: startingPlayerUid,
        lastShot: null, liveAimData: null, turnInProgress: false,
        canMoveCueBall: true, isBreakShot: true, winner: null
    };

    if (inviteData.gameType === 'poker') {
        createDeck(); dealCards(); 
        Object.assign(gameData, { deck, player1Hand: playerHand, player2Hand: opponentHand, originalPlayer1Hand: originalPlayerHand, originalPlayer2Hand: originalOpponentHand });
    } else if (inviteData.gameType === 'straight-ball') {
        Object.assign(gameData, { colorsAssigned: false, player1ChipsType: null, player2ChipsType: null });
    } else if (inviteData.gameType === '61-ball') {
        Object.assign(gameData, { player1_61Score: 0, player2_61Score: 0, lowestChipNumber: 1 });
    }

    try {
        // 6. SAVE TO DATABASE
        await setDoc(doc(db, "games", newGameId), gameData);
        await updateDoc(doc(db, "game_invites", inviteId), { gameId: newGameId });
        
        // 7. SETUP UI & START GAME
        document.getElementById('invite-wait-modal').classList.remove('show');
        
        gameState = 'playing';
        isOnlineGame = true;
        showGameUI(); 
        history.pushState({ modal: 'game' }, 'Game', '#game');
        
        vsScreenShownThisGame = true; 
        
        const friendRankInfo = RANKS[friendPlayerInfo.rankIndex] || RANKS[0];
        
        const p1Data = { 
            name: localPlayerName, 
            rankInfo: myRankInfo, 
            photo: myPhoto 
        };
        const p2Data = { 
            name: friendPlayerInfo.displayName, 
            rankInfo: friendRankInfo, 
            photo: friendPlayerInfo.photo 
        };
        
        showVsScreen(p1Data, p2Data, inviteData.gameType);

        window.opponentPhotoUrl = friendPlayerInfo.photo;
        updateInfoBox(); 
        listenToGameUpdates(gameId);

    } catch (error) {
        console.error("Error creating private game:", error);
        document.getElementById('invite-wait-modal').classList.remove('show');
        showMessage("Error: Could not create game.", 3000);
        
        // NOTE: Wala nang refund logic dito dahil Server-side na.
        // Kung nag-error AFTER magbayad pero BEFORE mag-save ang game,
        // technically "talo" na yung pera.
        // (Sa future versions, pwede tayong gumawa ng /api/refund endpoint)
    }
}

function renderShopTabs() {
    const titleEl = document.querySelector('#shop-modal h2');
    // Inject Tabs HTML sa ilalim ng Title
    if (!document.getElementById('shop-tabs-container')) {
        const tabsHtml = `
            <div id="shop-tabs-container" style="display: flex; gap: 10px; justify-content: center; margin-bottom: 15px;">
                <button class="menu-button" onclick="switchShopTab('cues')" style="padding: 8px 15px; font-size: 0.9em;">Cues</button>
                <button class="menu-button" onclick="switchShopTab('frames')" style="padding: 8px 15px; font-size: 0.9em;">Frames</button>
                <button class="menu-button" onclick="switchShopTab('felts')" style="padding: 8px 15px; font-size: 0.9em;">Tables</button>
            </div>
        `;
        titleEl.insertAdjacentHTML('afterend', tabsHtml);
    }
    
    // Highlight active tab
    // (Pwede mong lagyan ng styling logic dito kung gusto mo mag-iba kulay ng active tab)
}

// Global function para sa onclick
window.switchShopTab = function(tabName) {
    playButtonSound();
    currentShopTab = tabName;
    renderShopItems();
};

function renderShopItems() {
    const container = document.getElementById('shop-items-container');
    if (!container) return;
    container.innerHTML = ''; 

    const itemsToDisplay = SHOP_ITEMS[currentShopTab]; 
    if (!itemsToDisplay) return;

    itemsToDisplay.forEach(item => {
        // 1. Check status (Owned o Equipped)
        let isOwned = playerInventory[currentShopTab].includes(item.id);
        // Hanapin ito sa loob ng renderShopItems loop:
let isEquipped = (equippedItems.cue === item.id || equippedItems.frame === item.id || equippedItems.felt === item.id);
        
        // 2. Kunin ang progress ng ads (hal. 1/3)
        let currentAds = adWatchProgress[item.id] || 0;
        let adsNeeded = item.adRequired || 0;

        let buttonHtml = '';

        if (isEquipped) {
            buttonHtml = `<button class="shop-buy-button equipped" disabled>Equipped</button>`;
        } else if (isOwned) {
            // Kung nabili na o na-unlock na via ads, "Equip" na lang ang button
            buttonHtml = `<button class="shop-buy-button equip" onclick="handleShopAction('${item.id}', '${currentShopTab}')">Equip</button>`;
        } else {
            // 3. DITO ANG MONETIZATION: Coins o Ads?
            buttonHtml = `
                <div style="display: flex; flex-direction: column; gap: 8px; width: 100%;">
                    <button class="shop-buy-button buy" onclick="handleShopAction('${item.id}', '${currentShopTab}')">
                        üí∞ ${formatCurrencyShort(item.price)}
                    </button>
                    
                    ${adsNeeded > 0 ? `
<button class="shop-buy-button" 
    style="background: linear-gradient(90deg, #FF8C00 ${(currentAds/adsNeeded)*100}%, #222 ${(currentAds/adsNeeded)*100}%); color: white; font-weight: 800; border: 2px solid #FFD700;" 
    onclick="window.watchAdForItem('${item.id}', '${currentShopTab}', ${adsNeeded})">
    üì∫ ${currentAds >= adsNeeded ? 'GET REWARD' : `WATCH (${currentAds}/${adsNeeded})`}
</button>` : ''}
                </div>
            `;
        }

        // 4. I-render ang Stats (para sa Cues)
        let statsHtml = '';
        if (currentShopTab === 'cues' && item.stats) {
            statsHtml = `
                <div class="shop-item-stats">
                    <div class="stat-entry">
                        <span class="stat-label">POW</span>
                        <div class="stat-bar-background"><div class="stat-bar-fill power" style="width: ${item.stats.Power * 10}%"></div></div>
                    </div>
                    <div class="stat-entry">
                        <span class="stat-label">AIM</span>
                        <div class="stat-bar-background"><div class="stat-bar-fill aim" style="width: ${item.stats.Aim * 10}%"></div></div>
                    </div>
                </div>
            `;
        }

        const itemDiv = document.createElement('div');
        itemDiv.className = 'shop-item';
        itemDiv.innerHTML = `
            <div class="shop-item-preview" style="background-image: url('${item.imageSrc}');"></div>
            <div class="shop-item-name">${item.name}</div>
            ${statsHtml}
            ${buttonHtml}
        `;
        container.appendChild(itemDiv);
    });
}

// Ginawa nating 'window.handleShopAction' para mabasa ng onclick sa shop HTML
window.handleShopAction = async function(itemId, category) {
    const item = SHOP_ITEMS[category].find(i => i.id === itemId);
    if (!item) return;

    let isOwned = playerInventory[category].includes(itemId);

    if (isOwned) {
        // --- EQUIP LOGIC ---
        if (category === 'cues') equippedItems.cue = itemId;
        if (category === 'frames') equippedItems.frame = itemId;
        if (category === 'felts') equippedItems.felt = itemId;
        
        saveInventory();
        applyEquippedItems(); 
        renderShopItems(); 
        showMessage(`Equipped: ${item.name}!`, 2000);
        
        // Online Sync
        if (isOnlineGame && gameId && localPlayerId && category === 'cues') {
            try {
                await updateDoc(doc(db, "games", gameId), {
                    [`players.${localPlayerId}.equippedCueId`]: itemId
                });
            } catch (error) {
                console.error("Error syncing cue change:", error);
            }
        }

    } else {
        // --- BUY LOGIC ---
        if (playerTotalCurrency >= item.price) {
            playerTotalCurrency -= item.price;
            saveCurrency();
            updateCurrencyDisplay();
            
            playerInventory[category].push(itemId);
            saveInventory();
            renderShopItems();
            showMessage(`Purchased: ${item.name}!`, 2000);
        } else {
            showMessage("Not enough coins!", 2000);
        }
    }
};

function applyEquippedItems() {
    // 1. Apply Cue to Game Stick (Yung ginagamit sa mesa)
    setCueForCurrentTurn();

    // 2. Apply Frame (Yung gilid ng mesa)
    const equippedFrame = SHOP_ITEMS.frames.find(f => f.id === equippedItems.frame);
    if (equippedFrame) {
        const frameEl = document.getElementById('table-frame');
        if (frameEl) {
            frameEl.style.backgroundImage = `url('${equippedFrame.imageSrc}')`;
        }
    }

    // 3. Apply Felt (Yung tela ng mesa)
    const equippedFelt = SHOP_ITEMS.felts.find(f => f.id === equippedItems.felt);
    if (equippedFelt) {
        tableSurfaceImage.src = equippedFelt.imageSrc;
        window.currentFeltTint = equippedFelt.tint || 'rgba(0,0,0,0)'; 
        tableSurfaceImage.onload = () => {
            drawBackgroundLayer();
        };
    }

    // ‚ñº‚ñº‚ñº 4. APPLY CUE TO POWER BAR (ITO ANG BAGONG DAGDAG) ‚ñº‚ñº‚ñº
    const powerCueImg = document.getElementById('power-cue-img');
    
    // Hanapin ang info ng kasalukuyang naka-equip na tako
    const currentCueData = SHOP_ITEMS.cues.find(c => c.id === equippedItems.cue);

    // Kung nahanap, palitan ang picture sa loob ng power bar
    if (powerCueImg && currentCueData) {
        powerCueImg.src = currentCueData.imageSrc;
    }
    // ‚ñ≤‚ñ≤‚ñ≤ HANGGANG DITO ANG DAGDAG ‚ñ≤‚ñ≤‚ñ≤
}

function setCueForCurrentTurn() {
    let isPlayerShooting = false;
    // Check kung sino ang titira
    if (gameState !== 'menu' && gameState !== 'gameover') {
        isPlayerShooting = isOnlineGame ? isMyTurnOnline : playerTurn; 
    } else {
        isPlayerShooting = true; 
    }

    let cueIdToUse;
    if (isPlayerShooting) {
        cueIdToUse = equippedItems.cue;
    } else {
        cueIdToUse = isOnlineGame ? (opponentEquippedCueId || 'default') : 'default';  
    }

    // Hanapin ang data ng cue
    const cueToDisplay = SHOP_ITEMS.cues.find(i => i.id === cueIdToUse);
    const defaultCueData = SHOP_ITEMS.cues.find(i => i.id === 'default');
    
    // Base sizes (Pang Mobile)
    const baseWidth = cueToDisplay?.displayWidth || defaultCueData?.displayWidth || 450;
    const baseHeight = cueToDisplay?.displayHeight || defaultCueData?.displayHeight || 150;

    // ‚ñº‚ñº‚ñº DITO ANG FIX PARA SA PC (AUTO-SCALE) ‚ñº‚ñº‚ñº
    
    // 1. Detect kung malaki ang screen (PC/Laptop usually > 1024px)
    const isBigScreen = window.innerWidth > 1024;
    
    // 2. Set Multiplier: 
    // Kung PC: 1.6 (Palakihin ng 60%)
    // Kung Mobile: 1.0 (Normal size)
    const scaleMultiplier = isBigScreen ? 1.6 : 1.0; 

    // 3. Compute Final Size
    const finalWidth = baseWidth * scaleMultiplier;
    const finalHeight = baseHeight * scaleMultiplier;

    // ‚ñ≤‚ñ≤‚ñ≤ END NG FIX ‚ñ≤‚ñ≤‚ñ≤

    let imageSrc = '';
    if (cueToDisplay && cueToDisplay.imageSrc) {
        imageSrc = cueToDisplay.imageSrc;
    } else if (defaultCueData && defaultCueData.imageSrc) {
        imageSrc = defaultCueData.imageSrc;
    }

    if (imageSrc) {
        cueStickElement.src = imageSrc;
        // I-apply ang bagong computed size
        cueStickElement.style.width = `${finalWidth}px`;
        cueStickElement.style.height = `${finalHeight}px`;
    } else {
        cueStickElement.src = '';
        cueStickElement.style.width = '0px';
        cueStickElement.style.height = '0px';
    }
}

let displayedCurrency = 0; 
let currencyAnimInterval = null; 

function updateCurrencyDisplay() {
    const targetAmount = playerTotalCurrency; // Kunin ang totoong pera
    
    // Hanapin ang mga display elements
    const displays = document.querySelectorAll('.coin-balance-display');
    const currencyContainer = document.getElementById('currency-display');
    const lobbyPill = document.querySelector('.coin-pill'); 

    // Kalkulahin ang diperensya (Nadagdag ba o Nabawasan?)
    const diff = targetAmount - displayedCurrency;

    // Kung walang nagbago (e.g. nag-load lang ang page), ipakita lang agad
    if (diff === 0) {
        displayedCurrency = targetAmount; // Sync
        const formatted = formatCurrencyShort(targetAmount);
        displays.forEach(display => {
            if (display) display.textContent = formatted;
        });
        return;
    }

    // 2. VISUAL EFFECTS (Pulse / Shake / Flying Coins)
    if (diff > 0) {
        // --- WIN / ADD ---
        // Tawagin ang Flying Coins (siguraduhing na-paste mo rin ang function na 'to sa baba)
        if (typeof spawnFlyingCoins === 'function') spawnFlyingCoins(); 
        
        // Green Pulse Effect
        if (currencyContainer) {
            currencyContainer.classList.remove('hud-shake-loss');
            currencyContainer.classList.add('hud-bump-win');
            setTimeout(() => currencyContainer.classList.remove('hud-bump-win'), 300);
        }
        if (lobbyPill) {
            lobbyPill.style.transform = "scale(1.2)";
            lobbyPill.style.borderColor = "#00FF00";
            setTimeout(() => { 
                lobbyPill.style.transform = "scale(1)"; 
                lobbyPill.style.borderColor = "#FFD700";
            }, 300);
        }
    } else {
        // --- LOSS / DEDUCT ---
        // Red Shake Effect
        if (currencyContainer) {
            currencyContainer.classList.remove('hud-bump-win');
            currencyContainer.classList.add('hud-shake-loss');
            setTimeout(() => currencyContainer.classList.remove('hud-shake-loss'), 400);
        }
        if (lobbyPill) {
            lobbyPill.style.transform = "translateX(-5px)";
            lobbyPill.style.borderColor = "#FF0000";
            setTimeout(() => { 
                lobbyPill.style.transform = "translateX(0)"; 
                lobbyPill.style.borderColor = "#FFD700";
            }, 300);
        }
    }

    // 3. ROLLING NUMBER ANIMATION
    if (currencyAnimInterval) clearInterval(currencyAnimInterval); // Reset kung may existing animation

    const duration = 1000; // 1 second tatakbo ang numero
    const steps = 20; // 20 frames
    const stepTime = duration / steps;
    const increment = diff / steps;
    
    let currentStep = 0;

    currencyAnimInterval = setInterval(() => {
        currentStep++;
        displayedCurrency += increment;

        // I-format at ipakita ang "gumagalaw" na numero
        // Math.floor para walang decimal habang umiikot
        const currentVal = Math.floor(displayedCurrency);
        const formatted = formatCurrencyShort(currentVal);
        
        displays.forEach(display => {
            if (display) display.textContent = formatted;
        });

        // Pag tapos na ang animation, isakto sa Final Value
        if (currentStep >= steps) {
            clearInterval(currencyAnimInterval);
            displayedCurrency = targetAmount; // Siguraduhing sakto
            
            const finalFmt = formatCurrencyShort(displayedCurrency);
            displays.forEach(display => {
                if (display) display.textContent = finalFmt;
            });
        }
    }, stepTime);
}

// Helper Function: Short Format (1.5K, 2M)
function formatCurrencyShort(num) {
    if (num < 1000) {
        return num.toString();
    } else if (num < 1000000) {
        // 1K - 999K
        return (num / 1000).toFixed(1).replace(/\.0$/, '') + 'K';
    } else if (num < 1000000000) {
        // 1M - 999M
        return (num / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
    } else {
        // 1B pataas
        return (num / 1000000000).toFixed(1).replace(/\.0$/, '') + 'B';
    }
}

function spawnFlyingCoins() {
    // 1. SMART TARGETING (Kung saan pupunta)
    let targetEl = null;
    if (gameState === 'lobby' || gameState === 'menu') {
        targetEl = document.getElementById('lobby-coin-display');
    } else {
        targetEl = document.getElementById('currency-display');
    }
    // Fallback
    if (!targetEl || targetEl.offsetParent === null) {
        targetEl = document.getElementById('lobby-coin-display') || document.getElementById('currency-display');
    }

    if (!targetEl) return;
    
    const targetRect = targetEl.getBoundingClientRect();
    const targetX = targetRect.left + (targetRect.width / 2);
    const targetY = targetRect.top + (targetRect.height / 2);
    const startX = window.innerWidth / 2;
    const startY = window.innerHeight / 2;

    const coinCount = 8; 
    
    for (let i = 0; i < coinCount; i++) {
        setTimeout(() => {
            // ‚ñº‚ñº‚ñº DITO NATIN NILIPAT (TUNOG AGAD!) ‚ñº‚ñº‚ñº
            // Tutunog na siya habang lumilikha pa lang ng barya
            if (typeof playCoinSound === 'function') playCoinSound(); 
            // ‚ñ≤‚ñ≤‚ñ≤ ‚ñ≤‚ñ≤‚ñ≤

            const coin = document.createElement('div');
            coin.textContent = 'ü™ô'; 
            coin.className = 'flying-coin-particle';
            coin.style.left = `${startX}px`;
            coin.style.top = `${startY}px`;
            coin.style.zIndex = "9999"; 

            document.body.appendChild(coin);

            // Trigger Animation
            requestAnimationFrame(() => {
                coin.style.transform = `translate(${targetX - startX}px, ${targetY - startY}px) scale(0.5)`;
                coin.style.opacity = '0'; 
            });

            // Clean up (Alisin na lang, wala nang sound dito)
            setTimeout(() => {
                coin.remove();
            }, 800);

        }, i * 100); // Sunod-sunod na interval
    }
}
function showRewardPopup(amount, reason = "") {
    // Ito 'yung maliit na popup na "+10 Coins!"
    const popup = document.createElement('div');
    let text = `+${amount} ${CURRENCY_NAME}!`;
    if (reason) {
        text = `${reason}<br>+${amount} ${CURRENCY_NAME}!`;
    }
    popup.innerHTML = text; // Gumamit ng .innerHTML para sa <br>
    
    popup.style.cssText = `
        position: absolute;
        left: 10px;
        top: 40px; /* Sa ilalim ng main currency display */
        color: #00FF00; /* Bright green */
        font-size: 1.2em;
        font-weight: bold;
        font-family: 'Luckiest Guy', cursive;
        text-shadow: 1px 1px 3px rgba(0,0,0,0.8);
        z-index: 210;
        opacity: 1;
        transition: opacity 1.5s ease-out, transform 1.5s ease-out;
        transform: translateY(0);
        pointer-events: none;
        text-align: center;
        padding: 5px 10px;
        background: rgba(0,0,0,0.5);
        border-radius: 5px;
    `;
    document.getElementById('non-interactive-overlay').appendChild(popup);
    
    setTimeout(() => {
        popup.style.opacity = '0';
        popup.style.transform = 'translateY(-30px)';
    }, 100); // Simulan ang animation
    
    setTimeout(() => {
        popup.remove();
    }, 1600); // Alisin sa DOM
}


/**
 * Nagpapakita ng animated popup para sa color assignment (gaya ng coin reward).
 * @param {string} message - Ang text na ipapakita (e.g., "You got RED!")
 * @param {string} color - Ang kulay ('red' o 'blue') para sa text.
 */
function showColorAssignmentPopup(message, color) {
    const popup = document.createElement('div');
    popup.innerHTML = message;
    
    // Itatakda natin ang kulay ng text base sa kulay ng bola
    let popupColor = '#FFFFFF'; // Default
    if (color.toLowerCase() === 'red') {
        popupColor = '#ff6b6b'; // Vibrant Red (gaya ng sa info box)
    } else if (color.toLowerCase() === 'blue') {
        popupColor = '#54a0ff'; // Vibrant Blue (gaya ng sa info box)
    }

    // Kinopya natin ang style ng coin popup pero in-adjust ang pwesto at kulay
    popup.style.cssText = `
        position: absolute;
        left: 50%; /* Igigitna natin */
        top: 70px;  /* Sa ilalim ng main message box */
        transform: translateX(-50%) translateY(0); /* Simula sa pwesto */
        color: ${popupColor}; /* Gagamitin ang kulay (red/blue) */
        font-size: 1.4em; /* Medyo mas malaki */
        font-weight: bold;
        font-family: 'Luckiest Guy', cursive;
        text-shadow: 1px 1px 3px rgba(0,0,0,0.8);
        z-index: 210;
        opacity: 1;
        transition: opacity 1.5s ease-out, transform 1.5s ease-out; /* Parehong transition */
        pointer-events: none;
        text-align: center;
        padding: 5px 10px;
        background: rgba(0,0,0,0.5);
        border-radius: 5px;
        border: 1px solid ${popupColor}; /* Lagyan natin ng border na may kulay */
    `;
    // Ilalagay natin sa #non-interactive-overlay para laging nasa ibabaw
    document.getElementById('non-interactive-overlay').appendChild(popup);
    
    // Ito 'yung animation logic na ginaya sa coin popup (pa-fade pataas)
    setTimeout(() => {
        popup.style.opacity = '0';
        popup.style.transform = 'translateX(-50%) translateY(-30px)'; // Aakyat habang nawawala
    }, 2500); // Simulan ang animation
    
    setTimeout(() => {
        popup.remove();
    }, 4000); // Mananatili ng 2.5 segundo
}
// ‚ñ≤‚ñ≤‚ñ≤ HANGGANG DITO ANG BAGONG FUNCTION ‚ñ≤‚ñ≤‚ñ≤
     function signInPlayer() { 
    onAuthStateChanged(auth, (user) => { 
        if (user) { 
            // Gawin nating 'window' property para mabasa ng Adsgram
            window.localPlayerUid = user.uid; 
            
            // I-assign din ang 'db' sa window para sa wallet function
            window.db = db; 

            isAuthReady = true; 
            onlineButton.disabled = false;
        
        // --- 1. Load Currency ---
        if (typeof loadCurrency === 'function') {
            loadCurrency(); 
        }

        // --- 2. üëá DAGDAG: CHECK PENDING WALLET üëá ---
        // I-check kung may naka-store na wallet address sa localStorage
        const pendingWallet = localStorage.getItem('pendingWalletAddress');
        if (pendingWallet) {
            console.log("Saving pending wallet for logged-in user...");
            // Siguraduhin na ang saveWalletToFirestore function ay defined sa script mo
            if (typeof saveWalletToFirestore === 'function') {
                saveWalletToFirestore(localPlayerUid, pendingWallet);
            }
        }
        // ----------------------------------------------
        
        // Update UI (Subtitle lang)
        const sub = document.querySelector('#online-button .card-subtitle');
        if(sub) {
            sub.textContent = "Ranked Match ‚Ä¢ Online";
            sub.style.color = "#00FF00"; 
        }

        createPlayerDocument(); 
        startInviteListener(); 
        setupOnlineStatus(); 
    } else { 
        signInAnonymously(auth).catch((error) => { 
            console.error("Sign-in failed:", error); 
            isAuthReady = false; 
            onlineButton.disabled = true; 
        }); 
    } 
}); 
}
// Dito ise-save ang "unsubscribe" function para sa invite listener
let unsubscribeFromInvites = null;

/**
 * Nagsisimulang makinig sa 'game_invites' collection para sa mga
 * imbitasyon na para sa kasalukuyang player (localPlayerUid).
 */
function startInviteListener() {
    // Tiyakin na may UID at database
    if (!localPlayerUid || !db) return;

    // Itigil ang lumang listener kung meron man
    if (unsubscribeFromInvites) {
        unsubscribeFromInvites();
    }

    // Gumawa ng query: Hanapin ang lahat ng 'game_invites' na:
    // 1. Para sa akin (toUid == localPlayerUid)
    // 2. "pending" pa ang status
    const invitesQuery = query(collection(db, "game_invites"),
        where("toUid", "==", localPlayerUid),
        where("status", "==", "pending")
    );

    // Ito ang real-time listener
    unsubscribeFromInvites = onSnapshot(invitesQuery, (snapshot) => {
        snapshot.docChanges().forEach((change) => {
            // Interesado lang tayo sa mga BAGONG invite
            if (change.type === "added") {
                const inviteData = change.doc.data();
                const inviteId = change.doc.id;
                
                // Kunin ang game type at gawing maganda ang format (e.g. "poker" -> "Poker")
                const gameType = (inviteData.gameType || "pool").charAt(0).toUpperCase() + (inviteData.gameType || "pool").slice(1);
                
                // ‚ñº‚ñº‚ñº DITO ANG PAGBABAGO ‚ñº‚ñº‚ñº
                // Ipinasa natin ang 'inviteData' bilang pang-apat na parameter.
                // Dati: showInvitePopup(inviteData.fromName, gameType, inviteId);
                // Ngayon:
                showInvitePopup(inviteData.fromName, gameType, inviteId, inviteData);
                // ‚ñ≤‚ñ≤‚ñ≤ ‚ñ≤‚ñ≤‚ñ≤
            }
        });
    });
}
function showInvitePopup(fromName, gameType, inviteId, inviteData) { // Note: Added inviteData param if possible, or fetch it inside
    // Mabilisang fix: Kunin natin ang inviteData sa listener mismo
    // Sa startInviteListener, ipasa mo ang 'inviteData' sa function call:
    // showInvitePopup(inviteData.fromName, gameType, inviteId, inviteData);
    
    if (gameState !== 'lobby') return; 

    const modal = document.getElementById('invite-popup-modal');
    const title = document.getElementById('invite-popup-title');
    const text = document.getElementById('invite-popup-text');
    const acceptBtn = document.getElementById('invite-accept-btn');
    const declineBtn = document.getElementById('invite-decline-btn');

    // ‚ñº‚ñº‚ñº DISPLAY BET AMOUNT ‚ñº‚ñº‚ñº
    // Kung hindi naipasa ang inviteData (sa lumang listener), magiging undefined.
    // So kailangan mong i-update ang startInviteListener (see below).
    let betText = "";
    if (inviteData && inviteData.betAmount > 0) {
        betText = `<br><span style="color:#FFD700; font-size: 1.1em;">BET: ${formatCurrencyShort(inviteData.betAmount)} Coins</span>`;
    } else {
        betText = `<br><span style="color:#00FF00; font-size: 0.9em;">Free Play</span>`;
    }

    title.textContent = `${gameType} Invite!`;
    text.innerHTML = `<strong style="color:var(--gold-accent)">${fromName}</strong> is inviting you!${betText}`;
    // ‚ñ≤‚ñ≤‚ñ≤ ‚ñ≤‚ñ≤‚ñ≤

    const newAcceptBtn = acceptBtn.cloneNode(true);
    acceptBtn.parentNode.replaceChild(newAcceptBtn, acceptBtn);
    newAcceptBtn.textContent = "Accept";
    newAcceptBtn.disabled = false;
    
    const newDeclineBtn = declineBtn.cloneNode(true);
    declineBtn.parentNode.replaceChild(newDeclineBtn, declineBtn);
    newDeclineBtn.textContent = "Decline";
    newDeclineBtn.disabled = false;

    newAcceptBtn.addEventListener('click', () => {
        playButtonSound();
        
        // ‚ñº‚ñº‚ñº CHECK GUEST BALANCE ‚ñº‚ñº‚ñº
        if (inviteData && inviteData.betAmount > 0) {
            if (playerTotalCurrency < inviteData.betAmount) {
                showMessage(`Cannot accept! You need ${formatCurrencyShort(inviteData.betAmount)} coins.`, 3000);
                return;
            }
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ‚ñ≤‚ñ≤‚ñ≤
        
        modal.classList.remove('show'); 
        handleInviteAccept(inviteId, inviteData); // Pass inviteData
    }, { once: true });

    newDeclineBtn.addEventListener('click', () => {
        playButtonSound();
        modal.classList.remove('show');
        handleInviteDecline(inviteId);
    }, { once: true });

    modal.classList.add('show');
}

/**
 * Tinitingnan kung may player document na, kung wala, gagawa ng bago.
 * Ito ang titiyak na lahat ng player ay may 'searchableName' agad.
 */
async function createPlayerDocument() {
    // Siguraduhin na may UID, database, AT pangalan na bago sumubok magsulat
    if (!localPlayerUid || !db || !localPlayerName || localPlayerName === "Guest") {
        // Kung wala pa ang isa sa mga 'to, huwag munang ituloy.
        // Tatawagin ulit 'to mamaya kapag kumpleto na.
        console.log("Waiting for UID and Name before creating player document...");
        return; 
    }

    const playerDocRef = doc(db, "players", localPlayerUid);

    try {
        const playerDoc = await getDoc(playerDocRef);

        if (!playerDoc.exists()) {
            // --- BAGO PA LANG ANG PLAYER ---
            // Gagawa tayo ng bagong document para sa kanila
            console.log("Creating new player document for:", localPlayerName);
            await setDoc(playerDocRef, {
                displayName: localPlayerName,
                searchableName: localPlayerName.toLowerCase(), // ETO NA YUN!
                wins: 0,
                level: 1, // Kunin natin sa global variable
                xp: 0,    // Kunin natin sa global variable
                equippedCueId: 'default',
                lastPlayed: serverTimestamp()
            });
        } else {
            // --- BUMALIK NA PLAYER ---
            // I-update lang natin ang pangalan at searchableName
            // para kung nag-iba man, updated pa rin.
            console.log("Player document exists. Updating name...");
            await updateDoc(playerDocRef, {
                displayName: localPlayerName,
                searchableName: localPlayerName.toLowerCase() // ETO NA YUN!
            });
        }
    } catch (error) {
        console.error("Error creating or updating player document:", error);
    }
}

async function createOnlineGame() {
    const displayName = localPlayerName || "Guest";
    if (!isAuthReady || !localPlayerUid) { showMessage("Connecting to server..."); return; }

    // 1. CHECK BALANCE
    if (playerTotalCurrency < selectedBetAmount) {
        showMessage(`Kulang ang coins mo! Need: ${formatCurrencyShort(selectedBetAmount)}`, 3000);
        return;
    }

    onlineMenu.classList.remove('show');
    resizeCanvas();
    setupChips();

    // 2. Generate ID
    gameId = Math.random().toString(36).substring(2, 7).toUpperCase();
    localPlayerId = 'player1';
    gameMode = `online-${selectedOnlineGameType}`;
    
    // Bawas Pera
    if (selectedBetAmount > 0) {
        playerTotalCurrency -= selectedBetAmount;
        currentMatchBet = selectedBetAmount;
        saveCurrency();
        updateCurrencyDisplay();
    }
    
    // Prepare Data
    const initialChips = chips.map(c => ({...c, x: c.x/canvas.width, y: c.y/canvas.height }));
    const myCue = equippedItems.cue || 'default';
    const myRank = getPlayerRank(playerLevel).index;

    // ‚ñº‚ñº‚ñº FIX: KUNIN ANG PHOTO MULA SA STORAGE ‚ñº‚ñº‚ñº
    const myPhoto = localStorage.getItem('pinoyPoolPlayerPhoto'); 
    // ‚ñ≤‚ñ≤‚ñ≤ ‚ñ≤‚ñ≤‚ñ≤

    const gameData = { 
        gameId: gameId,
        gameType: selectedOnlineGameType, 
        gameState: 'waiting', 
        
        betAmount: selectedBetAmount, 
        pot: selectedBetAmount * 2,

        turnId: 0, 
        players: { 
            player1: { 
                uid: localPlayerUid, 
                status: 'online', 
                displayName: displayName, 
                equippedCueId: myCue, 
                rankIndex: myRank,
                photo: myPhoto // <--- NGAYON OKAY NA ITO KASI DEFINED NA SA TAAS
            }, 
            player2: null 
        }, 
        chips: initialChips, 
        currentTurnUid: null, 
        canMoveCueBall: true, 
        isBreakShot: true,
        lastShot: null,
        winner: null
    };

    // Game Modes Logic
    if (selectedOnlineGameType === 'poker') {
        createDeck(); dealCards();
        Object.assign(gameData, { deck, player1Hand: playerHand, player2Hand: opponentHand, originalPlayer1Hand: originalPlayerHand, originalPlayer2Hand: originalOpponentHand });
    } else if (selectedOnlineGameType === 'straight-ball') {
        Object.assign(gameData, { colorsAssigned: false, player1ChipsType: null, player2ChipsType: null });
    } else if (selectedOnlineGameType === '61-ball') {
        Object.assign(gameData, { player1_61Score: 0, player2_61Score: 0, lowestChipNumber: 1 });
    }

    try {
        await setDoc(doc(db, "games", gameId), gameData);
        
        gameIdDisplay.textContent = gameId;
        
        const waitTitle = document.querySelector('#waiting-room h2');
        if(selectedBetAmount > 0) {
            waitTitle.innerHTML = `Waiting for Opponent...<br><span style="color:#FFD700; font-size:0.6em;">Bet: ${formatCurrencyShort(selectedBetAmount)}</span>`;
        } else {
            waitTitle.textContent = "Waiting for Opponent...";
        }

        waitingRoom.classList.add('show');
        history.pushState({ modal: 'waitingRoom' }, 'Waiting Room', '#wait');
        
        listenToGameUpdates(gameId);
        showMessage("Game Created! Share ID: " + gameId, 3000);

    } catch (error) {
        console.error("Create Error:", error);
        if (selectedBetAmount > 0) {
            playerTotalCurrency += selectedBetAmount;
            saveCurrency();
            updateCurrencyDisplay();
        }
        showMessage("Error creating game. Check internet.", 3000);
        onlineMenu.classList.add('show');
    }
}
async function cancelOnlineGame() { 
    if (gameId) { 
        try { 
            // Kunin muna ang bet amount bago burahin gamit ang local variable
            // REFUND HOST
            if (localPlayerId === 'player1' && selectedBetAmount > 0) {
                playerTotalCurrency += selectedBetAmount;
                saveCurrency();
                updateCurrencyDisplay();
                showMessage(`Game Cancelled. ${formatCurrencyShort(selectedBetAmount)} refunded.`);
            } else {
                showMessage("Game Cancelled.");
            }

            await deleteDoc(doc(db, "games", gameId)); 
            gameId = null; 
        } catch (e) { 
            console.error("Error cancelling", e); 
        } 
    } 
    resetToMenu(); 
}
// ‚ñ≤‚ñ≤‚ñ≤ END PASTE ‚ñ≤‚ñ≤‚ñ≤

async function joinOnlineGame() {
    const displayName = localPlayerName || "Guest";
    
    if (!isAuthReady || !localPlayerUid) { 
        showMessage("Connecting..."); 
        return; 
    }
    
    const inputId = gameIdInput.value.trim().toUpperCase();
    if (!inputId) { 
        showMessage("Enter Game ID first."); 
        return; 
    }

    showMessage("Checking game details...");

    const gameDocRef = doc(db, "games", inputId);

    try {
        const docSnap = await getDoc(gameDocRef);
        
        if (!docSnap.exists()) {
            showMessage("Game ID not found.", 3000);
            return;
        }
        
        const data = docSnap.data();
        
        if (data.gameState !== 'waiting') {
            showMessage("Game is already full/started.", 3000);
            return;
        }

        const requiredBet = data.betAmount || 0; 
        
        if (playerTotalCurrency < requiredBet) {
            showMessage(`Can't join! Bet is ${formatCurrencyShort(requiredBet)}. You only have ${formatCurrencyShort(playerTotalCurrency)}.`, 4000);
            return; 
        }

        if (requiredBet > 0) {
            playerTotalCurrency -= requiredBet;
            saveCurrency(); 
            updateCurrencyDisplay(); 
            console.log(`Paid ${requiredBet} coins.`);
        }

        const myCue = equippedItems.cue || 'default';
        const myRank = getPlayerRank(playerLevel).index;
        const startingPlayerUid = Math.random() < 0.5 ? data.players.player1.uid : localPlayerUid;

        // ‚ñº‚ñº‚ñº FIX: KUNIN ANG PHOTO MULA SA STORAGE ‚ñº‚ñº‚ñº
        const myPhoto = localStorage.getItem('pinoyPoolPlayerPhoto');
        // ‚ñ≤‚ñ≤‚ñ≤ ‚ñ≤‚ñ≤‚ñ≤

        await updateDoc(gameDocRef, {
            'players.player2': {
                uid: localPlayerUid,
                status: 'online',
                displayName: displayName,
                equippedCueId: myCue,
                rankIndex: myRank,
                photo: myPhoto // <--- NGAYON OKAY NA ITO
            },
            'gameState': 'playing',
            'currentTurnUid': startingPlayerUid,
            'turnId': 1
        });

        onlineMenu.classList.remove('show');
        gameId = inputId;
        localPlayerId = 'player2';
        gameMode = `online-${data.gameType}`;
        
        resizeCanvas();
        setupChips();
        
        listenToGameUpdates(gameId);
        
        if (requiredBet > 0) {
            showMessage(`Joined! You paid ${formatCurrencyShort(requiredBet)}.`, 3000);
        } else {
            showMessage("Joined successfully!", 2000);
        }

    } catch (error) {
        console.error("Join Error:", error);
        
        if (docSnap && docSnap.exists()) { 
             const data = docSnap.data();
             const requiredBet = data.betAmount || 0;
             if (requiredBet > 0) {
                 playerTotalCurrency += requiredBet;
                 saveCurrency();
                 updateCurrencyDisplay();
             }
        }
        
        showMessage("Failed to join: " + error.message, 3000);
    }
}

        
        async function resetOnlineGameForRematch(gameData) { 
    // Tanggalin ang unsubscribe dito, kasi HINDI natin papatayin ang listener
    // if (unsubscribeGameListener) unsubscribeGameListener(); <--- WAG MO ITO GAWIN
    
    gameMode = `online-${gameData.gameType}`; 
    resizeCanvas(); 
    setupChips(); 
    
    const newChipsState = chips.map(c => ({...c, x: c.x / canvas.width, y: c.y / canvas.height })); 
    const startingPlayerUid = Math.random() < 0.5 ? gameData.players.player1.uid : gameData.players.player2.uid; 
    
    const resetData = { 
        gameState: 'playing', 
        chips: newChipsState, 
        currentTurnUid: startingPlayerUid, 
        canMoveCueBall: true, 
        isBreakShot: true, 
        winner: null, 
        rematchRequest: null, 
        turnId: (gameData.turnId || 0) + 10, 
        lastShot: null 
    }; 
    
    if (gameData.gameType === 'poker') { 
        createDeck(); 
        dealCards(); 
        Object.assign(resetData, { 
            deck, 
            player1Hand: localPlayerId === 'player1' ? playerHand : opponentHand, 
            player2Hand: localPlayerId === 'player1' ? opponentHand : playerHand, 
            originalPlayer1Hand: localPlayerId === 'player1' ? originalPlayerHand : originalOpponentHand, 
            originalPlayer2Hand: localPlayerId === 'player1' ? originalOpponentHand : originalPlayerHand, 
        }); 
    } else if (gameData.gameType === '61-ball') { 
        Object.assign(resetData, { player1_61Score: 0, player2_61Score: 0, lowestChipNumber: 1 }); 
    } else if (gameData.gameType === 'straight-ball') { 
        Object.assign(resetData, { colorsAssigned: false, player1ChipsType: null, player2ChipsType: null }); 
    } 
    
    try { 
        await updateDoc(doc(db, "games", gameId), resetData); 
        console.log("Game reset successfully for rematch.");
    } catch (error) { 
        console.error("Failed to reset game for rematch:", error); 
    } 
    // DITO ANG FIX: TINANGGAL KO YUNG 'finally { listenToGameUpdates... }' 
    // Kasi active pa ang listener, hindi kailangan ulitin.
}
        function sendLiveAimData() {
    // 1. Safety Checks (Wag galawin - ito yung dati)
    if (!isOnlineGame || !isMyTurnOnline || !gameId || table.width === 0) return;

    // Throttling (Para hindi bawat millisecond ay nagpapadala)
    const now = Date.now();
    if (now - lastAimUpdateTime < AIM_UPDATE_INTERVAL) return;
    lastAimUpdateTime = now;

    const cueChip = chips.find(c => c.id === 0);
    if (!cueChip) return;

    // 2. Ihanda ang Data (Wag galawin - ito yung dati)
    const dataToSend = {
        angle: cueStick.angle,
        cueBallX: cueChip.x / canvas.width,
        cueBallY: cueChip.y / canvas.height,
        pektusX: pektusOffset.x,
        pektusY: pektusOffset.y,
        pullback: cueStick.pullback, // Sinama natin ang hatak
        sender: localPlayerUid
    };

    // 3. PADALAHIN SA RTDB (Ito ang Bago!)
    // Dati: updateDoc(...)
    // Ngayon: Gagamit na tayo ng 'set' sa RTDB path na 'gameData/GAME_ID/liveAim'
    
    // Gumawa ng reference (address) kung saan ise-save
    const aimRef = ref(rtdb, `gameData/${gameId}/liveAim`);
    
    // I-save ang data
    set(aimRef, dataToSend).catch((err) => {
        console.warn("Aim sync error:", err);
    });
}
// Variable para pwede nating patayin ang listener pagtapos ng game
let unsubscribeAimListener = null; 

function listenToRealtimeAiming(gameId) {
    // 1. Patayin muna ang lumang listener kung meron man (Para iwas doble)
    if (unsubscribeAimListener) {
        unsubscribeAimListener(); 
        unsubscribeAimListener = null; 
    }

    // 2. Ituro kung saan makikinig (Sa parehong address na pinadalhan natin sa Step 1)
    const aimRef = ref(rtdb, `gameData/${gameId}/liveAim`);

    // 3. Simulan ang pakikinig (onValue = bawat pagbabago, basahin agad)
    unsubscribeAimListener = onValue(aimRef, (snapshot) => {
        const liveAim = snapshot.val();

        // Safety Check: Kung walang laman o IKAW ang nagpadala, wag pansinin
        if (!liveAim || liveAim.sender === localPlayerUid) return;

        // Kung turn mo, wag mong pansinin ang galaw ng kalaban (iwas glitch)
        if (isMyTurnOnline) return;

        // --- DITO NA GAGALAW ANG TAKO NG KALABAN SA SCREEN MO ---
        
        // Ipakita ang tako
        cueStick.visible = true;
        if (cueStickElement) cueStickElement.style.display = 'block';

        // Gayahin ang Angle at Hatak
        cueStick.angle = liveAim.angle;
        cueStick.pullback = liveAim.pullback || 0;

        // Gayahin ang Pektus (Red Dot)
        pektusOffset.x = liveAim.pektusX || 0;
        pektusOffset.y = liveAim.pektusY || 0;
        updatePektusUI(); // Update mo yung red dot sa screen

        // Gayahin ang pwesto ng Cue Ball (Kung Ball-in-hand sila)
        if (canMoveCueBall) {
            const cueChip = chips.find(c => c.id === 0);
            if (cueChip) {
                cueChip.x = liveAim.cueBallX * canvas.width;
                cueChip.y = liveAim.cueBallY * canvas.height;
            }
        }
    });
}

function listenToGameUpdates(gameId) { 
    let lastShotTimestamp = 0; 
    let previousGameState = null; 

    // 1. Setup listeners para sa Chat at Galaw ng Tako
    setupChatListener(gameId);
    listenToRealtimeAiming(gameId);
    
    // 2. PRESENCE SYSTEM (Online/Offline Status)
    // FIX: Nagdagdag ako ng "&& gameId" para siguradong hindi mag-error ang database
    if (rtdb && localPlayerUid && gameId) {
        const connectionRef = ref(rtdb, '.info/connected');
        const playerStatusRef = ref(rtdb, `gameStatus/${gameId}/${localPlayerUid}`);
        const firestoreGameDocRef = doc(db, "games", gameId);
        
        onValue(connectionRef, (snap) => {
            if (snap.val() === true) {
                // Set Online sa Realtime DB
                set(playerStatusRef, { online: true, lastSeen: Date.now() });
                onDisconnect(playerStatusRef).set({ online: false, lastSeen: Date.now() });
                
                // Set Online sa Firestore
                updateDoc(firestoreGameDocRef, { [`players.${localPlayerId}.status`]: 'online' }).catch(e=>{});
                onDisconnect(firestoreGameDocRef).update({ [`players.${localPlayerId}.status`]: 'disconnected' }).catch(e=>{});
            }
        }, { onlyOnce: true });
    }

    // 3. GAME UPDATE LISTENER (Main Loop)
    unsubscribeGameListener = onSnapshot(doc(db, "games", gameId), (doc) => { 
        if (!doc.exists()) { 
            if (gameState !== 'menu' && gameState !== 'gameover') { 
                showMessage("Game ended by host.", 3000); 
                resetToMenu(); 
            } 
            return; 
        } 
        
        const gameData = doc.data(); 
        if (!gameData) return; 

        // ‚ñº‚ñº‚ñº FIX: FORCE CLOSE WAITING ROOM ‚ñº‚ñº‚ñº
        // Kung nag-start na ang laro sa database pero nakabukas pa ang waiting room sa screen mo
        const waitingModal = document.getElementById('waiting-room');
        if (gameData.gameState === 'playing' && waitingModal && waitingModal.classList.contains('show')) {
            console.log("Force closing Waiting Room...");
            waitingModal.classList.remove('show'); 
            showMessage("Game Starting...", 1500);
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ‚ñ≤‚ñ≤‚ñ≤

        // --- REMATCH FEE DEDUCTION LOGIC ---
        // Kung galing sa "Finished" at naging "Playing" ulit (Rematch)
        if (previousGameState === 'finished' && gameData.gameState === 'playing') {
            const rawBet = gameData.betAmount || currentMatchBet || 0;
            const betToDeduct = parseInt(rawBet, 10);
            
            if (betToDeduct > 0) {
                // Bawas ulit para sa rematch
                let currentMoney = parseInt(playerTotalCurrency, 10);
                playerTotalCurrency = currentMoney - betToDeduct;
                currentMatchBet = betToDeduct;
                
                saveCurrency();
                updateCurrencyDisplay();
                
                setTimeout(() => {
                    showRewardPopup(0, `<span style="color:red; font-size: 0.8em;">REMATCH FEE: -${formatCurrencyShort(betToDeduct)}</span>`);
                }, 1000);
            }
            winnerModal.classList.remove('show');
        }
        previousGameState = gameData.gameState; 

        // --- SHOT ANIMATION SYNC ---
        // Kung may bagong tira ang kalaban
        if (gameData.lastShot && gameData.lastShot.timestamp > lastShotTimestamp && !chipsMoving) { 
            lastShotTimestamp = gameData.lastShot.timestamp; 
            animateAndApplyShot(gameData.lastShot); 
        } 
        
        // --- GAME OVER / REMATCH REQUESTS ---
        if (gameData.gameState === 'finished' && gameData.rematchRequest) { 
            const players = Object.keys(gameData.players).filter(p => gameData.players[p] !== null); 
            if (players.length === 2) { 
                const playerUIDs = players.map(p => gameData.players[p].uid); 
                const player1_uid = playerUIDs[0]; 
                const player2_uid = playerUIDs[1]; 
                
                const iWantRematch = gameData.rematchRequest[localPlayerUid]; 
                const opponentUid = localPlayerUid === player1_uid ? player2_uid : player1_uid; 
                const opponentWantsRematch = gameData.rematchRequest[opponentUid]; 
                
                const rematchButton = document.getElementById('rematch-button'); 
                
                if (iWantRematch && opponentWantsRematch) { 
                    if (localPlayerId === 'player1') { 
                        resetOnlineGameForRematch(gameData); 
                    } 
                } else if (opponentWantsRematch && !iWantRematch) { 
                    rematchButton.textContent = 'Accept Rematch'; 
                    if (gameData.betAmount > 0) {
                         rematchButton.innerHTML = `Accept Rematch <span style="color:#FFD700">(${formatCurrencyShort(gameData.betAmount)})</span>`;
                    }
                } 
            } 
        } 
        
        // --- MAIN SYNC FUNCTION ---
        syncGameState(gameData); 

        // --- MANUAL TURN HANDLING ---
        // Ito ang nag-aayos ng pwesto ng bola kung sakaling na-late ang sync
        if (gameData.turnId > lastProcessedTurnId) {
             lastProcessedTurnId = gameData.turnId;
             
             // Update chips positions (teleport correction)
             if (gameData.chips && canvas.width > 0) {
                 chips = gameData.chips.map(remoteChip => ({ ...remoteChip,
                     x: remoteChip.x * canvas.width,
                     y: remoteChip.y * canvas.height,
                     radius: (remoteChip.id === 0 ? CUE_BALL_RADIUS : BALL_RADIUS) * scale
                 }));
             }
             
             // Sync variables
             canMoveCueBall = gameData.canMoveCueBall;
             isBreakShot = gameData.isBreakShot;
             
             // Update UI
             updateCardDisplay();
             updateInfoBox(); // Update HUD Glow

             // Ipakita ang Drag Guide kung Ball-in-Hand
             if (isMyTurnOnline && canMoveCueBall) {
                 dragGuideText.style.display = 'block';
             } else {
                 dragGuideText.style.display = 'none';
             }
             
             // Reset Pektus pagkatapos ng tira ng kalaban
             if (isMyTurnOnline && !canMoveCueBall && gameState !== 'aiming') {
                 resetPektus();
             }
        }
    }); 
}
        async function leaveOnlineGame(isForfeit) { if (!isOnlineGame || !gameId || !localPlayerId) return; const gameDocRef = doc(db, "games", gameId); try { const docSnap = await getDoc(gameDocRef); if (docSnap.exists() && docSnap.data().gameState !== 'finished') { const opponentId = localPlayerId === 'player1' ? 'player2' : 'player1'; const winnerUid = docSnap.data().players[opponentId]?.uid; if (isForfeit && winnerUid) { await updateDoc(gameDocRef, { gameState: 'finished', winner: winnerUid, [`players.${localPlayerId}.status`]: 'disconnected' }); } else { await updateDoc(gameDocRef, { [`players.${localPlayerId}.status`]: 'disconnected' }); } } } catch (error) { console.error("Error leaving/forfeiting game:", error); } }
        function isPathObstructed(startObj, endObj, ignoreChipIds = []) { const allObstacles = chips.filter(c => c.inPlay && !ignoreChipIds.includes(c.id)); for (const obstacle of allObstacles) { const dist = Math.abs((endObj.y - startObj.y) * obstacle.x - (endObj.x - startObj.x) * obstacle.y + endObj.x * startObj.y - endObj.y * startObj.x) / Math.hypot(endObj.y - startObj.y, endObj.x - startObj.x); const safetyMargin = 4 * scale; const effectiveRadius = obstacle.radius + (startObj.radius || 0) + safetyMargin; if (dist < effectiveRadius) { const dotProduct = (obstacle.x - startObj.x) * (endObj.x - startObj.x) + (obstacle.y - startObj.y) * (endObj.y - startObj.y); const squaredLength = Math.pow(Math.hypot(endObj.x - startObj.x, endObj.y - startObj.y), 2); if (dotProduct > 0 && dotProduct < squaredLength) { return true; } } } return false; }
        function isAnyDirectPathClear(cueChip, legalTargets) { if (!legalTargets || legalTargets.length === 0) return false; for (const target of legalTargets) { if (!isPathObstructed(cueChip, target, [])) return true; } return false; }
        function evaluateShot(cueChip, targetChip, hole, allLegalTargets, difficulty, isCombination = false) {
    let firstContactTarget = isCombination ? allLegalTargets[0] : targetChip;
    if (!firstContactTarget) return null;

    // --- OBSTRUCTION CHECK ---
    const path1Clear = !isPathObstructed(cueChip, firstContactTarget, [targetChip.id]);
    const path2Clear = !isPathObstructed(targetChip, hole, [cueChip.id, firstContactTarget.id]);
    if (!path1Clear || !path2Clear) return null;

    // --- GHOST BALL CALCULATION ---
    const dx = hole.x - targetChip.x;
    const dy = hole.y - targetChip.y;
    const angleToHole = Math.atan2(dy, dx);
    const distToGhost = cueChip.radius + targetChip.radius;
    const ghostX = targetChip.x - Math.cos(angleToHole) * distToGhost;
    const ghostY = targetChip.y - Math.sin(angleToHole) * distToGhost;
    const shotAngle = Math.atan2(ghostY - cueChip.y, ghostX - cueChip.x);

    // --- BASE SCORING ---
    let score = 1000;
    const distToHole = Math.hypot(dx, dy);
    score -= distToHole; 

    // --- POSITIONAL PLAY (PREPARE SHOT) ---
    // Predict kung saan hihinto ang Cue Ball (Simpleng Tangent Line prediction)
    // Ang cue ball ay lilihis ng 90 degrees mula sa impact line pagkatapos tumama (Stun shot assumption)
    const impactLineAngle = angleToHole; // Linya papunta sa butas
    const cueArrivalAngle = shotAngle; // Anggulo ng dating ng cue ball
    const cutAngle = Math.abs(impactLineAngle - cueArrivalAngle);
    
    // Simpleng estimate: Cue ball moves along tangent line
    // Kung full ball hit (0 degrees cut), stop ball. Kung manipis, takbo malayo.
    const tangentAngle = impactLineAngle + (Math.PI / 2); // 90 degrees
    const predictedTravelDist = 100 * Math.sin(cutAngle); // Tantiya lang
    
    const predictedCueX = ghostX + Math.cos(tangentAngle) * predictedTravelDist;
    const predictedCueY = ghostY + Math.sin(tangentAngle) * predictedTravelDist;

    // Check Next Ball: Hanapin ang pinakamalapit na *ibang* target mula sa predicted spot
    let bestNextDist = Infinity;
    for (const nextTarget of allLegalTargets) {
        if (nextTarget.id === targetChip.id) continue; // Skip current target
        
        const distToNext = Math.hypot(nextTarget.x - predictedCueX, nextTarget.y - predictedCueY);
        
        // Check kung clear ang daan mula Predicted Spot -> Next Target -> Any Hole
        // (Simpleng check lang para di masyadong mabigat sa CPU)
        if (distToNext < bestNextDist) {
            bestNextDist = distToNext;
        }
    }

    // SCORING BOOST: Kung malapit sa next ball, dagdag points!
    if (bestNextDist < 300) {
        score += (300 - bestNextDist) * 0.5; // Up to +150 points para sa magandang pwesto
    }

    // --- POWER CALCULATION ---
    const distCueToTarget = Math.hypot(ghostX - cueChip.x, ghostY - cueChip.y);
    const totalDist = distCueToTarget + distToHole;
    let power;
    if (distToHole < canvas.width * 0.2) {
        power = Math.min(0.6, (totalDist / canvas.width) + 0.15);
    } else {
        power = Math.min(0.85, (totalDist / canvas.width) * 1.5 + 0.3);
    }

    return {
        angle: shotAngle,
        power: power,
        score: score,
        probability: 1.0,
        target: targetChip,
        hole: hole,
        pektus: { x: 0, y: 0 }
    };
}

// --- NEW FUNCTION: DOBLETE (Bank Shot Calculator) ---
function findBestBankShot(cueChip, legalTargets) {
    let bestBank = null;
    let highestScore = -Infinity;

    const cushions = [
        { type: 'y', val: 0 },             // Top
        { type: 'y', val: canvas.height }, // Bottom
        { type: 'x', val: 0 },             // Left
        { type: 'x', val: canvas.width }   // Right
    ];

    for (const target of legalTargets) {
        for (const hole of holes) {
            for (const cushion of cushions) {
                // 1. MIRROR THE POCKET (Ilipat ang butas sa kabila ng pader)
                let mirroredHole = { x: hole.x, y: hole.y };
                if (cushion.type === 'y') {
                    mirroredHole.y = cushion.val + (cushion.val - hole.y);
                } else {
                    mirroredHole.x = cushion.val + (cushion.val - hole.x);
                }

                // 2. HANAPIN ANG POINT SA PADER (Banking Point)
                // Ito ang linya mula Target Ball papunta sa Mirrored Hole
                const angleToMirrored = Math.atan2(mirroredHole.y - target.y, mirroredHole.x - target.x);
                
                // Saan tatama sa pader?
                let bankPoint;
                if (cushion.type === 'y') {
                    const dy = cushion.val - target.y;
                    const dx = dy / Math.tan(angleToMirrored);
                    bankPoint = { x: target.x + dx, y: cushion.val };
                } else {
                    const dx = cushion.val - target.x;
                    const dy = dx * Math.tan(angleToMirrored);
                    bankPoint = { x: cushion.val, y: target.y + dy };
                }

                // Check kung pasok sa table ang tama sa pader
                if (bankPoint.x < 0 || bankPoint.x > canvas.width || bankPoint.y < 0 || bankPoint.y > canvas.height) continue;

                // 3. OBSTRUCTION CHECK (Malinis ba ang daan?)
                // A. Target -> Pader -> Butas
                const pathTargetToRail = !isPathObstructed(target, bankPoint, [cueChip.id]);
                const pathRailToHole = !isPathObstructed(bankPoint, hole, [cueChip.id, target.id]);
                
                // 4. CUE BALL AIMING (Ghost Ball para sa Bank Shot)
                // Kailangan tamaan ang target para pumunta ito sa bankPoint
                const angleTargetToRail = Math.atan2(bankPoint.y - target.y, bankPoint.x - target.x);
                // Ghost ball location (likod ng target)
                const ghostX = target.x - Math.cos(angleTargetToRail) * (cueChip.radius + target.radius);
                const ghostY = target.y - Math.sin(angleTargetToRail) * (cueChip.radius + target.radius);
                
                // B. Cue -> Ghost Ball
                const ghostPos = { x: ghostX, y: ghostY, radius: cueChip.radius };
                const pathCueToTarget = !isPathObstructed(cueChip, ghostPos, [target.id]);

                if (pathTargetToRail && pathRailToHole && pathCueToTarget) {
                    const shotAngle = Math.atan2(ghostY - cueChip.y, ghostX - cueChip.x);
                    
                    // Calculation ng Score
                    const distCueToTarget = Math.hypot(ghostX - cueChip.x, ghostY - cueChip.y);
                    const distTargetToRail = Math.hypot(bankPoint.x - target.x, bankPoint.y - target.y);
                    const distRailToHole = Math.hypot(hole.x - bankPoint.x, hole.y - bankPoint.y);
                    const totalDist = distCueToTarget + distTargetToRail + distRailToHole;

                    // Power calculation (Mas malakas kasi doblete)
                    const power = Math.min(1.0, (totalDist / canvas.width) * 1.6 + 0.35);

                    // Mas mababa konti ang score ng doblete kesa direct shot, 
                    // pero mas mataas kesa sa wala.
                    const score = 800 - totalDist; 

                    if (score > highestScore) {
                        highestScore = score;
                        bestBank = {
                            angle: shotAngle,
                            power: power,
                            score: score,
                            target: target,
                            type: 'doblete',
                            pektus: { x: 0, y: 0.2 } // Konting follow para kumagat
                        };
                    }
                }
            }
        }
    }
    return bestBank;
}
  
 function aiTurn() {
    if (gameState !== 'aiming' || chipsMoving || !chips[0]?.inPlay) return;
    const cueChip = chips[0];

    // 1. BREAK SHOT (Super Break)
    if (isBreakShot) {
        showMessage("Opponent performing Power Break!", 2000);
        let apexBall;
        if (gameMode.includes('61-ball')) {
            apexBall = chips.find(c => c.inPlay && c.id === 1);
        } else {
            let frontMostX = canvas.width;
            chips.forEach(c => {
                if (c.inPlay && c.id !== 0 && c.x < frontMostX) {
                    frontMostX = c.x;
                    apexBall = c;
                }
            });
        }
        if (!apexBall) apexBall = { x: canvas.width * 0.7, y: canvas.height / 2 };
        // Magdagdag ng kaunting "Random Error" sa angle (-0.05 hanggang +0.05 radians)
// Para hindi laging saktong gitna ang tama ng sargo
const randomError = (Math.random() - 0.5) * 0.1; 
const breakAngle = Math.atan2(apexBall.y - cueChip.y, apexBall.x - cueChip.x) + randomError;

animateAiAiming(breakAngle, 1.0, { DURATION_ALIGN: 1000, DURATION_FEATHER: 1000 }, { x: 0, y: -0.5 });
        return;
    }

    // 2. TARGET IDENTIFICATION
    let allLegalTargets = [], allPocketableChips = [];
    if (gameMode.includes('poker')) {
        allLegalTargets = chips.filter(c => c.inPlay && opponentHand.some(card => card.value === c.id));
        allPocketableChips = allLegalTargets;
    } else if (gameMode.includes('61-ball')) {
        const lowestChip = chips.find(c => c.id === lowestChipNumber);
        if (!lowestChip) { setTimeout(handleTurnEnd, 500); return; }
        allLegalTargets = [lowestChip];
        allPocketableChips = chips.filter(c => c.inPlay && c.id !== 0);
    } else {
        if (colorsAssigned && opponentChipsType) allLegalTargets = chips.filter(c => c.inPlay && c.type === opponentChipsType);
        else allLegalTargets = chips.filter(c => c.inPlay && (c.type === 'red' || c.type === 'blue'));
        allPocketableChips = allLegalTargets;
    }

    // 3. EVALUATE DIRECT SHOTS (Pina)
    let bestDirectShot = null;
    let highestDirectScore = -Infinity;

    for (const target of allLegalTargets) {
        for (const hole of holes) {
            const evalShot = evaluateShot(cueChip, target, hole, allLegalTargets, 'hard', false);
            if (evalShot && evalShot.score > highestDirectScore) {
                highestDirectScore = evalShot.score;
                bestDirectShot = evalShot;
            }
        }
    }

    // 4. DECISION MAKING (Dito ang talino ng AI)
    let finalShot = null;
    let shotType = "normal";

    // A. Check kung "Alanganin" ang Direct Shot
    // Ang score sa evaluateShot ay (1000 - distance). 
    // Kung mababa sa 600, ibig sabihin malayo o mahirap ang anggulo.
    const isDirectRisky = !bestDirectShot || highestDirectScore < 600;

    if (isDirectRisky) {
        // B. Kung alanganin, hanap ng DOBLETE (Bank Shot)
        const bestBank = findBestBankShot(cueChip, allLegalTargets);
        
        if (bestBank) {
            // Kung mas maganda ang score ng Doblete o kaya wala talagang Direct Shot
            if (!bestDirectShot || bestBank.score > (highestDirectScore - 100)) { 
                // Note: Minus 100 kasi mas prefer pa rin natin direct pag konti lang diperensya
                finalShot = bestBank;
                shotType = "doblete";
            }
        }
    }

    // C. Kung wala pa ring napili (so pwedeng Direct Shot ang best)
    if (!finalShot && bestDirectShot) {
        finalShot = bestDirectShot;
        shotType = "direct";
    }

    // D. Kung "Walang Kita" (Blocked lahat), hanap ng BANDA (Kick Shot)
    if (!finalShot) {
        // Ito yung logic na binigay ko dati (Mirror Logic)
        const bestKick = findBestKickShot(cueChip, allLegalTargets);
        if (bestKick) {
            finalShot = bestKick;
            shotType = "banda";
        }
    }

    // E. Kung wala talagang magawa, SAFETY / DEFENSIVE na lang
    if (!finalShot) {
        shotType = "safety";
        showMessage("opponent playing Safe...", 1500);
        const target = allLegalTargets[0];
        if (target) {
            finalShot = { 
                angle: Math.atan2(target.y - cueChip.y, target.x - cueChip.x), 
                power: 0.3, 
                pektus: {x:0, y:0} 
            };
        } else {
            setTimeout(handleTurnEnd, 500);
            return;
        }
    }

    // 5. MESSAGE & EXECUTE
    if (shotType === "doblete") showMessage("opponent attempting Bank Shot (Doblete)!", 2000);
    if (shotType === "banda") showMessage("opponent calculating Kick Shot (Banda)...", 2000);
    if (shotType === "direct" && highestDirectScore > 900) showMessage("opponent aiming Sureball...", 1500);

    // I-lock ang tira
    animateAiAiming(finalShot.angle, finalShot.power, { DURATION_ALIGN: 800, DURATION_FEATHER: 1500 }, finalShot.pektus || { x: 0, y: 0 });
}
        
        function findBestKickShot(cueChip, legalTargets) {
    if (!legalTargets || legalTargets.length === 0) return null;
    
    let bestKickShot = { score: -Infinity };
    const target = legalTargets[0]; // Ang target na bola (lowest number o card)

    // Apat na pader (Top, Bottom, Left, Right)
    const cushions = [
        { type: 'y', val: 0, name: 'top' },
        { type: 'y', val: canvas.height, name: 'bottom' },
        { type: 'x', val: 0, name: 'left' },
        { type: 'x', val: canvas.width, name: 'right' }
    ];

    // Subukan ang bawat pader
    for (const cushion of cushions) {
        // --- MIRROR SYSTEM CALCULATION ---
        // I-mirror natin ang target ball sa kabila ng pader para makuha ang tamang aiming point
        let mirroredTarget = { x: target.x, y: target.y };
        
        if (cushion.type === 'y') { // Top or Bottom Wall
            // Mirror Y coordinate
            mirroredTarget.y = cushion.val + (cushion.val - target.y);
        } else { // Left or Right Wall
            // Mirror X coordinate
            mirroredTarget.x = cushion.val + (cushion.val - target.x);
        }

        // Kalkulahin ang Ghost Ball sa mirrored position (para tumama sa gitna ng bola)
        const angleToMirrored = Math.atan2(mirroredTarget.y - cueChip.y, mirroredTarget.x - cueChip.x);
        
        // Ito ang punto sa pader na dapat tamaan
        let impactPoint;
        if (cushion.type === 'y') {
            const dy = cushion.val - cueChip.y;
            const dx = dy / Math.tan(angleToMirrored);
            impactPoint = { x: cueChip.x + dx, y: cushion.val };
        } else {
            const dx = cushion.val - cueChip.x;
            const dy = dx * Math.tan(angleToMirrored);
            impactPoint = { x: cushion.val, y: cueChip.y + dy };
        }

        // Check kung pasok sa table ang tama sa pader (baka lumampas)
        if (impactPoint.x < 0 || impactPoint.x > canvas.width || impactPoint.y < 0 || impactPoint.y > canvas.height) continue;

        // --- PATH CHECKING ---
        // 1. Path mula Cue Ball papuntang Pader (Clear ba?)
        const pathToCushionClear = !isPathObstructed(cueChip, impactPoint, [target.id]);
        
        // 2. Path mula Pader papuntang Target (Clear ba?)
        const pathFromCushionClear = !isPathObstructed(impactPoint, target, [cueChip.id]);

        if (pathToCushionClear && pathFromCushionClear) {
            // Success! May nakitang banda.
            const finalShotAngle = Math.atan2(impactPoint.y - cueChip.y, impactPoint.x - cueChip.x);
            const totalDistance = Math.hypot(impactPoint.x - cueChip.x, impactPoint.y - cueChip.y) + 
                                  Math.hypot(target.x - impactPoint.x, target.y - impactPoint.y);
            
            // Mas malakas na power para sigurado umabot kahit tumalbog
            const power = Math.min(1.0, (totalDistance / canvas.width) * 1.8) + 0.2; 
            
            // Mas mataas ang score pag mas malapit ang distansya
            const score = 1000 - totalDistance; 

            if (score > bestKickShot.score) {
                bestKickShot = { 
                    score, 
                    angle: finalShotAngle, 
                    power, 
                    probability: 1.0, // Sureball ang aim
                    pektus: { x: 0, y: 0.5 } // Konting forward spin para kumagat sa banda
                };
            }
        }
    }

    return bestKickShot.score > -Infinity ? bestKickShot : null;
}
        function predictSimpleCuePos(cueChip,targetChip,shotAngle,power){const distance=Math.hypot(targetChip.x-cueChip.x,targetChip.y-cueChip.y);const followDistance=(power*power)*(distance*0.4);return{id:0,x:targetChip.x+Math.cos(shotAngle)*followDistance,y:targetChip.y+Math.sin(shotAngle)*followDistance,radius:cueChip.radius};}
        // ‚ñº‚ñº‚ñº PALITAN MO ITONG BUONG FUNCTION ‚ñº‚ñº‚ñº

    // ‚ñº‚ñº‚ñº IPALIT MO ITONG BUONG FUNCTION (Version 3: May Topspin at Sidespin) ‚ñº‚ñº‚ñº

        function calculatePositionalScore(predictedCuePos, pocketedChip, allLegalTargets) {
            
            // --- 1. Hanapin ang susunod na target ---
            let nextTargets = [];
            if (gameMode.includes('poker')) {
                nextTargets = allLegalTargets.filter(t => t.id !== pocketedChip.id); // Pinalitan ang 'justPocketedId'
            } else if (gameMode.includes('61-ball')) {
                const remaining = chips.filter(c => c.inPlay && c.id !== 0 && c.id !== pocketedChip.id); // Pinalitan ang 'justPocketedId'
                if (remaining.length > 0) nextTargets = [remaining.sort((a, b) => a.id - b.id)[0]];
            } else nextTargets = allLegalTargets.filter(t => t.id !== pocketedChip.id); // Pinalitan ang 'justPocketedId'

            // Default pektus: "Stun" shot (gitna)
            let bestPektus = { x: 0, y: 0 };
            
            if (nextTargets.length === 0) {
                // Kung wala nang susunod na target, 'wag na mag-spin.
                return { score: 800, pektus: bestPektus }; 
            }

            const nextBestTarget = nextTargets.sort((a, b) => Math.hypot(a.x - predictedCuePos.x, a.y - predictedCuePos.y) - Math.hypot(b.x - predictedCuePos.x, b.y - predictedCuePos.y))[0];
            
            // --- 2. Logic para sa TOPSPIN (Follow) ---
            const distanceToNext = Math.hypot(nextBestTarget.x - predictedCuePos.x, nextBestTarget.y - predictedCuePos.y);
            if (distanceToNext > canvas.width / 3.5) {
                // Kung MALAYO ang next target, gumamit ng TOPSPIN
                bestPektus.y = -0.5; // -Y ay topspin (pataas ang dot)
            }
            // (Tandaan: Bawal ang backspin, kaya walang 'else if' dito)


            // --- 3. Logic para sa SIDESPIN (Left/Right) ---

            // Ito ay isang "helper" function na magko-compute ng score ng anggulo
            const getAngleScore = (cuePos, target) => {
                let bestScore = -200; // Simula sa negatibong score
                for (const hole of holes) {
                    if (!isPathObstructed(target, hole, [cuePos.id])) {
                        const angleToHole = Math.atan2(hole.y - target.y, hole.x - target.x);
                        const shotLine = Math.atan2(target.y - cuePos.y, target.x - cuePos.x);
                        const cutAngle = Math.abs(angleToHole - shotLine); // 0 = diretso, 1.57 = 90 degrees
                        // Mas mataas ang bonus kung mas diretso ang anggulo
                        const angleBonus = 200 * (1 - cutAngle / (Math.PI / 2)); 
                        if (angleBonus > bestScore) bestScore = angleBonus;
                    }
                }
                return bestScore;
            };

            // A. Kunin ang score ng STUN shot (natural na pwesto)
            let stunScore = getAngleScore(predictedCuePos, nextBestTarget);
            let finalScore = stunScore; // Ito ang default score

            // B. Kalkulahin ang "tangent" vector (ang direksyon na i-a-adjust ng side spin)
            const tangentX = -(predictedCuePos.y - pocketedChip.y);
            const tangentY = (predictedCuePos.x - pocketedChip.x);
            const mag = Math.hypot(tangentX, tangentY);

            if (mag > 0.1) { // Siguraduhin na hindi zero (para maiwasan ang divide by zero)
                const normTangentX = tangentX / mag;
                const normTangentY = tangentY / mag;
                // Gaano kalayo ang "estimate" natin na epekto ng spin
                const SPIN_ADJUST_DISTANCE = 30 * scale; 

                // C. Estimate ang position para sa LEFT SPIN
                const leftSpinPos = { 
                    id: 0, 
                    x: predictedCuePos.x - normTangentX * SPIN_ADJUST_DISTANCE, 
                    y: predictedCuePos.y - normTangentY * SPIN_ADJUST_DISTANCE 
                };
                let leftSpinScore = getAngleScore(leftSpinPos, nextBestTarget) - 20; // May -20 penalty kasi mas mahirap

                // D. Estimate ang position para sa RIGHT SPIN
                const rightSpinPos = { 
                    id: 0, 
                    x: predictedCuePos.x + normTangentX * SPIN_ADJUST_DISTANCE, 
                    y: predictedCuePos.y + normTangentY * SPIN_ADJUST_DISTANCE 
                };
                let rightSpinScore = getAngleScore(rightSpinPos, nextBestTarget) - 20; // May -20 penalty

                // E. Pag-desisyunan kung aling spin ang pinakamaganda
                if (leftSpinScore > stunScore && leftSpinScore > rightSpinScore) {
                    bestPektus.x = -0.6; // Gagamit ng Left Spin
                    finalScore = leftSpinScore; // Ito na ang bagong score
                } else if (rightSpinScore > stunScore && rightSpinScore > leftSpinScore) {
                    bestPektus.x = 0.6; // Gagamit ng Right Spin
                    finalScore = rightSpinScore; // Ito na ang bagong score
                }
                // Kung stunScore ang pinakamataas, mananatili ang bestPektus.x = 0
            }

            // 4. Ibalik ang pinakamagandang score AT ang pektus na gagamitin
            return { score: finalScore, pektus: bestPektus };
        }
        
        // ‚ñ≤‚ñ≤‚ñ≤ HANGGANG DITO ANG PALIT ‚ñ≤‚ñ≤‚ñ≤
        function findBestDefensiveShot(cueChip,legalTargets){if(!legalTargets||legalTargets.length===0)return null;let bestSafety={score:-Infinity,angle:0,power:0};const primaryTarget=legalTargets[0];const opponentNextTarget=primaryTarget;for(let i=0;i < 32;i++){const angleOffset=(Math.random()-0.5)*(Math.PI/4);const shotAngle=Math.atan2(primaryTarget.y-cueChip.y,primaryTarget.x-cueChip.x)+angleOffset;const power=0.25+Math.random()*0.2;const predictedCuePos=predictSimpleCuePos(cueChip,primaryTarget,shotAngle,power);if(holes.some(h=>Math.hypot(h.x-predictedCuePos.x,h.y-predictedCuePos.y)<h.radius*1.2))continue;let safetyScore=0;safetyScore+=Math.hypot(predictedCuePos.x-opponentNextTarget.x,predictedCuePos.y-opponentNextTarget.y);const distToCushion=Math.min(predictedCuePos.x,canvas.width-predictedCuePos.x,predictedCuePos.y,canvas.height-predictedCuePos.y);if(distToCushion<cueChip.radius*3)safetyScore+=300;let blockingBallsCount=0;for(const chip of chips){if(chip.inPlay&&chip.id!==cueChip.id&&chip.id!==opponentNextTarget.id){const distToLine=Math.abs((opponentNextTarget.y-predictedCuePos.y)*chip.x-(opponentNextTarget.x-predictedCuePos.x)*chip.y+opponentNextTarget.x*predictedCuePos.y-opponentNextTarget.y*predictedCuePos.x)/Math.hypot(opponentNextTarget.y-predictedCuePos.y,opponentNextTarget.x-predictedCuePos.x);if(distToLine<chip.radius*2)blockingBallsCount++;}}safetyScore+=blockingBallsCount*400;if(safetyScore>bestSafety.score)bestSafety={score:safetyScore,angle:shotAngle,power:power,probability:0.9};}return bestSafety.score>-Infinity?bestSafety:null;}
       
 // ‚ñº‚ñº‚ñº SMARTER AI PLACEMENT (FIXED: NO MORE DEFAULT CENTER) ‚ñº‚ñº‚ñº

function placeCueChipForAI() {
    cueBallGuide.style.display = 'none'; 
    dragGuideText.style.display = 'none'; 
    const cueChip = chips[0]; 
    gameState = 'ai_placing'; 

    let targetX, targetY;

    // 1. BREAK SHOT (Head String - Keep as is)
    if (isBreakShot) {
    // Mananatili ang X sa headstring (1/4 ng mesa)
    targetX = canvas.width * 0.25;

    // RANDOM Y: Kukuha tayo ng random spot sa pagitan ng 20% hanggang 80% ng taas ng mesa.
    // Sa paraang ito, hindi na lang dalawang pwesto ang pagpipilian niya.
    const minY = canvas.height * 0.2;
    const maxY = canvas.height * 0.8;
    targetY = Math.random() * (maxY - minY) + minY;
} 
    
    // 2. BALL IN HAND (Anywhere)
    else {
        // A. Initial Fallback: Maghanap muna ng random valid spot (HINDI GITNA)
        // Para kung sakaling wala siyang makitang tira, at least hindi sa gitna ilalagay.
        let safeX = Math.random() * (canvas.width * 0.8) + (canvas.width * 0.1);
        let safeY = Math.random() * (canvas.height * 0.8) + (canvas.height * 0.1);
        
        // Siguraduhing hindi nakapatong ang fallback
        for(let k=0; k<50; k++) {
             let tx = Math.random() * (canvas.width - 60) + 30;
             let ty = Math.random() * (canvas.height - 60) + 30;
             if (!isPositionOccupied(tx, ty, cueChip)) {
                 safeX = tx;
                 safeY = ty;
                 break;
             }
        }

        // Set initial best placement to the random safe spot (Score: -500)
        let bestPlacement = { score: -500, x: safeX, y: safeY }; 
        
        // B. Identify Targets
        let legalTargets = [];
        if (gameMode.includes('poker')) {
            legalTargets = chips.filter(c => c.inPlay && opponentHand.some(card => card.value === c.id));
        } else if (gameMode.includes('61-ball')) {
            const lowestChip = chips.find(c => c.id === lowestChipNumber);
            if (lowestChip) legalTargets = [lowestChip];
        } else {
            if (colorsAssigned && opponentChipsType) legalTargets = chips.filter(c => c.inPlay && c.type === opponentChipsType);
            else legalTargets = chips.filter(c => c.inPlay && (c.type === 'red' || c.type === 'blue'));
        }

        // C. Intelligent Scanning (Increased to 100 attempts)
        for (let i = 0; i < 100; i++) { 
            const safeMargin = cueChip.radius + (5 * scale); 
            const proposedX = (Math.random() * (canvas.width - safeMargin * 2)) + safeMargin;
            const proposedY = (Math.random() * (canvas.height - safeMargin * 2)) + safeMargin;
            
            if (isPositionOccupied(proposedX, proposedY, cueChip)) continue; 
            
            const tempCueChip = { ...cueChip, x: proposedX, y: proposedY }; 
            let bestScoreFromPos = -Infinity; 
            
            // Evaluate Shots
            for (const target of legalTargets) { 
                for (const hole of holes) { 
                    const evalShot = evaluateShot(tempCueChip, target, hole, legalTargets, 'hard'); 
                    if (evalShot && evalShot.score > bestScoreFromPos) bestScoreFromPos = evalShot.score; 
                } 
            } 
            
            // Kung may nahanap na valid shot, kunin ang score.
            // Kung wala (-Infinity), bigyan ng mababang score (-100) basta valid position.
            // Mas mataas ang -100 kaysa sa initial na -500, kaya pipiliin pa rin 'to.
            let currentScore = (bestScoreFromPos === -Infinity) ? -100 : bestScoreFromPos;

            if (currentScore > bestPlacement.score) { 
                bestPlacement = { score: currentScore, x: proposedX, y: proposedY }; 
            } 
        } 
        
        targetX = bestPlacement.x;
        targetY = bestPlacement.y;
    }

    // 3. Animation
    animateAIHandDrag(cueChip, targetX, targetY);
}

function animateAIHandDrag(cueChip, targetX, targetY) {
    const startX = cueChip.x;
    const startY = cueChip.y;
    const startTime = performance.now();
    const duration = 1200; // 1.2 seconds na pag-drag (para natural)

    // Ipakita ang Ghost Hand
    const handEl = document.getElementById('ghost-hand');
    if (handEl) {
        handEl.style.display = 'block';
        handEl.style.opacity = '0.8';
    }

    function animate(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        // Smooth Easing (Ease Out)
        const ease = 1 - Math.pow(1 - progress, 3);

        // Galawin ang bola
        cueChip.x = startX + (targetX - startX) * ease;
        cueChip.y = startY + (targetY - startY) * ease;

        // I-update ang pwesto ng Kamay sa screen
        if (handEl) {
            // Kailangan i-convert ang virtual coords to screen coords para sa HTML element
            const canvasRect = canvas.getBoundingClientRect();
            const scaleX = canvasRect.width / 970; // VIRTUAL_WIDTH
            const scaleY = canvasRect.height / 500; // VIRTUAL_HEIGHT
            
            const screenX = (cueChip.x * scaleX) + canvasRect.left;
            const screenY = (cueChip.y * scaleY) + canvasRect.top;

            handEl.style.left = `${screenX}px`;
            handEl.style.top = `${screenY}px`;
        }

        if (progress < 1) {
            requestAnimationFrame(animate);
        } else {
            // TAPOS NA ANG DRAG
            if (handEl) handEl.style.display = 'none'; // Tago kamay
            
            // Set state to Aiming
            setTimeout(() => {
                canMoveCueBall = false; 
                gameState = 'aiming'; 
                cueStick.visible = true; 
                if (cueStickElement) cueStickElement.style.display = 'block'; 
                
                // Tira na!
                setTimeout(aiTurn, 500); 
            }, 200);
        }
    }
    
    requestAnimationFrame(animate);
}

function animateAiAiming(targetAngle, finalPower, pacingOptions = {}, pektus = { x: 0, y: 0 }) {
    // Override pacing para mabilis at walang arte (God Mode style)
    const DURATION_ALIGN = 500;  // Mabilis na align
    const DURATION_FEATHER = 1000; // Isang atras-abante lang
    const TOTAL_DURATION = DURATION_ALIGN + DURATION_FEATHER;
    
    const startTime = performance.now();
    const startAngle = cueStick.angle;

    function animate(currentTime) {
        const elapsedTime = currentTime - startTime;

        if (elapsedTime < DURATION_ALIGN) {
            // Stage 1: Aligning
            const progress = elapsedTime / DURATION_ALIGN;
            // Smooth easing
            const ease = 1 - Math.pow(1 - progress, 3); 
            cueStick.angle = startAngle + (targetAngle - startAngle) * ease;
            
            // Set Pektus visuals
            pektusOffset.x = pektus.x * ease;
            pektusOffset.y = pektus.y * ease;
            updatePektusUI();

        } else if (elapsedTime < TOTAL_DURATION) {
            // Stage 2: LOCK ON TARGET (Dito ang sikreto, naka-lock na)
            cueStick.angle = targetAngle; // <--- FORCE PERFECT ANGLE
            
            // Set Final Pektus
            pektusOffset = { ...pektus };
            updatePektusUI();

            // Pullback animation lang (Visuals lang to, di nakakaapekto sa aim)
            const featherTime = elapsedTime - DURATION_ALIGN;
            const featherProgress = featherTime / DURATION_FEATHER;
            cueStick.pullback = Math.sin(featherProgress * Math.PI) * (50 * scale);

        } else {
            // Stage 3: SHOOT
            // SIGURADUHIN na naka-set ang angle at pektus bago tumira
            cueStick.angle = targetAngle; 
            pektusOffset = { ...pektus };
            updatePektusUI();
            
            // Fire!
            shoot(finalPower * 40 + 2);
            return;
        }
        requestAnimationFrame(animate);
    }
    requestAnimationFrame(animate);
}

function placeChipOnSpot(chipToPlace) {
    // Siguraduhin na ang pwesto ay LAGING 0.7 (70%)
    const spotX = canvas.width * 0.7; 
    const spotY = canvas.height / 2;
    
    let finalX = spotX, finalY = spotY, attempts = 0;
    
    // Habang may nakaharang na ibang bola sa spot...
    while (attempts < 100) {
        // Check kung 'yung pwesto (finalX, finalY) ay bakante
        if (!chips.some(c => c.inPlay && c.id !== chipToPlace.id && (finalX - c.x)**2 + (finalY - c.y)**2 < (c.radius + chipToPlace.radius)**2)) {
            break; // Bakante! Dito na ilalagay.
        }
        
        // Kung hindi bakante, mag-spiral out para humanap ng pwesto
        const angle = attempts * 0.5;
        const radius = chipToPlace.radius * 1.2 * Math.sqrt(attempts + 1);
        finalX = spotX + Math.cos(angle) * radius;
        finalY = spotY + Math.sin(angle) * radius;
        attempts++;
    }
    
    // Ilagay ang picha sa nahanap na pwesto
    chipToPlace.x = finalX;
    chipToPlace.y = finalY;
}
// ‚ñ≤‚ñ≤‚ñ≤ HANGGANG DITO ‚ñ≤‚ñ≤‚ñ≤
        function createDeck() { deck = []; const suits = ['‚ô•', '‚ô¶', '‚ô£', '‚ô†'], ranks = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K']; for (const suit of suits) for (const rank of ranks) { let value = parseInt(rank); if(rank==='A') value=1; else if(rank==='J') value=11; else if(rank==='Q') value=12; else if(rank==='K') value=13; deck.push({ suit, rank, value }); }}
        function dealCards() { playerHand = []; opponentHand = []; for (let i = deck.length-1; i > 0; i--) { const j = Math.floor(Math.random()*(i+1)); [deck[i], deck[j]]=[deck[j], deck[i]]; } for (let i = 0; i < 7; i++) { if(deck.length > 0) playerHand.push(deck.pop()); if(deck.length > 0) opponentHand.push(deck.pop()); } originalPlayerHand = [...playerHand]; originalOpponentHand = [...opponentHand]; }
        function toggleFullScreen() { if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(() => showMessage(`Could not activate full-screen mode.`, 2000)); else if (document.exitFullscreen) document.exitFullscreen(); }
        
        function handlePointerDown(e) { 
    e.preventDefault(); 

    // ‚ñº‚ñº‚ñº BAGONG DAGDAG: HARANG KAPAG MAY MODAL ‚ñº‚ñº‚ñº
    // Kung may nakabukas na modal (tulad ng Profile), 'wag pansinin ang click sa mesa
    if (document.querySelector('.modal-overlay.show')) {
        return; 
    }
    // ‚ñ≤‚ñ≤‚ñ≤ ‚ñ≤‚ñ≤‚ñ≤

    if (isTutorialActive) {
        const currentStep = tutorialSteps[tutorialStep];
        if (currentStep && currentStep.trigger === 'drag') {
            // Handled in pointerMove
        }
    }

    const isMyTurn = isOnlineGame ? isMyTurnOnline : playerTurn; 
    if (!isMyTurn || (isOnlineGame && isSyncing)) return; 
    
    const targetId = e.currentTarget.id; 
    
    if (gameState === 'moving' && canMoveCueBall && targetId === 'game-canvas') { 
        isDraggingCueBall = true; 
        cueStick.visible = false; 
        ghostHand.style.display = 'block'; 
        dragGuideText.style.display = 'none'; 
        updateCueBallPosition(e); 
    } else if (gameState === 'aiming') { 
        if (targetId === 'game-canvas') { 
            isAimingOnCanvas = true; 
            updateAimFromCanvas(e); 
            playAimingSound(); 
        } else if (targetId === 'power-control') {
            isPoweringUp = true;
            playPowerSound(0); 
        } 
        // --- DITO NATIN BINAGO ---
        else if (targetId === 'pektus-control') { 
            // Buksan ang Modal sa gitna
            if (typeof openPektusModal === 'function') {
                openPektusModal();
            } else {
                console.error("Wala pa yung openPektusModal function!");
            }
        } 
        // -------------------------
        else if (targetId === 'left-arrow') {
            isRotatingLeft = true; 
        } else if (targetId === 'right-arrow') {
            isRotatingRight = true; 
        }
    } 
}

        function handlePointerMove(e) { 
            if (isTutorialActive) {
                const currentStep = tutorialSteps[tutorialStep];
                if (currentStep) {
                    if (isDraggingCueBall && currentStep.key === 'place') {
                        // Position is updated by the main logic below
                    } else if (isAimingOnCanvas && currentStep.key === 'aim') {
                        nextTutorialStep();
                    } else if (isDraggingPektusDot && currentStep.key === 'pektus') {
                        nextTutorialStep();
                    } else if (isPoweringUp && currentStep.key === 'power' && cueStick.power > 0.5) {
                        nextTutorialStep();
                    }
                }
            }

            if (isDraggingCueBall) { 
                e.preventDefault(); 
                const clientX = e.touches ? e.touches[0].clientX : e.clientX; 
                const clientY = e.touches ? e.touches[0].clientY : e.clientY; 
                ghostHand.style.left = `${clientX}px`; 
                ghostHand.style.top = `${clientY}px`; 
                updateCueBallPosition(e); 
            } else if (isPoweringUp) { 
                e.preventDefault(); 
                updatePower(e); 
            } else if (isAimingOnCanvas) { 
                e.preventDefault(); 
                updateAimFromCanvas(e); 
                playAimingSound(); // Play sound while dragging aim
            } else if (isDraggingPektusDot) { 
                e.preventDefault(); 
                handlePektusInput(e); 
                playAimingSound(); // Play sound while dragging pektus
            } 
        }

        function handlePointerUp(e) {
    if (isTutorialActive) {
        const currentStep = tutorialSteps[tutorialStep];
        if (currentStep) {
                if (isDraggingCueBall && currentStep.key === 'place') {
                if (!isInvalidPlacement) nextTutorialStep();
            }
        }
    }

    // Sa loob ng handlePointerUp...
if (isPoweringUp) {
    isPoweringUp = false;
    stopPowerSound(); 
    
    if (cueStick.power > 0.05) {
        shoot(cueStick.power * 40 + 2);
        
        // ANIMATION: Ibalik sa GITNA (parang tumira)
        const cueImg = document.getElementById('power-cue-img');
        if(cueImg) cueImg.style.top = '50%'; 

    } else {
        // Cancel shot: Reset lahat
        cueStick.power = 0;
        powerBar.style.height = '0%';
        cueStick.pullback = 0;
        
        // RESET VISUALS: Balik sa GITNA
        const cueImg = document.getElementById('power-cue-img');
        if(cueImg) cueImg.style.top = '50%';
    }
}
    
    isAimingOnCanvas = false;
    
    if (isDraggingCueBall) {
        isDraggingCueBall = false;
        ghostHand.style.display = 'none';
        dragGuideText.style.display = 'none';
        if (!isInvalidPlacement) {
            canMoveCueBall = false;
            gameState = 'aiming';
            resetPektus();
            cueStick.visible = true;
            if (cueStickElement) cueStickElement.style.display = 'block';
            if (isOnlineGame && !isTutorialActive) {
                const chipsToSend = chips.map(c => ({...c, x: c.x / canvas.width, y: c.y / canvas.height }));
                updateDoc(doc(db, "games", gameId), { canMoveCueBall: false, chips: chipsToSend, liveAimData: null, currentTurnUid: localPlayerUid });
            }
        } else {
            cueStick.visible = true; 
        }
    }

    // --- DITO ANG FIX PARA SA RED DOT ---
    if (isDraggingPektusDot) {
        isDraggingPektusDot = false;
        resetPektus(); // <--- ITO ANG MAGBABALIK SA GITNA
        if (!isTutorialActive) sendLiveAimData(); // Optional: Para makita ng kalaban na bumalik sa gitna
    }
    // ------------------------------------

    isRotatingLeft = false;
    isRotatingRight = false;
    if (e.currentTarget.id === 'left-arrow' || e.currentTarget.id === 'right-arrow') {
        e.currentTarget.style.transform = '';
    }
}
function getUIPos(e, relativeTo) {
    const rect = relativeTo.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    return { x: clientX - rect.left, y: clientY - rect.top };
}

/**
 * Kinukuha ang mouse position para sa CANVAS
 * Ito ay nagco-convert ng pixel click papuntang Virtual World (1000x500)
 */
function getCanvasPos(e, relativeTo) { 
    const rect = relativeTo.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;

    const xRatio = (clientX - rect.left) / rect.width;
    const yRatio = (clientY - rect.top) / rect.height;

    return {
        x: xRatio * VIRTUAL_WIDTH,
        y: yRatio * VIRTUAL_HEIGHT
    };
}

function updatePower(e) {
    // 1. Kunin ang touch position
    const pos = getUIPos(e, powerControl);
    let p = pos.y / powerControl.clientHeight;
    
    // 2. Limitahan sa 0 hanggang 1
    cueStick.power = Math.max(0, Math.min(1, p));
    
    // 3. Galawin ang kulay ng Bar
    powerBar.style.height = `${cueStick.power * 100}%`;
    
    // 4. Set Pullback sa laro
    cueStick.pullback = cueStick.power * (150 * scale);
    
    // --- 5. VISUAL UPDATE: PAGALAWIN ANG TAKO ---
const cueImg = document.getElementById('power-cue-img');
if (cueImg) {
    // Logic: Start sa 50% (gitna). 
    // Magdadagdag tayo ng hanggang 35% pababa base sa lakas.
    // (50% + 35% = 85% max baba, para di lumagpas sa box)
    const newTop = 50 + (cueStick.power * 35); 
    
    cueImg.style.top = `${newTop}%`;
}
    
    // 6. Sound Effect
    playPowerSound(cueStick.power);
}

function updateAimFromCanvas(e) {
    const cueChip = chips[0];
    if (!cueChip || !cueChip.inPlay) return;
    const pos = getCanvasPos(e, canvas); // <-- Pinalitan na natin
    cueStick.angle = Math.atan2(pos.y - cueChip.y, pos.x - cueChip.x);
    if (!isTutorialActive) sendLiveAimData();
}

function updateCueBallPosition(e) {
    const pos = getCanvasPos(e, canvas); // <-- Pinalitan na natin
    const cueChip = chips[0];
    const breakLineX = VIRTUAL_WIDTH * 0.25; // <-- Gumamit ng VIRTUAL_WIDTH
    let proposedX, proposedY;
    
    if (isBreakShot) {
        proposedX = Math.max(cueChip.radius, Math.min(breakLineX - cueChip.radius, pos.x));
        proposedY = Math.max(cueChip.radius, Math.min(VIRTUAL_HEIGHT - cueChip.radius, pos.y));
    } else {
        proposedX = Math.max(cueChip.radius, Math.min(VIRTUAL_WIDTH - cueChip.radius, pos.x));
        proposedY = Math.max(cueChip.radius, Math.min(VIRTUAL_HEIGHT - cueChip.radius, pos.y));
    }
    
    if (!isPositionOccupied(proposedX, proposedY, cueChip)) {
        cueChip.x = proposedX;
        cueChip.y = proposedY;
        isInvalidPlacement = false;
        if (!isTutorialActive) sendLiveAimData();
    } else isInvalidPlacement = true;
}

function handlePektusInput(e) {
    const rect = pektusControl.getBoundingClientRect();
    const pos = getUIPos(e, pektusControl);
    
    const centerX = rect.width / 2;
    const centerY = rect.height / 2;

    // 1. Calculate Distances from Center
    let dx = pos.x - centerX;
    let dy = pos.y - centerY; 

    // 2. Limits (X Axis - Lapad)
    // Binawasan ko ng 4px (kalahati ng dot size na 8px) para hindi lumabas ang gilid ng bilog
    const maxDistX = (rect.width / 2) - 4; 
    
    // CLAMPING: Kung sobra, gawing max
    if (dx > maxDistX) dx = maxDistX;
    if (dx < -maxDistX) dx = -maxDistX;

    // 3. Limits (Y Axis - Taas/Baba)
    const maxDistY = (rect.height / 2) - 4; 
    
    // CLAMPING: Kung sobra, gawing max
    if (dy > maxDistY) dy = maxDistY;
    if (dy < -maxDistY) dy = -maxDistY;
    
    // 4. Save normalized values (-1 to 1) for Game Logic
    pektusOffset.x = dx / maxDistX;
    pektusOffset.y = dy / maxDistY; 
    
    // 5. Update UI visually
    // Direkta nating i-set ang style dito para smooth at sunod sa clamp
    const dotSize = pektusDot.offsetWidth; 
    pektusDot.style.left = `${centerX + dx - (dotSize/2)}px`;
    pektusDot.style.top = `${centerY + dy - (dotSize/2)}px`;

    if (!isTutorialActive) sendLiveAimData();
}
// ‚ñ≤‚ñ≤‚ñ≤ HANGGANG DITO ANG PAGPALIT ‚ñ≤‚ñ≤‚ñ≤
        function isPositionOccupied(x, y, draggedChip) { for (const chip of chips) { if (chip.id === draggedChip.id || !chip.inPlay) continue; if ((x-chip.x)**2 + (y-chip.y)**2 < (draggedChip.radius + chip.radius)**2) return true; } return false; }
        function updateCardDisplay() { if (gameMode.includes('poker')) { cardHandContainer.style.display = 'flex'; cardHandContainer.innerHTML = ''; let currentHand = playerHand; if (!currentHand) return; currentHand.forEach(card => { const cardDiv = document.createElement('div'); cardDiv.className = 'card'; const rankSpan = document.createElement('span'); rankSpan.className = 'card-rank'; rankSpan.textContent = card.rank; const suitSpan = document.createElement('span'); suitSpan.className = 'card-suit'; suitSpan.textContent = card.suit; if (card.suit === '‚ô•' || card.suit === '‚ô¶') { rankSpan.style.color = '#D32F2F'; suitSpan.style.color = '#D32F2F'; } else { rankSpan.style.color = '#212121'; suitSpan.style.color = '#212121'; } cardDiv.appendChild(rankSpan); cardDiv.appendChild(suitSpan); cardHandContainer.appendChild(cardDiv); }); } else { cardHandContainer.style.display = 'none'; } updateInfoBox(); }
        
     
        function updateLegalTargetChips() {
            legalTargetChipIds.clear(); // I-clear muna ang dating listahan
            const isMyTurn = isOnlineGame ? isMyTurnOnline : playerTurn;

            if (isMyTurn) { // Kunin lang ang legal targets kung turn ng player
                if (gameMode.includes('poker')) {
                    if (playerHand) {
                         playerHand.forEach(card => {
                            const targetChip = chips.find(c => c.inPlay && c.id === card.value);
                            if (targetChip) legalTargetChipIds.add(targetChip.id);
                        });
                    }
                } else if (gameMode.includes('61-ball')) {
                     // Sa 61-ball, ang lowest chip lang ang legal na UNANG tatamaan
                    if (lowestChipNumber > 0) {
                         const targetChip = chips.find(c => c.inPlay && c.id === lowestChipNumber);
                         if (targetChip) legalTargetChipIds.add(targetChip.id);
                    }
                } else if (gameMode.includes('straight-ball')) {
                     if (colorsAssigned && playerChipsType) {
                        // Kung may kulay na, 'yung kulay mo lang ang legal
                         chips.forEach(chip => {
                            if(chip.inPlay && chip.type === playerChipsType) {
                                legalTargetChipIds.add(chip.id);
                            }
                         });
                     } else {
                         // Kung wala pang kulay (open table), lahat pwede (maliban sa cue ball)
                         chips.forEach(chip => {
                            if(chip.inPlay && chip.id !== 0) {
                                legalTargetChipIds.add(chip.id);
                            }
                         });
                     }
                }
            }
            // Kung hindi turn ng player, or hindi pa nag-start ang game, or game over na,
            // 'legalTargetChipIds' ay mananatiling empty (walang iha-highlight)
        }
        // === END: RING LIGHT REQUEST (BAGONG FUNCTION) ===


        function resetPektus() { pektusOffset = { x: 0, y: 0 }; updatePektusUI(); }
        function updatePektusUI() { 
    const rect = pektusControl.getBoundingClientRect(); 
    const dotSize = pektusDot.offsetWidth; 
    
    // X Axis Logic (Kaliwa/Kanan)
    const maxOffsetX = (rect.width / 2) - 6; 
    const dotX = (rect.width / 2) + (pektusOffset.x * maxOffsetX) - (dotSize / 2); 
    
    // Y Axis Logic (Taas/Baba) - ETO ANG BAGO
    // Imbes na naka-lock sa gitna, nag-a-adjust na siya base sa pektusOffset.y
    const maxOffsetY = (rect.height / 2) - 6;
    const dotY = (rect.height / 2) + (pektusOffset.y * maxOffsetY) - (dotSize / 2); 
    
    pektusDot.style.left = `${dotX}px`; 
    pektusDot.style.top = `${dotY}px`; 
}        
        // START: Tutorial Functions
        function startTutorial(mode, difficultyLevel) {
            resizeCanvas(); 
            const allModals = [gameModeSelect, aiMenu, /*difficultySelect,*/ straightBallInstructions, pokerInstructions, sixtyOneInstructions, onlineGameSelect, onlineMenu, waitingRoom, winnerModal, confirmExitModal, pokerFoulCardPickModal, leaderboardModal]; 
            allModals.forEach(modal => modal.classList.remove('show')); 
            gameMode = mode; 
            isOnlineGame = false; 
            difficulty = difficultyLevel; 
            playerTurn = true; 
            canMoveCueBall = true; 
            chipsMoving = false; 
            colorsAssigned = false;
            playerChipsType = null;
            opponentChipsType = null;
            setupChips();
            isBreakShot = true;
            gameState = 'moving';
            cueStick.visible = true;
            resetPektus();
            updateInfoBox(); // Tatawagin nito ang updateLegalTargetChips()
            
            isTutorialActive = true;
            tutorialStep = -1;

            tutorialSteps = [
                {
                    key: 'welcome',
                    elementId: null,
                    text: "Welcome sa Pinoy Pool! Turuan kita ng basics.",
                    trigger: 'button'
                },
                {
                    key: 'place',
                    elementId: 'game-canvas',
                    text: "Unang hakbang: i-drag ang cue ball (puting bola) sa kahit saang pwesto sa likod ng invisible line.",
                    trigger: 'release-cue-ball'
                },
                {
                    key: 'aim',
                    elementId: 'game-canvas',
                    text: "Kita mo ang tako? I-drag mo ang iyong mouse o daliri sa mesa para umasinta.",
                    trigger: 'drag'
                },
                 {
                    key: 'pektus',
                    elementId: 'pektus-control',
                    text: "Gusto mo ng spin? I-drag ang pulang tuldok dito para sa 'pektus'!",
                    trigger: 'drag'
                },
                {
                    key: 'power',
                    elementId: 'power-control',
                    text: "Ito naman ang power bar. I-drag ito pababa para i-set ang lakas ng tira mo.",
                    trigger: 'drag'
                },
                {
                    key: 'shoot',
                    elementId: 'power-control',
                    text: "Ayos! Bitawan mo na ang power bar para tumira.",
                    trigger: 'release-power'
                },
                {
                    key: 'finish',
                    elementId: null,
                    text: "Nice shot! Ganyan lang kadali. Ikaw na ang bahala sa laro. Good luck!",
                    trigger: 'button'
                }
            ];
            
            nextTutorialStep();
        }

        function updateTutorialStep(index) {
    const step = tutorialSteps[index];
    if (!step) {
        endTutorial();
        return;
    }

    interactiveElements.forEach(el => el.style.pointerEvents = 'none');
    
    tutorialOverlay.classList.add('show');
    tutorialText.textContent = step.text;

    if (step.elementId) {
        const targetElement = document.getElementById(step.elementId);
        targetElement.style.pointerEvents = 'all';

        const rect = targetElement.getBoundingClientRect();
        
        tutorialHighlight.style.display = 'block';
        tutorialHighlight.style.left = `${rect.left}px`;
        tutorialHighlight.style.top = `${rect.top}px`;
        tutorialHighlight.style.width = `${rect.width}px`;
        tutorialHighlight.style.height = `${rect.height}px`;

        // --- START OF FIX ---
        // Logic to intelligently position the tutorial box

        // Get the height of the tutorial box itself.
        // We use a slight delay to ensure it has rendered and has a height.
        setTimeout(() => {
            const boxHeight = tutorialBox.offsetHeight;
            let boxTopPosition = rect.bottom + 20; // Default position: below the element

            // Check if positioning it below makes it go off-screen
            if (boxTopPosition + boxHeight > window.innerHeight) {
                // If so, try positioning it above the element
                boxTopPosition = rect.top - boxHeight - 20;
            }

            // After trying above/below, check if it's still going off the top of the screen (especially on landscape)
            if (boxTopPosition < 0) {
                // If it goes off the top, just center it on the screen as a fallback
                tutorialBox.style.top = '50%';
                tutorialBox.style.left = '50%';
                tutorialBox.style.transform = 'translate(-50%, -50%)';
            } else {
                // Otherwise, the calculated position is fine. Center it horizontally.
                tutorialBox.style.top = `${boxTopPosition}px`;
                tutorialBox.style.left = '50%';
                tutorialBox.style.transform = 'translateX(-50%)';
            }
        }, 0);
        // --- END OF FIX ---

    } else {
        tutorialHighlight.style.display = 'none';
        tutorialBox.style.top = '50%';
        tutorialBox.style.left = '50%';
        tutorialBox.style.transform = 'translate(-50%, -50%)';
    }

    if (step.trigger === 'button') {
        tutorialNextBtn.style.display = 'block';
        tutorialNextBtn.textContent = (step.key === 'finish') ? 'Tapusin ang Tutorial' : 'Sige';
    } else {
        tutorialNextBtn.style.display = 'none';
    }
}


        function nextTutorialStep() {
            if (!isTutorialActive) return;
            
            tutorialStep++;
            if (tutorialStep < tutorialSteps.length) {
                updateTutorialStep(tutorialStep);
            } else {
                endTutorial();
            }
        }

        function resetControlInteractivity() {
            interactiveElements.forEach(el => el.style.pointerEvents = 'all');
        }

        function endTutorial() {
            isTutorialActive = false;
            tutorialOverlay.classList.remove('show');
            resetControlInteractivity();
            localStorage.setItem('pinoyPoolTutorialCompleted', 'true');
            showMessage("Tutorial finished. Good luck!", 3000);
            
            if (playerTurn) {
                 // Simulate starting the game after tutorial
                 canMoveCueBall = false; // Player already placed the ball
                 gameState = 'aiming'; // Ready to aim
                 cueStick.visible = true;
                 if(cueStickElement) cueStickElement.style.display = 'block';
                 updateLegalTargetChips(); // Update highlights for the actual game
            }
        }
        
const DAILY_REWARD_AMOUNT = 500; // Magkano ang reward
const DAILY_REWARD_COOLDOWN = 24 * 60 * 60 * 1000; // 24 oras in milliseconds (pwede mong babaan for testing, e.g., 60000 for 1 minute)
let lastRewardClaimTime = 0;

function loadLastClaimTime() {
    const savedTime = localStorage.getItem('pinoyPoolLastRewardClaim');
    lastRewardClaimTime = savedTime ? parseInt(savedTime, 10) : 0;
    // Hindi na kailangan i-update dito, tatawagin ito ng showLobbyUI or init
}

function saveLastClaimTime() {
    lastRewardClaimTime = Date.now();
    localStorage.setItem('pinoyPoolLastRewardClaim', lastRewardClaimTime.toString());
}

function isDailyRewardAvailable() {
    const currentTime = Date.now();
    // Check kung ang lastRewardClaimTime ay valid (hindi 0)
    if (lastRewardClaimTime === 0) {
        return true; // Available kung hindi pa naka-claim kahit kailan
    }
    return currentTime >= (lastRewardClaimTime + DAILY_REWARD_COOLDOWN);
}

function updateDailyRewardButtonState() {
    const rewardButton = document.getElementById('daily-reward-button');
    if (!rewardButton) return;

    // Hanapin ang "dot" o label sa loob
    const label = rewardButton.querySelector('.dock-label');
    const icon = rewardButton.querySelector('.dock-icon');

    if (isDailyRewardAvailable()) {
        rewardButton.style.opacity = '1';
        if(icon) icon.innerHTML = 'üéÅ'; // Gift
        if(label) {
            label.textContent = 'Claim!';
            label.style.color = '#00FF00'; // Green text
        }
        rewardButton.onclick = claimDailyReward; // Re-attach click just in case
    } else {
        rewardButton.style.opacity = '0.7';
        if(label) {
            label.textContent = 'Wait...';
            label.style.color = '#aaa';
        }
        // Kalkulahin ang oras (optional visuals)
    }
}

// --- UPDATED CLAIM FUNCTION (Para sa Spin Wheel) ---
function claimDailyReward() {
    // 1. Check kung available pa ang reward
    if (isDailyRewardAvailable()) {
        playButtonSound();
        
        // 2. Hanapin ang Modal
        const modal = document.getElementById('daily-reward-modal');
        if (modal) {
            // 3. Ipakita ang Spin Wheel Modal
            modal.classList.add('show');
            
            // Add history state para gumana ang back button
            history.pushState({ modal: 'dailyRewardModal' }, 'Spin Wheel', '#spin');
            
            // 4. Reset ang Wheel UI (Para mukhang bago ulit)
            const spinStatus = document.getElementById('spin-status-text');
            const spinBtn = document.getElementById('spin-btn');
            
            if(spinStatus) spinStatus.innerHTML = "Spin to Win Coins!";
            if(spinBtn) {
                spinBtn.disabled = false;
                spinBtn.textContent = "SPIN!";
                spinBtn.style.opacity = "1";
            }
            
            // 5. I-drawing ulit ang wheel para fresh
            if(typeof drawWheel === 'function') {
                drawWheel();
            }
        }
    } else {
        // KUNG HINDI PA PWEDE (Cooldown)
        // Kalkulahin ang natitirang oras
        const remainingMs = (lastRewardClaimTime + DAILY_REWARD_COOLDOWN) - Date.now();
        const hours = Math.floor(remainingMs / (1000 * 60 * 60));
        const minutes = Math.floor((remainingMs % (1000 * 60 * 60)) / (1000 * 60));
        
        showMessage(`Reward available in ${hours}h ${minutes}m`, 3000);
    }
}

/**
 * Isinasara ang daily reward modal.
 */
function closeDailyRewardModal() {
    playButtonSound();
    const rewardModal = document.getElementById('daily-reward-modal');
    if (rewardModal) {
        rewardModal.classList.remove('show');
        // Hindi na kailangan mag history.back kung hindi nag push state
        // if (history.state && history.state.modal === 'dailyRewardModal') {
        //      history.back();
        // }
    }
}

async function saveCurrency() {
    if (!db || !localPlayerUid) return;
    // Tatawagin ang updatePlayerData pero 'false' sa didWin dahil currency update lang ito
    await updatePlayerData(localPlayerUid, false);
}
// ‚ñº‚ñº‚ñº UPDATED LOBBY LOGIC (WITH RANK CARD) ‚ñº‚ñº‚ñº

/**
 * Ito ang function na nag-cacalculate kung gaano kalayo ka na sa next rank.
 */
function updateLobbyRankDisplay() {
    const card = document.getElementById('lobby-rank-card');
    const iconEl = document.getElementById('lobby-rank-icon');
    const nameEl = document.getElementById('lobby-rank-name');
    const trophyEl = document.getElementById('lobby-trophy-count');
    const fillEl = document.getElementById('rank-progress-fill');
    const nextTextEl = document.getElementById('lobby-next-rank-text');

    if (!card) return;

    // Kunin ang current data
    const safeTrophies = (typeof playerTrophies !== 'undefined') ? playerTrophies : 0;
    const rankData = getPlayerRank(safeTrophies);
    const currentIndex = rankData.index;

    // Update Visuals
    iconEl.textContent = rankData.icon;
    nameEl.textContent = rankData.name;
    nameEl.style.color = rankData.color;
    trophyEl.textContent = `${safeTrophies} Trophies`;

    // Calculate Progress Bar
    // Tignan kung may "Next Rank" pa
    if (currentIndex < RANKS.length - 1) {
        const nextRank = RANKS[currentIndex + 1];
        const currentRankMin = RANKS[currentIndex].minTrophies;
        const nextRankMin = nextRank.minTrophies;

        // Formula: (Current - Min) / (Max - Min)
        const progress = ((safeTrophies - currentRankMin) / (nextRankMin - currentRankMin)) * 100;
        
        // Limitahan sa 0% - 100%
        const safeProgress = Math.max(0, Math.min(100, progress));
        
        fillEl.style.width = `${safeProgress}%`;
        nextTextEl.textContent = `Next: ${nextRank.name} (${nextRankMin})`;
    } else {
        // Max Rank na (Mythical)
        fillEl.style.width = '100%';
        nextTextEl.textContent = 'Max Rank Reached!';
    }
}

function showLobbyUI() {
    const lobbyScreen = document.getElementById('lobby-screen');
    
    // 1. Ipakita ang Lobby at I-set ang Theme (Background)
    if (lobbyScreen) {
        lobbyScreen.style.display = 'flex';

        // --- NEW: DYNAMIC LOBBY THEME ---
        // Kunin ang Rank Name
        const currentRankInfo = getPlayerRank(playerTrophies);
        const rName = currentRankInfo.name;

        // Reset: Tanggalin ang lumang themes
        lobbyScreen.classList.remove('theme-classic', 'theme-gold', 'theme-diamond', 'theme-mythical');

        // Apply: Ilagay ang bagong theme base sa Rank
        if (rName === 'Gold' || rName === 'Platinum') {
            lobbyScreen.classList.add('theme-gold');
        } 
        else if (rName === 'Diamond') {
            lobbyScreen.classList.add('theme-diamond');
        } 
        else if (rName === 'Legendary' || rName === 'Mythical') {
            lobbyScreen.classList.add('theme-mythical');
        } 
        else {
            // Default (Bronze/Silver)
            lobbyScreen.classList.add('theme-classic');
        }
    }

    // 2. Update Profile Info sa Top Bar (Name & Level)
    const nameEl = document.getElementById('lobby-player-name');
    const levelEl = document.getElementById('lobby-level-badge');
    
    // Kunin ulit ang Rank Info para sa texts at borders
    const rankInfo = getPlayerRank(playerTrophies); 

    if (nameEl) nameEl.textContent = localPlayerName || "Guest";
    if (levelEl) {
        levelEl.innerHTML = `${rankInfo.icon} Lv. ${playerLevel}`;
        levelEl.style.color = rankInfo.color;
    }

    // 3. Avatar Update (With Rank Borders)
    const avatarContainer = document.querySelector('.avatar-circle'); 
    const myPhoto = localStorage.getItem('pinoyPoolPlayerPhoto');
    
    if (avatarContainer) {
        avatarContainer.style.pointerEvents = 'auto'; 
        avatarContainer.style.zIndex = '100'; 
        avatarContainer.style.cursor = 'pointer';

        // --- BAGO: RESET AT APPLY RANK CLASS (BORDER) ---
        // I-reset muna sa default class
        avatarContainer.className = 'avatar-circle'; 
        
        // I-add ang Rank Class (e.g. rank-border-mythical)
        // Siguraduhing na-update mo na ang RANKS constant sa Step 2
        if (rankInfo.cssClass) {
            avatarContainer.classList.add(rankInfo.cssClass);
        } else {
            avatarContainer.classList.add('rank-border-bronze'); // Fallback
        }

        // TANGGALIN ang manual border style para CSS ang masunod
        avatarContainer.style.border = ''; 
        // ---------------------------------------

        // Load Photo or Default Icon
        if (myPhoto && myPhoto !== 'null' && myPhoto !== 'undefined') {
            avatarContainer.style.backgroundImage = `url('${myPhoto}')`;
            avatarContainer.style.backgroundSize = 'cover';
            avatarContainer.style.backgroundPosition = 'center';
            avatarContainer.innerHTML = ''; 
        } else {
            avatarContainer.style.backgroundImage = 'none';
            avatarContainer.innerHTML = 'üë§';
        }

        // Onclick Event (Open Profile)
        avatarContainer.onclick = function(e) {
            e.preventDefault();
            e.stopPropagation();
            if (typeof playButtonSound === 'function') playButtonSound();
            if (typeof showProfile === 'function') {
                showProfile('player'); 
            }
        };
    }

    // 4. Update Buttons & Currency & Rank Card
    updateDailyRewardButtonState(); 
    setCueForCurrentTurn(); 
    updateCurrencyDisplay();
    
    if (typeof updateLobbyRankDisplay === 'function') {
        updateLobbyRankDisplay();
    }
}
function hideLobbyUI() {
    const lobbyScreen = document.getElementById('lobby-screen');
    if (lobbyScreen) lobbyScreen.style.display = 'none';

    // Ipakita ang Exit button pag nasa game na
    const exitBtn = document.getElementById('exit-button');
    if (exitBtn) exitBtn.style.display = 'block';
}


function showGameUI() {
    hideLobbyUI(); // Siguraduhing tago ang lobby buttons

    // Ipakita ang mga game controls
    const gameControls = ['power-control', 'pektus-control', 'left-arrow', 'right-arrow', 'exit-button', 'player-info', 'opponent-info', 'cue-stick-element'];
    gameControls.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
             if (id.includes('-control') || id.includes('-arrow')) {
                 el.style.display = 'flex'; 
             } else if (id === 'cue-stick-element') {
                 if (gameState === 'aiming' || gameState === 'shooting_animation') {
                     el.style.display = 'block';
                 } else {
                     el.style.display = 'none';
                 }
             } else {
                 el.style.display = 'block'; 
             }
        }
    });

    // Handle Poker UI
    if (gameMode.includes('poker')) {
        const cardHand = document.getElementById('card-hand-container');
        if (cardHand) cardHand.style.display = 'flex';
    } else {
         const cardHand = document.getElementById('card-hand-container');
         if (cardHand) cardHand.style.display = 'none';
    }
    
    // Chat Button
     const chatToggle = document.getElementById('chat-toggle-button');
     if (chatToggle) chatToggle.style.display = isOnlineGame ? 'flex' : 'none'; 

    // ‚ñº‚ñº‚ñº ITO ANG FIX: IDINAGDAG KO ANG #friends-modal SA LISTAHAN ‚ñº‚ñº‚ñº
    // Kasama na rin ang #invite-popup-modal para sure
     const instructionModals = document.querySelectorAll('.instruction-modal, #ai-menu, #online-game-select, #online-menu, #invite-wait-modal, #friends-modal, #invite-popup-modal'); 
     instructionModals.forEach(modal => modal.classList.remove('show'));
}

async function showProfile(target) {
    playButtonSound();
    
    const modal = document.getElementById('profile-modal');
    
    // Elements
    const nameEl = document.getElementById('profile-name-display');
    const winsEl = document.getElementById('profile-wins-display');
    const levelEl = document.getElementById('profile-level-display');
    const cueImgEl = document.getElementById('profile-cue-preview');
    const cueNameEl = document.getElementById('profile-cue-name');
    
    const trophyIconEl = document.getElementById('profile-trophy-icon');
    const rankNameEl = document.getElementById('profile-rank-name');
    
    // PROGRESS BAR ELEMENTS (Bago)
    const rankFillEl = document.getElementById('profile-rank-fill');
    const rankNextTextEl = document.getElementById('profile-rank-next-text');
    
    const avatarImg = document.getElementById('profile-avatar-img');
    const defaultAvatar = document.getElementById('profile-avatar-default');
    const uploadBtn = document.getElementById('profile-upload-btn');

    let playerData = {};

    if (target === 'player') {
        // --- MY PROFILE ---
        const safeTrophies = (typeof playerTrophies !== 'undefined') ? playerTrophies : 0;
        const rankInfo = getPlayerRank(safeTrophies);
        
        // --- LOGIC PARA SA NEXT RANK (MATH) ---
        const currentIndex = rankInfo.index;
        let progressPercent = 100;
        let progressText = "Max Rank Reached!";

        // Check kung hindi pa Max Rank (Mythical)
        if (currentIndex < RANKS.length - 1) {
            const nextRank = RANKS[currentIndex + 1];
            const currentRankMin = RANKS[currentIndex].minTrophies;
            const nextRankMin = nextRank.minTrophies;

            // Kwentahin ang percentage
            // (Current - Base) / (Target - Base)
            const numerator = safeTrophies - currentRankMin;
            const denominator = nextRankMin - currentRankMin;
            
            // Iwas divide by zero
            if (denominator > 0) {
                progressPercent = (numerator / denominator) * 100;
            } else {
                progressPercent = 0;
            }
            
            // Limit sa 100%
            progressPercent = Math.max(0, Math.min(100, progressPercent));

            const needed = nextRankMin - safeTrophies;
            progressText = `${safeTrophies} / ${nextRankMin} (${needed} to ${nextRank.name})`;
        }

        // I-set ang UI
        if (rankFillEl) rankFillEl.style.width = `${progressPercent}%`;
        if (rankNextTextEl) rankNextTextEl.textContent = progressText;

        // Ipakita ang Upload Button
        if(uploadBtn) uploadBtn.style.display = 'flex';

        let myPhoto = localStorage.getItem('pinoyPoolPlayerPhoto');

        playerData = {
            name: localPlayerName,
            photo: myPhoto, 
            rankName: rankInfo.name,
            rankColor: rankInfo.color,
            rankIcon: rankInfo.icon,
            wins: "My Stats", 
            level: playerLevel,
            cueId: equippedItems.cue
        };

        // Fetch wins from DB
        if (localPlayerUid && db) {
             getDoc(doc(db, "players", localPlayerUid)).then(snap => {
                 if(snap.exists()) {
                     const data = snap.data();
                     if (winsEl) winsEl.textContent = data.wins || 0;
                     if (data.photo) {
                         if(avatarImg) {
                             avatarImg.src = data.photo;
                             avatarImg.style.display = 'block';
                             avatarImg.onclick = () => window.viewFullPhoto(data.photo);
                         }
                         if(defaultAvatar) defaultAvatar.style.display = 'none';
                         localStorage.setItem('pinoyPoolPlayerPhoto', data.photo);
                     }
                 }
             });
        }

    } else {
        // --- OPPONENT PROFILE ---
        if(uploadBtn) uploadBtn.style.display = 'none'; 
        
        // Hide progress bar pag kalaban ang tinitignan (kasi secret yun hehe)
        if(rankFillEl) rankFillEl.parentElement.style.display = 'none';
        if(rankNextTextEl) rankNextTextEl.style.display = 'none';

        if (!isOnlineGame) {
            // AI
            const botNameDisplay = (opponentPlayerName && opponentPlayerName !== "Opponent") ? opponentPlayerName : "AI Bot";
            playerData = {
                name: botNameDisplay,
                photo: null,
                rankName: "Computer",
                rankColor: "#aaa",
                rankIcon: "ü§ñ",
                wins: "‚àû",
                level: 99,
                cueId: 'default'
            };
        } else {
            // ONLINE
            const oppRankInfo = RANKS[opponentRankIndex] || RANKS[0];
            playerData = {
                name: opponentPlayerName,
                photo: window.opponentPhotoUrl || null, 
                rankName: oppRankInfo.name,
                rankColor: oppRankInfo.color,
                rankIcon: oppRankInfo.icon,
                wins: "?", 
                level: "?",
                cueId: opponentEquippedCueId || 'default'
            };
        }
    }

    // --- RENDER ---
    if(nameEl) nameEl.textContent = playerData.name;
    
    if(trophyIconEl) {
        trophyIconEl.textContent = playerData.rankIcon;
        trophyIconEl.style.filter = `drop-shadow(0 0 15px ${playerData.rankColor})`;
    }
    
    if(rankNameEl) {
        rankNameEl.textContent = playerData.rankName;
        rankNameEl.style.color = playerData.rankColor;
    }

    if(winsEl && target !== 'player') winsEl.textContent = playerData.wins;
    if(levelEl) levelEl.textContent = playerData.level;

    if (playerData.photo) {
        if(avatarImg) {
            avatarImg.src = playerData.photo;
            avatarImg.style.display = 'block';
            avatarImg.onclick = () => window.viewFullPhoto(playerData.photo);
        }
        if(defaultAvatar) defaultAvatar.style.display = 'none';
    } else {
        if(avatarImg) avatarImg.style.display = 'none';
        if(defaultAvatar) {
            defaultAvatar.style.display = 'flex';
            defaultAvatar.innerHTML = (target !== 'player' && !isOnlineGame) ? "ü§ñ" : "üë§";
        }
    }

    const cueItem = SHOP_ITEMS.cues.find(c => c.id === playerData.cueId) || SHOP_ITEMS.cues[0];
    if(cueImgEl) cueImgEl.style.backgroundImage = `url('${cueItem.imageSrc}')`;
    if(cueNameEl) cueNameEl.textContent = cueItem.name;

    // Ibalik ang visibility ng bar kung PLAYER ang tinitignan
    if (target === 'player') {
        if(rankFillEl) rankFillEl.parentElement.style.display = 'block';
        if(rankNextTextEl) rankNextTextEl.style.display = 'block';
    }

    modal.classList.add('show');
    history.pushState({ modal: 'profileModal' }, 'Profile', '#profile');
}
function triggerFireworks() {
    // Mag-spawn ng fireworks sa random locations
    for (let i = 0; i < 5; i++) {
        setTimeout(() => {
            createFireworkExplosion(
                canvas.width * (0.2 + Math.random() * 0.6), // Random X
                canvas.height * (0.2 + Math.random() * 0.5) // Random Y
            );
        }, i * 300); // Sunod-sunod na putok
    }
}

function createFireworkExplosion(x, y) {
    const particleCount = 50;
    const colors = ['#FFD700', '#FF0000', '#00FF00', '#00E5FF', '#FFFFFF'];
    
    for (let i = 0; i < particleCount; i++) {
        const angle = Math.random() * Math.PI * 2;
        const speed = Math.random() * 5 + 2;
        fireworks.push({
            x: x,
            y: y,
            vx: Math.cos(angle) * speed,
            vy: Math.sin(angle) * speed,
            alpha: 1,
            color: colors[Math.floor(Math.random() * colors.length)],
            size: Math.random() * 3 + 2
        });
    }
}

function updateAndDrawFireworks() {
    if (fireworks.length === 0) return;

    for (let i = fireworks.length - 1; i >= 0; i--) {
        let p = fireworks[i];
        
        // Physics
        p.x += p.vx;
        p.y += p.vy;
        p.vy += 0.1; // Gravity
        p.alpha -= 0.015; // Fade out

        // Draw
        ctx.globalAlpha = p.alpha;
        ctx.fillStyle = p.color;
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
        ctx.fill();
        ctx.globalAlpha = 1.0; // Reset alpha

        // Remove pag nawala na
        if (p.alpha <= 0) {
            fireworks.splice(i, 1);
        }
    }
}

function renderBetButtons() {
    const container = document.getElementById('bet-selection-container');
    if (!container) return;
    
    container.innerHTML = '';

    BET_TIERS.forEach(tier => {
        const btn = document.createElement('button');
        btn.className = 'menu-button';
        btn.style.padding = '8px 5px';
        btn.style.fontSize = '0.75em';
        btn.style.minWidth = '70px';
        btn.style.display = 'flex';
        btn.style.flexDirection = 'column';
        btn.style.alignItems = 'center';
        btn.style.margin = '2px';
        
        const displayAmount = tier.amount > 0 ? formatCurrencyShort(tier.amount) : 'FREE';
        
        btn.innerHTML = `<span style="font-size:1.5em; margin-bottom:2px;">${tier.icon}</span>${tier.name}<br><span style="color:#FFD700; font-weight:bold;">${displayAmount}</span>`;
        
        if (selectedBetAmount === tier.amount) {
            btn.style.border = '2px solid #00FF00';
            btn.style.background = 'rgba(40, 167, 69, 0.6)'; 
            btn.style.transform = 'scale(1.05)';
        } else {
            btn.style.border = '1px solid rgba(255,255,255,0.2)';
            btn.style.background = 'rgba(0,0,0,0.3)';
            btn.style.opacity = '0.7';
        }

        btn.onclick = () => {
            playButtonSound();

            // ‚ñº‚ñº‚ñº DITO ANG BAGONG ANTI-SMURF CHECK ‚ñº‚ñº‚ñº
            // Sinisigurado nito na hindi makakapasok ang High Rank sa Low Bet

            // Rule 1: Gold Rank+ (1500 Trophies) bawal na sa Free Play (Tambay Lane)
            if (tier.amount === 0 && playerTrophies >= 1500) {
                showMessage("üö´ Gold Rank+ cannot play in Free/Tambay Lane!", 2500);
                return; // Stop! Wag ituloy ang pag-select
            }

            // Rule 2: Mythical Rank (20000 Trophies) bawal sa 100 Coins (Barangay Cup)
            if (tier.amount === 100 && playerTrophies >= 20000) {
                showMessage("üö´ Mythical players must bet high!", 2500);
                return; // Stop!
            }
            // ‚ñ≤‚ñ≤‚ñ≤ ‚ñ≤‚ñ≤‚ñ≤

            selectedBetAmount = tier.amount;
            
            // Update Status Text
            const statusText = document.getElementById('bet-status-text');
            if (statusText) {
                if (tier.amount > 0) {
                    const pot = tier.amount * 2;
                    const tong = pot * HOUSE_CUT_PERCENTAGE;
                    const win = pot - tong;
                    statusText.innerHTML = `Pot: <span style="color:#fff">${formatCurrencyShort(pot)}</span> | Win: <span style="color:#00FF00">${formatCurrencyShort(win)}</span> <small>(Tong: ${formatCurrencyShort(tong)})</small>`;
                } else {
                    statusText.textContent = "Current Pot: Free Play (No Risk)";
                }
            }

            // Update Button Texts
            const createBtn = document.getElementById('create-game-button');
            const findBtn = document.getElementById('find-match-button');
            
            if (tier.amount > 0) {
                const amt = formatCurrencyShort(tier.amount);
                if(createBtn) createBtn.innerHTML = `CREATE <span style="color:#FFD700">(${amt})</span>`;
                if(findBtn) findBtn.innerHTML = `FIND MATCH <span style="color:#FFD700">(${amt})</span>`;
            } else {
                if(createBtn) createBtn.textContent = "Create Private";
                if(findBtn) findBtn.textContent = "FIND MATCH";
            }

            renderBetButtons(); 
        };

        container.appendChild(btn);
    });
}
function renderInviteBetButtons() {
    const container = document.getElementById('invite-bet-container');
    if (!container) return;
    
    container.innerHTML = '';

    BET_TIERS.forEach(tier => {
        const btn = document.createElement('button');
        btn.className = 'menu-button';
        btn.style.padding = '6px 4px';
        btn.style.fontSize = '0.7em';
        btn.style.minWidth = '60px';
        btn.innerHTML = `${tier.icon}<br>${tier.amount > 0 ? formatCurrencyShort(tier.amount) : 'FREE'}`;
        
        // Highlight logic
        if (selectedBetAmount === tier.amount) {
            btn.style.border = '2px solid #00FF00';
            btn.style.background = 'rgba(40, 167, 69, 0.6)';
        } else {
            btn.style.border = '1px solid rgba(255,255,255,0.2)';
            btn.style.background = 'rgba(0,0,0,0.3)';
        }

        btn.onclick = () => {
            playButtonSound();

            // ‚ñº‚ñº‚ñº ANTI-SMURF CHECK FOR INVITES ‚ñº‚ñº‚ñº
            // Rule 1: Gold Rank+ (1500+) bawal mag-invite sa Free Play
            if (tier.amount === 0 && playerTrophies >= 1500) {
                showMessage("üö´ Gold Rank+ cannot invite to Free Match!", 2500);
                return;
            }

            // Rule 2: Mythical Rank (20000+) bawal mag-invite sa 100 Coins
            if (tier.amount === 100 && playerTrophies >= 20000) {
                showMessage("üö´ Mythical players must invite with high bets!", 2500);
                return;
            }
            // ‚ñ≤‚ñ≤‚ñ≤ ‚ñ≤‚ñ≤‚ñ≤

            selectedBetAmount = tier.amount; // Update global bet variable
            
            // Update text
            const statusEl = document.getElementById('invite-bet-status');
            if(statusEl) statusEl.innerHTML = tier.amount > 0 ? `Bet: <span style="color:#00FF00">${formatCurrencyShort(tier.amount)}</span>` : "Bet: Free Play";
            
            renderInviteBetButtons(); // Re-render para lumipat ang highlight
        };

        container.appendChild(btn);
    });
}
let currentChatUnsubscribe = null;
let currentChatFriendUid = null;

function getChatId(uid1, uid2) {
    return [uid1, uid2].sort().join("_");
}

// 2. Function para buksan ang Chat Modal
function openPrivateChat(friendUid, friendName) {
    if (!localPlayerUid) return;
    
    // I-save kung sino ang ka-chat
    currentChatFriendUid = friendUid;
    clearChatNotification(friendUid);
    
    // Ipakita ang Modal
    const modal = document.getElementById('private-chat-modal');
    const title = document.getElementById('private-chat-title');
    const historyDiv = document.getElementById('private-chat-history');
    
    title.textContent = friendName;
    modal.classList.add('show');

if (typeof tg !== 'undefined') {
        tg.BackButton.show();
    }
    // ‚ñº‚ñº‚ñº DAGDAG: HISTORY FIX PARA HINDI MAG-EXIT ANG GAME ‚ñº‚ñº‚ñº
    history.pushState({ modal: 'privateChatModal' }, 'Chat', '#chat'); 
    // ‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤

    historyDiv.innerHTML = '<div style="text-align: center; opacity: 0.5; margin-top: 20px;">Loading conversation...</div>';
    
    // Simulan ang pakikinig sa messages
    listenToPrivateChat(friendUid);

    // ‚ñº‚ñº‚ñº DAGDAG: SAFE CLOSE BUTTON (Para mag-sync sa Back Button) ‚ñº‚ñº‚ñº
    // Siguraduhing may function ka na `attachSafeCloseListener` sa baba ng code mo
    if (typeof attachSafeCloseListener === 'function') {
        attachSafeCloseListener('private-chat-close', 'private-chat-modal');
    }
    // ‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤
}
// 3. Listener: Makinig sa mga bagong messages
function listenToPrivateChat(friendUid) {
    if (currentChatUnsubscribe) currentChatUnsubscribe(); // Stop previous listener
    
    const chatId = getChatId(localPlayerUid, friendUid);
    const messagesRef = collection(db, "private_chats", chatId, "messages");
    
    // Kunin ang last 50 messages, ordered by time
    const q = query(messagesRef, orderBy("timestamp", "asc"), limit(50));
    
    currentChatUnsubscribe = onSnapshot(q, (snapshot) => {
        const historyDiv = document.getElementById('private-chat-history');
        historyDiv.innerHTML = ''; // Clear muna
        
        if (snapshot.empty) {
            historyDiv.innerHTML = '<div style="text-align: center; opacity: 0.5; margin-top: 50px;">No messages yet.<br>Say Hi! üëã</div>';
            return;
        }
        
        snapshot.forEach((doc) => {
            const data = doc.data();
            const isMe = data.senderId === localPlayerUid;
            
            // Gumawa ng Bubble
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${isMe ? 'me' : 'friend'}`;
            
            // Format Time (e.g., 10:30 AM)
            let timeStr = "";
            if (data.timestamp) {
                const date = data.timestamp.toDate();
                timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }
            
            bubble.innerHTML = `${data.text} <span class="chat-time">${timeStr}</span>`;
            historyDiv.appendChild(bubble);
        });
        
        // Auto-scroll sa pinakababa
        historyDiv.scrollTop = historyDiv.scrollHeight;
    });
}

// 4. Function: Mag-send ng Message
async function sendPrivateMessage() {
    const input = document.getElementById('private-chat-input');
    const text = input.value.trim();
    
    if (!text || !currentChatFriendUid) return;
    
    const chatId = getChatId(localPlayerUid, currentChatFriendUid);
    const messagesRef = collection(db, "private_chats", chatId, "messages");
    
    try {
        input.value = ''; // Clear input agad
        await addDoc(messagesRef, {
            text: text,
            senderId: localPlayerUid,
            timestamp: serverTimestamp()
        });
        playButtonSound();
    } catch (error) {
        console.error("Error sending message:", error);
    }
}

// 5. Setup Listeners (Close, Send, Enter Key)
document.getElementById('private-chat-close').addEventListener('click', () => {
    document.getElementById('private-chat-modal').classList.remove('show');
    if (currentChatUnsubscribe) currentChatUnsubscribe(); // Stop listening para tipid sa data
});

document.getElementById('private-chat-send-btn').addEventListener('click', sendPrivateMessage);

document.getElementById('private-chat-input').addEventListener('keyup', (e) => {
    if (e.key === 'Enter') sendPrivateMessage();
});

// Global storage para sa listeners (para hindi mag-doble)
const activeChatListeners = {};

function monitorFriendChat(friendUid, friendName, btnElement) {
    if (!localPlayerUid || !friendUid) return;

    // Gumawa ng ID para sa badge (Red Dot)
    const badgeId = `badge-${friendUid}`;
    
    // Check kung may badge na, kung wala, gumawa
    let badge = btnElement.querySelector('.chat-badge');
    if (!badge) {
        badge = document.createElement('div');
        badge.className = 'chat-badge';
        badge.id = badgeId;
        btnElement.appendChild(badge);
    }

    // Kung nakikinig na tayo sa friend na 'to, wag na ulitin
    if (activeChatListeners[friendUid]) return;

    const chatId = getChatId(localPlayerUid, friendUid);
    const messagesRef = collection(db, "private_chats", chatId, "messages");
    
    // Kunin lang ang PINAKABAGONG message
    const q = query(messagesRef, orderBy("timestamp", "desc"), limit(1));

    let isFirstLoad = true; 

    // Simulan ang pakikinig
    activeChatListeners[friendUid] = onSnapshot(q, (snapshot) => {
        if (!snapshot.empty) {
            const data = snapshot.docs[0].data();
            
            // --- AUTO SORT LOGIC ---
            let timestamp = 0;
            if (data.timestamp) {
                // Safety check para sa timestamp
                timestamp = data.timestamp.toMillis ? data.timestamp.toMillis() : Date.now();
            }

            // Hanapin ang item sa listahan at i-update ang oras
            const friendItem = document.querySelector(`.friend-item[data-friend-uid="${friendUid}"]`);
            if (friendItem) {
                const oldTime = parseInt(friendItem.getAttribute('data-last-msg-time') || 0);
                
                // Kung mas bago ang message na ito, update at sort!
                if (timestamp > oldTime) {
                    friendItem.setAttribute('data-last-msg-time', timestamp);
                    sortFriendsList(); // <--- AAKYAT NA SIYA DITO!
                }
            }
            // --- END SORT LOGIC ---
            
            // Kung HINDI ikaw ang sender (ibig sabihin galing sa friend)
            if (data.senderId !== localPlayerUid) {
                
                // 1. Ipakita ang Red Dot
                const currentBadge = document.getElementById(badgeId);
                if (currentBadge) currentBadge.style.display = 'block';

                // 2. Ipakita ang Popup Notification (Kung bagong dating lang)
                if (!isFirstLoad) {
                    playButtonSound(); 
                    showMessage(`üí¨ ${friendName}: ${data.text}`, 4000);
                }
            }
        }
        isFirstLoad = false;
    });
}
// Function para mawala ang Red Dot pag binuksan ang chat
function clearChatNotification(friendUid) {
    const badge = document.getElementById(`badge-${friendUid}`);
    if (badge) {
        badge.style.display = 'none';
    }
}

// Function para i-reorder ang friends list (Newest message on top)
function sortFriendsList() {
    const container = document.getElementById('friends-list-accepted');
    if (!container) return;

    // 1. Kunin lahat ng items at gawing Array
    const items = Array.from(container.children);

    // 2. Paghambingin base sa 'data-last-msg-time'
    items.sort((a, b) => {
        const timeA = parseInt(a.getAttribute('data-last-msg-time') || 0);
        const timeB = parseInt(b.getAttribute('data-last-msg-time') || 0);
        // Descending order (Pinakabago sa taas)
        return timeB - timeA; 
    });

    // 3. Ibalik sa container (Re-append para ma-reorder)
    items.forEach(item => container.appendChild(item));
}

const settingsModal = document.getElementById('settings-modal');
const settingsBtn = document.getElementById('main-settings-btn');
const settingsCloseBtn = document.getElementById('settings-close-btn');

// Toggles
const musicToggle = document.getElementById('setting-music-toggle');
const sfxToggle = document.getElementById('setting-sfx-toggle');
const fsToggle = document.getElementById('setting-fullscreen-toggle');

// Global Mute State for SFX
window.isSfxMuted = false; 

if (settingsBtn) {
    settingsBtn.addEventListener('click', () => {
        playButtonSound();
        settingsModal.classList.add('show');
        history.pushState({ modal: 'settingsModal' }, 'Settings', '#settings');
        
        // Sync Visuals
        if(musicToggle) musicToggle.checked = !backgroundPlaylist[0].muted;
        if(fsToggle) fsToggle.checked = !!document.fullscreenElement;
        if(sfxToggle) sfxToggle.checked = !window.isSfxMuted;
    });
}

if (settingsCloseBtn) {
    settingsCloseBtn.addEventListener('click', () => {
        playButtonSound();
        history.back(); // Gamitin ang history back
    });
}

// 2. TOGGLE MUSIC
if (musicToggle) {
    musicToggle.addEventListener('change', () => {
        const isMuted = !musicToggle.checked;
        backgroundPlaylist.forEach(player => { player.muted = isMuted; });
    });
}

// 3. TOGGLE SFX (Overwrite existing sound functions if needed)
if (sfxToggle) {
    sfxToggle.addEventListener('change', () => {
        window.isSfxMuted = !sfxToggle.checked;
        
        // I-mute ang Tone.js destination kung OFF
        if (typeof Tone !== 'undefined') {
            Tone.Destination.mute = window.isSfxMuted;
        }
    });
}

// 4. TOGGLE FULLSCREEN
if (fsToggle) {
    fsToggle.addEventListener('change', () => {
        toggleFullScreen();
    });
}

const forceSettingsCloseBtn = document.getElementById('settings-close-btn');
const settingsModalEl = document.getElementById('settings-modal');

if (forceSettingsCloseBtn) {
    // Tanggalin ang lumang listener para iwas doble (clone trick)
    const newBtn = forceSettingsCloseBtn.cloneNode(true);
    forceSettingsCloseBtn.parentNode.replaceChild(newBtn, forceSettingsCloseBtn);

    // Ikabit ang bagong listener
    newBtn.addEventListener('click', (e) => {
        e.stopPropagation(); // Pigilan ang ibang elements
        playButtonSound();
        
        // 1. Isara gamit ang class removal (Sureball)
        if (settingsModalEl) settingsModalEl.classList.remove('show');
        
        // 2. Subukang gamitin ang history back kung pwede
        if (history.state && history.state.modal === 'settingsModal') {
            history.back();
        }
    });
}


const fixProfileCloseBtn = document.getElementById('profile-close-btn');
const profileModalEl = document.getElementById('profile-modal');

if (fixProfileCloseBtn) {
    // 1. Clone para tanggalin ang lumang listeners
    const newProfileBtn = fixProfileCloseBtn.cloneNode(true);
    fixProfileCloseBtn.parentNode.replaceChild(newProfileBtn, fixProfileCloseBtn);

    // 2. Ikabit ang Safe Listener
    newProfileBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        playButtonSound();
        
        // Manual hide muna para smooth
        if (profileModalEl) profileModalEl.classList.remove('show');
        
        // Check history state bago mag-back
        if (history.state && history.state.modal === 'profileModal') {
            history.back(); // Ito ang magti-trigger ng onpopstate
        } else {
            // Fallback kung sira ang history: Isara lang at ibalik ang game state
            gameState = 'aiming'; 
        }
    });
}

function attachSafeCloseListener(btnId, modalId) {
    const btn = document.getElementById(btnId);
    const modal = document.getElementById(modalId);

    if (btn) {
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);

        newBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            // Check kung may sound function bago tawagin para iwas error
            if (typeof playButtonSound === 'function') playButtonSound();

            // 1. ITAAS ANG FLAG! (Safe ito!)
            window.isClosingModal = true; 

            // 2. SET STATE (ITO ANG FIX) ‚úÖ
            // Check natin kung nasa laro ka ba o nasa menu
            if (typeof gameMode !== 'undefined' && (gameMode === 'online' || gameMode === 'practice')) {
                gameState = 'playing'; // Kung naglalaro, resume game
            } else {
                gameState = 'menu';    // Kung nasa labas, balik sa menu
            }

            // 3. Hide Modal
            if (modal) modal.classList.remove('show');

            // 4. Trigger Back
            history.back();
        });
    }
}

// Apply
attachSafeCloseListener('profile-close-btn', 'profile-modal');
attachSafeCloseListener('settings-close-btn', 'settings-modal');
        
const assetsToLoad = [
    // 1. Audio Files (Music & SFX)
    'https://arnoldtasipit66-wq.github.io/my-game-assets/mrbas-music-labs-roots-reggae-285790.mp3',
    'https://arnoldtasipit66-wq.github.io/my-game-assets/coin-dropped-81172.mp3',
    'https://arnoldtasipit66-wq.github.io/my-game-assets/win.mp3',
    'https://arnoldtasipit66-wq.github.io/my-game-assets/lose.mp3',

    // 2. Static Images
    'https://i.imgur.com/Wg3y3Zn.jpeg', // Background Floor
    'https://raw.githubusercontent.com/arnoldtasipit66-wq/my-game-assets/refs/heads/main/Gemini_Generated_Image_qtberbqtberbqtbe.png', // Wood Texture (UPDATED NA)
    'https://i.imgur.com/yCvO16j.png', // Ghost Hand
    'https://i.imgur.com/FYXWKhr.png', // Default Cue Stick
];
// 3. Dynamic Images (Galing sa Shop Items)
// Kinukuha natin lahat ng imageSrc mula sa SHOP_ITEMS object mo
if (typeof SHOP_ITEMS !== 'undefined') {
    if (SHOP_ITEMS.cues) SHOP_ITEMS.cues.forEach(item => assetsToLoad.push(item.imageSrc));
    if (SHOP_ITEMS.frames) SHOP_ITEMS.frames.forEach(item => assetsToLoad.push(item.imageSrc));
    if (SHOP_ITEMS.felts) SHOP_ITEMS.felts.forEach(item => assetsToLoad.push(item.imageSrc));
}

let loadedCount = 0;
const totalAssets = assetsToLoad.length;
const loadingText = document.getElementById('loading-text');
const spinner = document.querySelector('.loader-spinner');
const startBtn = document.getElementById('start-game-btn');
const preloaderOverlay = document.getElementById('preloader-overlay');

function updateProgress() {
    loadedCount++;
    const percent = Math.floor((loadedCount / totalAssets) * 100);
    loadingText.textContent = `Loading Assets... ${percent}%`;

    if (loadedCount >= totalAssets) {
        onLoadingComplete();
    }
}

function preloadImage(src) {
    const img = new Image();
    img.src = src;
    img.onload = updateProgress;
    img.onerror = () => {
        console.warn("Failed to load image:", src);
        updateProgress(); // Ituloy pa rin kahit fail para di ma-stuck
    };
}

// Simpleng fetch para sa audio para masiguradong cached
function preloadAudio(src) {
    const audio = new Audio();
    audio.src = src;
    audio.oncanplaythrough = updateProgress;
    audio.onerror = () => {
        // Fallback: Minsan strict ang browser sa audio download, ituloy lang
        console.warn("Audio preload skip:", src);
        updateProgress();
    };
    // Force load
    audio.load();
}

function startPreloading() {
    console.log(`Starting preload of ${totalAssets} assets...`);
    
    if (totalAssets === 0) {
        onLoadingComplete();
        return;
    }

    assetsToLoad.forEach(src => {
        if (src.endsWith('.mp3') || src.endsWith('.wav')) {
            // Audio loading strategy (Simple fetch for caching)
            fetch(src).then(updateProgress).catch(updateProgress);
        } else {
            preloadImage(src);
        }
    });
}

function onLoadingComplete() {
    loadingText.textContent = "Game Ready!";
    spinner.style.display = 'none'; // Tago spinner
    startBtn.style.display = 'block'; // Pakita Start Button
}

// Listener para sa Start Button
startBtn.addEventListener('click', async () => {
    // 1. Initialize Audio Context (Tone.js)
    // Ito ang solusyon para gumana ang sounds sa mobile/Chrome
    if (typeof Tone !== 'undefined') {
        await Tone.start();
        console.log('Audio Context Started via Preloader');
    }
    
    // 2. Initialize Background Music (Kung meron)
    playBackgroundMusic();

    // 3. Fade Out Preloader
    preloaderOverlay.classList.add('hidden');
    
    // 4. Start the Actual Game Logic
    // Dito natin tatawagin ang original init() function mo
    init();
    
    // Tanggalin sa DOM pagtapos ng animation para tipid sa memory
    setTimeout(() => {
        preloaderOverlay.remove();
    }, 600);
});

// Simulan ang proseso
// --- üõ°Ô∏è SAFETY TIMER (FIX SA 76% STUCK) ---
// Kapag lumampas ng 7 seconds at naglo-load pa rin, pilitin nang tapusin.
setTimeout(() => {
    const loadingDiv = document.getElementById('preloader-overlay');
    // Check kung nakaharang pa rin ang loading screen
    if (loadingDiv && !loadingDiv.classList.contains('hidden')) {
        console.warn("Loading too slow! Forcing start...");
        
        // I-update ang text para alam ng user
        const loadText = document.getElementById('loading-text');
        if(loadText) loadText.textContent = "Taking too long... Force Starting!";
        
        // Pilitin tapusin ang loading
        loadedCount = totalAssets; 
        onLoadingComplete();
    }
}, 7000); // 7000ms = 7 seconds waiting time

// Simulan ang proseso (Normal Start)
startPreloading();


 // --- PROFILE PICTURE UPLOAD LOGIC ---

// 1. Setup Listeners pag-load ng game
document.addEventListener('DOMContentLoaded', () => {
    const uploadBtn = document.getElementById('profile-upload-btn');
    const fileInput = document.getElementById('profile-file-input');

    if (uploadBtn && fileInput) {
        // Pag pinindot ang Camera icon, buksan ang file selector
        uploadBtn.addEventListener('click', () => {
            playButtonSound();
            fileInput.click();
        });

        // Pag nakapili na ng file
        fileInput.addEventListener('change', handleProfileUpload);
    }
});

function handleProfileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    // Loading indicator
    const avatarImg = document.getElementById('profile-avatar-img');
    const defaultAvatar = document.getElementById('profile-avatar-default');
    if(defaultAvatar) defaultAvatar.innerHTML = "‚è≥"; 

    const reader = new FileReader();
    reader.onload = function(e) {
        const img = new Image();
        img.src = e.target.result;

        img.onload = function() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            // --- ULTRA CLEAR SETTINGS ---
            // Tinaasan natin from 512 -> 1024 (HD na ito)
            const MAX_SIZE = 1024; 
            let width = img.width;
            let height = img.height;

            // Resize logic (Maintain aspect ratio)
            if (width > height) {
                if (width > MAX_SIZE) {
                    height *= MAX_SIZE / width;
                    width = MAX_SIZE;
                }
            } else {
                if (height > MAX_SIZE) {
                    width *= MAX_SIZE / height;
                    height = MAX_SIZE;
                }
            }

            canvas.width = width;
            canvas.height = height;
            
            // --- CRITICAL: FORCE HIGH QUALITY RENDERING ---
            // Ito ang nagpapakinis ng pixels
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';

            ctx.drawImage(img, 0, 0, width, height);

            // --- QUALITY CONTROL ---
            // 0.98 = 98% Quality (Halos Original na)
            // Huwag nating gawing 1.0 (100%) dahil baka sumabog ang database limit.
            let compressedDataUrl = canvas.toDataURL('image/jpeg', 0.98);

            // --- SAFETY CHECK: 1MB LIMIT (Firestore Restriction) ---
            // Kung sobra sa 1MB ang HD picture, babawasan natin konti ang quality
            // para pumasok sa database, pero malinaw pa rin.
            let quality = 0.98;
            while (compressedDataUrl.length > 1000000 && quality > 0.5) {
                quality -= 0.05;
                compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                console.log("Adjusting quality to fit database...", quality);
            }

            // --- SAVE STEP ---
            if (localPlayerUid && db) {
                const playerRef = doc(db, "players", localPlayerUid);
                
                updateDoc(playerRef, {
                    photo: compressedDataUrl
                }).then(() => {
                    showMessage("HD Photo Updated!", 2000);
                    
                    if(avatarImg) {
                        avatarImg.src = compressedDataUrl;
                        avatarImg.style.display = 'block';
                    }
                    if(defaultAvatar) defaultAvatar.style.display = 'none';
                    
                    localStorage.setItem('pinoyPoolPlayerPhoto', compressedDataUrl);
                    
                    // Force Refresh Lobby
                    if (typeof showLobbyUI === 'function') showLobbyUI(); 

                }).catch((error) => {
                    console.error("Upload failed:", error);
                    showMessage("Error saving. Try a different photo.", 3000);
                    if(defaultAvatar) defaultAvatar.innerHTML = "üë§";
                });
            }
        }
    };
    reader.readAsDataURL(file);
}

// --- RANK UP SYSTEM ---

function showRankUpScreen(newRankIndex) {
    const modal = document.getElementById('rank-up-modal');
    const iconEl = document.getElementById('rank-up-icon');
    const nameEl = document.getElementById('rank-up-name');
    const rewardEl = document.getElementById('rank-up-reward-text');
    const claimBtn = document.getElementById('rank-up-claim-btn');

    if (!modal) return;

    // 1. Get Rank Data
    const rankData = RANKS[newRankIndex];
    
    // 2. Update Content
    iconEl.textContent = rankData.icon;
    nameEl.textContent = rankData.name;
    nameEl.style.color = rankData.color;
    nameEl.style.textShadow = `0 5px 0 #000, 0 0 30px ${rankData.color}`;
    
    // 3. Reward Logic (Formula: 1000 * Rank Index)
    // Example: Silver (index 1) = 1000, Gold (index 2) = 2000
    const rewardAmount = 1000 * newRankIndex; 
    
    if(rewardAmount > 0) {
        rewardEl.style.display = 'block';
        rewardEl.innerHTML = `Rank Bonus: <span style="color:#FFD700">üí∞ ${rewardAmount}</span>`;
        
        // Add coins automatically
        playerTotalCurrency += rewardAmount;
        saveCurrency();
        updateCurrencyDisplay();
    } else {
        rewardEl.style.display = 'none'; // Walang reward pag Bronze (Start)
    }

    // 4. Reset Animations (Trick para umulit ang animation pag binuksan ulit)
    iconEl.classList.remove('rank-pop-anim');
    void iconEl.offsetWidth; // Trigger reflow
    iconEl.classList.add('rank-pop-anim');

    nameEl.classList.remove('rank-text-slide');
    void nameEl.offsetWidth;
    nameEl.classList.add('rank-text-slide');

    // 5. Play Epic Sound (Fanfare using Tone.js)
    if (typeof Tone !== 'undefined' && audioInitialized && uiSynth) {
        const now = Tone.now();
        // Fanfare Sequence: C4 - E4 - G4 - C5 (Fast Arpeggio)
        try {
            uiSynth.triggerAttackRelease("C4", "16n", now);
            uiSynth.triggerAttackRelease("E4", "16n", now + 0.1);
            uiSynth.triggerAttackRelease("G4", "16n", now + 0.2);
            uiSynth.triggerAttackRelease("C5", "2n", now + 0.3); // Long last note
        } catch(e) {}
    }

    // 6. Show Modal & Fireworks
    modal.classList.add('show');
    if (typeof triggerFireworks === 'function') triggerFireworks(); 
    
    // 7. Close Button Listener (Manual Close)
    claimBtn.onclick = function() {
        if (typeof playButtonSound === 'function') playButtonSound();
        modal.classList.remove('show');
    };

    // ‚ñº‚ñº‚ñº 8. AUTO CLOSE TIMER (6 Seconds) ‚ñº‚ñº‚ñº
    // Ito ang magsasara ng kusa pagtapos ng anim na segundo
    setTimeout(() => {
        if (modal.classList.contains('show')) {
            modal.classList.remove('show');
        }
    }, 6000); 
    // ‚ñ≤‚ñ≤‚ñ≤ ‚ñ≤‚ñ≤‚ñ≤
}

/* ========================================= */
/* üé° SPIN WHEEL LOGIC (IDINAGDAG)        üé° */
/* ========================================= */

const spinCanvas = document.getElementById('spin-wheel-canvas');
const spinCtx = spinCanvas ? spinCanvas.getContext('2d') : null;
const spinBtn = document.getElementById('spin-btn');
const spinStatus = document.getElementById('spin-status-text');

// Mga Premyo
const SEGMENTS = [
    { text: "100",  color: "#FF5733", value: 100 },
    { text: "500",  color: "#33FF57", value: 500 },
    { text: "250",  color: "#3357FF", value: 250 },
    { text: "1000", color: "#FFD700", value: 1000 }, 
    { text: "50",   color: "#FF33A1", value: 50 },
    { text: "2000", color: "#00E5FF", value: 2000 }, 
    { text: "150",  color: "#A133FF", value: 150 },
    { text: "750",  color: "#FF8C00", value: 750 }
];

let wheelAngle = 0;       
let wheelVelocity = 0;    
let isSpinning = false;

function drawWheel() {
    if (!spinCtx) return;
    const centerX = spinCanvas.width / 2;
    const centerY = spinCanvas.height / 2;
    const radius = spinCanvas.width / 2 - 10; 
    const arcSize = (2 * Math.PI) / SEGMENTS.length;

    spinCtx.clearRect(0, 0, spinCanvas.width, spinCanvas.height);

    spinCtx.save();
    spinCtx.translate(centerX, centerY);
    spinCtx.rotate(wheelAngle);

    SEGMENTS.forEach((seg, i) => {
        const angle = i * arcSize;
        spinCtx.beginPath();
        spinCtx.moveTo(0, 0);
        spinCtx.arc(0, 0, radius, angle, angle + arcSize);
        spinCtx.fillStyle = seg.color;
        spinCtx.fill();
        spinCtx.stroke(); 

        spinCtx.save();
        spinCtx.rotate(angle + arcSize / 2);
        spinCtx.textAlign = "right";
        spinCtx.fillStyle = "#fff";
        spinCtx.font = "bold 18px Arial";
        spinCtx.shadowColor = "black";
        spinCtx.shadowBlur = 4;
        spinCtx.fillText(seg.text, radius - 20, 5); 
        spinCtx.restore();
    });
    spinCtx.restore();
}

function startSpin() {
    if (isSpinning) return;
    if (!isDailyRewardAvailable()) {
        showMessage("Wait for cooldown!", 2000);
        return;
    }

    playButtonSound();
    isSpinning = true;
    spinBtn.disabled = true;
    spinBtn.style.opacity = "0.5";
    spinStatus.textContent = "Spinning...";

    wheelVelocity = 0.3 + Math.random() * 0.3; 
    animateSpin();
}

function animateSpin() {
    // 1. Friction: Dati 0.985, ginawang 0.96 para mas mabilis bumagal
    wheelVelocity *= 0.96; 

    wheelAngle += wheelVelocity;
    drawWheel();

    // 2. Cutoff: Dati 0.002, ginawang 0.005 para huminto agad pag mabagal na
    if (wheelVelocity < 0.005) {
        finishSpin();
    } else {
        requestAnimationFrame(animateSpin);
    }
}
function finishSpin() {
    isSpinning = false;
    wheelVelocity = 0;
    
    const arcSize = (2 * Math.PI) / SEGMENTS.length; // Sukat ng bawat slice
    
    // 1. Gawing positive ang angle (normalize)
    const currentRotation = (wheelAngle % (2 * Math.PI) + (2 * Math.PI)) % (2 * Math.PI);
    
    // 2. MATH FIX:
    // Ang Arrow ay nasa Taas (270 degrees o 1.5 * PI).
    // Ang formula: (Arrow Position - Wheel Rotation) % Circle
    let pointerPos = (1.5 * Math.PI - currentRotation + (2 * Math.PI)) % (2 * Math.PI);
    
    // 3. Kunin ang index
    let index = Math.floor(pointerPos / arcSize);
    
    // Safety check kung lumagpas sa array
    if (index >= SEGMENTS.length) index = 0;
    
    const winningSegment = SEGMENTS[index];
    const prize = winningSegment.value;

    // --- REWARD LOGIC ---
    spinStatus.innerHTML = `YOU WON: <span style="color:${winningSegment.color}; font-size:1.5em;">${prize}</span> COINS!`;
    
    playerTotalCurrency += prize;
    saveCurrency();
    updateCurrencyDisplay();
    saveLastClaimTime();
    updateDailyRewardButtonState();

    // Play Sound & Effects
    if(typeof playCoinSound === 'function') playCoinSound();
    triggerFireworks(); 

    spinBtn.textContent = "CLAIMED";
}
// Initial Draw
setTimeout(drawWheel, 1000);

if (spinBtn) spinBtn.addEventListener('click', startSpin);

    
</script> <div id="full-image-modal" class="modal-overlay">
    <span class="modal-close-btn" id="full-image-close-btn">&times;</span>
    <div class="full-image-content">
        <img id="full-image-display" src="">
    </div>
</div>

<div id="rank-up-modal" class="modal-overlay" style="z-index: 25000; background: rgba(0,0,0,0.95) !important;">
    <div class="rank-up-content" style="position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%; overflow: hidden;">
        
        <div class="rank-rays"></div>
        
        <div id="rank-up-icon" style="font-size: 8rem; margin-bottom: 20px; z-index: 2; filter: drop-shadow(0 0 30px rgba(255, 215, 0, 0.8));">
            üèÜ
        </div>

        <h1 style="font-family: 'Luckiest Guy', cursive; font-size: 3.5rem; color: #FFF; text-shadow: 0 5px 0 #000; margin: 0; z-index: 2; letter-spacing: 2px;">
            PROMOTED!
        </h1>

        <div id="rank-up-name" style="font-family: 'Luckiest Guy', cursive; font-size: 4rem; color: #FFD700; text-shadow: 0 5px 0 #000, 0 0 20px #FFD700; margin: 10px 0 30px 0; z-index: 2; text-transform: uppercase;">
            GOLD
        </div>

        <div id="rank-up-reward-text" style="font-family: 'Nunito', sans-serif; font-size: 1.5rem; color: #FFF; margin-bottom: 30px; z-index: 2; font-weight: bold; background: rgba(0,0,0,0.5); padding: 10px 30px; border-radius: 50px; border: 2px solid #FFD700;">
            Rewards: üí∞ 1000 Coins
        </div>

        <button id="rank-up-claim-btn" class="menu-button" style="z-index: 2; padding: 15px 60px; font-size: 1.5rem; border: 3px solid #FFF; box-shadow: 0 0 30px rgba(255,215,0,0.6); background: linear-gradient(to bottom, #FFD700, #FFA500); color: #000;">
            CLAIM!
        </button>
    </div>
</div>

<script>
    // --- 1. GLOBAL IMAGE VIEWER LOGIC ---
    window.viewFullPhoto = function(src) {
        // Basic checks
        if (!src || src === 'null' || src === 'undefined' || src === '') return;
        if (src.includes('ui-avatars.com')) return;

        const modal = document.getElementById('full-image-modal');
        const display = document.getElementById('full-image-display');

        if (modal && display) {
            display.src = src;
            modal.classList.add('show');
            history.pushState({ modal: 'fullImage' }, 'View Image', '#view-image');
        }
    };

    // --- 2. CLOSE BUTTONS LOGIC ---
    document.addEventListener('DOMContentLoaded', () => {
        
        // Full Image Close
        const imgModal = document.getElementById('full-image-modal');
        const imgCloseBtn = document.getElementById('full-image-close-btn');

        if (imgCloseBtn) {
            imgCloseBtn.onclick = function() {
                if (imgModal) imgModal.classList.remove('show');
                if (history.state && history.state.modal === 'fullImage') history.back();
            };
        }

        if (imgModal) {
            imgModal.onclick = function(e) {
                if (e.target === imgModal || e.target.classList.contains('full-image-content')) {
                    imgModal.classList.remove('show');
                    if (history.state && history.state.modal === 'fullImage') history.back();
                }
            };
        }

        // Rank Up Claim Button
        const rankClaimBtn = document.getElementById('rank-up-claim-btn');
        const rankModal = document.getElementById('rank-up-modal');
        if(rankClaimBtn && rankModal) {
            rankClaimBtn.onclick = function() {
                if (typeof playButtonSound === 'function') playButtonSound();
                rankModal.classList.remove('show');
            };
        }

        // --- IDAGDAG MO ITO DITO ---
        
        // Listahan ng mga buttons na aayusin natin
        const modalsToFix = [
            { btnId: 'ai-menu-close-btn', modalId: 'ai-menu' },
            { btnId: 'online-select-close-btn', modalId: 'online-game-select' },
            { btnId: 'online-menu-close-btn', modalId: 'online-menu' },
            { btnId: 'shop-close-btn', modalId: 'shop-modal' },
            { btnId: 'daily-reward-close-btn', modalId: 'daily-reward-modal' },
            { btnId: 'full-image-close-btn', modalId: 'full-image-modal' },
            { btnId: 'leaderboard-close-btn', modalId: 'leaderboard-modal' },
            { btnId: 'private-chat-close', modalId: 'private-chat-modal' } // Sinama ko na rin chat dito
        ];

        // I-activate ang safe close sa kanilang lahat
        modalsToFix.forEach(item => {
            if (document.getElementById(item.btnId)) {
                attachSafeCloseListener(item.btnId, item.modalId);
            }
        });
        
        // --- TAPOS NA ANG DAGDAG ---
    });

    // --- TON WALLET INTEGRATION (MODULAR VERSION) ---

// 1. I-initialize ang TON Connect UI
const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
    manifestUrl: 'https://raw.githubusercontent.com/arnoldtasipit66-wq/my-game-assets/refs/heads/main/tonconnect-manifest.json', 
    buttonRootId: 'ton-connect'
});

// 2. Makinig sa status change ng wallet
tonConnectUI.onStatusChange(async (wallet) => {
    if (wallet) {
        const walletAddress = wallet.account.address;
        console.log("Wallet Connected:", walletAddress);
        
        // 1. I-save muna sa localStorage para kahit mag-reload o mabagal ang Auth, may record tayo
        localStorage.setItem('pendingWalletAddress', walletAddress);

        // 2. I-check kung may logged in user na
        if (localPlayerUid) {
            await saveWalletToFirestore(localPlayerUid, walletAddress);
        } else {
            console.log("Waiting for user to log in before saving wallet...");
        }
    } else {
        console.log("Wallet disconnected");
        localStorage.removeItem('pendingWalletAddress');
    }
});

// ============================================================
// ‚¨áÔ∏è START NG CLEAN CODE (Paste mo ito sa dulo) ‚¨áÔ∏è
// ============================================================

async function saveWalletToFirestore(uid, address) {
    // 1. CHECK: Gamitin ang window.db para ma-access ang database mula sa labas ng module
    const database = window.db || db; 

    if (!database) {
        console.warn("‚ö†Ô∏è Database not initialized yet. Retrying in 1s...");
        setTimeout(() => saveWalletToFirestore(uid, address), 1000);
        return;
    }

    if (!uid) {
        console.error("‚ùå Error: Walang UID na nahanap.");
        return;
    }

    try {
        // Siguraduhin na ang 'doc' at 'setDoc' ay kasama sa iyong Firebase imports sa taas
        const playerDocRef = doc(database, "players", uid);
        
        await setDoc(playerDocRef, {
            walletAddress: address,
            lastWalletUpdate: serverTimestamp()
        }, { merge: true });

        console.log("‚úÖ Wallet successfully saved to Firestore!");
        
        localStorage.removeItem('pendingWalletAddress');
        
        if (typeof tg !== 'undefined' && tg.showAlert) {
            tg.showAlert("Wallet Linked Successfully!");
        }
    } catch (error) {
        console.error("‚ùå Firestore Save Error:", error);
        if (error.code === 'permission-denied') {
            console.error("üëâ Permissions Error: I-check ang Firestore Rules mo.");
        }
    }
}

// ------------------------------------------------------------
// üöÄ NAVIGATION & BUTTON SYSTEM ACTIVATOR
// ------------------------------------------------------------

// 1. Paandarin ang Navigation System (Back Button Support)
// (Siguraduhing na-paste mo na yung 'setupNavigationSystem' function sa gitna kanina)
if (typeof setupNavigationSystem === 'function') {
    setupNavigationSystem();
}

// 2. I-connect ang mga MENU BUTTONS (Open Modals)
try {
    const menuButtons = [
        { id: 'profile-btn', modal: 'profile-modal' },
        { id: 'settings-btn', modal: 'settings-modal' },
        { id: 'shop-btn', modal: 'shop-modal' }
    ];

    menuButtons.forEach(item => {
        const btn = document.getElementById(item.id);
        if (btn) {
            // Clone para fresh ang listener (iwas doble)
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);

            newBtn.onclick = (e) => {
                e.preventDefault();
                // Tawagin ang Universal Modal Opener
                if (typeof openUniversalModal === 'function') {
                    openUniversalModal(item.modal);
                } else {
                    console.error("‚ö†Ô∏è Missing function: openUniversalModal");
                }
            };
        }
    });

} catch (err) {
    console.log("Button setup error:", err);
}

// ============================================================
// üöÄ NAVIGATION & STATE MANAGEMENT SYSTEM (COMBINED)
// ============================================================

// 1. PINAGANDANG CLOSE BUTTON LOGIC
// Ito ang nag-aasikaso sa lahat ng "X" buttons sa iyong Modals
const closeButtonsList = [
    'profile-close-btn', 
    'settings-close-btn', 
    'shop-close-btn',
    'daily-reward-close-btn'
];

closeButtonsList.forEach(btnId => {
    const btn = document.getElementById(btnId);
    if (btn) {
        // Clone trick para malinis ang dating listeners
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);

        newBtn.onclick = (e) => {
            e.preventDefault();
            
            // Patunugin ang click kung may audio setup ka na
            if (typeof playButtonSound === 'function') playButtonSound();
            
            // Instant UI Response: Isara agad ang modal visually
            const modal = newBtn.closest('.modal-overlay');
            if (modal) modal.classList.remove('show');

            // I-sync ang browser history (Back Button support)
            window.history.back();

            // Tawagin ang restorer para hindi mag-freeze ang laro
            setTimeout(() => {
                restoreGameState();
            }, 50);
        };
    }
});

// 2. CENTRALIZED STATE RESTORER
// Ito ang "utak" na nagdedesisyon kung anong state ang dapat ipakita
function restoreGameState() {
    // A. Hanapin kung may natitira pang modal na nakabukas (stacked modals)
    const activeModal = document.querySelector('.modal-overlay.show');
    
    if (activeModal) {
        gameState = 'modal_open'; 
        return;
    }

    // B. Kung wala nang modal, tignan kung nasaan ang player
    if (window.isInGame) {
        // Balik sa loob ng match (Bilyaran Mode)
        if (canMoveCueBall) {
            gameState = 'moving';
            if (dragGuideText) dragGuideText.style.display = 'block';
        } else if (chipsMoving) {
            gameState = 'shooting';
        } else {
            gameState = 'aiming';
            // Siguraduhing lumitaw ang tako at asinta
            cueStick.visible = true;
            if (typeof cueStickElement !== 'undefined' && cueStickElement) {
                cueStickElement.style.display = 'block';
            }
        }
    } else {
        // Balik sa main display ng Lobby
        gameState = 'lobby';
        if (typeof showLobbyUI === 'function') showLobbyUI();
    }
    
    console.log("Game state successfully restored to:", gameState);
    
    // Refresh ang visuals (Dapat tawagin ang main draw function mo)
    if (typeof draw === 'function') draw(); 
}

// ============================================================
// üõë END OF NAVIGATION SYSTEM
// ============================================================

console.log("‚úÖ ALL SYSTEMS GO: Navigation & Buttons Ready!");

// --- ADSGRAM REWARD SYSTEM (BLOCK ID: 21752) ---
// --- FIXED ADSGRAM REWARD SYSTEM ---
window.watchAdForItem = function(itemId, category, required) {
    if (typeof playButtonSound === 'function') playButtonSound();
    
    if (!window.Adsgram) {
        showMessage("Adsgram is still loading...", 3000);
        return;
    }

    const AdController = window.Adsgram.init({ blockId: "21752" });

    AdController.show().then((result) => {
        if (result.done) {
            // 1. Load current progress
            let progress = JSON.parse(localStorage.getItem('pinoyPoolAdProgress')) || {};
            if (!progress[itemId]) progress[itemId] = 0;
            
            // 2. Increment progress
            progress[itemId]++;
            localStorage.setItem('pinoyPoolAdProgress', JSON.stringify(progress));
            
            // Update global variable
            if (typeof adWatchProgress !== 'undefined') {
                adWatchProgress = progress;
            }

            // 3. CHECK UNLOCK CONDITION (Ito ang inuna natin!)
            let justUnlocked = false;
            if (progress[itemId] >= required) {
                // Check kung wala pa sa inventory
                if (!playerInventory[category].includes(itemId)) {
                    playerInventory[category].push(itemId);
                    saveInventory(); // Save agad para sure
                    
                    justUnlocked = true;
                    showMessage(`üéâ UNLOCKED: ${itemId.toUpperCase()}!`, 4000);
                    
                    if (typeof triggerFireworks === 'function') triggerFireworks();
                }
            } else {
                const remaining = required - progress[itemId];
                showMessage(`Ad complete! ${remaining} more to go.`, 3000);
            }

            // 4. REFRESH UI (Ngayon tatawagin natin ito PAGKATAPOS ma-update ang inventory)
            if (typeof renderShopItems === 'function') {
                renderShopItems(); 
            }

        } else {
            showMessage("Ad skipped. No reward given.", 3000);
        }

    }).catch((error) => {
        console.error("Adsgram Error:", error);
        if (error.error === 'no_fill') {
            showMessage("Walang available na ads sa ngayon. Subukan muli.", 3000);
        } else {
            showMessage("Ad failed to load. Check internet.", 3000);
        }
    });
};
    
</script>
</body>
</html>
